<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coffee Marketplace | joe</title>
  <meta name="robots" content="noindex">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --black: #1c1917;
      --white: #fff;
      --gray-50: #fafaf9;
      --gray-100: #f5f5f4;
      --gray-200: #e7e5e3;
      --gray-300: #d6d3d1;
      --gray-400: #a8a29e;
      --gray-500: #78716c;
      --gray-600: #57534e;
      --gray-700: #44403c;
      --gray-800: #292524;
      --gray-900: #1c1917;
      --amber-500: #f59e0b;
      --green-500: #22c55e;
    }
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--gray-50);
      color: var(--gray-900);
      line-height: 1.6;
    }
    a { color: inherit; text-decoration: none; }

    /* Header */
    .header {
      background: var(--white);
      border-bottom: 1px solid var(--gray-200);
      padding: 1rem 1.5rem;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-inner {
      max-width: 1280px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .logo { font-size: 1.5rem; font-weight: 700; }
    .nav { display: flex; gap: 1.5rem; align-items: center; }
    .nav a { font-weight: 500; color: var(--gray-600); }
    .nav a:hover { color: var(--black); }
    .cart-btn {
      background: var(--black);
      color: var(--white);
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      border: none;
    }
    .cart-count {
      background: var(--amber-500);
      color: var(--black);
      padding: 0.125rem 0.5rem;
      border-radius: 10px;
      font-size: 0.75rem;
      font-weight: 700;
    }

    /* Main */
    .main {
      max-width: 1280px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }
    .page-title {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    .page-subtitle {
      color: var(--gray-500);
      margin-bottom: 2rem;
    }

    /* Filters */
    .filters {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .filter-btn {
      padding: 0.5rem 1rem;
      border: 1px solid var(--gray-300);
      border-radius: 20px;
      background: var(--white);
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s;
    }
    .filter-btn:hover, .filter-btn.active {
      background: var(--black);
      color: var(--white);
      border-color: var(--black);
    }
    .filter-select {
      padding: 0.5rem 1rem;
      border: 1px solid var(--gray-300);
      border-radius: 20px;
      background: var(--white);
      font-size: 0.875rem;
      cursor: pointer;
    }
    .results-count {
      margin-left: auto;
      color: var(--gray-500);
      font-size: 0.875rem;
    }

    /* Products Grid */
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1.5rem;
    }
    .product-card {
      background: var(--white);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--gray-200);
      transition: all 0.2s;
      cursor: pointer;
    }
    .product-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }
    .product-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
      background: var(--gray-100);
    }
    .product-image-placeholder {
      width: 100%;
      height: 200px;
      background: linear-gradient(135deg, var(--gray-200), var(--gray-300));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
    }
    .product-info {
      padding: 1rem;
    }
    .product-roaster {
      font-size: 0.75rem;
      color: var(--gray-500);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.25rem;
    }
    .product-name {
      font-weight: 600;
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
    }
    .product-meta {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 0.75rem;
    }
    .product-tag {
      font-size: 0.7rem;
      padding: 0.25rem 0.5rem;
      background: var(--gray-100);
      border-radius: 4px;
      color: var(--gray-600);
    }
    .product-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .product-price {
      font-size: 1.25rem;
      font-weight: 700;
    }
    .product-price-compare {
      font-size: 0.875rem;
      color: var(--gray-400);
      text-decoration: line-through;
      margin-left: 0.5rem;
    }
    .add-to-cart {
      background: var(--black);
      color: var(--white);
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.875rem;
      transition: background 0.2s;
    }
    .add-to-cart:hover {
      background: var(--gray-800);
    }
    .add-to-cart:disabled {
      background: var(--gray-300);
      cursor: not-allowed;
    }

    /* Product Modal */
    .product-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
      z-index: 300;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .product-modal-overlay.open {
      opacity: 1;
      visibility: visible;
    }
    .product-modal {
      background: var(--white);
      border-radius: 16px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      display: grid;
      grid-template-columns: 1fr 1fr;
      transform: scale(0.95);
      transition: transform 0.3s;
    }
    .product-modal-overlay.open .product-modal {
      transform: scale(1);
    }
    .modal-image-section {
      background: var(--gray-100);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 400px;
    }
    .modal-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .modal-image-placeholder {
      font-size: 6rem;
      color: var(--gray-300);
    }
    .modal-details {
      padding: 2rem;
      display: flex;
      flex-direction: column;
    }
    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: var(--white);
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 1.25rem;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .modal-roaster {
      font-size: 0.875rem;
      color: var(--gray-500);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
    }
    .modal-roaster a {
      color: var(--amber-500);
      text-decoration: underline;
    }
    .modal-title {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 1rem;
    }
    .modal-price {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1rem;
    }
    .modal-price-compare {
      font-size: 1rem;
      color: var(--gray-400);
      text-decoration: line-through;
      margin-left: 0.5rem;
    }
    .modal-meta {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
    }
    .modal-tag {
      font-size: 0.75rem;
      padding: 0.375rem 0.75rem;
      background: var(--gray-100);
      border-radius: 20px;
      color: var(--gray-700);
    }
    .modal-description {
      color: var(--gray-600);
      font-size: 0.9rem;
      margin-bottom: 1.5rem;
      line-height: 1.7;
      flex-grow: 1;
    }
    .modal-options {
      margin-bottom: 1.5rem;
    }
    .option-group {
      margin-bottom: 1rem;
    }
    .option-label {
      font-weight: 600;
      font-size: 0.875rem;
      margin-bottom: 0.5rem;
    }
    .option-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .option-btn {
      padding: 0.5rem 1rem;
      border: 2px solid var(--gray-300);
      border-radius: 8px;
      background: var(--white);
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s;
    }
    .option-btn:hover {
      border-color: var(--gray-500);
    }
    .option-btn.selected {
      border-color: var(--black);
      background: var(--black);
      color: var(--white);
    }
    .option-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .modal-add-btn {
      width: 100%;
      background: var(--black);
      color: var(--white);
      border: none;
      padding: 1rem;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .modal-add-btn:hover {
      background: var(--gray-800);
    }
    .modal-add-btn:disabled {
      background: var(--gray-300);
      cursor: not-allowed;
    }
    .flavor-notes {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }
    .flavor-note {
      font-size: 0.75rem;
      padding: 0.25rem 0.75rem;
      background: #fef3c7;
      border-radius: 20px;
      color: #92400e;
    }

    @media (max-width: 768px) {
      .product-modal {
        grid-template-columns: 1fr;
      }
      .modal-image-section {
        min-height: 250px;
      }
    }

    /* Cart Sidebar */
    .cart-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
      z-index: 200;
    }
    .cart-overlay.open {
      opacity: 1;
      visibility: visible;
    }
    .cart-sidebar {
      position: fixed;
      top: 0;
      right: 0;
      width: 400px;
      max-width: 100%;
      height: 100%;
      background: var(--white);
      transform: translateX(100%);
      transition: transform 0.3s;
      z-index: 201;
      display: flex;
      flex-direction: column;
    }
    .cart-overlay.open .cart-sidebar {
      transform: translateX(0);
    }
    .cart-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .cart-header h2 {
      font-size: 1.25rem;
    }
    .cart-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--gray-500);
    }
    .cart-items {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }
    .cart-empty {
      text-align: center;
      color: var(--gray-500);
      padding: 3rem 1rem;
    }
    .cart-item {
      display: flex;
      gap: 1rem;
      padding: 1rem 0;
      border-bottom: 1px solid var(--gray-100);
    }
    .cart-item-image {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      background: var(--gray-100);
    }
    .cart-item-info {
      flex: 1;
    }
    .cart-item-name {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    .cart-item-roaster {
      font-size: 0.75rem;
      color: var(--gray-500);
    }
    .cart-item-variant {
      font-size: 0.75rem;
      color: var(--gray-500);
    }
    .cart-item-price {
      font-weight: 600;
      margin-top: 0.5rem;
    }
    .cart-item-qty {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .qty-btn {
      width: 28px;
      height: 28px;
      border: 1px solid var(--gray-300);
      background: var(--white);
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
    }
    .qty-btn:hover {
      background: var(--gray-100);
    }
    .cart-item-remove {
      color: var(--gray-400);
      cursor: pointer;
      font-size: 0.75rem;
    }
    .cart-item-remove:hover {
      color: red;
    }
    .cart-footer {
      padding: 1.5rem;
      border-top: 1px solid var(--gray-200);
    }
    .cart-subtotal {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }
    .cart-shipping {
      display: flex;
      justify-content: space-between;
      color: var(--gray-500);
      font-size: 0.875rem;
      margin-bottom: 1rem;
    }
    .cart-total {
      display: flex;
      justify-content: space-between;
      font-weight: 700;
      font-size: 1.25rem;
      margin-bottom: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--gray-200);
    }
    .checkout-btn {
      width: 100%;
      background: var(--black);
      color: var(--white);
      border: none;
      padding: 1rem;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .checkout-btn:hover {
      background: var(--gray-800);
    }
    .checkout-btn:disabled {
      background: var(--gray-300);
      cursor: not-allowed;
    }
    .free-shipping-note {
      text-align: center;
      font-size: 0.75rem;
      color: var(--green-500);
      margin-top: 0.5rem;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 3rem;
      color: var(--gray-500);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--gray-500);
    }
    .empty-state h3 {
      color: var(--gray-700);
      margin-bottom: 0.5rem;
    }

    @media (max-width: 640px) {
      .filters { flex-direction: column; }
      .cart-sidebar { width: 100%; }
      .results-count { margin-left: 0; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <a href="/" class="logo">â˜• joe</a>
      <nav class="nav">
        <a href="/locations/">Find Coffee</a>
        <a href="/marketplace/">Shop</a>
        <button class="cart-btn" onclick="toggleCart()">
          ðŸ›’ Cart <span class="cart-count" id="cartCount">0</span>
        </button>
      </nav>
    </div>
  </header>

  <main class="main">
    <h1 class="page-title">Coffee Marketplace</h1>
    <p class="page-subtitle">Fresh roasted coffee from independent roasters, shipped to your door</p>

    <div class="filters">
      <button class="filter-btn" onclick="filterType('all')">All</button>
      <button class="filter-btn active" onclick="filterType('coffee')">â˜• Coffee</button>
      <button class="filter-btn" onclick="filterType('merch')">ðŸ‘• Merch</button>
      <select class="filter-select" onchange="filterRoast(this.value)">
        <option value="">All Roasts</option>
        <option value="light">Light Roast</option>
        <option value="medium">Medium Roast</option>
        <option value="dark">Dark Roast</option>
        <option value="espresso">Espresso</option>
      </select>
      <select class="filter-select" onchange="filterGrind(this.value)">
        <option value="">All Grinds</option>
        <option value="whole_bean">Whole Bean</option>
        <option value="ground">Ground</option>
      </select>
      <label style="display:flex;align-items:center;gap:0.5rem;font-size:0.875rem;">
        <input type="checkbox" onchange="filterFreeShipping(this.checked)">
        Free Shipping
      </label>
      <span class="results-count" id="resultsCount"></span>
    </div>

    <div class="products-grid" id="productsGrid">
      <div class="loading">Loading products...</div>
    </div>
  </main>

  <!-- Product Detail Modal -->
  <div class="product-modal-overlay" id="productModal" onclick="closeProductModal()">
    <div class="product-modal" onclick="event.stopPropagation()">
      <button class="modal-close" onclick="closeProductModal()">Ã—</button>
      <div class="modal-image-section">
        <img src="" alt="" class="modal-image" id="modalImage" style="display:none;">
        <div class="modal-image-placeholder" id="modalImagePlaceholder">â˜•</div>
      </div>
      <div class="modal-details">
        <div class="modal-roaster" id="modalRoaster"></div>
        <h2 class="modal-title" id="modalTitle"></h2>
        <div class="modal-price">
          <span id="modalPrice"></span>
          <span class="modal-price-compare" id="modalPriceCompare"></span>
        </div>
        <div class="modal-meta" id="modalMeta"></div>
        <div class="flavor-notes" id="modalFlavors"></div>
        <p class="modal-description" id="modalDescription"></p>
        <div class="modal-options" id="modalOptions"></div>
        <button class="modal-add-btn" id="modalAddBtn" onclick="addFromModal()">
          Add to Cart
        </button>
      </div>
    </div>
  </div>

  <!-- Cart Sidebar -->
  <div class="cart-overlay" id="cartOverlay" onclick="toggleCart()">
    <div class="cart-sidebar" onclick="event.stopPropagation()">
      <div class="cart-header">
        <h2>Your Cart</h2>
        <button class="cart-close" onclick="toggleCart()">Ã—</button>
      </div>
      <div class="cart-items" id="cartItems">
        <div class="cart-empty">Your cart is empty</div>
      </div>
      <div class="cart-footer">
        <div class="cart-subtotal">
          <span>Subtotal</span>
          <span id="cartSubtotal">$0.00</span>
        </div>
        <div class="cart-shipping">
          <span>Shipping</span>
          <span id="cartShipping">Calculated at checkout</span>
        </div>
        <div class="cart-total">
          <span>Total</span>
          <span id="cartTotal">$0.00</span>
        </div>
        <button class="checkout-btn" id="checkoutBtn" onclick="checkout()" disabled>
          Checkout
        </button>
        <div class="free-shipping-note" id="freeShippingNote" style="display:none">
          ðŸŽ‰ You qualify for free shipping!
        </div>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://vpnoaxpmhuknyaxcyxsu.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZwbm9heHBtaHVrbnlheGN5eHN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NjkzNTMsImV4cCI6MjA4MjQ0NTM1M30.0JVwCaY-3nUHuJk49ibifQviT0LxBSdYXMslw9WIr9M';
    const STRIPE_PK = 'pk_test_pVhmxVfpg2WXDdXjkLZtpXsc';
    
    const stripe = Stripe(STRIPE_PK);
    
    let products = [];
    let cart = JSON.parse(localStorage.getItem('joe_cart') || '[]');
    let filters = { type: 'coffee', roast: '', grind: '', freeShipping: false };
    let currentProduct = null;
    let selectedVariant = null;

    // Fetch products
    async function loadProducts() {
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/products?is_active=eq.true&select=*,shops(id,name,slug,has_free_shipping,free_shipping_threshold)&order=created_at.desc`, {
          headers: { 
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`
          }
        });
        products = await res.json();
        renderProducts();
      } catch (err) {
        console.error('Error loading products:', err);
        document.getElementById('productsGrid').innerHTML = `
          <div class="empty-state">
            <h3>Unable to load products</h3>
            <p>Please try again later</p>
          </div>
        `;
      }
    }

    function renderProducts() {
      const grid = document.getElementById('productsGrid');
      
      let filtered = products.filter(p => {
        if (filters.type !== 'all' && p.product_type !== filters.type) return false;
        if (filters.roast && p.roast_level !== filters.roast) return false;
        if (filters.grind && p.grind_type !== filters.grind) return false;
        if (filters.freeShipping && !p.shops?.has_free_shipping) return false;
        return true;
      });

      document.getElementById('resultsCount').textContent = `${filtered.length} products`;

      if (filtered.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <h3>No products found</h3>
            <p>Try adjusting your filters</p>
          </div>
        `;
        return;
      }

      grid.innerHTML = filtered.map(p => `
        <div class="product-card" onclick="openProductModal('${p.id}')">
          ${p.image_url 
            ? `<img src="${p.image_url}" alt="${p.name}" class="product-image">`
            : `<div class="product-image-placeholder">â˜•</div>`
          }
          <div class="product-info">
            <div class="product-roaster">${p.shops?.name || 'Unknown Roaster'}</div>
            <div class="product-name">${p.name}</div>
            <div class="product-meta">
              ${p.grind_type ? `<span class="product-tag">${p.grind_type.replace('_', ' ')}</span>` : ''}
              ${p.size ? `<span class="product-tag">${p.size}</span>` : ''}
              ${p.origin ? `<span class="product-tag">${p.origin}</span>` : ''}
            </div>
            <div class="product-footer">
              <div>
                <span class="product-price">$${parseFloat(p.price).toFixed(2)}</span>
                ${p.compare_at_price ? `<span class="product-price-compare">$${parseFloat(p.compare_at_price).toFixed(2)}</span>` : ''}
              </div>
              <button class="add-to-cart" onclick="event.stopPropagation();addToCart('${p.id}')" ${!p.in_stock ? 'disabled' : ''}>
                ${p.in_stock ? 'Add' : 'Sold Out'}
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Product Modal
    function openProductModal(productId) {
      const product = products.find(p => p.id === productId);
      if (!product) return;
      
      currentProduct = product;
      selectedVariant = product;
      
      // Find all variants (same product name from same shop)
      const variants = products.filter(p => 
        p.shop_id === product.shop_id && 
        p.name === product.name
      );
      
      // Image
      const imgEl = document.getElementById('modalImage');
      const placeholderEl = document.getElementById('modalImagePlaceholder');
      if (product.image_url) {
        imgEl.src = product.image_url;
        imgEl.style.display = 'block';
        placeholderEl.style.display = 'none';
      } else {
        imgEl.style.display = 'none';
        placeholderEl.style.display = 'flex';
      }
      
      // Roaster with link
      const roasterHtml = product.shops?.slug 
        ? `<a href="/locations/${product.shops.slug}/">${product.shops.name}</a>`
        : product.shops?.name || 'Unknown Roaster';
      document.getElementById('modalRoaster').innerHTML = roasterHtml;
      
      // Title
      document.getElementById('modalTitle').textContent = product.name;
      
      // Price
      document.getElementById('modalPrice').textContent = `$${parseFloat(product.price).toFixed(2)}`;
      document.getElementById('modalPriceCompare').textContent = product.compare_at_price 
        ? `$${parseFloat(product.compare_at_price).toFixed(2)}` 
        : '';
      
      // Meta tags
      let metaHtml = '';
      if (product.roast_level) metaHtml += `<span class="modal-tag">${product.roast_level} roast</span>`;
      if (product.origin) metaHtml += `<span class="modal-tag">${product.origin}</span>`;
      if (product.size) metaHtml += `<span class="modal-tag">${product.size}</span>`;
      document.getElementById('modalMeta').innerHTML = metaHtml;
      
      // Flavor notes
      let flavorsHtml = '';
      if (product.flavor_notes && product.flavor_notes.length > 0) {
        const notes = Array.isArray(product.flavor_notes) ? product.flavor_notes : [product.flavor_notes];
        flavorsHtml = notes.map(n => `<span class="flavor-note">${n}</span>`).join('');
      }
      document.getElementById('modalFlavors').innerHTML = flavorsHtml;
      
      // Description
      document.getElementById('modalDescription').textContent = product.description || 'No description available.';
      
      // Options (size and grind)
      let optionsHtml = '';
      
      // Get unique sizes
      const sizes = [...new Set(variants.map(v => v.size).filter(Boolean))];
      if (sizes.length > 1) {
        optionsHtml += `
          <div class="option-group">
            <div class="option-label">Size</div>
            <div class="option-buttons">
              ${sizes.map(s => `
                <button class="option-btn ${s === product.size ? 'selected' : ''}" 
                        onclick="selectSize('${s}')">${s}</button>
              `).join('')}
            </div>
          </div>
        `;
      }
      
      // Get unique grinds
      const grinds = [...new Set(variants.map(v => v.grind_type).filter(Boolean))];
      if (grinds.length > 1) {
        optionsHtml += `
          <div class="option-group">
            <div class="option-label">Grind</div>
            <div class="option-buttons">
              ${grinds.map(g => `
                <button class="option-btn ${g === product.grind_type ? 'selected' : ''}" 
                        onclick="selectGrind('${g}')">${g.replace('_', ' ')}</button>
              `).join('')}
            </div>
          </div>
        `;
      }
      
      document.getElementById('modalOptions').innerHTML = optionsHtml;
      
      // Update add button
      updateModalAddButton();
      
      // Open modal
      document.getElementById('productModal').classList.add('open');
    }
    
    function closeProductModal() {
      document.getElementById('productModal').classList.remove('open');
      currentProduct = null;
      selectedVariant = null;
    }
    
    function selectSize(size) {
      if (!currentProduct) return;
      
      // Find variant with this size (and matching grind if selected)
      const currentGrind = selectedVariant?.grind_type;
      const variant = products.find(p => 
        p.shop_id === currentProduct.shop_id && 
        p.name === currentProduct.name &&
        p.size === size &&
        (!currentGrind || p.grind_type === currentGrind)
      ) || products.find(p => 
        p.shop_id === currentProduct.shop_id && 
        p.name === currentProduct.name &&
        p.size === size
      );
      
      if (variant) {
        selectedVariant = variant;
        updateModalPrice();
        
        // Update button states
        document.querySelectorAll('.option-group:first-child .option-btn').forEach(btn => {
          btn.classList.toggle('selected', btn.textContent === size);
        });
      }
    }
    
    function selectGrind(grind) {
      if (!currentProduct) return;
      
      // Find variant with this grind (and matching size if selected)
      const currentSize = selectedVariant?.size;
      const variant = products.find(p => 
        p.shop_id === currentProduct.shop_id && 
        p.name === currentProduct.name &&
        p.grind_type === grind &&
        (!currentSize || p.size === currentSize)
      ) || products.find(p => 
        p.shop_id === currentProduct.shop_id && 
        p.name === currentProduct.name &&
        p.grind_type === grind
      );
      
      if (variant) {
        selectedVariant = variant;
        updateModalPrice();
        
        // Update button states
        document.querySelectorAll('.option-group:last-child .option-btn').forEach(btn => {
          btn.classList.toggle('selected', btn.textContent === grind.replace('_', ' '));
        });
      }
    }
    
    function updateModalPrice() {
      if (!selectedVariant) return;
      document.getElementById('modalPrice').textContent = `$${parseFloat(selectedVariant.price).toFixed(2)}`;
      document.getElementById('modalPriceCompare').textContent = selectedVariant.compare_at_price 
        ? `$${parseFloat(selectedVariant.compare_at_price).toFixed(2)}` 
        : '';
      updateModalAddButton();
    }
    
    function updateModalAddButton() {
      const btn = document.getElementById('modalAddBtn');
      if (selectedVariant?.in_stock) {
        btn.disabled = false;
        btn.textContent = `Add to Cart â€” $${parseFloat(selectedVariant.price).toFixed(2)}`;
      } else {
        btn.disabled = true;
        btn.textContent = 'Sold Out';
      }
    }
    
    function addFromModal() {
      if (!selectedVariant) return;
      addToCart(selectedVariant.id);
      closeProductModal();
    }

    // Filters
    function filterType(type) {
      filters.type = type;
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      renderProducts();
    }
    function filterRoast(roast) { filters.roast = roast; renderProducts(); }
    function filterGrind(grind) { filters.grind = grind; renderProducts(); }
    function filterFreeShipping(checked) { filters.freeShipping = checked; renderProducts(); }

    // Cart
    function addToCart(productId) {
      const product = products.find(p => p.id === productId);
      if (!product) return;

      // Create unique cart key with variant info
      const cartKey = `${product.id}`;
      const existing = cart.find(i => i.id === cartKey);
      
      if (existing) {
        existing.qty++;
      } else {
        cart.push({
          id: cartKey,
          productId: product.id,
          name: product.name,
          price: parseFloat(product.price),
          image: product.image_url,
          roaster: product.shops?.name,
          shop_id: product.shop_id,
          size: product.size,
          grind: product.grind_type,
          qty: 1
        });
      }
      saveCart();
      renderCart();
      
      // Show toast
      showToast(`Added ${product.name} to cart`);
    }

    function showToast(message) {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--black);
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 500;
        z-index: 1000;
        animation: fadeIn 0.3s;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2000);
    }

    function updateQty(productId, delta) {
      const item = cart.find(i => i.id === productId);
      if (!item) return;
      item.qty += delta;
      if (item.qty <= 0) {
        cart = cart.filter(i => i.id !== productId);
      }
      saveCart();
      renderCart();
    }

    function removeFromCart(productId) {
      cart = cart.filter(i => i.id !== productId);
      saveCart();
      renderCart();
    }

    function saveCart() {
      localStorage.setItem('joe_cart', JSON.stringify(cart));
    }

    function renderCart() {
      const itemsEl = document.getElementById('cartItems');
      const countEl = document.getElementById('cartCount');
      const subtotalEl = document.getElementById('cartSubtotal');
      const totalEl = document.getElementById('cartTotal');
      const checkoutBtn = document.getElementById('checkoutBtn');
      const freeShippingNote = document.getElementById('freeShippingNote');

      const totalQty = cart.reduce((sum, i) => sum + i.qty, 0);
      const subtotal = cart.reduce((sum, i) => sum + (i.price * i.qty), 0);

      countEl.textContent = totalQty;
      subtotalEl.textContent = `$${subtotal.toFixed(2)}`;
      totalEl.textContent = `$${subtotal.toFixed(2)}`;
      checkoutBtn.disabled = cart.length === 0;

      // Free shipping check (example: $50+)
      if (subtotal >= 50) {
        freeShippingNote.style.display = 'block';
      } else {
        freeShippingNote.style.display = 'none';
      }

      if (cart.length === 0) {
        itemsEl.innerHTML = '<div class="cart-empty">Your cart is empty</div>';
        return;
      }

      // Group items by roaster
      const grouped = {};
      cart.forEach(item => {
        const roaster = item.roaster || 'Unknown Roaster';
        if (!grouped[roaster]) grouped[roaster] = [];
        grouped[roaster].push(item);
      });

      const roasters = Object.keys(grouped);
      const multiShop = roasters.length > 1;

      let html = '';
      
      // Multi-shop notice
      if (multiShop) {
        html += `<div style="background:#fef3c7;padding:0.75rem;border-radius:8px;margin-bottom:1rem;font-size:0.85rem;color:#92400e;">
          ðŸ“¦ Ordering from ${roasters.length} shops â€” each will ship separately
        </div>`;
      }

      // Render grouped items
      roasters.forEach(roaster => {
        if (multiShop) {
          html += `<div style="font-weight:600;font-size:0.85rem;color:#57534e;margin:1rem 0 0.5rem;padding-top:0.5rem;border-top:1px solid #e7e5e3;">${roaster}</div>`;
        }
        
        grouped[roaster].forEach(item => {
          const variantInfo = [item.size, item.grind?.replace('_', ' ')].filter(Boolean).join(' â€¢ ');
          html += `
            <div class="cart-item">
              ${item.image 
                ? `<img src="${item.image}" alt="${item.name}" class="cart-item-image">`
                : `<div class="cart-item-image" style="display:flex;align-items:center;justify-content:center;font-size:2rem;">â˜•</div>`
              }
              <div class="cart-item-info">
                <div class="cart-item-name">${item.name}</div>
                ${!multiShop ? `<div class="cart-item-roaster">${item.roaster || ''}</div>` : ''}
                ${variantInfo ? `<div class="cart-item-variant">${variantInfo}</div>` : ''}
                <div class="cart-item-price">$${(item.price * item.qty).toFixed(2)}</div>
                <div class="cart-item-qty">
                  <button class="qty-btn" onclick="updateQty('${item.id}', -1)">âˆ’</button>
                  <span>${item.qty}</span>
                  <button class="qty-btn" onclick="updateQty('${item.id}', 1)">+</button>
                  <span class="cart-item-remove" onclick="removeFromCart('${item.id}')">Remove</span>
                </div>
              </div>
            </div>
          `;
        });
      });

      itemsEl.innerHTML = html;
    }

    function toggleCart() {
      document.getElementById('cartOverlay').classList.toggle('open');
    }

    // Checkout
    async function checkout() {
      const checkoutBtn = document.getElementById('checkoutBtn');
      checkoutBtn.disabled = true;
      checkoutBtn.textContent = 'Processing...';

      try {
        const res = await fetch('/.netlify/functions/create-checkout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items: cart })
        });

        const { sessionId, error } = await res.json();

        if (error) {
          throw new Error(error);
        }

        // Redirect to Stripe Checkout
        const result = await stripe.redirectToCheckout({ sessionId });
        if (result.error) {
          throw new Error(result.error.message);
        }
      } catch (err) {
        alert('Checkout error: ' + err.message);
        checkoutBtn.disabled = false;
        checkoutBtn.textContent = 'Checkout';
      }
    }

    // Handle escape key for modals
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeProductModal();
        if (document.getElementById('cartOverlay').classList.contains('open')) {
          toggleCart();
        }
      }
    });

    // Init
    loadProducts();
    renderCart();
  </script>
</body>
</html>