<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Loading... | joe</title>
  <meta name="description" content="Shop fresh roasted coffee from independent roasters.">
  <link rel="icon" type="image/png" href="/images/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --black: #1c1917;
      --white: #fff;
      --gray-50: #fafaf9;
      --gray-100: #f5f5f4;
      --gray-200: #e7e5e3;
      --gray-300: #d6d3d1;
      --gray-400: #a8a29e;
      --gray-500: #78716c;
      --gray-600: #57534e;
      --gray-800: #292524;
      --amber-500: #f59e0b;
      --green-500: #22c55e;
    }
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--gray-50);
      color: var(--black);
      line-height: 1.6;
    }
    a { color: inherit; text-decoration: none; }

    /* Header - matches homepage */
    .header {
      background: var(--white);
      border-bottom: 1px solid var(--gray-200);
      padding: 1rem 1.5rem;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-inner {
      max-width: 1280px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .logo { display: flex; align-items: center; }
    .logo img { height: 40px; width: auto; }
    .nav { display: flex; gap: 1.5rem; align-items: center; }
    .nav a { font-weight: 500; color: var(--gray-600); }
    .nav a:hover { color: var(--black); }
    .btn-primary {
      background: var(--black);
      color: var(--white) !important;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-weight: 600;
    }
    .cart-btn {
      background: var(--black);
      color: var(--white);
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      border: none;
    }
    .cart-count {
      background: var(--amber-500);
      color: var(--black);
      padding: 0.125rem 0.5rem;
      border-radius: 10px;
      font-size: 0.75rem;
      font-weight: 700;
    }

    /* Breadcrumb */
    .breadcrumb {
      max-width: 1280px;
      margin: 0 auto;
      padding: 1rem 1.5rem;
      font-size: 0.875rem;
      color: var(--gray-500);
    }
    .breadcrumb a:hover { color: var(--black); }
    .breadcrumb span { margin: 0 0.5rem; color: var(--gray-300); }

    /* Loading State */
    .loading-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 400px;
      flex-direction: column;
      gap: 1rem;
    }
    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--gray-200);
      border-top-color: var(--black);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .loading-text {
      color: var(--gray-500);
      font-size: 0.875rem;
    }

    /* Product Layout */
    .product-container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 3rem;
    }
    .product-gallery {
      position: sticky;
      top: 100px;
      align-self: start;
    }
    .product-main-image {
      width: 100%;
      aspect-ratio: 1;
      background: var(--white);
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid var(--gray-200);
    }
    .product-main-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .product-thumbnails {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
      overflow-x: auto;
    }
    .product-thumb {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      border: 2px solid transparent;
      flex-shrink: 0;
    }
    .product-thumb.active { border-color: var(--black); }
    .product-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .product-details {
      padding-top: 1rem;
    }
    .shop-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: var(--gray-100);
      padding: 0.5rem 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
    }
    .shop-badge img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
    }
    .shop-badge-name {
      font-weight: 600;
      font-size: 0.875rem;
    }
    .shop-badge-location {
      font-size: 0.75rem;
      color: var(--gray-500);
    }
    .joe-partner-tag {
      background: var(--green-500);
      color: var(--white);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.65rem;
      font-weight: 700;
      margin-left: 0.5rem;
    }
    .shop-info {
      margin-bottom: 1rem;
    }
    .view-all-link {
      display: inline-block;
      margin-top: 0.5rem;
      font-size: 0.875rem;
      color: var(--gray-600);
      font-weight: 500;
    }
    .view-all-link:hover {
      color: var(--black);
    }

    .product-title {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      line-height: 1.2;
    }
    .product-price {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
    }
    .product-price .original {
      text-decoration: line-through;
      color: var(--gray-400);
      font-size: 1.125rem;
      margin-left: 0.5rem;
    }
    .product-price .sale {
      color: #dc2626;
    }

    .product-description {
      color: var(--gray-600);
      margin-bottom: 2rem;
      line-height: 1.7;
    }

    .quantity-selector {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .quantity-selector label {
      font-weight: 600;
    }
    .quantity-controls {
      display: flex;
      align-items: center;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      overflow: hidden;
    }
    .quantity-btn {
      width: 44px;
      height: 44px;
      background: var(--white);
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
    }
    .quantity-btn:hover { background: var(--gray-100); }
    .quantity-value {
      width: 60px;
      text-align: center;
      font-weight: 600;
      font-size: 1rem;
    }

    .add-to-cart-btn {
      width: 100%;
      padding: 1rem 2rem;
      background: var(--black);
      color: var(--white);
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 1rem;
      transition: background 0.2s;
    }
    .add-to-cart-btn:hover { background: var(--gray-800); }
    .add-to-cart-btn:disabled {
      background: var(--gray-300);
      cursor: not-allowed;
    }

    .buy-now-btn {
      width: 100%;
      padding: 1rem 2rem;
      background: var(--white);
      color: var(--black);
      border: 2px solid var(--black);
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .buy-now-btn:hover {
      background: var(--gray-100);
    }

    .product-meta {
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 1px solid var(--gray-200);
    }
    .meta-item {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      font-size: 0.875rem;
      color: var(--gray-600);
    }
    .meta-item strong {
      color: var(--black);
    }

    /* Related Products */
    .related-section {
      max-width: 1280px;
      margin: 4rem auto;
      padding: 0 1.5rem;
    }
    .related-section h2 {
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .related-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 1.5rem;
    }
    .related-card {
      background: var(--white);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--gray-100);
      transition: all 0.2s;
    }
    .related-card:hover {
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      transform: translateY(-4px);
    }
    .related-card img {
      width: 100%;
      height: 180px;
      object-fit: cover;
    }
    .related-card-info {
      padding: 1rem;
    }
    .related-card-name {
      font-weight: 600;
      margin-bottom: 0.25rem;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .related-card-price {
      font-weight: 700;
    }

    /* Error State */
    .error-container {
      text-align: center;
      padding: 4rem 1.5rem;
    }
    .error-container h1 {
      font-size: 2rem;
      margin-bottom: 1rem;
    }
    .error-container p {
      color: var(--gray-500);
      margin-bottom: 2rem;
    }
    .error-btn {
      display: inline-block;
      padding: 0.75rem 1.5rem;
      background: var(--black);
      color: var(--white);
      border-radius: 8px;
      font-weight: 600;
    }

    /* Footer */
    footer {
      background: var(--black);
      color: var(--white);
      padding: 3rem 1.5rem;
      margin-top: 4rem;
    }
    .footer-inner {
      max-width: 1280px;
      margin: 0 auto;
      text-align: center;
    }
    .footer-links {
      display: flex;
      justify-content: center;
      gap: 2rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    .footer-links a { color: var(--gray-400); }
    .footer-links a:hover { color: var(--white); }
    .footer-copy { color: var(--gray-500); font-size: 0.875rem; }

    @media (max-width: 768px) {
      .nav a:not(.btn-primary):not(.cart-btn) { display: none; }
      .product-container {
        grid-template-columns: 1fr;
        gap: 2rem;
      }
      .product-gallery {
        position: relative;
        top: 0;
      }
      .product-title { font-size: 1.5rem; }
      .related-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-inner">
      <a href="/" class="logo"><img src="/images/logo.png" alt="joe"></a>
      <nav class="nav">
        <a href="/locations/">Find Coffee</a>
        <a href="/marketplace/">Shop</a>
        <a href="/for-coffee-shops/">For Coffee Shops</a>
        <a href="/about/">About</a>
        <button class="cart-btn" onclick="openCart()">
          ðŸ›’ Cart <span class="cart-count" id="cartCount">0</span>
        </button>
      </nav>
    </div>
  </header>

  <!-- Breadcrumb -->
  <div class="breadcrumb" id="breadcrumb">
    <a href="/">Home</a>
    <span>â€º</span>
    <a href="/marketplace/">Marketplace</a>
    <span>â€º</span>
    <span id="breadcrumbProduct">Loading...</span>
  </div>

  <!-- Main Content -->
  <main id="mainContent">
    <div class="loading-container" id="loadingState">
      <div class="loading-spinner"></div>
      <div class="loading-text">Loading product...</div>
    </div>
  </main>

  <!-- Footer -->
  <footer>
    <div class="footer-inner">
      <div class="footer-links">
        <a href="/about/">About</a>
        <a href="/for-coffee-shops/">For Coffee Shops</a>
        <a href="/locations/">Find Coffee</a>
        <a href="/blog/">Blog</a>
        <a href="/privacy/">Privacy</a>
        <a href="/terms/">Terms</a>
      </div>
      <p class="footer-copy">Â© 2026 The Joe Collective. All rights reserved.</p>
    </div>
  </footer>

  <script>
    const SUPABASE_URL = 'https://vpnoaxpmhuknyaxcyxsu.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZwbm9heHBtaHVrbnlheGN5eHN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NjkzNTMsImV4cCI6MjA4MjQ0NTM1M30.0JVwCaY-3nUHuJk49ibifQviT0LxBSdYXMslw9WIr9M';
    
    let cart = JSON.parse(localStorage.getItem('joe_cart') || '[]');
    let currentProduct = null;
    let quantity = 1;

    document.addEventListener('DOMContentLoaded', () => {
      updateCartCount();
      loadProduct();
    });

    async function loadProduct() {
      const params = new URLSearchParams(window.location.search);
      const productId = params.get('id');
      
      if (!productId) {
        showError('Product not found');
        return;
      }

      try {
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/products?select=*,shops!products_shop_id_fkey(id,name,is_joe_partner,slug,state_code,city_slug,city,state,photos)&id=eq.${productId}`,
          {
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`
            }
          }
        );

        if (!response.ok) throw new Error('Failed to load product');
        
        const products = await response.json();
        
        if (products.length === 0) {
          showError('Product not found');
          return;
        }

        currentProduct = products[0];
        renderProduct();
        loadRelatedProducts();
      } catch (error) {
        console.error('Error loading product:', error);
        showError('Error loading product');
      }
    }

    function renderProduct() {
      const p = currentProduct;
      const shop = p.shops || {};
      
      // Update page title
      document.title = `${p.name} | joe`;
      
      // Update breadcrumb
      document.getElementById('breadcrumbProduct').textContent = p.name;
      
      // Get images
      const images = p.images ? (Array.isArray(p.images) ? p.images : [p.images]) : [];
      if (p.image_url && !images.includes(p.image_url)) {
        images.unshift(p.image_url);
      }
      const mainImage = images[0] || '/images/placeholder-product.jpg';
      
      // Check if on sale
      const onSale = p.compare_at_price && parseFloat(p.compare_at_price) > parseFloat(p.price);
      
      // Render product
      document.getElementById('mainContent').innerHTML = `
        <div class="product-container">
          <div class="product-gallery">
            <div class="product-main-image">
              <img src="${mainImage}" alt="${escapeHtml(p.name)}" id="mainImage">
            </div>
            ${images.length > 1 ? `
              <div class="product-thumbnails">
                ${images.map((img, i) => `
                  <div class="product-thumb ${i === 0 ? 'active' : ''}" onclick="changeImage('${img}', this)">
                    <img src="${img}" alt="Thumbnail ${i + 1}">
                  </div>
                `).join('')}
              </div>
            ` : ''}
          </div>
          
          <div class="product-details">
            <div class="shop-info">
              <a href="/locations/${shop.state_code?.toLowerCase()}/${shop.city_slug}/${shop.slug}/" class="shop-badge">
                ${shop.photos ? `<img src="${Array.isArray(shop.photos) ? shop.photos[0] : shop.photos}" alt="${escapeHtml(shop.name)}">` : ''}
                <div>
                  <div class="shop-badge-name">
                    ${escapeHtml(shop.name)}
                    ${shop.is_joe_partner ? '<span class="joe-partner-tag">JOE PARTNER</span>' : ''}
                  </div>
                  ${shop.city && shop.state ? `<div class="shop-badge-location">${escapeHtml(shop.city)}, ${escapeHtml(shop.state)}</div>` : ''}
                </div>
              </a>
              <a href="/locations/${shop.state_code?.toLowerCase()}/${shop.city_slug}/${shop.slug}/products/" class="view-all-link">
                View all products â†’
              </a>
            </div>
            
            <h1 class="product-title">${escapeHtml(p.name)}</h1>
            
            <div class="product-price">
              ${onSale ? `
                <span class="sale">$${parseFloat(p.price).toFixed(2)}</span>
                <span class="original">$${parseFloat(p.compare_at_price).toFixed(2)}</span>
              ` : `
                $${parseFloat(p.price).toFixed(2)}
              `}
            </div>
            
            ${p.description ? `<div class="product-description">${escapeHtml(p.description)}</div>` : ''}
            
            <div class="quantity-selector">
              <label>Quantity</label>
              <div class="quantity-controls">
                <button class="quantity-btn" onclick="updateQuantity(-1)">âˆ’</button>
                <span class="quantity-value" id="quantityValue">1</span>
                <button class="quantity-btn" onclick="updateQuantity(1)">+</button>
              </div>
            </div>
            
            <button class="add-to-cart-btn" onclick="addToCart()">
              Add to Cart
            </button>
            
            ${p.external_url ? `
              <a href="${p.external_url}" target="_blank" rel="noopener" class="buy-now-btn" style="display:block;text-align:center;">
                Buy Direct from ${escapeHtml(shop.name)} â†’
              </a>
            ` : ''}
            
            <div class="product-meta">
              ${p.sku ? `<div class="meta-item"><strong>SKU:</strong> ${escapeHtml(p.sku)}</div>` : ''}
              ${p.type ? `<div class="meta-item"><strong>Type:</strong> ${escapeHtml(p.type)}</div>` : ''}
              ${p.vendor ? `<div class="meta-item"><strong>Vendor:</strong> ${escapeHtml(p.vendor)}</div>` : ''}
            </div>
          </div>
        </div>
        
        <div class="related-section">
          <h2>More from ${escapeHtml(shop.name)}</h2>
          <div class="related-grid" id="relatedProducts">
            <div class="loading-text">Loading...</div>
          </div>
        </div>
      `;
    }

    async function loadRelatedProducts() {
      if (!currentProduct) return;
      
      try {
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/products?select=id,name,price,image_url&shop_id=eq.${currentProduct.shop_id}&id=neq.${currentProduct.id}&is_active=eq.true&limit=4`,
          {
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`
            }
          }
        );

        if (!response.ok) throw new Error('Failed to load related');
        
        const related = await response.json();
        
        const container = document.getElementById('relatedProducts');
        if (!container) return;
        
        if (related.length === 0) {
          container.innerHTML = '<p class="loading-text">No other products available</p>';
          return;
        }

        container.innerHTML = related.map(p => `
          <a href="/marketplace/product/?id=${p.id}" class="related-card">
            <img src="${p.image_url || '/images/placeholder-product.jpg'}" alt="${escapeHtml(p.name)}" loading="lazy">
            <div class="related-card-info">
              <div class="related-card-name">${escapeHtml(p.name)}</div>
              <div class="related-card-price">$${parseFloat(p.price).toFixed(2)}</div>
            </div>
          </a>
        `).join('');
      } catch (error) {
        console.error('Error loading related:', error);
      }
    }

    function showError(message) {
      document.getElementById('mainContent').innerHTML = `
        <div class="error-container">
          <h1>Oops!</h1>
          <p>${escapeHtml(message)}</p>
          <a href="/marketplace/" class="error-btn">Back to Marketplace</a>
        </div>
      `;
    }

    function changeImage(src, thumb) {
      document.getElementById('mainImage').src = src;
      document.querySelectorAll('.product-thumb').forEach(t => t.classList.remove('active'));
      thumb.classList.add('active');
    }

    function updateQuantity(delta) {
      quantity = Math.max(1, quantity + delta);
      document.getElementById('quantityValue').textContent = quantity;
    }

    function addToCart() {
      if (!currentProduct) return;
      
      const existingIndex = cart.findIndex(item => item.id === currentProduct.id);
      
      if (existingIndex >= 0) {
        cart[existingIndex].quantity += quantity;
      } else {
        cart.push({
          id: currentProduct.id,
          name: currentProduct.name,
          price: parseFloat(currentProduct.price),
          image: currentProduct.image_url,
          quantity: quantity,
          shopId: currentProduct.shop_id,
          shopName: currentProduct.shops?.name || 'Unknown Shop'
        });
      }
      
      localStorage.setItem('joe_cart', JSON.stringify(cart));
      updateCartCount();
      
      // Show confirmation
      const btn = document.querySelector('.add-to-cart-btn');
      const originalText = btn.textContent;
      btn.textContent = 'âœ“ Added to Cart!';
      btn.disabled = true;
      setTimeout(() => {
        btn.textContent = originalText;
        btn.disabled = false;
      }, 2000);
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function updateCartCount() {
      const count = cart.reduce((sum, item) => sum + item.quantity, 0);
      document.getElementById('cartCount').textContent = count;
    }

    function openCart() {
      window.location.href = '/marketplace/';
    }
  </script>
</body>
</html>