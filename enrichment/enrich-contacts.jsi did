#!/usr/bin/env node

/**
 * joe CRM - Contact Enrichment Script
 * 
 * Scrapes coffee shop websites to find:
 * - Email addresses
 * - Phone numbers (if not already present)
 * - Social media links (Facebook, Instagram)
 * - Contact names
 * - Website type classification
 * 
 * Usage:
 *   node enrich-contacts.js              # Enrich all pending shops
 *   node enrich-contacts.js --limit 50   # Enrich 50 shops
 *   node enrich-contacts.js --city "Seattle"  # Enrich shops in Seattle only
 *   node enrich-contacts.js --force      # Re-enrich all shops (ignore status)
 */

const { createClient } = require('@supabase/supabase-js');
const https = require('https');
const http = require('http');
const { URL } = require('url');

// Config
const SUPABASE_URL = 'https://vpnoaxpmhuknyaxcyxsu.supabase.co';
const SUPABASE_KEY = 'sb_publishable_WYLU3R98ozKXNTsZgBV1MA_MFeDE5lB';

const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

// Rate limiting
const DELAY_MS = 1500; // 1.5 seconds between requests
const TIMEOUT_MS = 10000; // 10 second timeout per request

// Regex patterns
const EMAIL_PATTERNS = [
  /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g,
];

const PHONE_PATTERNS = [
  /\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}/g,
  /\+1[-.\s]?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}/g,
];

const SOCIAL_PATTERNS = {
  facebook: /(?:https?:\/\/)?(?:www\.)?facebook\.com\/[a-zA-Z0-9.]+/gi,
  instagram: /(?:https?:\/\/)?(?:www\.)?instagram\.com\/[a-zA-Z0-9._]+/gi,
};

// Common owner/manager title patterns
const NAME_TITLE_PATTERNS = [
  /(?:owner|founded by|manager|proprietor|ceo)[:\s]+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)?)/gi,
  /([A-Z][a-z]+(?:\s+[A-Z][a-z]+)?)[,\s]+(?:owner|founder|manager|proprietor)/gi,
];

// Email blacklist (generic/spam)
const EMAIL_BLACKLIST = [
  'example.com',
  'test.com',
  'email.com',
  'domain.com',
  'yoursite.com',
  'wixpress.com',
  'sentry.io',
  'googleapis.com',
];

/**
 * Fetch a URL with timeout
 */
function fetchUrl(url, redirectCount = 0) {
  return new Promise((resolve, reject) => {
    if (redirectCount > 5) {
      reject(new Error('Too many redirects'));
      return;
    }

    const parsedUrl = new URL(url);
    const client = parsedUrl.protocol === 'https:' ? https : http;

    const req = client.get(url, {
      timeout: TIMEOUT_MS,
      headers: {
        'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
        'Accept-Language': 'en-US,en;q=0.5',
      }
    }, (res) => {
      // Handle redirects
      if (res.statusCode >= 300 && res.statusCode < 400 && res.headers.location) {
        let redirectUrl = res.headers.location;
        if (!redirectUrl.startsWith('http')) {
          redirectUrl = new URL(redirectUrl, url).href;
        }
        fetchUrl(redirectUrl, redirectCount + 1).then(resolve).catch(reject);
        return;
      }

      if (res.statusCode !== 200) {
        reject(new Error(`HTTP ${res.statusCode}`));
        return;
      }

      let data = '';
      res.on('data', chunk => data += chunk);
      res.on('end', () => resolve(data));
    });

    req.on('error', reject);
    req.on('timeout', () => {
      req.destroy();
      reject(new Error('Timeout'));
    });
  });
}

/**
 * Extract emails from HTML
 */
function extractEmails(html) {
  const emails = new Set();
  
  for (const pattern of EMAIL_PATTERNS) {
    const matches = html.match(pattern) || [];
    for (const email of matches) {
      const normalized = email.toLowerCase().trim();
      // Filter out blacklisted domains and image files
      const domain = normalized.split('@')[1];
      if (domain && 
          !EMAIL_BLACKLIST.some(b => domain.includes(b)) &&
          !normalized.match(/\.(png|jpg|jpeg|gif|svg|webp)$/i)) {
        emails.add(normalized);
      }
    }
  }
  
  // Prioritize contact-style emails
  const sorted = [...emails].sort((a, b) => {
    const priority = ['contact', 'info', 'hello', 'mail', 'coffee', 'order'];
    const aScore = priority.findIndex(p => a.startsWith(p));
    const bScore = priority.findIndex(p => b.startsWith(p));
    return (aScore === -1 ? 999 : aScore) - (bScore === -1 ? 999 : bScore);
  });
  
  return sorted;
}

/**
 * Extract phone numbers from HTML
 */
function extractPhones(html) {
  const phones = new Set();
  
  // Remove HTML tags for better matching
  const text = html.replace(/<[^>]+>/g, ' ');
  
  for (const pattern of PHONE_PATTERNS) {
    const matches = text.match(pattern) || [];
    for (const phone of matches) {
      // Normalize phone format
      const digits = phone.replace(/\D/g, '');
      if (digits.length === 10) {
        phones.add(`(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`);
      } else if (digits.length === 11 && digits.startsWith('1')) {
        phones.add(`(${digits.slice(1,4)}) ${digits.slice(4,7)}-${digits.slice(7)}`);
      }
    }
  }
  
  return [...phones];
}

/**
 * Extract social media URLs
 */
function extractSocialLinks(html) {
  const social = {
    facebook: null,
    instagram: null,
  };
  
  for (const [platform, pattern] of Object.entries(SOCIAL_PATTERNS)) {
    const matches = html.match(pattern) || [];
    if (matches.length > 0) {
      // Take the first match, normalize it
      let url = matches[0];
      if (!url.startsWith('http')) {
        url = 'https://' + url;
      }
      social[platform] = url;
    }
  }
  
  return social;
}

/**
 * Try to extract owner/manager name
 */
function extractContactName(html) {
  const text = html.replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ');
  
  for (const pattern of NAME_TITLE_PATTERNS) {
    const match = pattern.exec(text);
    if (match && match[1]) {
      const name = match[1].trim();
      // Basic validation
      if (name.length > 3 && name.length < 50 && !name.match(/\d/)) {
        return name;
      }
    }
  }
  
  return null;
}

/**
 * Classify website type
 */
function classifyWebsite(url, html) {
  if (!url || url.trim() === '') {
    return 'none';
  }
  
  const urlLower = url.toLowerCase();
  
  if (urlLower.includes('facebook.com')) {
    return 'facebook';
  }
  
  if (urlLower.includes('instagram.com')) {
    return 'instagram';
  }
  
  // Check for website builders (basic sites)
  const builders = ['wix', 'squarespace', 'weebly', 'godaddy', 'wordpress.com', 'site123', 'jimdo'];
  for (const builder of builders) {
    if (urlLower.includes(builder) || (html && html.toLowerCase().includes(builder))) {
      return 'basic';
    }
  }
  
  // Check for full/custom sites (has multiple pages, contact form, etc)
  if (html) {
    const hasContactForm = html.includes('type="email"') || html.includes('contact-form');
    const hasMultiplePages = (html.match(/href=["'][^"']*["']/g) || []).length > 10;
    const hasMenu = html.toLowerCase().includes('menu') && html.toLowerCase().includes('coffee');
    
    if (hasContactForm || (hasMultiplePages && hasMenu)) {
      return 'full';
    }
  }
  
  return 'basic';
}

/**
 * Enrich a single shop
 */
async function enrichShop(shop) {
  const result = {
    enrichment_status: 'enriched',
    enriched_at: new Date().toISOString(),
  };

  // If no website, mark as such
  if (!shop.website || shop.website.trim() === '') {
    result.website_type = 'none';
    result.enrichment_status = 'no_website';
    return result;
  }

  let url = shop.website.trim();
  
  // Ensure URL has protocol
  if (!url.startsWith('http')) {
    url = 'https://' + url;
  }

  try {
    console.log(`  Fetching: ${url}`);
    const html = await fetchUrl(url);
    
    // Extract data
    const emails = extractEmails(html);
    const phones = extractPhones(html);
    const social = extractSocialLinks(html);
    const contactName = extractContactName(html);
    const websiteType = classifyWebsite(url, html);

    // Only update fields if we found data (don't overwrite existing)
    if (emails.length > 0 && !shop.email) {
      result.email = emails[0];
    }
    
    if (phones.length > 0 && !shop.phone) {
      result.phone = phones[0];
    }
    
    if (social.facebook) {
      result.facebook_url = social.facebook;
    }
    
    if (social.instagram) {
      result.instagram_url = social.instagram;
    }
    
    if (contactName && !shop.contact_name) {
      result.contact_name = contactName;
    }
    
    result.website_type = websiteType;

    console.log(`    âœ“ Type: ${websiteType}, Email: ${result.email || 'none'}, Phone: ${result.phone || 'existing'}`);
    
  } catch (err) {
    console.log(`    âœ— Error: ${err.message}`);
    result.enrichment_status = 'failed';
    result.website_type = classifyWebsite(url, null);
  }

  return result;
}

/**
 * Main enrichment function
 */
async function main() {
  const args = process.argv.slice(2);
  
  // Parse arguments
  let limit = null;
  let city = null;
  let force = false;
  
  for (let i = 0; i < args.length; i++) {
    if (args[i] === '--limit' && args[i + 1]) {
      limit = parseInt(args[i + 1]);
      i++;
    } else if (args[i] === '--city' && args[i + 1]) {
      city = args[i + 1];
      i++;
    } else if (args[i] === '--force') {
      force = true;
    }
  }

  console.log('\nâ˜• joe CRM - Contact Enrichment\n');
  console.log('Settings:');
  console.log(`  Limit: ${limit || 'all'}`);
  console.log(`  City: ${city || 'all'}`);
  console.log(`  Force re-enrich: ${force}`);
  console.log('');

  // Build query
  let query = supabase.from('shops').select('*');
  
  if (!force) {
    query = query.or('enrichment_status.is.null,enrichment_status.eq.pending');
  }
  
  if (city) {
    query = query.ilike('city', `%${city}%`);
  }
  
  query = query.order('lead_score', { ascending: false });
  
  if (limit) {
    query = query.limit(limit);
  }

  const { data: shops, error } = await query;

  if (error) {
    console.error('Error fetching shops:', error);
    process.exit(1);
  }

  console.log(`Found ${shops.length} shops to enrich\n`);

  let enriched = 0;
  let failed = 0;
  let noWebsite = 0;

  for (let i = 0; i < shops.length; i++) {
    const shop = shops[i];
    console.log(`[${i + 1}/${shops.length}] ${shop.name}`);
    
    const updates = await enrichShop(shop);
    
    // Update in Supabase
    const { error: updateError } = await supabase
      .from('shops')
      .update(updates)
      .eq('id', shop.id);

    if (updateError) {
      console.log(`    âœ— DB Error: ${updateError.message}`);
      failed++;
    } else if (updates.enrichment_status === 'no_website') {
      noWebsite++;
    } else if (updates.enrichment_status === 'failed') {
      failed++;
    } else {
      enriched++;
    }

    // Rate limiting
    if (i < shops.length - 1) {
      await new Promise(r => setTimeout(r, DELAY_MS));
    }
  }

  console.log('\n' + '='.repeat(50));
  console.log('Summary:');
  console.log(`  âœ“ Enriched: ${enriched}`);
  console.log(`  âœ— Failed: ${failed}`);
  console.log(`  â—‹ No Website: ${noWebsite}`);
  console.log('='.repeat(50) + '\n');

  // Show opportunities
  const { data: opportunities } = await supabase
    .from('shops')
    .select('name, city, state, lead_score')
    .or('website_type.eq.none,website_type.eq.facebook')
    .order('lead_score', { ascending: false })
    .limit(10);

  if (opportunities && opportunities.length > 0) {
    console.log('ðŸŽ¯ Top Website Opportunities (no website or Facebook-only):');
    opportunities.forEach((shop, i) => {
      console.log(`  ${i + 1}. ${shop.name} (${shop.city}, ${shop.state}) - Score: ${shop.lead_score}`);
    });
    console.log('');
  }
}

main().catch(console.error);
