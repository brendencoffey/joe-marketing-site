<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Owner Dashboard | joe coffee</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', -apple-system, sans-serif; background: #FAF9F6; color: #1a1a1a; min-height: 100vh; }
    
    .header { background: #fff; border-bottom: 1px solid #e5e5e5; padding: 1rem 1.5rem; position: sticky; top: 0; z-index: 100; }
    .header-inner { max-width: 1000px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
    .logo { font-size: 1.5rem; font-weight: 700; text-decoration: none; color: #1a1a1a; }
    .user-info { display: flex; align-items: center; gap: 12px; }
    .avatar { width: 36px; height: 36px; border-radius: 50%; background: #e5e5e5; }
    .btn { padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; font-size: 14px; text-decoration: none; display: inline-block; }
    .btn-primary { background: #1a1a1a; color: #fff; }
    .btn-secondary { background: #f5f5f5; color: #1a1a1a; }
    .btn-google { background: #fff; border: 1px solid #ddd; display: flex; align-items: center; gap: 10px; }
    .btn-google:hover { background: #f9f9f9; }
    
    .container { max-width: 1000px; margin: 0 auto; padding: 2rem 1.5rem; }
    
    /* Login State */
    .login-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; text-align: center; }
    .login-container h1 { font-size: 2rem; margin-bottom: 0.5rem; }
    .login-container p { color: #666; margin-bottom: 2rem; }
    
    /* Dashboard */
    .dashboard { display: none; }
    .page-title { font-size: 1.75rem; font-weight: 700; margin-bottom: 0.5rem; }
    .page-subtitle { color: #666; margin-bottom: 2rem; }
    
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
    .stat-card { background: #fff; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .stat-card .label { font-size: 0.875rem; color: #666; margin-bottom: 0.25rem; }
    .stat-card .value { font-size: 2rem; font-weight: 700; }
    .stat-card .change { font-size: 0.75rem; color: #059669; margin-top: 0.25rem; }
    
    .card { background: #fff; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 1.5rem; }
    .card-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; }
    
    .upvote-list { display: flex; flex-direction: column; gap: 0.75rem; }
    .upvote-item { display: flex; align-items: center; gap: 12px; padding: 0.75rem; background: #f9fafb; border-radius: 8px; }
    .upvote-avatar { width: 40px; height: 40px; border-radius: 50%; background: #e5e5e5; display: flex; align-items: center; justify-content: center; font-weight: 600; }
    .upvote-info { flex: 1; }
    .upvote-name { font-weight: 500; }
    .upvote-email { font-size: 0.875rem; color: #666; }
    
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; }
    .form-group input, .form-group textarea { width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
    .form-group textarea { min-height: 100px; resize: vertical; }
    
    .empty-state { text-align: center; padding: 2rem; color: #666; }
    .amenity-tag { display:flex;align-items:center;gap:4px;font-size:13px;background:#f3f4f6;padding:6px 10px;border-radius:6px;cursor:pointer;transition:background 0.2s; }
    .amenity-tag:hover { background:#e5e7eb; }
    .amenity-tag input:checked + span, .amenity-tag:has(input:checked) { background:#dcfce7; }
    
    .upgrade-banner { background: linear-gradient(135deg, #1a1a1a, #333); color: #fff; border-radius: 12px; padding: 2rem; text-align: center; margin-top: 2rem; }
    .upgrade-banner h3 { font-size: 1.25rem; margin-bottom: 0.5rem; }
    .upgrade-banner p { opacity: 0.8; margin-bottom: 1.5rem; }
    .upgrade-banner .btn { background: #fff; color: #1a1a1a; }
    
    .no-access { text-align: center; padding: 3rem; }
    .no-access h2 { margin-bottom: 1rem; }
    .no-access p { color: #666; margin-bottom: 1.5rem; }
    
    .tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 2px solid #e5e5e5; flex-wrap: wrap; }
    .tab { padding: 0.75rem 1rem; cursor: pointer; font-weight: 500; color: #666; border-bottom: 2px solid transparent; margin-bottom: -2px; }
    .tab.active { color: #1a1a1a; border-bottom-color: #1a1a1a; }
    
    /* Photo Management Styles */
    .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; }
    .photo-card { position: relative; aspect-ratio: 1; border-radius: 10px; overflow: hidden; background: #f3f4f6; }
    .photo-card img { width: 100%; height: 100%; object-fit: cover; }
    .photo-card.hidden-photo { opacity: 0.4; }
    .photo-card.hidden-photo::after { content: 'HIDDEN'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
    .photo-card.hero-photo { box-shadow: 0 0 0 3px #f59e0b; }
    .photo-actions { position: absolute; top: 6px; right: 6px; display: flex; gap: 4px; }
    .photo-btn { width: 28px; height: 28px; border-radius: 50%; border: none; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; transition: transform 0.1s; }
    .photo-btn:hover { transform: scale(1.1); }
    .photo-btn.hero { background: #fbbf24; color: #1a1a1a; }
    .photo-btn.hero.inactive { background: rgba(255,255,255,0.9); }
    .photo-btn.delete { background: rgba(239,68,68,0.9); color: white; }
    .photo-btn.hide { background: rgba(107,114,128,0.9); color: white; }
    .photo-btn.show { background: rgba(34,197,94,0.9); color: white; }
    .photo-source { position: absolute; bottom: 6px; left: 6px; font-size: 10px; font-weight: 600; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; }
    .photo-source.google { background: #4285f4; color: white; }
    .photo-source.yelp { background: #d32323; color: white; }
    .photo-source.uploaded { background: #1a1a1a; color: white; }
    .photo-source.instagram { background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); color: white; }
    
    .upload-zone { border: 2px dashed #ddd; border-radius: 12px; padding: 2rem; text-align: center; cursor: pointer; transition: border-color 0.2s, background 0.2s; }
    .upload-zone:hover { border-color: #1a1a1a; background: #f9fafb; }
    .upload-zone.dragover { border-color: #1a1a1a; background: #f0f0f0; }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <a href="/" class="logo">joe</a>
      <div class="user-info" id="userInfo" style="display:none">
        <span id="userName"></span>
        <img id="userAvatar" class="avatar" src="" alt="">
        <button class="btn btn-secondary" onclick="signOut()">Sign Out</button>
      </div>
    </div>
  </header>

  <!-- Login State -->
  <div class="container login-container" id="loginState">
    <h1>Owner Dashboard</h1>
    <p>Manage your coffee shop listing, see analytics, and connect with customers.</p>
    <button class="btn btn-google" onclick="signInWithGoogle()">
      <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"></path><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332A8.997 8.997 0 0 0 9 18z"></path><path fill="#FBBC05" d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z"></path><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"></path></svg>
      Sign in with Google
    </button>
  </div>

  <!-- No Access State -->
  <div class="container no-access" id="noAccessState" style="display:none">
    <h2>No Shops Linked</h2>
    <p>Your account isn't linked to any coffee shops yet. If you've claimed a listing, please wait for verification.</p>
    <a href="/locations/" class="btn btn-primary">Find Your Shop</a>
  </div>

  <!-- Dashboard -->
  <div class="container dashboard" id="dashboard">
    <h1 class="page-title" id="shopName">Your Coffee Shop</h1>
    <p class="page-subtitle" id="shopAddress">123 Main St, City, ST</p>
    
    <div class="tabs">
      <div class="tab active" onclick="switchTab('analytics')">üìä Analytics</div>
      <div class="tab" onclick="switchTab('photos')">üì∏ Photos</div>
      <div class="tab" onclick="switchTab('edit')">‚úèÔ∏è Edit Listing</div>
      <div class="tab" onclick="switchTab('gbp')">üîó Google Business</div>
    </div>

    <!-- Analytics Tab -->
    <div id="tab-analytics">
      <div style="display:flex;justify-content:flex-end;margin-bottom:1rem">
        <select id="dateRange" onchange="loadAnalytics(currentShop.id)" style="padding:8px 12px;border:1px solid #ddd;border-radius:6px;font-size:14px">
          <option value="today">Today</option>
          <option value="week" selected>Last 7 Days</option>
          <option value="month">Last 30 Days</option>
          <option value="custom">Custom Range</option>
        </select>
        <div id="customDateRange" style="display:none;margin-left:8px">
          <input type="date" id="startDate" style="padding:8px;border:1px solid #ddd;border-radius:6px">
          <span style="margin:0 4px">to</span>
          <input type="date" id="endDate" style="padding:8px;border:1px solid #ddd;border-radius:6px">
          <button onclick="loadAnalytics(currentShop.id)" class="btn btn-primary" style="margin-left:8px;padding:8px 12px">Apply</button>
        </div>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="label">Page Views</div>
          <div class="value" id="statViews">0</div>
        </div>
        <div class="stat-card">
          <div class="label">Website Clicks</div>
          <div class="value" id="statWebsite">0</div>
        </div>
        <div class="stat-card">
          <div class="label">Phone Clicks</div>
          <div class="value" id="statPhone">0</div>
        </div>
        <div class="stat-card">
          <div class="label">Social Clicks</div>
          <div class="value" id="statSocial">0</div>
        </div>
        <div class="stat-card">
          <div class="label">Upvotes</div>
          <div class="value" id="statUpvotes">0</div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-title">üëã People Who Want to Order Ahead</div>
        <div class="upvote-list" id="upvoteList">
          <div class="empty-state">No upvotes yet</div>
        </div>
      </div>
    </div>

    <!-- Photos Tab (NEW) -->
    <div id="tab-photos" style="display:none">
      <div class="card">
        <div class="card-title" style="display:flex;align-items:center;justify-content:space-between">
          <span>üì∏ Manage Photos</span>
          <span style="font-size:12px;color:#666;font-weight:400" id="photoCount">0 photos</span>
        </div>
        
        <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;padding:12px;margin-bottom:1rem;font-size:14px">
          <strong>‚≠ê Hero Photo:</strong> Click the star to set your main photo that appears first on your listing.<br>
          <strong>üëÅÔ∏è Hide Photos:</strong> Can't delete Google/Yelp photos? Click the eye icon to hide them from your listing.
        </div>
        
        <!-- Photo Grid -->
        <div class="photo-grid" id="photoGrid">
          <!-- Populated by JS -->
        </div>
        
        <!-- Upload Section -->
        <div style="margin-top:1.5rem;padding-top:1.5rem;border-top:1px solid #e5e5e5">
          <h4 style="font-size:14px;font-weight:600;margin-bottom:12px">Upload New Photos</h4>
          <div class="upload-zone" id="uploadZone" onclick="document.getElementById('photoUpload').click()">
            <input type="file" id="photoUpload" accept="image/*" multiple onchange="uploadPhotos(this.files)" style="display:none">
            <div style="font-size:2rem;margin-bottom:8px">üì∑</div>
            <div style="font-weight:500;margin-bottom:4px">Click to upload or drag & drop</div>
            <div style="font-size:12px;color:#666">JPG, PNG, WebP, GIF up to 5MB each</div>
          </div>
        </div>
      </div>
      
      <!-- Hidden Photos Section -->
      <div class="card" id="hiddenPhotosCard" style="display:none">
        <div class="card-title" style="display:flex;align-items:center;justify-content:space-between">
          <span>üôà Hidden Photos</span>
          <button class="btn btn-secondary" onclick="showAllPhotos()" style="padding:6px 12px;font-size:12px">Show All</button>
        </div>
        <p style="font-size:13px;color:#666;margin-bottom:1rem">These photos won't appear on your public listing.</p>
        <div class="photo-grid" id="hiddenPhotoGrid">
          <!-- Populated by JS -->
        </div>
      </div>
    </div>

    <!-- Edit Tab -->
    <div id="tab-edit" style="display:none">
      <div class="card">
        <div class="card-title">About Your Shop</div>
        <form id="editForm">
          <div class="form-group">
            <label>About / Description</label>
            <textarea id="editAbout" placeholder="Tell customers about your shop..." rows="4"></textarea>
          </div>
          <div class="form-group">
            <label>Business Type</label>
            <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:4px" id="editBusinessType">
              <label class="amenity-tag"><input type="radio" name="businessType" value="cafe"> Cafe</label>
              <label class="amenity-tag"><input type="radio" name="businessType" value="drive_thru"> Drive-Thru</label>
              <label class="amenity-tag"><input type="radio" name="businessType" value="cafe_drive_thru"> Cafe w/ Drive-Thru</label>
              <label class="amenity-tag"><input type="radio" name="businessType" value="walk_up"> Walk-up Window</label>
              <label class="amenity-tag"><input type="radio" name="businessType" value="roaster"> Roaster</label>
              <label class="amenity-tag"><input type="radio" name="businessType" value="mobile_truck"> Mobile Truck</label>
              <label class="amenity-tag"><input type="radio" name="businessType" value="kiosk"> Kiosk</label>
            </div>
          </div>
          
          <div class="form-group">
            <label>Amenities</label>
            <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:4px" id="editAmenities">
              <label class="amenity-tag"><input type="checkbox" data-amenity="WiFi"> WiFi</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="Pickup"> Pickup</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="Curbside"> Curbside</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="Dine-In"> Dine-In</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="Delivery"> Delivery</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="Private Meeting Rooms"> Private Meeting Rooms</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="Quiet Room"> Quiet Room</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="Child Play Area"> Child Play Area</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="Outdoor Seating"> Outdoor Seating</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="Indoor Seating"> Indoor Seating</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="Drive-Thru"> Drive-Thru</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="Restroom"> Restroom</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="Parking"> Parking</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="Wheelchair Access"> Wheelchair Access</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="Pet Friendly"> Pet Friendly</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="Power Outlets"> Power Outlets</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="Laptop Friendly"> Laptop Friendly</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="Food Menu"> Food Menu</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="Pastries"> Pastries/Bakery</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="Vegan Options"> Vegan Options</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="Beer/Wine"> Beer/Wine</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="Roasts On-Site"> Roasts On-Site</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="Retail"> Retail/Merch</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="Live Music"> Live Music</label>
            </div>
          </div>
          
          <button type="submit" class="btn btn-primary" style="margin-top:1rem">Save Changes</button>
        </form>
      </div>
      
      <div class="card">
        <div class="card-title">Links & Social</div>
        <div class="form-group">
          <label>Website</label>
          <input type="url" id="editWebsite" placeholder="https://yourshop.com">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
          <div class="form-group">
            <label>Instagram</label>
            <input type="url" id="editInstagram" placeholder="https://instagram.com/yourshop">
          </div>
          <div class="form-group">
            <label>Facebook</label>
            <input type="url" id="editFacebook" placeholder="https://facebook.com/yourshop">
          </div>
          <div class="form-group">
            <label>TikTok</label>
            <input type="url" id="editTiktok" placeholder="https://tiktok.com/@yourshop">
          </div>
          <div class="form-group">
            <label>Twitter / X</label>
            <input type="url" id="editTwitter" placeholder="https://twitter.com/yourshop">
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:1rem;padding-top:1rem;border-top:1px solid #e5e5e5">
          <div class="form-group">
            <label>Google Business Page</label>
            <input type="url" id="editGoogleBusiness" placeholder="https://maps.google.com/...">
          </div>
          <div class="form-group">
            <label>Yelp Page</label>
            <input type="url" id="editYelp" placeholder="https://yelp.com/biz/...">
          </div>
        </div>
        <button type="button" class="btn btn-primary" onclick="saveLinks()" style="margin-top:1rem">Save Links</button>
      </div>
      
      <div class="card">
        <div class="card-title">Hours</div>
        <div id="hoursEditor" style="display:grid;gap:8px">
          <!-- Populated by JS -->
        </div>
        <button type="button" class="btn btn-primary" onclick="saveHours()" style="margin-top:1rem">Save Hours</button>
      </div>
    </div>

    <!-- GBP Tab -->
    <div id="tab-gbp" style="display:none">
      <div class="card" style="text-align:center;padding:3rem">
        <div style="font-size:3rem;margin-bottom:1rem">üîó</div>
        <h3 style="font-size:1.25rem;margin-bottom:0.5rem">Google Business Profile Integration</h3>
        <p style="color:#666;margin-bottom:1.5rem">Coming Soon!</p>
        <div style="background:#f9fafb;border-radius:8px;padding:1.5rem;max-width:400px;margin:0 auto;text-align:left">
          <p style="font-weight:600;margin-bottom:0.75rem">Soon you will be able to:</p>
          <ul style="color:#666;margin-left:1.25rem;line-height:1.8">
            <li>Add joe ordering link to Google Maps</li>
            <li>Sync your hours automatically</li>
            <li>Keep your listing up to date</li>
          </ul>
        </div>
        <p style="color:#999;font-size:0.875rem;margin-top:1.5rem">We are finalizing our Google Business Profile API access.<br>Check back soon!</p>
      </div>
    </div>

    <!-- Upgrade Banner - Hidden for existing partners -->
    <div class="upgrade-banner" id="upgradeBanner">
      <h3>üöÄ Ready to grow your business?</h3>
      <p>Join 500+ independent coffee shops on joe‚Äîthe complete operating system with POS, mobile ordering, loyalty, and 2.75% flat processing. One platform that runs your shop and grows demand collectively.</p>
      <a href="/for-coffee-shops/" class="btn" target="_blank">Learn About joe OS ‚Üí</a>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const SUPABASE_URL = 'https://vpnoaxpmhuknyaxcyxsu.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZwbm9heHBtaHVrbnlheGN5eHN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NjkzNTMsImV4cCI6MjA4MjQ0NTM1M30.0JVwCaY-3nUHuJk49ibifQviT0LxBSdYXMslw9WIr9M';
    
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {auth:{autoRefreshToken:false,persistSession:false,detectSessionInUrl:false}});
    
    let currentUser = null;
    let currentOwner = null;
    let currentShop = null;
    let viewsChart = null;

    // Check auth on load
    async function init() {
      // Handle OAuth callback - tokens in URL hash
      const hash = window.location.hash.substring(1);
      if (hash && hash.includes('access_token')) {
        const params = new URLSearchParams(hash);
        const access_token = params.get('access_token');
        const refresh_token = params.get('refresh_token');
        if (access_token) {
          try {
            const payload = JSON.parse(atob(access_token.split('.')[1]));
            const user = {
              id: payload.sub,
              email: payload.email,
              user_metadata: payload.user_metadata
            };
            localStorage.setItem('sb-access-token', access_token);
            localStorage.setItem('sb-refresh-token', refresh_token);
            try { await db.auth.setSession({access_token, refresh_token}); } catch(e) {}
            history.replaceState(null, '', window.location.pathname + window.location.search);
            await handleSignedIn(user);
            return;
          } catch(e) { console.error('Auth error:', e); }
        }
      }
      
      // Check localStorage for existing session
      const stored_token = localStorage.getItem('sb-access-token');
      const stored_refresh = localStorage.getItem('sb-refresh-token');
      if (stored_token && stored_refresh) {
        try {
          const payload = JSON.parse(atob(stored_token.split('.')[1]));
          if (payload.exp * 1000 > Date.now()) {
            try { await db.auth.setSession({access_token: stored_token, refresh_token: stored_refresh}); } catch(e) {}
            const user = {
              id: payload.sub,
              email: payload.email,
              user_metadata: payload.user_metadata
            };
            await handleSignedIn(user);
            return;
          } else {
            localStorage.removeItem('sb-access-token');
            localStorage.removeItem('sb-refresh-token');
          }
        } catch(e) { console.error('Session restore error:', e); }
      }
      
      // No session - show login
      showLogin();
    }

    function showLogin() {
      document.getElementById('loginState').style.display = 'flex';
      document.getElementById('noAccessState').style.display = 'none';
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('userInfo').style.display = 'none';
    }

    async function handleSignedIn(user) {
      currentUser = user;
      
      // Update header
      document.getElementById('userInfo').style.display = 'flex';
      document.getElementById('userName').textContent = user.user_metadata?.full_name || user.email;
      document.getElementById('userAvatar').src = user.user_metadata?.avatar_url || '';
      
      // Check if @joe.coffee team member
      const isJoeTeam = user.email?.endsWith('@joe.coffee');
      
      // Check for shop_id in URL (for team access)
      const urlParams = new URLSearchParams(window.location.search);
      const shopIdParam = urlParams.get('shop_id');
      
      if (isJoeTeam) {
        if (shopIdParam) {
          const { data: shop } = await db.from('shops').select('*').eq('id', shopIdParam).single();
          if (shop) { await showDashboard(shop); return; }
        }
        showJoeTeamPicker();
        return;
      }
      
      // Regular user flow
      let { data: owner } = await db.from('shop_owners').select('*').eq('email', user.email).single();
      
      if (!owner) {
        const { data: newOwner } = await db.from('shop_owners').insert({
          email: user.email,
          name: user.user_metadata?.full_name,
          google_id: user.id,
          avatar_url: user.user_metadata?.avatar_url
        }).select().single();
        owner = newOwner;
      } else {
        await db.from('shop_owners').update({ last_login_at: new Date().toISOString() }).eq('id', owner.id);
      }
      
      currentOwner = owner;
      
      const { data: access } = await db.from('shop_owner_access').select('shop_id').eq('owner_id', owner.id);
      
      if (!access || access.length === 0) {
        showNoAccess();
      } else {
        const { data: shop } = await db.from('shops').select('*').eq('id', access[0].shop_id).single();
        if (shop) { await showDashboard(shop); } else { showNoAccess(); }
      }
    }

    function showJoeTeamPicker() {
      document.getElementById('loginState').style.display = 'none';
      document.getElementById('noAccessState').style.display = 'none';
      document.getElementById('dashboard').style.display = 'none';
      
      let container = document.getElementById('teamPicker');
      if (!container) {
        container = document.createElement('div');
        container.id = 'teamPicker';
        container.className = 'container';
        document.body.appendChild(container);
      }
      container.style.display = 'block';
      container.innerHTML = `
        <div style="max-width:500px;margin:2rem auto;padding:2rem">
          <h1 style="margin-bottom:1rem">üîß joe Team Admin</h1>
          <p style="color:#666;margin-bottom:1.5rem">Search for a shop to view its owner dashboard.</p>
          <div style="display:flex;gap:8px">
            <input type="text" id="shopSearch" placeholder="Search by shop name or city..." style="flex:1;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:16px" onkeypress="if(event.key==='Enter')searchShops()">
            <button onclick="searchShops()" class="btn btn-primary">Search</button>
          </div>
          <div id="shopResults" style="margin-top:1rem"></div>
        </div>
      `;
    }
    
    async function searchShops() {
      const query = document.getElementById('shopSearch').value.trim();
      if (!query || query.length < 2) return;
      
      const { data: shops } = await db.from('shops').select('id, name, city, state_code').or(`name.ilike.%${query}%,city.ilike.%${query}%`).limit(10);
      
      const results = document.getElementById('shopResults');
      if (!shops || shops.length === 0) {
        results.innerHTML = '<p style="color:#666;padding:1rem">No shops found</p>';
        return;
      }
      
      results.innerHTML = shops.map(s => `
        <div style="padding:12px;border:1px solid #e5e5e5;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;background:#fff">
          <div>
            <div style="font-weight:600">${s.name}</div>
            <div style="font-size:14px;color:#666">${s.city || ''}, ${s.state_code || ''}</div>
          </div>
          <a href="/owner/?shop_id=${s.id}" class="btn btn-primary" style="padding:8px 16px">View</a>
        </div>
      `).join('');
    }

    function showNoAccess() {
      document.getElementById('loginState').style.display = 'none';
      document.getElementById('noAccessState').style.display = 'block';
      document.getElementById('dashboard').style.display = 'none';
      const picker = document.getElementById('teamPicker');
      if (picker) picker.style.display = 'none';
    }

    async function showDashboard(shop) {
      currentShop = shop;
      
      document.getElementById('loginState').style.display = 'none';
      document.getElementById('noAccessState').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      const picker = document.getElementById('teamPicker');
      if (picker) picker.style.display = 'none';
      
      document.getElementById('shopName').textContent = shop.name;
      document.getElementById('shopAddress').textContent = [shop.address, shop.city, shop.state].filter(Boolean).join(', ');
      
      // Hide upgrade banner for existing joe partners
      const upgradeBanner = document.getElementById('upgradeBanner');
      const isPartner = shop.is_joe_partner || shop.ordering_url || shop.partner_id;
      if (isPartner) {
        upgradeBanner.style.display = 'none';
      } else {
        upgradeBanner.style.display = 'block';
      }
      
      await loadAnalytics(shop.id);
      
      const amenities = shop.amenities || [];
      document.querySelectorAll('#editAmenities input[type="checkbox"]').forEach(cb => {
        cb.checked = amenities.includes(cb.dataset.amenity);
      });
      if (shop.business_type) {
        const radio = document.querySelector(`#editBusinessType input[value="${shop.business_type}"]`);
        if (radio) radio.checked = true;
      }

      document.getElementById('editAbout').value = shop.description || '';
      document.getElementById('editWebsite').value = shop.website || '';
      document.getElementById('editInstagram').value = shop.instagram_url || '';
      document.getElementById('editFacebook').value = shop.facebook_url || '';
      document.getElementById('editTiktok').value = shop.tiktok_url || '';
      document.getElementById('editTwitter').value = shop.twitter_url || '';
      const googleUrl = shop.google_business_url || (shop.google_place_id ? `https://www.google.com/maps/place/?q=place_id:${shop.google_place_id}` : '');
      document.getElementById('editGoogleBusiness').value = googleUrl;
      const yelpUrl = shop.yelp_url || (shop.yelp_id ? `https://www.yelp.com/biz/${shop.yelp_id}` : '');
      document.getElementById('editYelp').value = yelpUrl;
      
      populateHoursEditor(shop.hours);
      populatePhotoGrid();
      setupDragDrop();
    }

    async function loadAnalytics(shopId) {
      const range = document.getElementById('dateRange').value;
      document.getElementById('customDateRange').style.display = range === 'custom' ? 'flex' : 'none';
      
      let start, end = new Date();
      end.setHours(23, 59, 59, 999);
      
      if (range === 'today') {
        start = new Date();
        start.setHours(0, 0, 0, 0);
      } else if (range === 'week') {
        start = new Date();
        start.setDate(start.getDate() - 7);
        start.setHours(0, 0, 0, 0);
      } else if (range === 'month') {
        start = new Date();
        start.setDate(start.getDate() - 30);
        start.setHours(0, 0, 0, 0);
      } else if (range === 'custom') {
        const startInput = document.getElementById('startDate').value;
        const endInput = document.getElementById('endDate').value;
        if (!startInput || !endInput) return;
        start = new Date(startInput);
        end = new Date(endInput);
        end.setHours(23, 59, 59, 999);
      }
      
      // Page views
      const { count: viewCount } = await db.from('page_views')
        .select('*', { count: 'exact', head: true })
        .eq('shop_id', shopId)
        .gte('viewed_at', start.toISOString())
        .lte('viewed_at', end.toISOString());
      document.getElementById('statViews').textContent = viewCount || 0;
      
      // Clicks
      const { data: clicks } = await db.from('shop_clicks')
        .select('click_type')
        .eq('shop_id', shopId)
        .gte('clicked_at', start.toISOString())
        .lte('clicked_at', end.toISOString());
      
      const clickCounts = { website: 0, phone: 0, social: 0 };
      (clicks || []).forEach(c => {
        if (c.click_type === 'website') clickCounts.website++;
        else if (c.click_type === 'phone') clickCounts.phone++;
        else if (['instagram', 'facebook', 'tiktok', 'twitter'].includes(c.click_type)) clickCounts.social++;
      });
      document.getElementById('statWebsite').textContent = clickCounts.website;
      document.getElementById('statPhone').textContent = clickCounts.phone;
      document.getElementById('statSocial').textContent = clickCounts.social;
      
      // Upvotes
      const { data: upvotes, count: upvoteCount } = await db.from('shop_upvotes')
        .select('*, users(email, name)', { count: 'exact' })
        .eq('shop_id', shopId);
      document.getElementById('statUpvotes').textContent = upvoteCount || 0;
      
      const upvoteList = document.getElementById('upvoteList');
      if (upvotes && upvotes.length > 0) {
        upvoteList.innerHTML = upvotes.slice(0, 10).map(u => {
          const name = u.users?.name || u.users?.email?.split('@')[0] || 'Anonymous';
          const email = u.users?.email || '';
          const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
          return `
            <div class="upvote-item">
              <div class="upvote-avatar">${initials}</div>
              <div class="upvote-info">
                <div class="upvote-name">${name}</div>
                <div class="upvote-email">${email}</div>
              </div>
            </div>
          `;
        }).join('');
      } else {
        upvoteList.innerHTML = '<div class="empty-state">No upvotes yet. Share your listing to get started!</div>';
      }
    }

    function switchTab(tab) {
      document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('[id^="tab-"]').forEach(t => t.style.display = 'none');
      
      event.target.classList.add('active');
      document.getElementById(`tab-${tab}`).style.display = 'block';
      
      // Refresh photo grid when switching to photos tab
      if (tab === 'photos') {
        populatePhotoGrid();
      }
    }

    async function signInWithGoogle() {
      const { error } = await db.auth.signInWithOAuth({
        provider: 'google',
        options: { redirectTo: window.location.origin + window.location.pathname }
      });
      if (error) alert('Error: ' + error.message);
    }

    function signOut() {
      localStorage.removeItem('sb-access-token');
      localStorage.removeItem('sb-refresh-token');
      showLogin();
    }

    document.getElementById('editForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const businessType = document.querySelector('#editBusinessType input:checked')?.value || null;
      const amenities = [];
      document.querySelectorAll('#editAmenities input:checked').forEach(cb => {
        amenities.push(cb.dataset.amenity);
      });
      
      const updates = {
        description: document.getElementById('editAbout').value || null,
        business_type: businessType,
        amenities
      };
      
      const { error } = await db.from('shops').update(updates).eq('id', currentShop.id);
      
      if (error) {
        alert('Error saving: ' + error.message);
      } else {
        currentShop = { ...currentShop, ...updates };
        alert('Changes saved!');
      }
    });

    function populateHoursEditor(hours) {
      const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
      const names = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
      const parsed = parseHours(hours);
      
      document.getElementById('hoursEditor').innerHTML = days.map((day, i) => `
        <div style="display:grid;grid-template-columns:100px 1fr;gap:8px;align-items:center">
          <label style="font-weight:500">${names[i]}</label>
          <input type="text" id="hours-${day}" value="${parsed?.[day] || ''}" placeholder="e.g., 7:00 AM ‚Äì 5:00 PM or Closed" style="padding:8px;border:1px solid #ddd;border-radius:6px">
        </div>
      `).join('');
    }
    
    function parseHours(h) {
      if (!h) return null;
      try {
        const data = typeof h === 'string' ? JSON.parse(h) : h;
        if (data?.weekday_text && Array.isArray(data.weekday_text)) {
          const result = {};
          data.weekday_text.forEach(entry => {
            const match = entry.match(/^(\w+):\s*(.+)$/i);
            if (match) result[match[1].toLowerCase()] = match[2].trim();
          });
          return result;
        }
        return data;
      } catch { return null; }
    }
    
    async function saveLinks() {
      const updates = {
        website: document.getElementById('editWebsite').value || null,
        instagram_url: document.getElementById('editInstagram').value || null,
        facebook_url: document.getElementById('editFacebook').value || null,
        tiktok_url: document.getElementById('editTiktok').value || null,
        twitter_url: document.getElementById('editTwitter').value || null,
        google_business_url: document.getElementById('editGoogleBusiness').value || null,
        yelp_url: document.getElementById('editYelp').value || null
      };
      
      const { error } = await db.from('shops').update(updates).eq('id', currentShop.id);
      if (error) alert('Error saving: ' + error.message);
      else { alert('Links saved!'); currentShop = { ...currentShop, ...updates }; }
    }
    
    async function saveHours() {
      const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
      const hours = {};
      days.forEach(day => {
        hours[day] = document.getElementById(`hours-${day}`).value || 'Closed';
      });
      
      const { error } = await db.from('shops').update({ hours }).eq('id', currentShop.id);
      if (error) alert('Error saving: ' + error.message);
      else { alert('Hours saved!'); currentShop.hours = hours; }
    }

    // ==========================================
    // PHOTO MANAGEMENT
    // ==========================================
    
    function getAllPhotos() {
      const googlePhotos = (currentShop.photos || []).map(url => ({ url, source: 'google' }));
      const yelpPhotos = (currentShop.yelp_photos || []).map(url => ({ url, source: 'yelp' }));
      const uploadedPhotos = (currentShop.uploaded_photos || []).map(url => ({ url, source: 'uploaded' }));
      const instagramPhotos = (currentShop.instagram_photos || []).map(url => ({ url, source: 'instagram' }));
      
      // Uploaded first, then Google, then Yelp, then Instagram
      return [...uploadedPhotos, ...googlePhotos, ...yelpPhotos, ...instagramPhotos];
    }
    
    function getHiddenPhotos() {
      return currentShop.hidden_photos || [];
    }
    
    function getHeroPhoto() {
      return currentShop.cover_photo_url || currentShop.hero_photo;
    }
    
    function populatePhotoGrid() {
      const allPhotos = getAllPhotos();
      const hiddenPhotos = getHiddenPhotos();
      const heroPhoto = getHeroPhoto();
      
      // Separate visible and hidden
      const visiblePhotos = allPhotos.filter(p => !hiddenPhotos.includes(p.url));
      const hiddenPhotosList = allPhotos.filter(p => hiddenPhotos.includes(p.url));
      
      // Update count
      document.getElementById('photoCount').textContent = `${visiblePhotos.length} visible, ${hiddenPhotosList.length} hidden`;
      
      // Render visible photos
      const grid = document.getElementById('photoGrid');
      if (visiblePhotos.length === 0) {
        grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1;padding:2rem">No photos yet. Upload some photos to showcase your shop!</div>';
      } else {
        grid.innerHTML = visiblePhotos.map(photo => renderPhotoCard(photo, heroPhoto, false)).join('');
      }
      
      // Render hidden photos section
      const hiddenCard = document.getElementById('hiddenPhotosCard');
      const hiddenGrid = document.getElementById('hiddenPhotoGrid');
      
      if (hiddenPhotosList.length > 0) {
        hiddenCard.style.display = 'block';
        hiddenGrid.innerHTML = hiddenPhotosList.map(photo => renderPhotoCard(photo, heroPhoto, true)).join('');
      } else {
        hiddenCard.style.display = 'none';
      }
    }
    
    function renderPhotoCard(photo, heroPhoto, isHidden) {
      const isHero = photo.url === heroPhoto;
      const isUploaded = photo.source === 'uploaded';
      const sourceLabel = photo.source.charAt(0).toUpperCase() + photo.source.slice(1);
      
      return `
        <div class="photo-card ${isHero ? 'hero-photo' : ''} ${isHidden ? 'hidden-photo' : ''}">
          <img src="${photo.url}" alt="Shop photo" onerror="this.parentElement.style.display='none'">
          <div class="photo-actions">
            ${isUploaded ? `<button class="photo-btn delete" onclick="deletePhoto('${photo.url}')" title="Delete">‚úï</button>` : ''}
            ${isHidden 
              ? `<button class="photo-btn show" onclick="showPhoto('${photo.url}')" title="Show on listing">üëÅÔ∏è</button>`
              : `<button class="photo-btn hide" onclick="hidePhoto('${photo.url}')" title="Hide from listing">üôà</button>`
            }
            <button class="photo-btn hero ${isHero ? '' : 'inactive'}" onclick="setHeroPhoto('${photo.url}')" title="${isHero ? 'Hero photo' : 'Set as hero'}">
              ${isHero ? '‚≠ê' : '‚òÜ'}
            </button>
          </div>
          <span class="photo-source ${photo.source}">${sourceLabel}</span>
        </div>
      `;
    }
    
    async function setHeroPhoto(url) {
      const { error } = await db.from('shops').update({ 
        cover_photo_url: url,
        hero_photo: url 
      }).eq('id', currentShop.id);
      
      if (error) {
        alert('Error setting hero photo: ' + error.message);
      } else {
        currentShop.cover_photo_url = url;
        currentShop.hero_photo = url;
        populatePhotoGrid();
      }
    }
    
    async function hidePhoto(url) {
      const hiddenPhotos = [...(currentShop.hidden_photos || [])];
      if (!hiddenPhotos.includes(url)) {
        hiddenPhotos.push(url);
      }
      
      const { error } = await db.from('shops').update({ hidden_photos: hiddenPhotos }).eq('id', currentShop.id);
      
      if (error) {
        alert('Error hiding photo: ' + error.message);
      } else {
        currentShop.hidden_photos = hiddenPhotos;
        
        // If hiding the hero photo, clear it
        if (currentShop.cover_photo_url === url || currentShop.hero_photo === url) {
          await db.from('shops').update({ cover_photo_url: null, hero_photo: null }).eq('id', currentShop.id);
          currentShop.cover_photo_url = null;
          currentShop.hero_photo = null;
        }
        
        populatePhotoGrid();
      }
    }
    
    async function showPhoto(url) {
      const hiddenPhotos = (currentShop.hidden_photos || []).filter(p => p !== url);
      
      const { error } = await db.from('shops').update({ hidden_photos: hiddenPhotos }).eq('id', currentShop.id);
      
      if (error) {
        alert('Error showing photo: ' + error.message);
      } else {
        currentShop.hidden_photos = hiddenPhotos;
        populatePhotoGrid();
      }
    }
    
    async function showAllPhotos() {
      if (!confirm('Show all hidden photos on your listing?')) return;
      
      const { error } = await db.from('shops').update({ hidden_photos: [] }).eq('id', currentShop.id);
      
      if (error) {
        alert('Error: ' + error.message);
      } else {
        currentShop.hidden_photos = [];
        populatePhotoGrid();
      }
    }
    
    async function deletePhoto(url) {
      if (!confirm('Delete this photo? This cannot be undone.')) return;
      
      const uploadedPhotos = (currentShop.uploaded_photos || []).filter(p => p !== url);
      
      const { error } = await db.from('shops').update({ uploaded_photos: uploadedPhotos }).eq('id', currentShop.id);
      
      if (error) {
        alert('Error deleting photo: ' + error.message);
      } else {
        // Also delete from storage
        const filename = url.split('/shop-photos/')[1];
        if (filename) {
          await db.storage.from('shop-photos').remove([filename]);
        }
        
        currentShop.uploaded_photos = uploadedPhotos;
        
        // If deleted hero photo, reset it
        if (currentShop.cover_photo_url === url || currentShop.hero_photo === url) {
          await db.from('shops').update({ cover_photo_url: null, hero_photo: null }).eq('id', currentShop.id);
          currentShop.cover_photo_url = null;
          currentShop.hero_photo = null;
        }
        
        // Also remove from hidden if it was there
        if ((currentShop.hidden_photos || []).includes(url)) {
          const hiddenPhotos = currentShop.hidden_photos.filter(p => p !== url);
          await db.from('shops').update({ hidden_photos: hiddenPhotos }).eq('id', currentShop.id);
          currentShop.hidden_photos = hiddenPhotos;
        }
        
        populatePhotoGrid();
      }
    }
    
    async function uploadPhotos(files) {
      if (!files || files.length === 0) return;
      
      const uploadedUrls = [];
      const statusDiv = document.createElement('div');
      statusDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:2rem;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.2);z-index:1000;text-align:center';
      statusDiv.innerHTML = '<div style="font-size:2rem;margin-bottom:8px">üì§</div><div>Uploading photos...</div>';
      document.body.appendChild(statusDiv);
      
      for (const file of files) {
        // Validate file type
        const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
        if (!allowedTypes.includes(file.type)) {
          alert(`${file.name} is not a supported format. Use JPG, PNG, WebP, or GIF.`);
          continue;
        }
        
        // Validate file size (5MB)
        if (file.size > 5 * 1024 * 1024) {
          alert(`${file.name} is too large (max 5MB)`);
          continue;
        }
        
        // Generate unique filename
        const ext = file.name.split('.').pop();
        const filename = `${currentShop.id}/${Date.now()}-${Math.random().toString(36).substr(2, 9)}.${ext}`;
        
        // Upload to Supabase Storage
        const { data, error } = await db.storage
          .from('shop-photos')
          .upload(filename, file, { cacheControl: '3600', upsert: false });
        
        if (error) {
          console.error('Upload error:', error);
          alert(`Failed to upload ${file.name}: ${error.message}`);
          continue;
        }
        
        // Get public URL
        const { data: urlData } = db.storage.from('shop-photos').getPublicUrl(filename);
        uploadedUrls.push(urlData.publicUrl);
      }
      
      document.body.removeChild(statusDiv);
      
      if (uploadedUrls.length > 0) {
        // Add to shop's photos array
        const existingPhotos = currentShop.uploaded_photos || [];
        const newPhotos = [...existingPhotos, ...uploadedUrls];
        
        const { error } = await db.from('shops').update({ uploaded_photos: newPhotos }).eq('id', currentShop.id);
        
        if (error) {
          alert('Error saving photos: ' + error.message);
        } else {
          currentShop.uploaded_photos = newPhotos;
          populatePhotoGrid();
          alert(`${uploadedUrls.length} photo(s) uploaded!`);
        }
      }
      
      document.getElementById('photoUpload').value = '';
    }
    
    function setupDragDrop() {
      const zone = document.getElementById('uploadZone');
      if (!zone) return;
      
      zone.addEventListener('dragover', (e) => {
        e.preventDefault();
        zone.classList.add('dragover');
      });
      
      zone.addEventListener('dragleave', () => {
        zone.classList.remove('dragover');
      });
      
      zone.addEventListener('drop', (e) => {
        e.preventDefault();
        zone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          uploadPhotos(files);
        }
      });
    }

    init();
  </script>
</body>
</html>