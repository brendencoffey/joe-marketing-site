<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Owner Dashboard | joe coffee</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', -apple-system, sans-serif; background: #FAF9F6; color: #1a1a1a; min-height: 100vh; }
    
    .header { background: #fff; border-bottom: 1px solid #e5e5e5; padding: 1rem 1.5rem; position: sticky; top: 0; z-index: 100; }
    .header-inner { max-width: 1000px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
    .logo { font-size: 1.5rem; font-weight: 700; text-decoration: none; color: #1a1a1a; }
    .user-info { display: flex; align-items: center; gap: 12px; }
    .avatar { width: 36px; height: 36px; border-radius: 50%; background: #e5e5e5; }
    .btn { padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; font-size: 14px; text-decoration: none; display: inline-block; }
    .btn-primary { background: #1a1a1a; color: #fff; }
    .btn-secondary { background: #f5f5f5; color: #1a1a1a; }
    .btn-google { background: #fff; border: 1px solid #ddd; display: flex; align-items: center; gap: 10px; }
    .btn-google:hover { background: #f9f9f9; }
    
    .container { max-width: 1000px; margin: 0 auto; padding: 2rem 1.5rem; }
    
    /* Login State */
    .login-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; text-align: center; }
    .login-container h1 { font-size: 2rem; margin-bottom: 0.5rem; }
    .login-container p { color: #666; margin-bottom: 2rem; }
    
    /* Dashboard */
    .dashboard { display: none; }
    .page-title { font-size: 1.75rem; font-weight: 700; margin-bottom: 0.5rem; }
    .page-subtitle { color: #666; margin-bottom: 2rem; }
    
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
    .stat-card { background: #fff; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .stat-card .label { font-size: 0.875rem; color: #666; margin-bottom: 0.25rem; }
    .stat-card .value { font-size: 2rem; font-weight: 700; }
    .stat-card .change { font-size: 0.75rem; color: #059669; margin-top: 0.25rem; }
    
    .card { background: #fff; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 1.5rem; }
    .card-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; }
    
    .upvote-list { display: flex; flex-direction: column; gap: 0.75rem; }
    .upvote-item { display: flex; align-items: center; gap: 12px; padding: 0.75rem; background: #f9fafb; border-radius: 8px; }
    .upvote-avatar { width: 40px; height: 40px; border-radius: 50%; background: #e5e5e5; display: flex; align-items: center; justify-content: center; font-weight: 600; }
    .upvote-info { flex: 1; }
    .upvote-name { font-weight: 500; }
    .upvote-email { font-size: 0.875rem; color: #666; }
    
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; }
    .form-group input, .form-group textarea { width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
    .form-group textarea { min-height: 100px; resize: vertical; }
    
    .empty-state { text-align: center; padding: 2rem; color: #666; }
    .amenity-tag { display:flex;align-items:center;gap:4px;font-size:13px;background:#f3f4f6;padding:6px 10px;border-radius:6px;cursor:pointer;transition:background 0.2s; }
    .amenity-tag:hover { background:#e5e7eb; }
    .amenity-tag input:checked + span, .amenity-tag:has(input:checked) { background:#dcfce7; }
    
    .upgrade-banner { background: linear-gradient(135deg, #1a1a1a, #333); color: #fff; border-radius: 12px; padding: 2rem; text-align: center; margin-top: 2rem; }
    .upgrade-banner h3 { font-size: 1.25rem; margin-bottom: 0.5rem; }
    .upgrade-banner p { opacity: 0.8; margin-bottom: 1.5rem; }
    .upgrade-banner .btn { background: #fff; color: #1a1a1a; }
    
    .no-access { text-align: center; padding: 3rem; }
    .no-access h2 { margin-bottom: 1rem; }
    .no-access p { color: #666; margin-bottom: 1.5rem; }
    
    .tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 2px solid #e5e5e5; }
    .tab { padding: 0.75rem 1rem; cursor: pointer; font-weight: 500; color: #666; border-bottom: 2px solid transparent; margin-bottom: -2px; }
    .tab.active { color: #1a1a1a; border-bottom-color: #1a1a1a; }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <a href="/" class="logo">joe</a>
      <div class="user-info" id="userInfo" style="display:none">
        <span id="userName"></span>
        <img id="userAvatar" class="avatar" src="" alt="">
        <button class="btn btn-secondary" onclick="signOut()">Sign Out</button>
      </div>
    </div>
  </header>

  <!-- Login State -->
  <div class="container login-container" id="loginState">
    <h1>Owner Dashboard</h1>
    <p>Manage your coffee shop listing, see analytics, and connect with customers.</p>
    <button class="btn btn-google" onclick="signInWithGoogle()">
      <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"></path><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332A8.997 8.997 0 0 0 9 18z"></path><path fill="#FBBC05" d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z"></path><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"></path></svg>
      Sign in with Google
    </button>
  </div>

  <!-- No Access State -->
  <div class="container no-access" id="noAccessState" style="display:none">
    <h2>No Shops Linked</h2>
    <p>Your account isn't linked to any coffee shops yet. If you've claimed a listing, please wait for verification.</p>
    <a href="/locations/" class="btn btn-primary">Find Your Shop</a>
  </div>

  <!-- Dashboard -->
  <div class="container dashboard" id="dashboard">
    <h1 class="page-title" id="shopName">Your Coffee Shop</h1>
    <p class="page-subtitle" id="shopAddress">123 Main St, City, ST</p>
    
    <div class="tabs">
      <div class="tab active" onclick="switchTab('analytics')">üìä Analytics</div>
      <div class="tab" onclick="switchTab('edit')">‚úèÔ∏è Edit Listing</div>
    </div>

    <!-- Analytics Tab -->
    <div id="tab-analytics">
      <div style="display:flex;justify-content:flex-end;margin-bottom:1rem">
        <select id="dateRange" onchange="loadAnalytics(currentShop.id)" style="padding:8px 12px;border:1px solid #ddd;border-radius:6px;font-size:14px">
          <option value="today">Today</option>
          <option value="week" selected>Last 7 Days</option>
          <option value="month">Last 30 Days</option>
          <option value="custom">Custom Range</option>
        </select>
        <div id="customDateRange" style="display:none;margin-left:8px">
          <input type="date" id="startDate" style="padding:8px;border:1px solid #ddd;border-radius:6px">
          <span style="margin:0 4px">to</span>
          <input type="date" id="endDate" style="padding:8px;border:1px solid #ddd;border-radius:6px">
          <button onclick="loadAnalytics(currentShop.id)" class="btn btn-primary" style="margin-left:8px;padding:8px 12px">Apply</button>
        </div>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="label">Page Views</div>
          <div class="value" id="statViews">0</div>
        </div>
        <div class="stat-card">
          <div class="label">Website Clicks</div>
          <div class="value" id="statWebsite">0</div>
        </div>
        <div class="stat-card">
          <div class="label">Phone Clicks</div>
          <div class="value" id="statPhone">0</div>
        </div>
        <div class="stat-card">
          <div class="label">Social Clicks</div>
          <div class="value" id="statSocial">0</div>
        </div>
        <div class="stat-card">
          <div class="label">Upvotes</div>
          <div class="value" id="statUpvotes">0</div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-title">üëã People Who Want to Order Ahead</div>
        <div class="upvote-list" id="upvoteList">
          <div class="empty-state">No upvotes yet</div>
        </div>
      </div>
    </div>

    <!-- Edit Tab -->
    <div id="tab-edit" style="display:none">
      <div class="card">
        <div class="card-title">üì∏ Photos</div>
        
        <!-- Existing Photos from Google/Yelp -->
        <div style="margin-bottom:1rem">
          <label style="font-size:0.875rem;font-weight:500;margin-bottom:0.5rem;display:block">Current Photos</label>
          <div id="existingPhotos" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px">
            <!-- Populated by JS -->
          </div>
        </div>
        
        <!-- Upload New Photos -->
        <div style="margin-bottom:1rem">
          <label style="font-size:0.875rem;font-weight:500;margin-bottom:0.5rem;display:block">Upload Photos</label>
          <input type="file" id="photoUpload" accept="image/*" multiple onchange="uploadPhotos(this.files)">
          <p style="font-size:12px;color:#666;margin-top:4px">Add photos of your shop, drinks, food, interior</p>
        </div>
        
        <!-- Import from Instagram -->
        <div>
          <label style="font-size:0.875rem;font-weight:500;margin-bottom:0.5rem;display:block">Import from Instagram</label>
          <div style="display:flex;gap:8px">
            <input type="url" id="instagramUrl" placeholder="Paste Instagram post URL..." style="flex:1;padding:8px;border:1px solid #ddd;border-radius:6px">
            <button type="button" class="btn btn-secondary" onclick="importInstagramPhoto()">Import</button>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">About Your Shop</div>
        <form id="editForm">
          <div class="form-group">
            <label>About / Description</label>
            <textarea id="editAbout" placeholder="Tell customers about your shop..." rows="4"></textarea>
          </div>
          <div class="form-group">
            <label>Business Type</label>
            <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:4px" id="editBusinessType">
              <label class="amenity-tag"><input type="radio" name="businessType" value="cafe"> Cafe</label>
              <label class="amenity-tag"><input type="radio" name="businessType" value="drive_thru"> Drive-Thru</label>
              <label class="amenity-tag"><input type="radio" name="businessType" value="cafe_drive_thru"> Cafe w/ Drive-Thru</label>
              <label class="amenity-tag"><input type="radio" name="businessType" value="walk_up"> Walk-up Window</label>
              <label class="amenity-tag"><input type="radio" name="businessType" value="roaster"> Roaster</label>
              <label class="amenity-tag"><input type="radio" name="businessType" value="mobile_truck"> Mobile Truck</label>
              <label class="amenity-tag"><input type="radio" name="businessType" value="kiosk"> Kiosk</label>
            </div>
          </div>
          
          <div class="form-group">
            <label>Amenities</label>
            <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:4px" id="editAmenities">
              <label class="amenity-tag"><input type="checkbox" data-amenity="wifi"> WiFi</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="outdoor_seating"> Outdoor Seating</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="indoor_seating"> Indoor Seating</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="restroom"> Restroom</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="parking"> Parking</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="drive_thru"> Drive-Thru</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="wheelchair"> Wheelchair Access</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="pets_allowed"> Pet Friendly</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="power_outlets"> Power Outlets</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="laptop_friendly"> Laptop Friendly</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="good_for_groups"> Good for Groups</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="food_menu"> Food Menu</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="pastries"> Pastries/Bakery</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="vegan_options"> Vegan Options</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="alcohol"> Beer/Wine</label>
              <label class="amenity-tag"><input type="checkbox" data-amenity="roasts_onsite"> Roasts On-Site</label>
            </div>
          </div>
          
          <button type="submit" class="btn btn-primary" style="margin-top:1rem">Save Changes</button>
        </form>
      </div>
      
      <div class="card">
        <div class="card-title">Links & Social</div>
        <div class="form-group">
          <label>Website</label>
          <input type="url" id="editWebsite" placeholder="https://yourshop.com">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
          <div class="form-group">
            <label>Instagram</label>
            <input type="url" id="editInstagram" placeholder="https://instagram.com/yourshop">
          </div>
          <div class="form-group">
            <label>Facebook</label>
            <input type="url" id="editFacebook" placeholder="https://facebook.com/yourshop">
          </div>
          <div class="form-group">
            <label>TikTok</label>
            <input type="url" id="editTiktok" placeholder="https://tiktok.com/@yourshop">
          </div>
          <div class="form-group">
            <label>Twitter / X</label>
            <input type="url" id="editTwitter" placeholder="https://twitter.com/yourshop">
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:1rem;padding-top:1rem;border-top:1px solid #e5e5e5">
          <div class="form-group">
            <label>Google Business Page</label>
            <input type="url" id="editGoogleBusiness" placeholder="https://maps.google.com/...">
          </div>
          <div class="form-group">
            <label>Yelp Page</label>
            <input type="url" id="editYelp" placeholder="https://yelp.com/biz/...">
          </div>
        </div>
        <button type="button" class="btn btn-primary" onclick="saveLinks()" style="margin-top:1rem">Save Links</button>
      </div>
      
      <div class="card">
        <div class="card-title">Hours</div>
        <div id="hoursEditor" style="display:grid;gap:8px">
          <!-- Populated by JS -->
        </div>
        <button type="button" class="btn btn-primary" onclick="saveHours()" style="margin-top:1rem">Save Hours</button>
      </div>
    </div>

    <div class="upgrade-banner">
      <h3>üöÄ Ready to grow your business?</h3>
      <p>Join 500+ independent coffee shops on joe‚Äîthe complete operating system with POS, mobile ordering, loyalty, and 2.75% flat processing. One platform that runs your shop and grows demand collectively.</p>
      <a href="/for-coffee-shops/" class="btn" target="_blank">Learn About joe OS ‚Üí</a>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const SUPABASE_URL = 'https://vpnoaxpmhuknyaxcyxsu.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZwbm9heHBtaHVrbnlheGN5eHN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NjkzNTMsImV4cCI6MjA4MjQ0NTM1M30.0JVwCaY-3nUHuJk49ibifQviT0LxBSdYXMslw9WIr9M';
    
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    let currentUser = null;
    let currentOwner = null;
    let currentShop = null;
    let viewsChart = null;

    // Check auth on load
    async function init() {
      const { data: { session } } = await db.auth.getSession();
      if (session) {
        await handleSignedIn(session.user);
      }
      
      // Listen for auth changes
      db.auth.onAuthStateChange(async (event, session) => {
        if (event === 'SIGNED_IN' && session) {
          await handleSignedIn(session.user);
        } else if (event === 'SIGNED_OUT') {
          showLogin();
        }
      });
    }

    async function signInWithGoogle() {
      const { error } = await db.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: window.location.origin + '/owner/'
        }
      });
      if (error) alert('Error signing in: ' + error.message);
    }

    async function signOut() {
      await db.auth.signOut();
      showLogin();
    }

    function showLogin() {
      document.getElementById('loginState').style.display = 'flex';
      document.getElementById('noAccessState').style.display = 'none';
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('userInfo').style.display = 'none';
    }

    async function handleSignedIn(user) {
      currentUser = user;
      
      // Update header
      document.getElementById('userInfo').style.display = 'flex';
      document.getElementById('userName').textContent = user.user_metadata?.full_name || user.email;
      document.getElementById('userAvatar').src = user.user_metadata?.avatar_url || '';
      
      // Check if @joe.coffee team member
      const isJoeTeam = user.email?.endsWith('@joe.coffee');
      
      // Check for shop_id in URL (for team access)
      const urlParams = new URLSearchParams(window.location.search);
      const shopIdParam = urlParams.get('shop_id');
      
      if (isJoeTeam && shopIdParam) {
        // Team member accessing specific shop
        const { data: shop } = await db
          .from('shops')
          .select('*')
          .eq('id', shopIdParam)
          .single();
        
        if (shop) {
          await showDashboard(shop);
          return;
        }
      }
      
      // Find or create owner record
      let { data: owner } = await db
        .from('shop_owners')
        .select('*')
        .eq('email', user.email)
        .single();
      
      if (!owner) {
        // Create owner record
        const { data: newOwner } = await db
          .from('shop_owners')
          .insert({
            email: user.email,
            name: user.user_metadata?.full_name,
            google_id: user.id,
            avatar_url: user.user_metadata?.avatar_url
          })
          .select()
          .single();
        owner = newOwner;
      } else {
        // Update last login
        await db
          .from('shop_owners')
          .update({ last_login_at: new Date().toISOString() })
          .eq('id', owner.id);
      }
      
      currentOwner = owner;
      
      // Check shop access
      const { data: access } = await db
        .from('shop_owner_access')
        .select('shop_id')
        .eq('owner_id', owner.id);
      
      if (!access || access.length === 0) {
        // No shops - check if they have a verified claim by email match
        const { data: shop } = await db
          .from('shops')
          .select('*')
          .eq('verification_status', 'verified')
          .eq('contact_id', (await getContactByEmail(user.email))?.id)
          .single();
        
        if (shop) {
          // Auto-link the shop
          await db.from('shop_owner_access').insert({
            shop_id: shop.id,
            owner_id: owner.id,
            role: 'owner'
          });
          await showDashboard(shop);
        } else {
          showNoAccess();
        }
      } else {
        // Get first shop they have access to
        const { data: shop } = await db
          .from('shops')
          .select('*')
          .eq('id', access[0].shop_id)
          .single();
        
        if (shop) {
          await showDashboard(shop);
        } else {
          showNoAccess();
        }
      }
    }

    async function getContactByEmail(email) {
      const { data } = await db
        .from('contacts')
        .select('id')
        .eq('email', email)
        .single();
      return data;
    }

    function showNoAccess() {
      document.getElementById('loginState').style.display = 'none';
      document.getElementById('noAccessState').style.display = 'block';
      document.getElementById('dashboard').style.display = 'none';
    }

    async function showDashboard(shop) {
      currentShop = shop;
      
      document.getElementById('loginState').style.display = 'none';
      document.getElementById('noAccessState').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      
      // Set shop info
      document.getElementById('shopName').textContent = shop.name;
      document.getElementById('shopAddress').textContent = [shop.address, shop.city, shop.state].filter(Boolean).join(', ');
      
      // Load analytics
      await loadAnalytics(shop.id);
      
      // Populate amenities
      const amenities = shop.amenities || [];
      document.querySelectorAll('#editAmenities input[type="checkbox"]').forEach(cb => {
        cb.checked = amenities.includes(cb.dataset.amenity);
      });
      // Populate business type
      if (shop.business_type) {
        const radio = document.querySelector(`#editBusinessType input[value="${shop.business_type}"]`);
        if (radio) radio.checked = true;
      }

      // Populate edit form
      document.getElementById('editAbout').value = shop.description || '';
      document.getElementById('editWebsite').value = shop.website || '';
      document.getElementById('editInstagram').value = shop.instagram_url || '';
      document.getElementById('editFacebook').value = shop.facebook_url || '';
      // Populate additional links
      document.getElementById('editTiktok').value = shop.tiktok_url || '';
      document.getElementById('editTwitter').value = shop.twitter_url || '';
      // Construct Google Business URL from place_id if we have it
      const googleUrl = shop.google_business_url || (shop.google_place_id ? `https://www.google.com/maps/place/?q=place_id:${shop.google_place_id}` : '');
      document.getElementById('editGoogleBusiness').value = googleUrl;
      
      // Construct Yelp URL from yelp_id if we have it
      const yelpUrl = shop.yelp_url || (shop.yelp_id ? `https://www.yelp.com/biz/${shop.yelp_id}` : '');
      document.getElementById('editYelp').value = yelpUrl;
      
      // Populate hours editor
      populateHoursEditor(shop.hours);
      // Populate photos
      populatePhotos();
    }

    async function loadAnalytics(shopId) {
      // Get date range
      const range = document.getElementById('dateRange').value;
      document.getElementById('customDateRange').style.display = range === 'custom' ? 'flex' : 'none';
      
      let start, end = new Date();
      end.setHours(23, 59, 59, 999);
      
      if (range === 'today') {
        start = new Date();
        start.setHours(0, 0, 0, 0);
      } else if (range === 'week') {
        start = new Date();
        start.setDate(start.getDate() - 7);
      } else if (range === 'month') {
        start = new Date();
        start.setDate(start.getDate() - 30);
      } else if (range === 'custom') {
        const startInput = document.getElementById('startDate').value;
        const endInput = document.getElementById('endDate').value;
        if (!startInput || !endInput) return;
        start = new Date(startInput);
        end = new Date(endInput);
        end.setHours(23, 59, 59, 999);
      }
      
      // Get activity counts
      const { data: activities } = await db
        .from('website_activity')
        .select('event_type, activity_subtype, created_at')
        .eq('shop_id', shopId)
        .gte('created_at', start.toISOString())
        .lte('created_at', end.toISOString());
      
      if (!activities) return;
      
      const views = activities.filter(a => a.event_type === 'page_view').length;
      const website = activities.filter(a => a.event_type === 'click' && a.activity_subtype === 'website').length;
      const phone = activities.filter(a => a.event_type === 'click' && a.activity_subtype === 'phone').length;
      const social = activities.filter(a => a.event_type === 'click' && ['facebook', 'instagram', 'twitter', 'tiktok', 'yelp'].includes(a.activity_subtype)).length;
      const upvotes = activities.filter(a => a.event_type === 'click' && a.activity_subtype === 'upvote_button').length;
      
      document.getElementById('statViews').textContent = views.toLocaleString();
      document.getElementById('statWebsite').textContent = website.toLocaleString();
      document.getElementById('statPhone').textContent = phone.toLocaleString();
      document.getElementById('statSocial').textContent = social.toLocaleString();
      document.getElementById('statUpvotes').textContent = upvotes.toLocaleString();
      
      // Load upvotes list
      await loadUpvotes(shopId);
    }

    async function loadUpvotes(shopId) {
      const { data: upvotes } = await db
        .from('shop_upvotes')
        .select('*')
        .eq('shop_id', shopId)
        .order('created_at', { ascending: false })
        .limit(20);
      
      const list = document.getElementById('upvoteList');
      
      if (!upvotes || upvotes.length === 0) {
        list.innerHTML = '<div class="empty-state">No one has requested ordering yet. Share your listing to get more visibility!</div>';
        return;
      }
      
      list.innerHTML = upvotes.map(u => {
        const email = u.email || '';
        const blurredEmail = email.length > 3 ? email.substring(0, 3) + '‚Ä¢‚Ä¢‚Ä¢' + email.substring(email.indexOf('@')) : '‚Ä¢‚Ä¢‚Ä¢';
        return `
          <div class="upvote-item">
            <div class="upvote-avatar">${(u.name || u.email || '?')[0].toUpperCase()}</div>
            <div class="upvote-info">
              <div class="upvote-name">${u.name || 'Anonymous'}</div>
              <div class="upvote-email" style="filter:blur(0px)">${blurredEmail}</div>
            </div>
            <div style="font-size:12px;color:#666">${new Date(u.created_at).toLocaleDateString()}</div>
          </div>
        `;
      }).join('');
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      
      document.getElementById('tab-analytics').style.display = tab === 'analytics' ? 'block' : 'none';
      document.getElementById('tab-edit').style.display = tab === 'edit' ? 'block' : 'none';
    }

    document.getElementById('editForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const amenities = [];
      document.querySelectorAll('#editAmenities input[type="checkbox"]:checked').forEach(cb => {
        amenities.push(cb.dataset.amenity);
      });

      const businessType = document.querySelector('#editBusinessType input[type="radio"]:checked')?.value || null;
      const updates = {
        description: document.getElementById('editAbout').value || null,
        amenities: amenities,
        business_type: businessType
      };
      
      const { error } = await db.from('shops').update(updates).eq('id', currentShop.id);
      if (error) {
        alert('Error saving: ' + error.message);
      } else {
        alert('Changes saved!');
        currentShop = { ...currentShop, ...updates };
      }
    });

    function populateHoursEditor(hours) {
      const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
      const names = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
      const parsed = parseHours(hours);
      
      document.getElementById('hoursEditor').innerHTML = days.map((day, i) => `
        <div style="display:grid;grid-template-columns:100px 1fr;gap:8px;align-items:center">
          <label style="font-weight:500">${names[i]}</label>
          <input type="text" id="hours-${day}" value="${parsed?.[day] || ''}" placeholder="e.g., 7:00 AM ‚Äì 5:00 PM or Closed" style="padding:8px;border:1px solid #ddd;border-radius:6px">
        </div>
      `).join('');
    }
    
    function parseHours(h) {
      if (!h) return null;
      try {
        const data = typeof h === 'string' ? JSON.parse(h) : h;
        if (data?.weekday_text && Array.isArray(data.weekday_text)) {
          const result = {};
          data.weekday_text.forEach(entry => {
            const match = entry.match(/^(\w+):\s*(.+)$/i);
            if (match) result[match[1].toLowerCase()] = match[2].trim();
          });
          return result;
        }
        return data;
      } catch { return null; }
    }
    
    async function saveLinks() {
      const updates = {
        website: document.getElementById('editWebsite').value || null,
        instagram_url: document.getElementById('editInstagram').value || null,
        facebook_url: document.getElementById('editFacebook').value || null,
        tiktok_url: document.getElementById('editTiktok').value || null,
        twitter_url: document.getElementById('editTwitter').value || null,
        google_business_url: document.getElementById('editGoogleBusiness').value || null,
        yelp_url: document.getElementById('editYelp').value || null
      };
      
      const { error } = await db.from('shops').update(updates).eq('id', currentShop.id);
      if (error) alert('Error saving: ' + error.message);
      else { alert('Links saved!'); currentShop = { ...currentShop, ...updates }; }
    }
    
    async function saveHours() {
      const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
      const hours = {};
      days.forEach(day => {
        hours[day] = document.getElementById(`hours-${day}`).value || 'Closed';
      });
      
      const { error } = await db.from('shops').update({ hours }).eq('id', currentShop.id);
      if (error) alert('Error saving: ' + error.message);
      else { alert('Hours saved!'); currentShop.hours = hours; }
    }
    function populatePhotos() {
      const container = document.getElementById('existingPhotos');
      const photos = currentShop.photos || [];
      const yelpPhotos = currentShop.yelp_photos || [];
      const uploadedPhotos = currentShop.uploaded_photos || [];
      const allPhotos = [...uploadedPhotos, ...photos, ...yelpPhotos]; // Uploaded first
      const coverPhoto = currentShop.cover_photo_url || allPhotos[0];
      
      if (allPhotos.length === 0) {
        container.innerHTML = '<div class="empty-state" style="padding:1rem">No photos yet</div>';
        return;
      }
      
      container.innerHTML = allPhotos.map((url, i) => {
        const isCover = url === coverPhoto;
        const isUploaded = uploadedPhotos.includes(url);
        return `
          <div style="position:relative;aspect-ratio:1;border-radius:8px;overflow:hidden;background:#f3f4f6;${isCover ? 'box-shadow:0 0 0 2px #1a1a1a' : ''}">
            <img src="${url}" alt="Shop photo ${i+1}" style="width:100%;height:100%;object-fit:cover" onerror="this.parentElement.style.display='none'">
            <div style="position:absolute;top:4px;right:4px;display:flex;gap:4px">
              ${isUploaded ? `<button onclick="deletePhoto('${url}')" style="background:rgba(239,68,68,0.9);border:none;border-radius:50%;width:28px;height:28px;cursor:pointer;font-size:12px;color:white" title="Delete">‚úï</button>` : ''}
              <button onclick="setCoverPhoto('${url}')" style="background:${isCover ? '#fbbf24' : 'rgba(255,255,255,0.9)'};border:none;border-radius:50%;width:28px;height:28px;cursor:pointer;font-size:14px" title="${isCover ? 'Cover photo' : 'Set as cover'}">
                ${isCover ? '‚≠ê' : '‚òÜ'}
              </button>
            </div>
          </div>
        `;
      }).join('');
    }
    async function deletePhoto(url) {
      if (!confirm('Delete this photo?')) return;
      
      const uploadedPhotos = currentShop.uploaded_photos || [];
      const newPhotos = uploadedPhotos.filter(p => p !== url);
      
      // Remove from database
      const { error } = await db.from('shops').update({ uploaded_photos: newPhotos }).eq('id', currentShop.id);
      
      if (error) {
        alert('Error deleting photo: ' + error.message);
      } else {
        // Also delete from storage
        const filename = url.split('/shop-photos/')[1];
        if (filename) {
          await db.storage.from('shop-photos').remove([filename]);
        }
        
        currentShop.uploaded_photos = newPhotos;
        
        // If deleted cover photo, reset it
        if (currentShop.cover_photo_url === url) {
          currentShop.cover_photo_url = null;
          await db.from('shops').update({ cover_photo_url: null }).eq('id', currentShop.id);
        }
        
        populatePhotos();
      }
    }
    
    async function setCoverPhoto(url) {
      const { error } = await db.from('shops').update({ cover_photo_url: url }).eq('id', currentShop.id);
      if (error) {
        alert('Error setting cover photo: ' + error.message);
      } else {
        currentShop.cover_photo_url = url;
        populatePhotos();
      }
    }
    
    async function uploadPhotos(files) {
      if (!files || files.length === 0) return;
      
      const uploadBtn = document.querySelector('#photoUpload');
      uploadBtn.disabled = true;
      
      const uploadedUrls = [];
      
      for (const file of files) {
        // Validate file type
        const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
        if (!allowedTypes.includes(file.type)) {
          alert(`${file.name} is not a supported format. Use JPG, PNG, WebP, or GIF.`);
          continue;
        }
        
        // Validate file size (5MB)
        if (file.size > 5 * 1024 * 1024) {
          alert(`${file.name} is too large (max 5MB)`);
          continue;
        }
        
        // Generate unique filename
        const ext = file.name.split('.').pop();
        const filename = `${currentShop.id}/${Date.now()}-${Math.random().toString(36).substr(2, 9)}.${ext}`;
        
        // Upload to Supabase Storage
        const { data, error } = await db.storage
          .from('shop-photos')
          .upload(filename, file, { cacheControl: '3600', upsert: false });
        
        if (error) {
          console.error('Upload error:', error);
          alert(`Failed to upload ${file.name}: ${error.message}`);
          continue;
        }
        
        // Get public URL
        const { data: urlData } = db.storage.from('shop-photos').getPublicUrl(filename);
        uploadedUrls.push(urlData.publicUrl);
      }
      
      if (uploadedUrls.length > 0) {
        // Add to shop's photos array
        const existingPhotos = currentShop.uploaded_photos || [];
        const newPhotos = [...existingPhotos, ...uploadedUrls];
        
        const { error } = await db.from('shops').update({ uploaded_photos: newPhotos }).eq('id', currentShop.id);
        
        if (error) {
          alert('Error saving photos: ' + error.message);
        } else {
          currentShop.uploaded_photos = newPhotos;
          populatePhotos();
          alert(`${uploadedUrls.length} photo(s) uploaded!`);
        }
      }
      
      uploadBtn.disabled = false;
      uploadBtn.value = '';
    }

    init();
  </script>
</body>
</html>
