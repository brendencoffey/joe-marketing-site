<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="robots" content="noindex, nofollow">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Market Intelligence | joe CRM</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --joe-orange: #E85D26;
      --joe-dark: #1a1a1a;
      --joe-gray: #6b7280;
      --joe-light: #f9fafb;
      --joe-border: #e5e7eb;
      --joe-green: #10b981;
      --joe-blue: #3b82f6;
      --joe-purple: #8b5cf6;
      --joe-red: #ef4444;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--joe-light);
      color: var(--joe-dark);
      line-height: 1.5;
    }
    
    /* Header */
    .header {
      background: var(--joe-dark);
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--joe-orange);
    }
    
    .header-title {
      font-size: 1.25rem;
      font-weight: 500;
      opacity: 0.9;
    }
    
    .header-nav {
      display: flex;
      gap: 0.5rem;
    }
    
    .header-nav a {
      color: white;
      text-decoration: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      opacity: 0.7;
      font-size: 0.875rem;
      transition: all 0.2s;
    }
    
    .header-nav a:hover, .header-nav a.active {
      background: rgba(255,255,255,0.1);
      opacity: 1;
    }
    
    /* Layout */
    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 1.5rem;
    }
    
    /* KPI Cards */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .kpi-card {
      background: white;
      border-radius: 12px;
      padding: 1.25rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .kpi-label {
      font-size: 0.75rem;
      color: var(--joe-gray);
      text-transform: uppercase;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    
    .kpi-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--joe-dark);
    }
    
    .kpi-sub {
      font-size: 0.75rem;
      color: var(--joe-gray);
      margin-top: 0.25rem;
    }
    
    /* Section Tabs */
    .section-tabs {
      display: flex;
      gap: 0.25rem;
      margin-bottom: 1.5rem;
      background: white;
      padding: 0.5rem;
      border-radius: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow-x: auto;
    }
    
    .section-tab {
      padding: 0.75rem 1.25rem;
      border: none;
      background: none;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--joe-gray);
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
      white-space: nowrap;
    }
    
    .section-tab:hover {
      background: var(--joe-light);
      color: var(--joe-dark);
    }
    
    .section-tab.active {
      background: var(--joe-orange);
      color: white;
    }
    
    /* Sections */
    .section { display: none; }
    .section.active { display: block; }
    
    /* Cards */
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 1.5rem;
      overflow: hidden;
    }
    
    .card-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--joe-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .card-title {
      font-size: 1rem;
      font-weight: 600;
    }
    
    .card-body {
      padding: 1rem 1.5rem;
    }
    
    .card-badge {
      font-size: 0.75rem;
      padding: 0.25rem 0.75rem;
      border-radius: 99px;
      background: var(--joe-light);
      color: var(--joe-gray);
    }
    
    /* Grid layouts */
    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1.5rem;
    }
    
    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.5rem;
    }
    
    @media (max-width: 1024px) {
      .grid-2, .grid-3 { grid-template-columns: 1fr; }
    }
    
    /* Tables */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }
    
    .data-table th {
      text-align: left;
      padding: 0.75rem;
      background: var(--joe-light);
      font-weight: 600;
      color: var(--joe-gray);
      font-size: 0.75rem;
      text-transform: uppercase;
      border-bottom: 1px solid var(--joe-border);
    }
    
    .data-table td {
      padding: 0.75rem;
      border-bottom: 1px solid var(--joe-border);
    }
    
    .data-table tr:hover {
      background: var(--joe-light);
    }
    
    .data-table tr:last-child td {
      border-bottom: none;
    }
    
    .price-cell {
      font-weight: 600;
      font-family: 'SF Mono', Monaco, monospace;
      color: var(--joe-green);
    }
    
    .trend-up { color: var(--joe-green); }
    .trend-down { color: var(--joe-red); }
    
    /* Filter bar */
    .filter-bar {
      display: flex;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1.5rem;
      background: white;
      padding: 1rem 1.5rem;
      border-radius: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      flex-wrap: wrap;
    }
    
    .filter-bar label {
      font-weight: 600;
      font-size: 0.875rem;
    }
    
    .filter-bar select {
      padding: 0.5rem 1rem;
      border: 1px solid var(--joe-border);
      border-radius: 6px;
      font-size: 0.875rem;
      min-width: 150px;
    }
    
    /* Insight cards */
    .insight-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .insight-card {
      background: linear-gradient(135deg, var(--joe-dark) 0%, #2d2d2d 100%);
      color: white;
      border-radius: 12px;
      padding: 1.25rem;
    }
    
    .insight-card.orange {
      background: linear-gradient(135deg, var(--joe-orange) 0%, #c94d1d 100%);
    }
    
    .insight-card.blue {
      background: linear-gradient(135deg, var(--joe-blue) 0%, #2563eb 100%);
    }
    
    .insight-card.purple {
      background: linear-gradient(135deg, var(--joe-purple) 0%, #7c3aed 100%);
    }
    
    .insight-card.green {
      background: linear-gradient(135deg, var(--joe-green) 0%, #059669 100%);
    }
    
    .insight-label {
      font-size: 0.75rem;
      opacity: 0.8;
      margin-bottom: 0.5rem;
    }
    
    .insight-value {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }
    
    .insight-detail {
      font-size: 0.875rem;
      opacity: 0.8;
    }
    
    /* Heatmap */
    .heatmap {
      display: grid;
      grid-template-columns: 80px repeat(5, 1fr);
      gap: 2px;
      font-size: 0.75rem;
    }
    
    .heatmap-header {
      padding: 0.5rem 0.25rem;
      font-weight: 600;
      text-align: center;
      background: var(--joe-light);
      font-size: 0.7rem;
    }
    
    .heatmap-row-label {
      padding: 0.5rem 0.25rem;
      font-weight: 500;
      background: var(--joe-light);
      font-size: 0.75rem;
    }
    
    .heatmap-cell {
      padding: 0.5rem 0.25rem;
      text-align: center;
      font-weight: 600;
      border-radius: 4px;
    }
    
    .heat-0 { background: #fef2f2; color: #b91c1c; }
    .heat-1 { background: #fef9c3; color: #a16207; }
    .heat-2 { background: #dcfce7; color: #166534; }
    .heat-3 { background: #bbf7d0; color: #166534; }
    .heat-4 { background: #86efac; color: #166534; }
    
    /* Coming soon */
    .coming-soon {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 12px;
      padding: 3rem 2rem;
      text-align: center;
    }
    
    .coming-soon h3 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }
    
    .coming-soon p {
      opacity: 0.9;
      max-width: 500px;
      margin: 0 auto;
    }
    
    .coming-soon-stats {
      display: flex;
      justify-content: center;
      gap: 3rem;
      margin-top: 2rem;
    }
    
    .coming-soon-stat .num {
      font-size: 2rem;
      font-weight: 700;
    }
    
    .coming-soon-stat .label {
      font-size: 0.875rem;
      opacity: 0.8;
    }
    
    /* Loading */
    .loading {
      padding: 2rem;
      text-align: center;
      color: var(--joe-gray);
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <a href="/crm/" class="logo">joe</a>
      <div class="header-title">Market Intelligence</div>
    </div>
    <nav class="header-nav">
      <a href="/crm/">‚Üê Back to CRM</a>
    </nav>
  </header>
  
  <div class="container">
    <!-- KPIs -->
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-label">Total Roasters</div>
        <div class="kpi-value" id="kpi-roasters">-</div>
        <div class="kpi-sub">Tracked nationwide</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Coffee Products</div>
        <div class="kpi-value" id="kpi-products">-</div>
        <div class="kpi-sub">In database</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Avg Bag Price</div>
        <div class="kpi-value" id="kpi-price">-</div>
        <div class="kpi-sub">12oz national</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">States</div>
        <div class="kpi-value" id="kpi-states">-</div>
        <div class="kpi-sub">With data</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Scrapeable Menus</div>
        <div class="kpi-value" id="kpi-menus">5,264</div>
        <div class="kpi-sub">Square + Toast</div>
      </div>
    </div>
    
    <!-- Tabs -->
    <div class="section-tabs">
      <button class="section-tab active" data-section="roasters">ü´ò Roasters</button>
      <button class="section-tab" data-section="origins">üåç Origins</button>
      <button class="section-tab" data-section="flavors">‚ú® Flavors</button>
      <button class="section-tab" data-section="regions">üìç Regions</button>
      <button class="section-tab" data-section="tech">üíª Tech Stack</button>
      <button class="section-tab" data-section="cpi">‚òï Drink CPI</button>
    </div>
    
    <!-- ROASTERS -->
    <div id="section-roasters" class="section active">
      <div class="filter-bar">
        <label>Filter:</label>
        <select id="state-filter">
          <option value="">All States</option>
        </select>
      </div>
      
      <div class="grid-2">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Roaster Pricing by State</div>
          </div>
          <div class="card-body">
            <table class="data-table" id="roaster-pricing-table">
              <thead>
                <tr>
                  <th>State</th>
                  <th>Roasters</th>
                  <th>Products</th>
                  <th>Avg Price</th>
                  <th>Median</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <div class="card-title">Top Roasters</div>
          </div>
          <div class="card-body">
            <table class="data-table" id="top-roasters-table">
              <thead>
                <tr>
                  <th>Roaster</th>
                  <th>City</th>
                  <th>Products</th>
                  <th>Origins</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <div class="card-title">Roasters by City</div>
        </div>
        <div class="card-body">
          <table class="data-table" id="roasters-city-table">
            <thead>
              <tr>
                <th>City</th>
                <th>State</th>
                <th>Roasters</th>
                <th>Products</th>
                <th>Avg Price</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- ORIGINS -->
    <div id="section-origins" class="section">
      <div class="insight-grid">
        <div class="insight-card orange">
          <div class="insight-label">Premium Origin</div>
          <div class="insight-value">Yemen</div>
          <div class="insight-detail">$31.79 avg (Northeast)</div>
        </div>
        <div class="insight-card blue">
          <div class="insight-label">Most Popular</div>
          <div class="insight-value">Ethiopia</div>
          <div class="insight-detail">757 products nationwide</div>
        </div>
        <div class="insight-card purple">
          <div class="insight-label">Biggest Gap</div>
          <div class="insight-value">Kenya</div>
          <div class="insight-detail">Only 7 in Southeast</div>
        </div>
        <div class="insight-card green">
          <div class="insight-label">Value Origin</div>
          <div class="insight-value">Brazil</div>
          <div class="insight-detail">$16.80 in Southeast</div>
        </div>
      </div>
      
      <div class="grid-2">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Origin Pricing</div>
          </div>
          <div class="card-body">
            <table class="data-table" id="origin-pricing-table">
              <thead>
                <tr>
                  <th>Origin</th>
                  <th>Products</th>
                  <th>Roasters</th>
                  <th>Avg Price</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <div class="card-title">Origin Gaps by State</div>
          </div>
          <div class="card-body" style="overflow-x: auto;">
            <div class="heatmap" id="origin-heatmap"></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- FLAVORS -->
    <div id="section-flavors" class="section">
      <div class="insight-grid">
        <div class="insight-card orange">
          <div class="insight-label">Premium Flavor</div>
          <div class="insight-value">Bold</div>
          <div class="insight-detail">$24.87 avg (+12%)</div>
        </div>
        <div class="insight-card blue">
          <div class="insight-label">Most Common</div>
          <div class="insight-value">Chocolate</div>
          <div class="insight-detail">2,750 products</div>
        </div>
        <div class="insight-card purple">
          <div class="insight-label">Trending</div>
          <div class="insight-value">Floral</div>
          <div class="insight-detail">838 products, $24.42</div>
        </div>
        <div class="insight-card green">
          <div class="insight-label">Value Flavor</div>
          <div class="insight-value">Vanilla</div>
          <div class="insight-detail">$21.05 (-5%)</div>
        </div>
      </div>
      
      <div class="grid-2">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Flavor Trends</div>
          </div>
          <div class="card-body">
            <table class="data-table" id="flavor-trends-table">
              <thead>
                <tr>
                  <th>Flavor</th>
                  <th>Products</th>
                  <th>Roasters</th>
                  <th>Avg Price</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <div class="card-title">Flavor Premium Analysis</div>
          </div>
          <div class="card-body">
            <table class="data-table" id="flavor-premium-table">
              <thead>
                <tr>
                  <th>Flavor</th>
                  <th>Avg Price</th>
                  <th>vs Avg</th>
                  <th>Premium</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <!-- REGIONS -->
    <div id="section-regions" class="section">
      <div class="insight-grid">
        <div class="insight-card orange">
          <div class="insight-label">Highest Prices</div>
          <div class="insight-value">South Central</div>
          <div class="insight-detail">Colombia $29.31</div>
        </div>
        <div class="insight-card blue">
          <div class="insight-label">Most Diverse</div>
          <div class="insight-value">West</div>
          <div class="insight-detail">18 origins tracked</div>
        </div>
        <div class="insight-card purple">
          <div class="insight-label">Premium Market</div>
          <div class="insight-value">Northeast</div>
          <div class="insight-detail">Yemen $31.79</div>
        </div>
        <div class="insight-card green">
          <div class="insight-label">Value Market</div>
          <div class="insight-value">Midwest</div>
          <div class="insight-detail">Java $15.18</div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <div class="card-title">Top Origins by Region (Highest Priced)</div>
        </div>
        <div class="card-body">
          <table class="data-table" id="region-table">
            <thead>
              <tr>
                <th>Region</th>
                <th>Origin</th>
                <th>Products</th>
                <th>Avg Price</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- TECH STACK -->
    <div id="section-tech" class="section">
      <div class="insight-grid">
        <div class="insight-card orange">
          <div class="insight-label">Square</div>
          <div class="insight-value">3,147</div>
          <div class="insight-detail">Online ordering</div>
        </div>
        <div class="insight-card blue">
          <div class="insight-label">Toast</div>
          <div class="insight-value">2,911</div>
          <div class="insight-detail">Restaurant POS</div>
        </div>
        <div class="insight-card purple">
          <div class="insight-label">Shopify (Roasters)</div>
          <div class="insight-value">3,174</div>
          <div class="insight-detail">E-commerce</div>
        </div>
        <div class="insight-card">
          <div class="insight-label">No Online Ordering</div>
          <div class="insight-value">48,211</div>
          <div class="insight-detail">Opportunity!</div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <div class="card-title">Tech Stack by State</div>
        </div>
        <div class="card-body">
          <table class="data-table" id="tech-table">
            <thead>
              <tr>
                <th>State</th>
                <th>Platform</th>
                <th>Shops</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- DRINK CPI -->
    <div id="section-cpi" class="section">
      <div class="coming-soon">
        <h3>‚òï Coffee Price Index - Coming Soon</h3>
        <p>We're building a Drink Price Index by scraping 5,264+ Square & Toast menus to track latte, cold brew, and modifier pricing across America.</p>
        <div class="coming-soon-stats">
          <div class="coming-soon-stat">
            <div class="num">5,264</div>
            <div class="label">Menus to Scrape</div>
          </div>
          <div class="coming-soon-stat">
            <div class="num">16</div>
            <div class="label">Drink Types</div>
          </div>
          <div class="coming-soon-stat">
            <div class="num">50</div>
            <div class="label">States</div>
          </div>
        </div>
      </div>
      
      <div style="margin-top: 1.5rem; opacity: 0.5;">
        <div class="grid-2">
          <div class="card">
            <div class="card-header">
              <div class="card-title">Hot Latte (16oz) by City</div>
            </div>
            <div class="card-body">
              <p class="loading">Data collection in progress...</p>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <div class="card-title">Modifier Upcharges</div>
            </div>
            <div class="card-body">
              <p class="loading">Data collection in progress...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    const SUPABASE_URL = 'https://vpnoaxpmhuknyaxcyxsu.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZwbm9heHBtaHVrbnlheGN5eHN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NjkzNTMsImV4cCI6MjA4MjQ0NTM1M30.0JVwCaY-3nUHuJk49ibifQviT0LxBSdYXMslw9WIr9M';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
      auth: { autoRefreshToken: false, persistSession: false, detectSessionInUrl: false }
    });
    
    // Tab switching
    document.querySelectorAll('.section-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.section-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`section-${tab.dataset.section}`).classList.add('active');
      });
    });
    
    const formatPrice = (p) => p ? '$' + parseFloat(p).toFixed(2) : '-';
    
    async function loadAll() {
      // Market summary
      const { data: summary } = await supabase.from('market_summary').select('*').single();
      if (summary) {
        document.getElementById('kpi-roasters').textContent = summary.total_roasters?.toLocaleString() || '-';
        document.getElementById('kpi-products').textContent = summary.total_coffee_products?.toLocaleString() || '-';
        document.getElementById('kpi-price').textContent = formatPrice(summary.national_avg_bag_price);
        document.getElementById('kpi-states').textContent = summary.states_covered || '-';
      }
      
      // Roaster pricing by state
      const { data: roasterPricing } = await supabase.from('roaster_pricing_by_state').select('*').limit(15);
      if (roasterPricing) {
        const tbody = document.querySelector('#roaster-pricing-table tbody');
        tbody.innerHTML = roasterPricing.map(r => `
          <tr>
            <td><strong>${r.state}</strong></td>
            <td>${r.roaster_count}</td>
            <td>${r.product_count}</td>
            <td class="price-cell">${formatPrice(r.avg_bag_price)}</td>
            <td class="price-cell">${formatPrice(r.median_bag_price)}</td>
          </tr>
        `).join('');
        
        // Populate state filter
        const select = document.getElementById('state-filter');
        roasterPricing.forEach(r => {
          const opt = document.createElement('option');
          opt.value = r.state;
          opt.textContent = r.state;
          select.appendChild(opt);
        });
      }
      
      // Top roasters
      const { data: topRoasters } = await supabase.from('roaster_product_diversity').select('*').order('total_products', { ascending: false }).limit(12);
      if (topRoasters) {
        const tbody = document.querySelector('#top-roasters-table tbody');
        tbody.innerHTML = topRoasters.map(r => `
          <tr>
            <td><strong>${r.roaster_name}</strong></td>
            <td>${r.city}, ${r.state}</td>
            <td>${r.total_products}</td>
            <td>${r.origin_count}</td>
          </tr>
        `).join('');
      }
      
      // Roasters by city
      const { data: roastersCities } = await supabase.from('roasters_by_city').select('*').limit(12);
      if (roastersCities) {
        const tbody = document.querySelector('#roasters-city-table tbody');
        tbody.innerHTML = roastersCities.map(r => `
          <tr>
            <td><strong>${r.city}</strong></td>
            <td>${r.state}</td>
            <td>${r.roaster_count}</td>
            <td>${r.product_count}</td>
            <td class="price-cell">${formatPrice(r.avg_bag_price)}</td>
          </tr>
        `).join('');
      }
      
      // Origin pricing
      const { data: originPricing } = await supabase.from('origin_pricing').select('*').limit(15);
      if (originPricing) {
        const tbody = document.querySelector('#origin-pricing-table tbody');
        tbody.innerHTML = originPricing.map(r => `
          <tr>
            <td><strong>${r.origin}</strong></td>
            <td>${r.products}</td>
            <td>${r.roasters}</td>
            <td class="price-cell">${formatPrice(r.avg_price)}</td>
          </tr>
        `).join('');
      }
      
      // Origin heatmap
      const { data: originGaps } = await supabase.from('origin_gaps_by_state').select('*').limit(12);
      if (originGaps) {
        const heatmap = document.getElementById('origin-heatmap');
        const getHeat = (v, m) => {
          if (v === 0) return 'heat-0';
          const p = v / m;
          if (p < 0.15) return 'heat-1';
          if (p < 0.35) return 'heat-2';
          if (p < 0.6) return 'heat-3';
          return 'heat-4';
        };
        
        let html = `
          <div class="heatmap-header">State</div>
          <div class="heatmap-header">ETH</div>
          <div class="heatmap-header">COL</div>
          <div class="heatmap-header">KEN</div>
          <div class="heatmap-header">GUA</div>
          <div class="heatmap-header">BRA</div>
        `;
        
        originGaps.forEach(r => {
          const max = Math.max(r.ethiopia, r.colombia, r.kenya, r.guatemala, r.brazil, 1);
          html += `
            <div class="heatmap-row-label">${r.state}</div>
            <div class="heatmap-cell ${getHeat(r.ethiopia, max)}">${r.ethiopia}</div>
            <div class="heatmap-cell ${getHeat(r.colombia, max)}">${r.colombia}</div>
            <div class="heatmap-cell ${getHeat(r.kenya, max)}">${r.kenya}</div>
            <div class="heatmap-cell ${getHeat(r.guatemala, max)}">${r.guatemala}</div>
            <div class="heatmap-cell ${getHeat(r.brazil, max)}">${r.brazil}</div>
          `;
        });
        
        heatmap.innerHTML = html;
      }
      
      // Flavor trends
      const { data: flavorTrends } = await supabase.from('flavor_trends').select('*').limit(12);
      if (flavorTrends) {
        const tbody = document.querySelector('#flavor-trends-table tbody');
        tbody.innerHTML = flavorTrends.map(r => `
          <tr>
            <td><strong>${r.flavor}</strong></td>
            <td>${r.occurrences.toLocaleString()}</td>
            <td>${r.roaster_count}</td>
            <td class="price-cell">${formatPrice(r.avg_price)}</td>
          </tr>
        `).join('');
      }
      
      // Flavor premium
      const { data: flavorPremium } = await supabase.from('flavor_premium').select('*').order('premium_pct', { ascending: false }).limit(12);
      if (flavorPremium) {
        const tbody = document.querySelector('#flavor-premium-table tbody');
        tbody.innerHTML = flavorPremium.map(r => `
          <tr>
            <td><strong>${r.flavor}</strong></td>
            <td class="price-cell">${formatPrice(r.avg_price)}</td>
            <td class="${r.premium_vs_avg >= 0 ? 'trend-up' : 'trend-down'}">${r.premium_vs_avg >= 0 ? '+' : ''}${formatPrice(r.premium_vs_avg)}</td>
            <td class="${r.premium_pct >= 0 ? 'trend-up' : 'trend-down'}">${r.premium_pct >= 0 ? '+' : ''}${r.premium_pct}%</td>
          </tr>
        `).join('');
      }
      
      // Region data (from provided data)
      const regionData = [
        { region: 'South Central', origin: 'Brazil', products: 16, price: '$38.00' },
        { region: 'West', origin: 'Java', products: 23, price: '$33.01' },
        { region: 'Northeast', origin: 'Yemen', products: 33, price: '$31.79' },
        { region: 'South Central', origin: 'Colombia', products: 49, price: '$29.31' },
        { region: 'West', origin: 'Panama', products: 48, price: '$28.85' },
        { region: 'West', origin: 'Kona', products: 42, price: '$28.65' },
        { region: 'West', origin: 'Indonesia', products: 15, price: '$28.83' },
        { region: 'Northeast', origin: 'Colombia', products: 156, price: '$26.61' },
        { region: 'Midwest', origin: 'Sumatra', products: 15, price: '$26.41' },
        { region: 'West', origin: 'Hawaiian', products: 28, price: '$26.33' },
      ];
      
      const regionTbody = document.querySelector('#region-table tbody');
      regionTbody.innerHTML = regionData.map(r => `
        <tr>
          <td><strong>${r.region}</strong></td>
          <td>${r.origin}</td>
          <td>${r.products}</td>
          <td class="price-cell">${r.price}</td>
        </tr>
      `).join('');
      
      // Tech stack
      const { data: techStack } = await supabase.from('tech_stack_by_state').select('*').order('shops', { ascending: false }).limit(20);
      if (techStack) {
        const tbody = document.querySelector('#tech-table tbody');
        tbody.innerHTML = techStack.map(r => `
          <tr>
            <td><strong>${r.state}</strong></td>
            <td>${r.platform}</td>
            <td>${r.shops}</td>
          </tr>
        `).join('');
      }
    }
    
    loadAll();
  </script>
</body>
</html>