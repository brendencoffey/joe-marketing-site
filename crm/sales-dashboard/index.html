<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sales Dashboard | joe CRM</title>
  <link rel="icon" type="image/png" href="/images/joe-favicon.png">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root { --joe-orange: #E07A5F; --joe-cream: #F5F1E8; --joe-dark: #2D2D2D; --joe-green: #4CAF50; --joe-blue: #3b82f6; --joe-gray: #6b7280; --joe-light: #e5e7eb; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f9fafb; color: var(--joe-dark); }
    .header { background: white; border-bottom: 1px solid var(--joe-light); padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { font-size: 24px; display: flex; align-items: center; gap: 12px; }
    .header h1 img { height: 32px; }
    .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 14px; font-weight: 500; }
    .btn-secondary { background: #f3f4f6; color: var(--joe-dark); }
    .btn-primary { background: var(--joe-orange); color: white; }
    .filters { background: white; padding: 16px 24px; border-bottom: 1px solid var(--joe-light); display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
    .filter-group { display: flex; flex-direction: column; gap: 4px; }
    .filter-group label { font-size: 11px; font-weight: 600; color: var(--joe-gray); text-transform: uppercase; }
    .filter-group select, .filter-group input { padding: 8px 12px; border: 1px solid var(--joe-light); border-radius: 6px; font-size: 14px; }
    .main { padding: 24px; max-width: 1400px; margin: 0 auto; }
    .metrics-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 16px; margin-bottom: 24px; }
    .metric-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .metric-card.highlight { background: linear-gradient(135deg, var(--joe-orange), #d4694f); color: white; }
    .metric-card.green { background: linear-gradient(135deg, var(--joe-green), #3d9140); color: white; }
    .metric-label { font-size: 12px; color: var(--joe-gray); text-transform: uppercase; font-weight: 600; margin-bottom: 8px; }
    .metric-card.highlight .metric-label, .metric-card.green .metric-label { color: rgba(255,255,255,0.8); }
    .metric-value { font-size: 36px; font-weight: 700; }
    .metric-sub { font-size: 11px; margin-top: 4px; opacity: 0.7; }
    .funnel-section { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .section-header h2 { font-size: 18px; }
    .funnel { display: flex; gap: 4px; align-items: stretch; }
    .funnel-stage { flex: 1; text-align: center; padding: 16px 8px; background: #f3f4f6; position: relative; }
    .funnel-stage:first-child { border-radius: 8px 0 0 8px; }
    .funnel-stage:last-child { border-radius: 0 8px 8px 0; }
    .funnel-stage::after { content: '‚Üí'; position: absolute; right: -10px; top: 50%; transform: translateY(-50%); color: var(--joe-gray); z-index: 1; font-size: 14px; }
    .funnel-stage:last-child::after { display: none; }
    .funnel-stage.claim { background: #e0e7ff; }
    .funnel-stage.sales { background: #fef3c7; }
    .funnel-stage.onboarding { background: #d1fae5; }
    .funnel-stage.live { background: var(--joe-green); color: white; }
    .funnel-count { font-size: 28px; font-weight: 700; }
    .funnel-label { font-size: 11px; margin-top: 4px; opacity: 0.8; }
    .funnel-rate { font-size: 10px; margin-top: 6px; padding-top: 6px; border-top: 1px solid rgba(0,0,0,0.1); }
    .pipeline-section { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px; }
    .pipeline-row { display: flex; gap: 24px; }
    .pipeline-card { flex: 1; padding: 16px; border-radius: 8px; background: #f9fafb; border: 1px solid var(--joe-light); }
    .pipeline-card h3 { font-size: 14px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .stage-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; font-size: 13px; }
    .stage-count { font-weight: 600; }
    .icp-section { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px; }
    .icp-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    .icp-card { padding: 16px; border-radius: 8px; background: #f9fafb; border: 1px solid var(--joe-light); }
    .icp-card.high { border-left: 4px solid var(--joe-green); }
    .icp-card.medium { border-left: 4px solid #f59e0b; }
    .icp-card.low { border-left: 4px solid var(--joe-gray); }
    .icp-name { font-size: 13px; font-weight: 600; margin-bottom: 8px; }
    .icp-stats { display: flex; gap: 12px; }
    .icp-stat { text-align: center; }
    .icp-stat-value { font-size: 18px; font-weight: 700; }
    .icp-stat-label { font-size: 10px; color: var(--joe-gray); }
    .two-col { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; }
    .activity-section { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .activity-item { display: flex; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--joe-light); }
    .activity-item:last-child { border-bottom: none; }
    .activity-icon { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; }
    .activity-icon.claim { background: #e0e7ff; }
    .activity-icon.meeting { background: #fef3c7; }
    .activity-icon.launch { background: #d1fae5; }
    .activity-content { flex: 1; }
    .activity-title { font-weight: 500; font-size: 13px; }
    .activity-meta { font-size: 11px; color: var(--joe-gray); }
    .activity-time { font-size: 10px; color: var(--joe-gray); }
    .loading { text-align: center; padding: 40px; color: var(--joe-gray); }
    @media (max-width: 1200px) { .metrics-grid { grid-template-columns: repeat(3, 1fr); } .icp-grid { grid-template-columns: repeat(2, 1fr); } .two-col { grid-template-columns: 1fr; } .pipeline-row { flex-direction: column; } }
  </style>
</head>
<body>
  <div class="header">
    <h1><img src="/images/logo.png" alt="joe"> Sales Dashboard</h1>
    <div style="display:flex;gap:12px">
      <button class="btn btn-secondary" onclick="window.location.href='/crm/'">‚Üê Back to CRM</button>
    </div>
  </div>
  <div class="filters">
    <div class="filter-group"><label>Period</label><select id="period-filter" onchange="updateDashboard()"><option value="week">This Week</option><option value="month" selected>This Month</option><option value="quarter">This Quarter</option><option value="year">This Year</option><option value="all">All Time</option></select></div>
    <div class="filter-group"><label>ICP Tier</label><select id="icp-filter" onchange="updateDashboard()"><option value="">All ICPs</option><option value="icp_1">üéØ ICP-1: Single Cafe</option><option value="icp_2">üéØ ICP-2: Cafe + Roaster</option><option value="icp_3">ICP-3: Small Roaster</option><option value="icp_4">ICP-4: Large Roaster</option><option value="icp_5">ICP-5: Multi-loc Cafe</option><option value="icp_6">ICP-6: Drive-Thru</option><option value="icp_7">ICP-7: Franchise</option><option value="icp_8">ICP-8: Mobile/Kiosk</option></select></div>
    <div class="filter-group"><label>Region</label><select id="region-filter" onchange="updateDashboard()"><option value="">All Regions</option><option value="east">East Coast</option><option value="midwest">Midwest</option><option value="west">West Coast</option></select></div>
    <div class="filter-group"><label>Assigned To</label><select id="owner-filter" onchange="updateDashboard()"><option value="">Everyone</option></select></div>
  </div>
  <div class="main">
    <div class="metrics-grid">
      <div class="metric-card"><div class="metric-label">üìã Claims</div><div class="metric-value" id="metric-claims">-</div><div class="metric-sub">Claim listing submissions</div></div>
      <div class="metric-card"><div class="metric-label">‚úÖ Verified</div><div class="metric-value" id="metric-verified">-</div><div class="metric-sub">Ownership verified</div></div>
      <div class="metric-card highlight"><div class="metric-label">üìÖ Demos</div><div class="metric-value" id="metric-demos">-</div><div class="metric-sub">Demo meetings</div></div>
      <div class="metric-card"><div class="metric-label">üéØ Ready Now</div><div class="metric-value" id="metric-ready">-</div><div class="metric-sub">Ready to onboard</div></div>
      <div class="metric-card"><div class="metric-label">üöÄ Onboarding</div><div class="metric-value" id="metric-onboarding">-</div><div class="metric-sub">In onboarding</div></div>
      <div class="metric-card green"><div class="metric-label">üéâ Launched</div><div class="metric-value" id="metric-launched">-</div><div class="metric-sub">Live partners</div></div>
    </div>
    
    <div class="funnel-section">
      <div class="section-header"><h2>üìä Full Funnel</h2><span id="funnel-period" style="font-size:13px;color:var(--joe-gray)">This Month</span></div>
      <div class="funnel">
        <div class="funnel-stage claim"><div class="funnel-count" id="f-claims">-</div><div class="funnel-label">Claims</div><div class="funnel-rate">100%</div></div>
        <div class="funnel-stage claim"><div class="funnel-count" id="f-verified">-</div><div class="funnel-label">Verified</div><div class="funnel-rate" id="f-verified-rate">-</div></div>
        <div class="funnel-stage sales"><div class="funnel-count" id="f-qualified">-</div><div class="funnel-label">Qualified</div><div class="funnel-rate" id="f-qualified-rate">-</div></div>
        <div class="funnel-stage sales"><div class="funnel-count" id="f-demo">-</div><div class="funnel-label">Demo</div><div class="funnel-rate" id="f-demo-rate">-</div></div>
        <div class="funnel-stage sales"><div class="funnel-count" id="f-ready">-</div><div class="funnel-label">Ready Now</div><div class="funnel-rate" id="f-ready-rate">-</div></div>
        <div class="funnel-stage onboarding"><div class="funnel-count" id="f-onboarding">-</div><div class="funnel-label">Onboarding</div><div class="funnel-rate" id="f-onboarding-rate">-</div></div>
        <div class="funnel-stage live"><div class="funnel-count" id="f-live">-</div><div class="funnel-label">Live</div><div class="funnel-rate" id="f-live-rate">-</div></div>
      </div>
    </div>

    <div class="pipeline-section">
      <div class="section-header"><h2>üìÅ Pipeline Breakdown</h2></div>
      <div class="pipeline-row">
        <div class="pipeline-card"><h3>üìã Claim Listing</h3><div id="claim-stages"></div></div>
        <div class="pipeline-card"><h3>üí∞ Sales</h3><div id="sales-stages"></div></div>
        <div class="pipeline-card"><h3>üöÄ Onboarding</h3><div id="onboarding-stages"></div></div>
        <div class="pipeline-card"><h3>‚≠ê Success</h3><div id="success-stages"></div></div>
      </div>
    </div>
    
    <div class="two-col">
      <div class="icp-section"><div class="section-header"><h2>üéØ Performance by ICP</h2></div><div class="icp-grid" id="icp-breakdown"><div class="loading">Loading...</div></div></div>
      <div class="activity-section"><div class="section-header"><h2>‚ö° Recent Activity</h2></div><div id="activity-list"><div class="loading">Loading...</div></div></div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const db=supabase.createClient('https://vpnoaxpmhuknyaxcyxsu.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZwbm9heHBtaHVrbnlheGN5eHN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjMwNjE3NDAsImV4cCI6MjAzODYzNzc0MH0.P2GVKAK6e3j3TL7KS_Oofv_q-5lQuPWBVE2923P32ww');
    
    const ICP_LABELS={'icp_1':'ICP-1: Single Cafe','icp_2':'ICP-2: Cafe + Roaster','icp_3':'ICP-3: Small Roaster','icp_4':'ICP-4: Large Roaster','icp_5':'ICP-5: Multi-loc Cafe','icp_6':'ICP-6: Drive-Thru','icp_7':'ICP-7: Franchise','icp_8':'ICP-8: Mobile/Kiosk','not_a_fit':'Not a Fit'};
    const ICP_PRIORITY={'icp_1':'high','icp_2':'high','icp_3':'medium','icp_4':'medium','icp_5':'medium','icp_6':'medium','icp_7':'low','icp_8':'low','not_a_fit':'low'};
    const TERRITORIES={east:['CT','DE','FL','GA','MA','MD','ME','NC','NH','NJ','NY','PA','RI','SC','VA','VT','WV','DC'],midwest:['AL','AR','IA','IL','IN','KS','KY','LA','MI','MN','MO','MS','ND','NE','OH','OK','SD','TN','TX','WI'],west:['AK','AZ','CA','CO','HI','ID','MT','NM','NV','OR','UT','WA','WY']};
    
    const CLAIM_STAGES=['Unverified','New Request','Under Review','Verified','To Sales','Declined','Not a Fit'];
    const SALES_STAGES=['New','Contacted','Qualified','Demo','Proposal','Ready Now','More Time','Not a Fit','Lost'];
    const ONBOARDING_STAGES=['Kickoff','Menu Setup','Hardware','Training','Pre-Launch','Live','Failed Launch'];
    const SUCCESS_STAGES=['Active - Basic','Active - Enhanced','Active - Joe POS','Active - Premium','Active - Full OS','At Risk','30-Day','60-Day','90-Day','Churned'];
    
    let deals=[],shops=[],bookings=[],pipelines=[],pipelineStages=[],teamMembers=[];
    
    async function init(){
      const[dealsRes,shopsRes,bookingsRes,pipelinesRes,stagesRes,teamRes]=await Promise.all([
        db.from('deals').select('*').order('created_at',{ascending:false}),
        db.from('shops').select('id,name,icp_tier,state_code,is_joe_partner'),
        db.from('bookings').select('*').order('created_at',{ascending:false}),
        db.from('pipelines').select('*'),
        db.from('pipeline_stages').select('*'),
        db.from('team_members').select('id,name,email')
      ]);
      deals=dealsRes.data||[];shops=shopsRes.data||[];bookings=bookingsRes.data||[];pipelines=pipelinesRes.data||[];pipelineStages=stagesRes.data||[];teamMembers=teamRes.data||[];
      
      // Populate owner filter
      document.getElementById('owner-filter').innerHTML='<option value="">Everyone</option>'+teamMembers.map(t=>'<option value="'+t.email+'">'+(t.name||t.email)+'</option>').join('');
      
      updateDashboard();
    }
    
    function getDateRange(){
      const period=document.getElementById('period-filter').value;
      const now=new Date();let start=null;
      if(period==='week'){start=new Date(now);start.setDate(now.getDate()-now.getDay());start.setHours(0,0,0,0);}
      else if(period==='month'){start=new Date(now.getFullYear(),now.getMonth(),1);}
      else if(period==='quarter'){const q=Math.floor(now.getMonth()/3);start=new Date(now.getFullYear(),q*3,1);}
      else if(period==='year'){start=new Date(now.getFullYear(),0,1);}
      else if(period==='all'){start=new Date(2020,0,1);}
      return{start,end:now};
    }
    
    function getPipelineId(name){
      const p=pipelines.find(x=>x.name.toLowerCase()===name.toLowerCase());
      return p?.id;
    }
    
    function updateDashboard(){
      const{start,end}=getDateRange();
      const icpFilter=document.getElementById('icp-filter').value;
      const regionFilter=document.getElementById('region-filter').value;
      const ownerFilter=document.getElementById('owner-filter').value;
      
      const periodLabels={week:'This Week',month:'This Month',quarter:'This Quarter',year:'This Year',all:'All Time'};
      document.getElementById('funnel-period').textContent=periodLabels[document.getElementById('period-filter').value];
      
      // Filter deals
      let fd=deals.filter(d=>{
        const created=new Date(d.created_at);
        if(created<start||created>end)return false;
        if(ownerFilter&&d.assigned_to!==ownerFilter)return false;
        return true;
      });
      
      // ICP filter
      if(icpFilter){
        const icpIds=new Set(shops.filter(s=>s.icp_tier===icpFilter).map(s=>s.id));
        fd=fd.filter(d=>icpIds.has(d.shop_id));
      }
      
      // Region filter
      if(regionFilter){
        const states=TERRITORIES[regionFilter]||[];
        const regionIds=new Set(shops.filter(s=>states.includes(s.state_code)).map(s=>s.id));
        fd=fd.filter(d=>regionIds.has(d.shop_id));
      }
      
      // Get pipeline IDs
      const claimPipelineId=getPipelineId('Claim Listing');
      const salesPipelineId=getPipelineId('Sales');
      const onboardingPipelineId=getPipelineId('Onboarding');
      const successPipelineId=getPipelineId('Success');
      
      // Count by stage
      const claimDeals=fd.filter(d=>d.pipeline_id===claimPipelineId);
      const salesDeals=fd.filter(d=>d.pipeline_id===salesPipelineId);
      const onboardingDeals=fd.filter(d=>d.pipeline_id===onboardingPipelineId);
      const successDeals=fd.filter(d=>d.pipeline_id===successPipelineId);
      
      // Metrics
      const claims=claimDeals.length;
      const verified=claimDeals.filter(d=>['Verified','To Sales'].includes(d.stage)).length;
      const qualified=salesDeals.filter(d=>['Qualified','Demo','Proposal','Ready Now'].includes(d.stage)).length;
      const demos=salesDeals.filter(d=>d.stage==='Demo').length;
      const ready=salesDeals.filter(d=>d.stage==='Ready Now').length;
      const onboarding=onboardingDeals.filter(d=>!['Live','Failed Launch'].includes(d.stage)).length;
      const live=onboardingDeals.filter(d=>d.stage==='Live').length + successDeals.length;
      
      document.getElementById('metric-claims').textContent=claims;
      document.getElementById('metric-verified').textContent=verified;
      document.getElementById('metric-demos').textContent=demos;
      document.getElementById('metric-ready').textContent=ready;
      document.getElementById('metric-onboarding').textContent=onboarding;
      document.getElementById('metric-launched').textContent=live;
      
      // Funnel
      document.getElementById('f-claims').textContent=claims;
      document.getElementById('f-verified').textContent=verified;
      document.getElementById('f-qualified').textContent=qualified;
      document.getElementById('f-demo').textContent=demos;
      document.getElementById('f-ready').textContent=ready;
      document.getElementById('f-onboarding').textContent=onboarding;
      document.getElementById('f-live').textContent=live;
      
      // Conversion rates
      document.getElementById('f-verified-rate').textContent=claims?Math.round(verified/claims*100)+'%':'-';
      document.getElementById('f-qualified-rate').textContent=verified?Math.round(qualified/verified*100)+'%':'-';
      document.getElementById('f-demo-rate').textContent=qualified?Math.round(demos/qualified*100)+'%':'-';
      document.getElementById('f-ready-rate').textContent=demos?Math.round(ready/demos*100)+'%':'-';
      document.getElementById('f-onboarding-rate').textContent=ready?Math.round(onboarding/ready*100)+'%':'-';
      document.getElementById('f-live-rate').textContent=onboarding?Math.round(live/(onboarding+live)*100)+'%':'-';
      
      // Pipeline breakdown
      renderPipelineStages('claim-stages',claimDeals,CLAIM_STAGES);
      renderPipelineStages('sales-stages',salesDeals,SALES_STAGES);
      renderPipelineStages('onboarding-stages',onboardingDeals,ONBOARDING_STAGES);
      renderPipelineStages('success-stages',successDeals,SUCCESS_STAGES);
      
      // ICP breakdown
      renderIcpBreakdown(fd);
      
      // Activity
      renderActivity(fd);
    }
    
    function renderPipelineStages(elementId,pipelineDeals,stages){
      const html=stages.map(stage=>{
        const count=pipelineDeals.filter(d=>d.stage===stage).length;
        if(count===0)return '';
        return '<div class="stage-row"><span>'+stage+'</span><span class="stage-count">'+count+'</span></div>';
      }).filter(Boolean).join('');
      document.getElementById(elementId).innerHTML=html||'<div style="color:#999;font-size:12px">No deals</div>';
    }
    
    function renderIcpBreakdown(fd){
      const stats={};
      fd.forEach(d=>{
        const shop=shops.find(s=>s.id===d.shop_id);
        const icp=shop?.icp_tier||'unknown';
        if(!stats[icp])stats[icp]={total:0,verified:0,ready:0,live:0};
        stats[icp].total++;
        if(['Verified','To Sales'].includes(d.stage))stats[icp].verified++;
        if(d.stage==='Ready Now')stats[icp].ready++;
        if(d.stage==='Live')stats[icp].live++;
      });
      
      const order=['icp_1','icp_2','icp_3','icp_4','icp_5','icp_6','icp_7','icp_8','not_a_fit','unknown'];
      const html=order.filter(icp=>stats[icp]).map(icp=>{
        const s=stats[icp];
        const p=ICP_PRIORITY[icp]||'low';
        const l=ICP_LABELS[icp]||'Unknown';
        return '<div class="icp-card '+p+'"><div class="icp-name">'+l+'</div><div class="icp-stats"><div class="icp-stat"><div class="icp-stat-value">'+s.total+'</div><div class="icp-stat-label">Total</div></div><div class="icp-stat"><div class="icp-stat-value">'+s.verified+'</div><div class="icp-stat-label">Verified</div></div><div class="icp-stat"><div class="icp-stat-value">'+s.ready+'</div><div class="icp-stat-label">Ready</div></div><div class="icp-stat"><div class="icp-stat-value">'+s.live+'</div><div class="icp-stat-label">Live</div></div></div></div>';
      }).join('');
      
      document.getElementById('icp-breakdown').innerHTML=html||'<div class="loading">No ICP data</div>';
    }
    
    function renderActivity(fd){
      const acts=[];
      fd.slice(0,15).forEach(d=>{
        const shop=shops.find(s=>s.id===d.shop_id);
        acts.push({icon:'üìã',type:'claim',title:d.name,meta:(shop?.icp_tier?ICP_LABELS[shop.icp_tier]:'New')+' ‚Ä¢ '+d.stage,time:new Date(d.created_at)});
      });
      bookings.slice(0,5).forEach(b=>{
        acts.push({icon:'üìÖ',type:'meeting',title:'Meeting: '+(b.booker_name||'Unknown'),meta:b.booker_email||'',time:new Date(b.created_at)});
      });
      acts.sort((a,b)=>b.time-a.time);
      
      const html=acts.slice(0,12).map(a=>'<div class="activity-item"><div class="activity-icon '+a.type+'">'+a.icon+'</div><div class="activity-content"><div class="activity-title">'+a.title+'</div><div class="activity-meta">'+a.meta+'</div></div><div class="activity-time">'+formatTime(a.time)+'</div></div>').join('');
      document.getElementById('activity-list').innerHTML=html||'<div class="loading">No activity</div>';
    }
    
    function formatTime(d){
      const now=new Date();
      const diff=now-d;
      const mins=Math.floor(diff/60000);
      const hrs=Math.floor(diff/3600000);
      const days=Math.floor(diff/86400000);
      if(mins<60)return mins+'m ago';
      if(hrs<24)return hrs+'h ago';
      if(days<7)return days+'d ago';
      return d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
    }
    
    init();
  </script>
</body>
</html>
