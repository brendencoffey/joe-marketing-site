<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>joe CRM</title>
  
  <!-- Netlify Identity Widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  
  <!-- Styles -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            joe: {
              black: '#000000',
              white: '#FFFFFF',
              gray: { 50: '#FAFAFA', 100: '#F5F5F5', 200: '#E5E5E5', 300: '#D4D4D4', 400: '#A3A3A3', 500: '#737373', 600: '#525252', 700: '#404040', 800: '#262626', 900: '#171717' },
            },
          },
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
        },
      },
    }
  </script>
  
  <style>
    body { font-family: 'Inter', sans-serif; }
    .badge { display: inline-flex; align-items: center; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
    .badge-hot { background-color: #FEE2E2; color: #991B1B; }
    .badge-warm { background-color: #FEF3C7; color: #92400E; }
    .badge-cold { background-color: #DBEAFE; color: #1E40AF; }
    .badge-partner { background-color: #D1FAE5; color: #065F46; }
    .card { background: white; border-radius: 12px; border: 1px solid #E5E5E5; transition: all 0.2s; }
    .card:hover { border-color: #D4D4D4; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .card.dragging { opacity: 0.5; transform: rotate(2deg); }
    .pipeline-column.drag-over { background-color: #F5F5F5; }
    
    /* Loading spinner */
    .spinner { border: 2px solid #E5E5E5; border-top: 2px solid #000; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* Auth overlay */
    #auth-overlay { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 1rem; }
    #auth-overlay.hidden { display: none; }
    
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #F5F5F5; border-radius: 9999px; }
    ::-webkit-scrollbar-thumb { background: #D4D4D4; border-radius: 9999px; }
  </style>
</head>
<body class="bg-joe-gray-50 text-joe-gray-900">
  
  <!-- Auth Overlay - shown until logged in -->
  <div id="auth-overlay">
    <img src="https://4591743.fs1.hubspotusercontent-na1.net/hubfs/4591743/Black.png" alt="joe" class="h-12 mb-4">
    <h1 class="text-2xl font-semibold">joe CRM</h1>
    <p class="text-joe-gray-500 mb-6">Sign in to access the sales dashboard</p>
    <button id="login-btn" class="px-6 py-3 bg-black text-white rounded-lg hover:bg-joe-gray-800 transition-colors font-medium">
      Sign In
    </button>
  </div>
  
  <!-- Main App -->
  <div id="app" class="hidden">
    <!-- Header -->
    <header class="bg-white border-b border-joe-gray-200 px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <a href="https://joe.coffee" class="flex items-center gap-2">
            <img src="https://4591743.fs1.hubspotusercontent-na1.net/hubfs/4591743/Black.png" alt="joe" class="h-7">
            <span class="text-xs font-medium text-joe-gray-400 uppercase tracking-wider">CRM</span>
          </a>
          <nav class="flex items-center gap-1 ml-8">
            <button onclick="setView('dashboard')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium" data-view="dashboard">Dashboard</button>
            <button onclick="setView('pipeline')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium" data-view="pipeline">Pipeline</button>
            <button onclick="setView('shops')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium" data-view="shops">All Shops</button>
          </nav>
        </div>
        <div class="flex items-center gap-4">
          <input type="file" id="import-file" accept=".json" class="hidden" onchange="handleImport(event)">
          <button onclick="document.getElementById('import-file').click()" class="px-3 py-1.5 text-sm bg-joe-gray-100 hover:bg-joe-gray-200 rounded-lg transition-colors">
            ðŸ“¥ Import JSON
          </button>
          <button onclick="exportShops()" class="px-3 py-1.5 text-sm bg-joe-gray-100 hover:bg-joe-gray-200 rounded-lg transition-colors">
            ðŸ“¤ Export
          </button>
          <span id="user-email" class="text-sm text-joe-gray-500"></span>
          <button onclick="logout()" class="text-sm text-joe-gray-500 hover:text-black">Sign Out</button>
        </div>
      </div>
    </header>
    
    <!-- Main Content -->
    <main class="p-8">
      <!-- Dashboard View -->
      <div id="view-dashboard" class="view">
        <div class="mb-8">
          <h1 class="text-2xl font-semibold">Dashboard</h1>
          <p class="text-joe-gray-500 mt-1">Welcome back! Here's your pipeline overview.</p>
        </div>
        
        <!-- Stats -->
        <div class="grid grid-cols-4 gap-4 mb-8">
          <div class="card p-5">
            <p class="text-sm text-joe-gray-500">Total Shops</p>
            <p class="text-3xl font-semibold mt-1" id="stat-total">-</p>
          </div>
          <div class="card p-5">
            <p class="text-sm text-joe-gray-500">Hot Leads</p>
            <p class="text-3xl font-semibold mt-1" id="stat-hot">-</p>
          </div>
          <div class="card p-5">
            <p class="text-sm text-joe-gray-500">In Pipeline</p>
            <p class="text-3xl font-semibold mt-1" id="stat-pipeline">-</p>
          </div>
          <div class="card p-5">
            <p class="text-sm text-joe-gray-500">Partners</p>
            <p class="text-3xl font-semibold mt-1" id="stat-partners">-</p>
          </div>
        </div>
        
        <!-- Recent Hot Leads -->
        <div class="card">
          <div class="p-4 border-b border-joe-gray-100">
            <h2 class="font-semibold">ðŸ”¥ Hot Leads (Score 80+)</h2>
          </div>
          <div id="hot-leads-list" class="divide-y divide-joe-gray-100">
            <div class="p-8 text-center text-joe-gray-400">Loading...</div>
          </div>
        </div>
      </div>
      
      <!-- Pipeline View -->
      <div id="view-pipeline" class="view hidden">
        <div class="mb-8 flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-semibold">Pipeline</h1>
            <p class="text-joe-gray-500 mt-1">Drag and drop to move shops between stages</p>
          </div>
          <button onclick="openAddShopModal()" class="px-4 py-2 bg-black text-white rounded-lg hover:bg-joe-gray-800 text-sm font-medium">
            + Add Shop
          </button>
        </div>
        
        <div id="pipeline-board" class="flex gap-4 overflow-x-auto pb-4">
          <!-- Pipeline columns will be rendered here -->
        </div>
      </div>
      
      <!-- Shops List View -->
      <div id="view-shops" class="view hidden">
        <div class="mb-8 flex items-center justify-between">
          <h1 class="text-2xl font-semibold">All Coffee Shops</h1>
          <div class="flex items-center gap-3">
            <input type="text" id="search-input" placeholder="Search shops..." 
              class="px-4 py-2 bg-joe-gray-100 rounded-lg border-0 focus:outline-none focus:ring-2 focus:ring-black/10 w-64"
              oninput="filterShops(this.value)">
            <button onclick="openAddShopModal()" class="px-4 py-2 bg-black text-white rounded-lg hover:bg-joe-gray-800 text-sm font-medium">
              + Add Shop
            </button>
          </div>
        </div>
        
        <div class="card overflow-hidden">
          <table class="w-full">
            <thead>
              <tr class="bg-joe-gray-50 border-b border-joe-gray-100">
                <th class="text-left p-4 text-sm font-medium text-joe-gray-500">Shop</th>
                <th class="text-left p-4 text-sm font-medium text-joe-gray-500">Location</th>
                <th class="text-left p-4 text-sm font-medium text-joe-gray-500">Rating</th>
                <th class="text-left p-4 text-sm font-medium text-joe-gray-500">Score</th>
                <th class="text-left p-4 text-sm font-medium text-joe-gray-500">Stage</th>
                <th class="text-left p-4 text-sm font-medium text-joe-gray-500">Actions</th>
              </tr>
            </thead>
            <tbody id="shops-table-body" class="divide-y divide-joe-gray-100">
              <tr><td colspan="6" class="p-8 text-center text-joe-gray-400">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>
  
  <!-- Shop Detail Modal -->
  <div id="shop-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50" onclick="closeShopModal()"></div>
    <div class="absolute inset-4 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
      <div class="p-6 border-b border-joe-gray-100">
        <div class="flex items-start justify-between">
          <div>
            <h2 id="modal-shop-name" class="text-xl font-semibold"></h2>
            <p id="modal-shop-location" class="text-joe-gray-500 mt-1"></p>
          </div>
          <button onclick="closeShopModal()" class="p-2 hover:bg-joe-gray-100 rounded-lg">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
      </div>
      <div class="p-6 overflow-y-auto flex-1">
        <div id="modal-content"></div>
      </div>
    </div>
  </div>
  
  <!-- Add Shop Modal -->
  <div id="add-shop-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50" onclick="closeAddShopModal()"></div>
    <div class="absolute inset-4 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-lg bg-white rounded-2xl shadow-2xl overflow-hidden">
      <div class="p-6 border-b border-joe-gray-100">
        <h2 class="text-xl font-semibold">Add Coffee Shop</h2>
      </div>
      <form id="add-shop-form" class="p-6 space-y-4" onsubmit="handleAddShop(event)">
        <div>
          <label class="block text-sm font-medium mb-1">Shop Name *</label>
          <input type="text" name="name" required class="w-full px-4 py-2 border border-joe-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/10">
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">City</label>
            <input type="text" name="city" class="w-full px-4 py-2 border border-joe-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/10">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">State</label>
            <input type="text" name="state" maxlength="2" placeholder="WA" class="w-full px-4 py-2 border border-joe-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/10">
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Phone</label>
          <input type="tel" name="phone" class="w-full px-4 py-2 border border-joe-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/10">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Website</label>
          <input type="url" name="website" class="w-full px-4 py-2 border border-joe-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/10">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Contact Email</label>
          <input type="email" name="email" class="w-full px-4 py-2 border border-joe-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/10">
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" onclick="closeAddShopModal()" class="px-4 py-2 text-joe-gray-600 hover:bg-joe-gray-100 rounded-lg">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-black text-white rounded-lg hover:bg-joe-gray-800">Add Shop</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ==========================================
    // DATA STORE (LocalStorage for now, API later)
    // ==========================================
    
    const PIPELINE_STAGES = [
      { key: 'new', label: 'New' },
      { key: 'contacted', label: 'Contacted' },
      { key: 'qualified', label: 'Qualified' },
      { key: 'demo_scheduled', label: 'Demo' },
      { key: 'proposal', label: 'Proposal' },
      { key: 'negotiation', label: 'Negotiation' },
      { key: 'closed_won', label: 'Won' },
      { key: 'closed_lost', label: 'Lost' },
    ];
    
    // Sample data - will be replaced with API calls
    const DEFAULT_SHOPS = [
      { id: '1', name: 'Blue Bottle Coffee', city: 'Oakland', state: 'CA', lead_score: 92, pipeline_stage: 'demo_scheduled', google_rating: 4.6, phone: '(510) 555-0123', website: 'https://bluebottlecoffee.com', email: 'hello@bluebottle.com' },
      { id: '2', name: 'Stumptown Coffee', city: 'Portland', state: 'OR', lead_score: 88, pipeline_stage: 'proposal', google_rating: 4.5, phone: '(503) 555-0456' },
      { id: '3', name: 'Intelligentsia', city: 'Chicago', state: 'IL', lead_score: 75, pipeline_stage: 'qualified', google_rating: 4.4 },
      { id: '4', name: 'Verve Coffee', city: 'Santa Cruz', state: 'CA', lead_score: 95, pipeline_stage: 'closed_won', google_rating: 4.7, is_joe_partner: true },
      { id: '5', name: 'Coava Coffee', city: 'Portland', state: 'OR', lead_score: 67, pipeline_stage: 'contacted', google_rating: 4.5 },
      { id: '6', name: 'Sightglass Coffee', city: 'San Francisco', state: 'CA', lead_score: 82, pipeline_stage: 'demo_scheduled', google_rating: 4.5 },
      { id: '7', name: 'Ritual Coffee', city: 'San Francisco', state: 'CA', lead_score: 45, pipeline_stage: 'new', google_rating: 4.3 },
      { id: '8', name: 'Four Barrel', city: 'San Francisco', state: 'CA', lead_score: 38, pipeline_stage: 'new', google_rating: 4.2 },
      { id: '9', name: 'Heart Coffee', city: 'Portland', state: 'OR', lead_score: 71, pipeline_stage: 'qualified', google_rating: 4.6 },
      { id: '10', name: 'Onyx Coffee Lab', city: 'Rogers', state: 'AR', lead_score: 89, pipeline_stage: 'negotiation', google_rating: 4.8 },
    ];
    
    function getShops() {
      const stored = localStorage.getItem('joe_crm_shops');
      if (stored) return JSON.parse(stored);
      localStorage.setItem('joe_crm_shops', JSON.stringify(DEFAULT_SHOPS));
      return DEFAULT_SHOPS;
    }
    
    // ==========================================
    // IMPORT / EXPORT
    // ==========================================
    
    function handleImport(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const imported = JSON.parse(e.target.result);
          
          if (!Array.isArray(imported)) {
            alert('Invalid file format. Expected an array of shops.');
            return;
          }
          
          // Get existing shops
          const existing = getShops();
          const existingIds = new Set(existing.map(s => s.id || s.google_place_id));
          
          // Merge, avoiding duplicates
          let newCount = 0;
          for (const shop of imported) {
            const shopId = shop.id || shop.google_place_id;
            if (!existingIds.has(shopId)) {
              existing.push(shop);
              existingIds.add(shopId);
              newCount++;
            }
          }
          
          saveShops(existing);
          
          alert(`âœ… Imported ${newCount} new shops!\n\nTotal shops: ${existing.length}`);
          
          // Refresh views
          renderDashboard();
          renderPipeline();
          renderShopsTable();
          
        } catch (err) {
          alert('Error reading file: ' + err.message);
        }
      };
      reader.readAsText(file);
      
      // Reset file input
      event.target.value = '';
    }
    
    function exportShops() {
      const shops = getShops();
      const json = JSON.stringify(shops, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = 'joe-crm-shops.json';
      a.click();
      
      URL.revokeObjectURL(url);
    }
    
    function saveShops(shops) {
      localStorage.setItem('joe_crm_shops', JSON.stringify(shops));
    }
    
    function updateShop(id, updates) {
      const shops = getShops();
      const index = shops.findIndex(s => s.id === id);
      if (index !== -1) {
        shops[index] = { ...shops[index], ...updates };
        saveShops(shops);
      }
      return shops;
    }
    
    function addShop(shop) {
      const shops = getShops();
      shop.id = Date.now().toString();
      shop.lead_score = 50;
      shop.pipeline_stage = 'new';
      shops.push(shop);
      saveShops(shops);
      return shops;
    }
    
    // ==========================================
    // AUTH (Netlify Identity)
    // ==========================================
    
    let currentUser = null;
    
    function initAuth() {
      // Check if user is already logged in
      currentUser = netlifyIdentity.currentUser();
      
      if (currentUser) {
        showApp();
      } else {
        showAuthOverlay();
      }
      
      // Listen for login/logout events
      netlifyIdentity.on('login', user => {
        currentUser = user;
        netlifyIdentity.close();
        showApp();
      });
      
      netlifyIdentity.on('logout', () => {
        currentUser = null;
        showAuthOverlay();
      });
    }
    
    function showAuthOverlay() {
      document.getElementById('auth-overlay').classList.remove('hidden');
      document.getElementById('app').classList.add('hidden');
    }
    
    function showApp() {
      document.getElementById('auth-overlay').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');
      document.getElementById('user-email').textContent = currentUser?.email || '';
      
      // Load data
      renderDashboard();
      renderPipeline();
      renderShopsTable();
      setView('dashboard');
    }
    
    function logout() {
      netlifyIdentity.logout();
    }
    
    document.getElementById('login-btn').addEventListener('click', () => {
      netlifyIdentity.open('login');
    });
    
    // ==========================================
    // VIEWS
    // ==========================================
    
    let currentView = 'dashboard';
    
    function setView(view) {
      currentView = view;
      
      // Hide all views
      document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
      
      // Show selected view
      document.getElementById(`view-${view}`).classList.remove('hidden');
      
      // Update nav buttons
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('bg-joe-gray-100', 'text-black');
        btn.classList.add('text-joe-gray-500', 'hover:bg-joe-gray-50');
        if (btn.dataset.view === view) {
          btn.classList.add('bg-joe-gray-100', 'text-black');
          btn.classList.remove('text-joe-gray-500', 'hover:bg-joe-gray-50');
        }
      });
    }
    
    // ==========================================
    // DASHBOARD
    // ==========================================
    
    function renderDashboard() {
      const shops = getShops();
      
      // Stats
      document.getElementById('stat-total').textContent = shops.length;
      document.getElementById('stat-hot').textContent = shops.filter(s => s.lead_score >= 80).length;
      document.getElementById('stat-pipeline').textContent = shops.filter(s => !['closed_won', 'closed_lost'].includes(s.pipeline_stage)).length;
      document.getElementById('stat-partners').textContent = shops.filter(s => s.is_joe_partner).length;
      
      // Hot leads list
      const hotLeads = shops.filter(s => s.lead_score >= 80 && !s.is_joe_partner).sort((a, b) => b.lead_score - a.lead_score).slice(0, 5);
      const listEl = document.getElementById('hot-leads-list');
      
      if (hotLeads.length === 0) {
        listEl.innerHTML = '<div class="p-8 text-center text-joe-gray-400">No hot leads yet</div>';
        return;
      }
      
      listEl.innerHTML = hotLeads.map(shop => `
        <button onclick="openShopModal('${shop.id}')" class="w-full p-4 flex items-center gap-4 hover:bg-joe-gray-50 transition-colors text-left">
          <div class="w-10 h-10 rounded-full bg-joe-gray-100 flex items-center justify-center font-medium text-sm">
            ${shop.name.charAt(0)}
          </div>
          <div class="flex-1 min-w-0">
            <p class="font-medium truncate">${shop.name}</p>
            <p class="text-sm text-joe-gray-500">${shop.city}, ${shop.state}</p>
          </div>
          <span class="badge badge-hot">Score: ${shop.lead_score}</span>
        </button>
      `).join('');
    }
    
    // ==========================================
    // PIPELINE (Drag & Drop)
    // ==========================================
    
    let draggedShopId = null;
    
    function renderPipeline() {
      const shops = getShops();
      const board = document.getElementById('pipeline-board');
      
      board.innerHTML = PIPELINE_STAGES.map(stage => {
        const stageShops = shops.filter(s => s.pipeline_stage === stage.key);
        
        return `
          <div class="flex-shrink-0 w-72">
            <div class="flex items-center justify-between mb-3 px-1">
              <h3 class="font-medium text-joe-gray-700">${stage.label}</h3>
              <span class="text-sm text-joe-gray-400">${stageShops.length}</span>
            </div>
            <div class="pipeline-column min-h-[400px] p-2 bg-joe-gray-100/50 rounded-lg space-y-3"
                 data-stage="${stage.key}"
                 ondragover="handleDragOver(event)"
                 ondragleave="handleDragLeave(event)"
                 ondrop="handleDrop(event, '${stage.key}')">
              ${stageShops.map(shop => renderPipelineCard(shop)).join('')}
            </div>
          </div>
        `;
      }).join('');
    }
    
    function renderPipelineCard(shop) {
      const scoreClass = shop.lead_score >= 80 ? 'badge-hot' : shop.lead_score >= 50 ? 'badge-warm' : 'badge-cold';
      
      return `
        <div class="card p-4 cursor-grab active:cursor-grabbing"
             draggable="true"
             data-shop-id="${shop.id}"
             ondragstart="handleDragStart(event, '${shop.id}')"
             ondragend="handleDragEnd(event)"
             onclick="openShopModal('${shop.id}')">
          <div class="flex items-start justify-between mb-2">
            <p class="font-medium text-sm">${shop.name}</p>
            <span class="badge ${scoreClass}">${shop.lead_score}</span>
          </div>
          <p class="text-xs text-joe-gray-500 mb-2">${shop.city}, ${shop.state}</p>
          ${shop.google_rating ? `
            <div class="flex items-center gap-1 text-xs text-joe-gray-400">
              <svg class="w-3 h-3 text-yellow-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
              ${shop.google_rating}
            </div>
          ` : ''}
        </div>
      `;
    }
    
    function handleDragStart(e, shopId) {
      draggedShopId = shopId;
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }
    
    function handleDragEnd(e) {
      e.target.classList.remove('dragging');
      document.querySelectorAll('.pipeline-column').forEach(col => col.classList.remove('drag-over'));
    }
    
    function handleDragOver(e) {
      e.preventDefault();
      e.currentTarget.classList.add('drag-over');
    }
    
    function handleDragLeave(e) {
      e.currentTarget.classList.remove('drag-over');
    }
    
    function handleDrop(e, newStage) {
      e.preventDefault();
      e.currentTarget.classList.remove('drag-over');
      
      if (draggedShopId) {
        updateShop(draggedShopId, { pipeline_stage: newStage });
        renderPipeline();
        renderDashboard();
        renderShopsTable();
      }
      
      draggedShopId = null;
    }
    
    // ==========================================
    // SHOPS TABLE
    // ==========================================
    
    function renderShopsTable(filter = '') {
      const shops = getShops();
      const filtered = filter 
        ? shops.filter(s => 
            s.name.toLowerCase().includes(filter.toLowerCase()) ||
            s.city?.toLowerCase().includes(filter.toLowerCase())
          )
        : shops;
      
      const sorted = filtered.sort((a, b) => b.lead_score - a.lead_score);
      const tbody = document.getElementById('shops-table-body');
      
      if (sorted.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-joe-gray-400">No shops found</td></tr>';
        return;
      }
      
      tbody.innerHTML = sorted.map(shop => {
        const scoreClass = shop.lead_score >= 80 ? 'badge-hot' : shop.lead_score >= 50 ? 'badge-warm' : 'badge-cold';
        const stageName = PIPELINE_STAGES.find(s => s.key === shop.pipeline_stage)?.label || shop.pipeline_stage;
        
        return `
          <tr class="hover:bg-joe-gray-50 transition-colors">
            <td class="p-4">
              <button onclick="openShopModal('${shop.id}')" class="font-medium hover:underline">${shop.name}</button>
              ${shop.is_joe_partner ? '<span class="ml-2 text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">Partner</span>' : ''}
            </td>
            <td class="p-4 text-joe-gray-500">${shop.city || '-'}, ${shop.state || '-'}</td>
            <td class="p-4">
              ${shop.google_rating ? `
                <div class="flex items-center gap-1">
                  <svg class="w-4 h-4 text-yellow-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                  ${shop.google_rating}
                </div>
              ` : '-'}
            </td>
            <td class="p-4"><span class="badge ${scoreClass}">${shop.lead_score}</span></td>
            <td class="p-4 text-sm text-joe-gray-500">${stageName}</td>
            <td class="p-4">
              <div class="flex items-center gap-1">
                <button onclick="event.stopPropagation(); openShopModal('${shop.id}')" class="p-2 hover:bg-joe-gray-100 rounded-lg" title="View Details">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }
    
    function filterShops(value) {
      renderShopsTable(value);
    }
    
    // ==========================================
    // MODALS
    // ==========================================
    
    function openShopModal(shopId) {
      const shops = getShops();
      const shop = shops.find(s => s.id === shopId);
      if (!shop) return;
      
      document.getElementById('modal-shop-name').textContent = shop.name;
      document.getElementById('modal-shop-location').textContent = `${shop.city || ''}, ${shop.state || ''}`;
      
      const scoreClass = shop.lead_score >= 80 ? 'badge-hot' : shop.lead_score >= 50 ? 'badge-warm' : 'badge-cold';
      const currentStage = PIPELINE_STAGES.find(s => s.key === shop.pipeline_stage);
      
      document.getElementById('modal-content').innerHTML = `
        <div class="space-y-6">
          <!-- Quick Stats -->
          <div class="grid grid-cols-3 gap-4">
            <div class="bg-joe-gray-50 rounded-lg p-4 text-center">
              <p class="text-sm text-joe-gray-500">Lead Score</p>
              <p class="text-2xl font-semibold">${shop.lead_score}</p>
            </div>
            <div class="bg-joe-gray-50 rounded-lg p-4 text-center">
              <p class="text-sm text-joe-gray-500">Rating</p>
              <p class="text-2xl font-semibold">${shop.google_rating || '-'}</p>
            </div>
            <div class="bg-joe-gray-50 rounded-lg p-4 text-center">
              <p class="text-sm text-joe-gray-500">Status</p>
              <p class="text-lg font-medium">${shop.is_joe_partner ? 'âœ… Partner' : currentStage?.label}</p>
            </div>
          </div>
          
          <!-- Pipeline Stage -->
          <div>
            <h3 class="text-sm font-medium text-joe-gray-500 mb-3">Move to Stage</h3>
            <div class="flex flex-wrap gap-2">
              ${PIPELINE_STAGES.map(stage => `
                <button 
                  onclick="moveShopToStage('${shopId}', '${stage.key}')"
                  class="px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
                    shop.pipeline_stage === stage.key 
                      ? 'bg-black text-white' 
                      : 'bg-joe-gray-100 text-joe-gray-600 hover:bg-joe-gray-200'
                  }">
                  ${stage.label}
                </button>
              `).join('')}
            </div>
          </div>
          
          <!-- Contact Info -->
          <div>
            <h3 class="text-sm font-medium text-joe-gray-500 mb-3">Contact Info</h3>
            <div class="space-y-2">
              ${shop.phone ? `<p class="flex items-center gap-2"><svg class="w-4 h-4 text-joe-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg> ${shop.phone}</p>` : ''}
              ${shop.email ? `<p class="flex items-center gap-2"><svg class="w-4 h-4 text-joe-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg> ${shop.email}</p>` : ''}
              ${shop.website ? `<p class="flex items-center gap-2"><svg class="w-4 h-4 text-joe-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/></svg> <a href="${shop.website}" target="_blank" class="text-blue-600 hover:underline">${shop.website}</a></p>` : ''}
              ${!shop.phone && !shop.email && !shop.website ? '<p class="text-joe-gray-400">No contact info</p>' : ''}
            </div>
          </div>
          
          <!-- Notes -->
          <div>
            <h3 class="text-sm font-medium text-joe-gray-500 mb-3">Notes</h3>
            <textarea 
              id="shop-notes-${shopId}"
              class="w-full p-3 bg-joe-gray-50 border border-joe-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/10 text-sm"
              rows="4"
              placeholder="Add notes about this shop..."
              onblur="saveShopNotes('${shopId}')"
            >${shop.notes || ''}</textarea>
          </div>
        </div>
      `;
      
      document.getElementById('shop-modal').classList.remove('hidden');
    }
    
    function closeShopModal() {
      document.getElementById('shop-modal').classList.add('hidden');
    }
    
    function moveShopToStage(shopId, newStage) {
      updateShop(shopId, { pipeline_stage: newStage });
      openShopModal(shopId); // Refresh modal
      renderPipeline();
      renderDashboard();
      renderShopsTable();
    }
    
    function saveShopNotes(shopId) {
      const notes = document.getElementById(`shop-notes-${shopId}`).value;
      updateShop(shopId, { notes });
    }
    
    function openAddShopModal() {
      document.getElementById('add-shop-modal').classList.remove('hidden');
      document.getElementById('add-shop-form').reset();
    }
    
    function closeAddShopModal() {
      document.getElementById('add-shop-modal').classList.add('hidden');
    }
    
    function handleAddShop(e) {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      
      const shop = {
        name: formData.get('name'),
        city: formData.get('city'),
        state: formData.get('state'),
        phone: formData.get('phone'),
        website: formData.get('website'),
        email: formData.get('email'),
      };
      
      addShop(shop);
      closeAddShopModal();
      renderPipeline();
      renderDashboard();
      renderShopsTable();
    }
    
    // ==========================================
    // INIT
    // ==========================================
    
    document.addEventListener('DOMContentLoaded', initAuth);
  </script>
</body>
</html>
