<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>joe CRM</title>
  
  <!-- Netlify Identity Widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Styles -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            joe: {
              black: '#000000',
              white: '#FFFFFF',
              gray: { 50: '#FAFAFA', 100: '#F5F5F5', 200: '#E5E5E5', 300: '#D4D4D4', 400: '#A3A3A3', 500: '#737373', 600: '#525252', 700: '#404040', 800: '#262626', 900: '#171717' },
            },
          },
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
        },
      },
    }
  </script>
  
  <style>
    body { font-family: 'Inter', sans-serif; }
    .badge { display: inline-flex; align-items: center; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
    .badge-hot { background-color: #FEE2E2; color: #991B1B; }
    .badge-warm { background-color: #FEF3C7; color: #92400E; }
    .badge-cold { background-color: #DBEAFE; color: #1E40AF; }
    .badge-partner { background-color: #D1FAE5; color: #065F46; }
    .card { background: white; border-radius: 12px; border: 1px solid #E5E5E5; transition: all 0.2s; }
    .card:hover { border-color: #D4D4D4; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .card.dragging { opacity: 0.5; transform: rotate(2deg); }
    .pipeline-column.drag-over { background-color: #F5F5F5; }
    
    .spinner { border: 2px solid #E5E5E5; border-top: 2px solid #000; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    #auth-overlay { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 1rem; }
    #auth-overlay.hidden { display: none; }
    
    .toast { position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; background: #171717; color: white; border-radius: 8px; z-index: 9999; animation: slideIn 0.3s ease; }
    @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #F5F5F5; border-radius: 9999px; }
    ::-webkit-scrollbar-thumb { background: #D4D4D4; border-radius: 9999px; }
  </style>
</head>
<body class="bg-joe-gray-50 text-joe-gray-900">
  
  <!-- Auth Overlay -->
  <div id="auth-overlay">
    <img src="https://4591743.fs1.hubspotusercontent-na1.net/hubfs/4591743/Black.png" alt="joe" class="h-12 mb-4">
    <h1 class="text-2xl font-semibold">joe CRM</h1>
    <p class="text-joe-gray-500 mb-6">Sign in to access the sales dashboard</p>
    <button id="login-btn" class="px-6 py-3 bg-black text-white rounded-lg hover:bg-joe-gray-800 transition-colors font-medium">
      Sign In
    </button>
  </div>
  
  <!-- Main App -->
  <div id="app" class="hidden">
    <!-- Header -->
    <header class="bg-white border-b border-joe-gray-200 px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <a href="https://joe.coffee" class="flex items-center gap-2">
            <img src="https://4591743.fs1.hubspotusercontent-na1.net/hubfs/4591743/Black.png" alt="joe" class="h-7">
            <span class="text-xs font-medium text-joe-gray-400 uppercase tracking-wider">CRM</span>
          </a>
          <nav class="flex items-center gap-1 ml-8">
            <button onclick="setView('dashboard')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium" data-view="dashboard">Dashboard</button>
            <button onclick="setView('pipeline')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium" data-view="pipeline">Pipeline</button>
            <button onclick="setView('shops')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium" data-view="shops">All Shops</button>
          </nav>
        </div>
        <div class="flex items-center gap-4">
          <span id="sync-status" class="text-xs text-joe-gray-400"></span>
          <input type="file" id="import-file" accept=".json" class="hidden" onchange="handleImport(event)">
          <button onclick="document.getElementById('import-file').click()" class="px-3 py-1.5 text-sm bg-joe-gray-100 hover:bg-joe-gray-200 rounded-lg transition-colors">
            üì• Import
          </button>
          <button onclick="exportShops()" class="px-3 py-1.5 text-sm bg-joe-gray-100 hover:bg-joe-gray-200 rounded-lg transition-colors">
            üì§ Export
          </button>
          <span id="user-email" class="text-sm text-joe-gray-500"></span>
          <button onclick="logout()" class="text-sm text-joe-gray-500 hover:text-black">Sign Out</button>
        </div>
      </div>
    </header>
    
    <!-- Main Content -->
    <main class="p-8">
      <!-- Loading State -->
      <div id="loading-state" class="flex items-center justify-center py-20">
        <div class="text-center">
          <div class="spinner mx-auto mb-4"></div>
          <p class="text-joe-gray-500">Loading shops...</p>
        </div>
      </div>
      
      <!-- Dashboard View -->
      <div id="view-dashboard" class="view hidden">
        <div class="mb-8">
          <h1 class="text-2xl font-semibold">Dashboard</h1>
          <p class="text-joe-gray-500 mt-1">Welcome back! Here's your pipeline overview.</p>
        </div>
        
        <div class="grid grid-cols-4 gap-4 mb-8">
          <div class="card p-5">
            <p class="text-sm text-joe-gray-500">Total Shops</p>
            <p class="text-3xl font-semibold mt-1" id="stat-total">-</p>
          </div>
          <div class="card p-5">
            <p class="text-sm text-joe-gray-500">Hot Leads</p>
            <p class="text-3xl font-semibold mt-1" id="stat-hot">-</p>
          </div>
          <div class="card p-5">
            <p class="text-sm text-joe-gray-500">In Pipeline</p>
            <p class="text-3xl font-semibold mt-1" id="stat-pipeline">-</p>
          </div>
          <div class="card p-5">
            <p class="text-sm text-joe-gray-500">Partners</p>
            <p class="text-3xl font-semibold mt-1" id="stat-partners">-</p>
          </div>
        </div>
        
        <div class="card">
          <div class="p-4 border-b border-joe-gray-100">
            <h2 class="font-semibold">üî• Hot Leads (Score 80+)</h2>
          </div>
          <div id="hot-leads-list" class="divide-y divide-joe-gray-100">
            <div class="p-8 text-center text-joe-gray-400">Loading...</div>
          </div>
        </div>
      </div>
      
      <!-- Pipeline View -->
      <div id="view-pipeline" class="view hidden">
        <div class="mb-8 flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-semibold">Pipeline</h1>
            <p class="text-joe-gray-500 mt-1">Drag and drop to move shops between stages</p>
          </div>
          <button onclick="openAddShopModal()" class="px-4 py-2 bg-black text-white rounded-lg hover:bg-joe-gray-800 text-sm font-medium">
            + Add Shop
          </button>
        </div>
        
        <div id="pipeline-board" class="flex gap-4 overflow-x-auto pb-4"></div>
      </div>
      
      <!-- Shops List View -->
      <div id="view-shops" class="view hidden">
        <div class="mb-8 flex items-center justify-between">
          <h1 class="text-2xl font-semibold">All Coffee Shops</h1>
          <div class="flex items-center gap-3">
            <input type="text" id="search-input" placeholder="Search shops..." 
              class="px-4 py-2 bg-joe-gray-100 rounded-lg border-0 focus:outline-none focus:ring-2 focus:ring-black/10 w-64"
              oninput="filterShops(this.value)">
            <button onclick="openAddShopModal()" class="px-4 py-2 bg-black text-white rounded-lg hover:bg-joe-gray-800 text-sm font-medium">
              + Add Shop
            </button>
          </div>
        </div>
        
        <div class="card overflow-hidden">
          <table class="w-full">
            <thead>
              <tr class="bg-joe-gray-50 border-b border-joe-gray-100">
                <th class="text-left p-4 text-sm font-medium text-joe-gray-500">Shop</th>
                <th class="text-left p-4 text-sm font-medium text-joe-gray-500">Location</th>
                <th class="text-left p-4 text-sm font-medium text-joe-gray-500">Rating</th>
                <th class="text-left p-4 text-sm font-medium text-joe-gray-500">Score</th>
                <th class="text-left p-4 text-sm font-medium text-joe-gray-500">Stage</th>
                <th class="text-left p-4 text-sm font-medium text-joe-gray-500">Actions</th>
              </tr>
            </thead>
            <tbody id="shops-table-body" class="divide-y divide-joe-gray-100">
              <tr><td colspan="6" class="p-8 text-center text-joe-gray-400">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>
  
  <!-- Shop Detail Modal -->
  <div id="shop-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50" onclick="closeShopModal()"></div>
    <div class="absolute inset-4 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
      <div class="p-6 border-b border-joe-gray-100">
        <div class="flex items-start justify-between">
          <div>
            <h2 id="modal-shop-name" class="text-xl font-semibold"></h2>
            <p id="modal-shop-location" class="text-joe-gray-500 mt-1"></p>
          </div>
          <button onclick="closeShopModal()" class="p-2 hover:bg-joe-gray-100 rounded-lg">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
      </div>
      <div class="p-6 overflow-y-auto flex-1">
        <div id="modal-content"></div>
      </div>
    </div>
  </div>
  
  <!-- Add Shop Modal -->
  <div id="add-shop-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50" onclick="closeAddShopModal()"></div>
    <div class="absolute inset-4 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-lg bg-white rounded-2xl shadow-2xl overflow-hidden">
      <div class="p-6 border-b border-joe-gray-100">
        <h2 class="text-xl font-semibold">Add Coffee Shop</h2>
      </div>
      <form id="add-shop-form" class="p-6 space-y-4" onsubmit="handleAddShop(event)">
        <div>
          <label class="block text-sm font-medium mb-1">Shop Name *</label>
          <input type="text" name="name" required class="w-full px-4 py-2 border border-joe-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/10">
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">City</label>
            <input type="text" name="city" class="w-full px-4 py-2 border border-joe-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/10">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">State</label>
            <input type="text" name="state" maxlength="2" placeholder="WA" class="w-full px-4 py-2 border border-joe-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/10">
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Phone</label>
          <input type="tel" name="phone" class="w-full px-4 py-2 border border-joe-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/10">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Website</label>
          <input type="url" name="website" class="w-full px-4 py-2 border border-joe-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/10">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Contact Email</label>
          <input type="email" name="email" class="w-full px-4 py-2 border border-joe-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/10">
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" onclick="closeAddShopModal()" class="px-4 py-2 text-joe-gray-600 hover:bg-joe-gray-100 rounded-lg">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-black text-white rounded-lg hover:bg-joe-gray-800">Add Shop</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ==========================================
    // SUPABASE CONFIG
    // ==========================================
    
    const SUPABASE_URL = 'https://vpnoaxpmhuknyaxcyxsu.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_WYLU3R98ozKXNTsZgBV1MA_MFeDE5lB';
    
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // ==========================================
    // DATA STORE
    // ==========================================
    
    let shopsCache = [];
    
    const PIPELINE_STAGES = [
      { key: 'new', label: 'New' },
      { key: 'contacted', label: 'Contacted' },
      { key: 'qualified', label: 'Qualified' },
      { key: 'demo_scheduled', label: 'Demo' },
      { key: 'proposal', label: 'Proposal' },
      { key: 'negotiation', label: 'Negotiation' },
      { key: 'closed_won', label: 'Won' },
      { key: 'closed_lost', label: 'Lost' },
    ];
    
    // Toast notifications
    function showToast(message, duration = 3000) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), duration);
    }
    
    function setSyncStatus(status) {
      document.getElementById('sync-status').textContent = status;
    }
    
    // ==========================================
    // DATABASE OPERATIONS
    // ==========================================
    
    async function loadShops() {
      setSyncStatus('Syncing...');
      
      const { data, error } = await supabase
        .from('shops')
        .select('*')
        .order('lead_score', { ascending: false });
      
      if (error) {
        console.error('Error loading shops:', error);
        showToast('‚ùå Error loading shops');
        setSyncStatus('Sync failed');
        return [];
      }
      
      shopsCache = data || [];
      setSyncStatus(`‚úì ${shopsCache.length} shops`);
      return shopsCache;
    }
    
    function getShops() {
      return shopsCache;
    }
    
    async function saveShop(shop) {
      setSyncStatus('Saving...');
      
      const { data, error } = await supabase
        .from('shops')
        .upsert(shop, { onConflict: 'google_place_id' })
        .select()
        .single();
      
      if (error) {
        console.error('Error saving shop:', error);
        showToast('‚ùå Error saving');
        return null;
      }
      
      // Update cache
      const index = shopsCache.findIndex(s => s.id === data.id);
      if (index >= 0) {
        shopsCache[index] = data;
      } else {
        shopsCache.push(data);
      }
      
      setSyncStatus(`‚úì Saved`);
      return data;
    }
    
    async function updateShop(id, updates) {
      setSyncStatus('Saving...');
      
      const { data, error } = await supabase
        .from('shops')
        .update({ ...updates, updated_at: new Date().toISOString() })
        .eq('id', id)
        .select()
        .single();
      
      if (error) {
        console.error('Error updating shop:', error);
        showToast('‚ùå Error saving');
        return null;
      }
      
      // Update cache
      const index = shopsCache.findIndex(s => s.id === id);
      if (index >= 0) {
        shopsCache[index] = data;
      }
      
      setSyncStatus(`‚úì Saved`);
      return data;
    }
    
    async function addShop(shopData) {
      const shop = {
        ...shopData,
        lead_score: shopData.lead_score || 50,
        pipeline_stage: shopData.pipeline_stage || 'new',
        is_joe_partner: false,
      };
      
      const { data, error } = await supabase
        .from('shops')
        .insert(shop)
        .select()
        .single();
      
      if (error) {
        console.error('Error adding shop:', error);
        showToast('‚ùå Error adding shop');
        return null;
      }
      
      shopsCache.push(data);
      showToast('‚úÖ Shop added!');
      return data;
    }
    
    // ==========================================
    // IMPORT / EXPORT
    // ==========================================
    
    async function handleImport(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const imported = JSON.parse(e.target.result);
          
          if (!Array.isArray(imported)) {
            alert('Invalid file format. Expected an array of shops.');
            return;
          }
          
          setSyncStatus('Importing...');
          showToast(`üì• Importing ${imported.length} shops...`);
          
          // Prepare shops for upsert (use google_place_id as unique key)
          const shopsToUpsert = imported.map(shop => ({
            google_place_id: shop.google_place_id || shop.id,
            name: shop.name,
            address: shop.address,
            city: shop.city,
            state: shop.state,
            zip: shop.zip,
            lat: shop.lat,
            lng: shop.lng,
            phone: shop.phone,
            website: shop.website,
            email: shop.email,
            google_rating: shop.google_rating,
            google_reviews: shop.google_reviews || 0,
            lead_score: shop.lead_score || 50,
            pipeline_stage: shop.pipeline_stage || 'new',
            is_joe_partner: shop.is_joe_partner || false,
          }));
          
          // Batch upsert (Supabase handles duplicates via google_place_id)
          const { data, error } = await supabase
            .from('shops')
            .upsert(shopsToUpsert, { 
              onConflict: 'google_place_id',
              ignoreDuplicates: false 
            })
            .select();
          
          if (error) {
            console.error('Import error:', error);
            alert('Error importing: ' + error.message);
            return;
          }
          
          // Reload data
          await loadShops();
          renderAll();
          
          showToast(`‚úÖ Imported ${data.length} shops!`);
          
        } catch (err) {
          alert('Error reading file: ' + err.message);
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }
    
    function exportShops() {
      const shops = getShops();
      const json = JSON.stringify(shops, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = 'joe-crm-shops.json';
      a.click();
      
      URL.revokeObjectURL(url);
      showToast('üì§ Exported ' + shops.length + ' shops');
    }
    
    // ==========================================
    // AUTH
    // ==========================================
    
    let currentUser = null;
    
    function initAuth() {
      currentUser = netlifyIdentity.currentUser();
      
      if (currentUser) {
        showApp();
      } else {
        showAuthOverlay();
      }
      
      netlifyIdentity.on('login', user => {
        currentUser = user;
        netlifyIdentity.close();
        showApp();
      });
      
      netlifyIdentity.on('logout', () => {
        currentUser = null;
        showAuthOverlay();
      });
    }
    
    function showAuthOverlay() {
      document.getElementById('auth-overlay').classList.remove('hidden');
      document.getElementById('app').classList.add('hidden');
    }
    
    async function showApp() {
      document.getElementById('auth-overlay').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');
      document.getElementById('user-email').textContent = currentUser?.email || '';
      
      // Load data from Supabase
      await loadShops();
      
      // Hide loading, show dashboard
      document.getElementById('loading-state').classList.add('hidden');
      renderAll();
      setView('dashboard');
    }
    
    function logout() {
      netlifyIdentity.logout();
    }
    
    document.getElementById('login-btn').addEventListener('click', () => {
      netlifyIdentity.open('login');
    });
    
    // ==========================================
    // RENDER FUNCTIONS
    // ==========================================
    
    function renderAll() {
      renderDashboard();
      renderPipeline();
      renderShopsTable();
    }
    
    function renderDashboard() {
      const shops = getShops();
      
      document.getElementById('stat-total').textContent = shops.length;
      document.getElementById('stat-hot').textContent = shops.filter(s => s.lead_score >= 80).length;
      document.getElementById('stat-pipeline').textContent = shops.filter(s => !['closed_won', 'closed_lost'].includes(s.pipeline_stage)).length;
      document.getElementById('stat-partners').textContent = shops.filter(s => s.is_joe_partner).length;
      
      const hotLeads = shops.filter(s => s.lead_score >= 80 && !s.is_joe_partner).sort((a, b) => b.lead_score - a.lead_score).slice(0, 10);
      const listEl = document.getElementById('hot-leads-list');
      
      if (hotLeads.length === 0) {
        listEl.innerHTML = '<div class="p-8 text-center text-joe-gray-400">No hot leads yet</div>';
        return;
      }
      
      listEl.innerHTML = hotLeads.map(shop => `
        <button onclick="openShopModal('${shop.id}')" class="w-full p-4 flex items-center gap-4 hover:bg-joe-gray-50 transition-colors text-left">
          <div class="w-10 h-10 rounded-full bg-joe-gray-100 flex items-center justify-center font-medium text-sm">
            ${shop.name.charAt(0)}
          </div>
          <div class="flex-1 min-w-0">
            <p class="font-medium truncate">${shop.name}</p>
            <p class="text-sm text-joe-gray-500">${shop.city || ''}, ${shop.state || ''}</p>
          </div>
          <span class="badge badge-hot">Score: ${shop.lead_score}</span>
        </button>
      `).join('');
      
      document.getElementById('view-dashboard').classList.remove('hidden');
    }
    
    // ==========================================
    // PIPELINE
    // ==========================================
    
    let draggedShopId = null;
    
    function renderPipeline() {
      const shops = getShops();
      const board = document.getElementById('pipeline-board');
      
      board.innerHTML = PIPELINE_STAGES.map(stage => {
        const stageShops = shops.filter(s => s.pipeline_stage === stage.key);
        
        return `
          <div class="flex-shrink-0 w-72">
            <div class="flex items-center justify-between mb-3 px-1">
              <h3 class="font-medium text-joe-gray-700">${stage.label}</h3>
              <span class="text-sm text-joe-gray-400">${stageShops.length}</span>
            </div>
            <div class="pipeline-column min-h-[400px] p-2 bg-joe-gray-100/50 rounded-lg space-y-3"
                 data-stage="${stage.key}"
                 ondragover="handleDragOver(event)"
                 ondragleave="handleDragLeave(event)"
                 ondrop="handleDrop(event, '${stage.key}')">
              ${stageShops.map(shop => renderPipelineCard(shop)).join('')}
            </div>
          </div>
        `;
      }).join('');
    }
    
    function renderPipelineCard(shop) {
      const scoreClass = shop.lead_score >= 80 ? 'badge-hot' : shop.lead_score >= 50 ? 'badge-warm' : 'badge-cold';
      
      return `
        <div class="card p-4 cursor-grab active:cursor-grabbing"
             draggable="true"
             data-shop-id="${shop.id}"
             ondragstart="handleDragStart(event, '${shop.id}')"
             ondragend="handleDragEnd(event)"
             onclick="openShopModal('${shop.id}')">
          <div class="flex items-start justify-between mb-2">
            <p class="font-medium text-sm">${shop.name}</p>
            <span class="badge ${scoreClass}">${shop.lead_score}</span>
          </div>
          <p class="text-xs text-joe-gray-500 mb-2">${shop.city || ''}, ${shop.state || ''}</p>
          ${shop.google_rating ? `
            <div class="flex items-center gap-1 text-xs text-joe-gray-400">
              <svg class="w-3 h-3 text-yellow-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
              ${shop.google_rating}
            </div>
          ` : ''}
        </div>
      `;
    }
    
    function handleDragStart(e, shopId) {
      draggedShopId = shopId;
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }
    
    function handleDragEnd(e) {
      e.target.classList.remove('dragging');
      document.querySelectorAll('.pipeline-column').forEach(col => col.classList.remove('drag-over'));
    }
    
    function handleDragOver(e) {
      e.preventDefault();
      e.currentTarget.classList.add('drag-over');
    }
    
    function handleDragLeave(e) {
      e.currentTarget.classList.remove('drag-over');
    }
    
    async function handleDrop(e, newStage) {
      e.preventDefault();
      e.currentTarget.classList.remove('drag-over');
      
      if (draggedShopId) {
        await updateShop(draggedShopId, { pipeline_stage: newStage });
        renderAll();
      }
      
      draggedShopId = null;
    }
    
    // ==========================================
    // SHOPS TABLE
    // ==========================================
    
    function renderShopsTable(filter = '') {
      const shops = getShops();
      const filtered = filter 
        ? shops.filter(s => 
            s.name.toLowerCase().includes(filter.toLowerCase()) ||
            s.city?.toLowerCase().includes(filter.toLowerCase())
          )
        : shops;
      
      const sorted = filtered.sort((a, b) => b.lead_score - a.lead_score);
      const tbody = document.getElementById('shops-table-body');
      
      if (sorted.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-joe-gray-400">No shops found</td></tr>';
        return;
      }
      
      tbody.innerHTML = sorted.map(shop => {
        const scoreClass = shop.lead_score >= 80 ? 'badge-hot' : shop.lead_score >= 50 ? 'badge-warm' : 'badge-cold';
        const stageName = PIPELINE_STAGES.find(s => s.key === shop.pipeline_stage)?.label || shop.pipeline_stage;
        
        return `
          <tr class="hover:bg-joe-gray-50 transition-colors">
            <td class="p-4">
              <button onclick="openShopModal('${shop.id}')" class="font-medium hover:underline">${shop.name}</button>
              ${shop.is_joe_partner ? '<span class="ml-2 text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">Partner</span>' : ''}
            </td>
            <td class="p-4 text-joe-gray-500">${shop.city || '-'}, ${shop.state || '-'}</td>
            <td class="p-4">
              ${shop.google_rating ? `
                <div class="flex items-center gap-1">
                  <svg class="w-4 h-4 text-yellow-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                  ${shop.google_rating}
                </div>
              ` : '-'}
            </td>
            <td class="p-4"><span class="badge ${scoreClass}">${shop.lead_score}</span></td>
            <td class="p-4 text-sm text-joe-gray-500">${stageName}</td>
            <td class="p-4">
              <button onclick="event.stopPropagation(); openShopModal('${shop.id}')" class="p-2 hover:bg-joe-gray-100 rounded-lg" title="View">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }
    
    function filterShops(value) {
      renderShopsTable(value);
    }
    
    // ==========================================
    // VIEWS
    // ==========================================
    
    let currentView = 'dashboard';
    
    function setView(view) {
      currentView = view;
      document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
      document.getElementById(`view-${view}`).classList.remove('hidden');
      
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('bg-joe-gray-100', 'text-black');
        btn.classList.add('text-joe-gray-500', 'hover:bg-joe-gray-50');
        if (btn.dataset.view === view) {
          btn.classList.add('bg-joe-gray-100', 'text-black');
          btn.classList.remove('text-joe-gray-500', 'hover:bg-joe-gray-50');
        }
      });
    }
    
    // ==========================================
    // MODALS
    // ==========================================
    
    function openShopModal(shopId) {
      const shops = getShops();
      const shop = shops.find(s => s.id === shopId);
      if (!shop) return;
      
      document.getElementById('modal-shop-name').textContent = shop.name;
      document.getElementById('modal-shop-location').textContent = `${shop.city || ''}, ${shop.state || ''}`;
      
      const scoreClass = shop.lead_score >= 80 ? 'badge-hot' : shop.lead_score >= 50 ? 'badge-warm' : 'badge-cold';
      const currentStage = PIPELINE_STAGES.find(s => s.key === shop.pipeline_stage);
      
      document.getElementById('modal-content').innerHTML = `
        <div class="space-y-6">
          <div class="grid grid-cols-3 gap-4">
            <div class="bg-joe-gray-50 rounded-lg p-4 text-center">
              <p class="text-sm text-joe-gray-500">Lead Score</p>
              <p class="text-2xl font-semibold">${shop.lead_score}</p>
            </div>
            <div class="bg-joe-gray-50 rounded-lg p-4 text-center">
              <p class="text-sm text-joe-gray-500">Rating</p>
              <p class="text-2xl font-semibold">${shop.google_rating || '-'}</p>
            </div>
            <div class="bg-joe-gray-50 rounded-lg p-4 text-center">
              <p class="text-sm text-joe-gray-500">Reviews</p>
              <p class="text-2xl font-semibold">${shop.google_reviews || '-'}</p>
            </div>
          </div>
          
          <div>
            <h3 class="text-sm font-medium text-joe-gray-500 mb-3">Pipeline Stage</h3>
            <div class="flex flex-wrap gap-2">
              ${PIPELINE_STAGES.map(stage => `
                <button 
                  onclick="moveShopToStage('${shopId}', '${stage.key}')"
                  class="px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
                    shop.pipeline_stage === stage.key 
                      ? 'bg-black text-white' 
                      : 'bg-joe-gray-100 text-joe-gray-600 hover:bg-joe-gray-200'
                  }">
                  ${stage.label}
                </button>
              `).join('')}
            </div>
          </div>
          
          <div>
            <h3 class="text-sm font-medium text-joe-gray-500 mb-3">Contact Info</h3>
            <div class="space-y-2 text-sm">
              ${shop.phone ? `<p>üìû ${shop.phone}</p>` : ''}
              ${shop.email ? `<p>‚úâÔ∏è ${shop.email}</p>` : ''}
              ${shop.website ? `<p>üåê <a href="${shop.website}" target="_blank" class="text-blue-600 hover:underline">${shop.website}</a></p>` : ''}
              ${shop.address ? `<p>üìç ${shop.address}</p>` : ''}
              ${!shop.phone && !shop.email && !shop.website ? '<p class="text-joe-gray-400">No contact info</p>' : ''}
            </div>
          </div>
          
          <div>
            <h3 class="text-sm font-medium text-joe-gray-500 mb-3">Notes</h3>
            <textarea 
              id="shop-notes-${shopId}"
              class="w-full p-3 bg-joe-gray-50 border border-joe-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-black/10 text-sm"
              rows="4"
              placeholder="Add notes..."
              onblur="saveShopNotes('${shopId}')"
            >${shop.notes || ''}</textarea>
          </div>
          
          <div class="flex items-center gap-2 pt-2">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" ${shop.is_joe_partner ? 'checked' : ''} onchange="togglePartner('${shopId}', this.checked)" class="w-4 h-4">
              <span class="text-sm">joe Partner</span>
            </label>
          </div>
        </div>
      `;
      
      document.getElementById('shop-modal').classList.remove('hidden');
    }
    
    function closeShopModal() {
      document.getElementById('shop-modal').classList.add('hidden');
    }
    
    async function moveShopToStage(shopId, newStage) {
      await updateShop(shopId, { pipeline_stage: newStage });
      openShopModal(shopId);
      renderAll();
    }
    
    async function saveShopNotes(shopId) {
      const notes = document.getElementById(`shop-notes-${shopId}`).value;
      await updateShop(shopId, { notes });
    }
    
    async function togglePartner(shopId, isPartner) {
      await updateShop(shopId, { is_joe_partner: isPartner });
      renderAll();
    }
    
    function openAddShopModal() {
      document.getElementById('add-shop-modal').classList.remove('hidden');
      document.getElementById('add-shop-form').reset();
    }
    
    function closeAddShopModal() {
      document.getElementById('add-shop-modal').classList.add('hidden');
    }
    
    async function handleAddShop(e) {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      
      const shop = {
        name: formData.get('name'),
        city: formData.get('city'),
        state: formData.get('state'),
        phone: formData.get('phone'),
        website: formData.get('website'),
        email: formData.get('email'),
      };
      
      await addShop(shop);
      closeAddShopModal();
      renderAll();
    }
    
    // ==========================================
    // INIT
    // ==========================================
    
    document.addEventListener('DOMContentLoaded', initAuth);
  </script>
</body>
</html>
