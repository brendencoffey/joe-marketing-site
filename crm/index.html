<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>joe CRM</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root { --joe-black: #1a1a1a; --joe-dark: #2d2d2d; --joe-gray: #6b7280; --joe-light: #f3f4f6; --joe-white: #ffffff; --joe-accent: #f59e0b; --joe-green: #10b981; --joe-red: #ef4444; --joe-blue: #3b82f6; --joe-purple: #8b5cf6; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--joe-light); color: var(--joe-black); min-height: 100vh; }
    .auth-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, var(--joe-black) 0%, var(--joe-dark) 100%); color: white; }
    .auth-screen img { height: 60px; margin-bottom: 24px; }
    .auth-screen h1 { font-size: 2rem; margin-bottom: 8px; }
    .auth-screen p { color: var(--joe-gray); margin-bottom: 24px; }
    .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
    .btn-primary { background: var(--joe-accent); color: var(--joe-black); }
    .btn-primary:hover { background: #d97706; }
    .btn-secondary { background: var(--joe-dark); color: white; border: 1px solid var(--joe-gray); }
    .btn-google { background: white; color: #333; padding: 14px 28px; font-size: 15px; }
    .btn-google:hover { background: #f5f5f5; }
    .btn-small { padding: 6px 12px; font-size: 12px; }
    .app { display: none; }
    .app.active { display: flex; min-height: 100vh; }
    .sidebar { width: 240px; background: var(--joe-black); color: white; padding: 20px 0; display: flex; flex-direction: column; flex-shrink: 0; }
    .sidebar-logo { padding: 0 20px 20px; border-bottom: 1px solid var(--joe-dark); margin-bottom: 20px; }
    .sidebar-logo img { height: 32px; }
    .nav-item { padding: 12px 20px; color: var(--joe-gray); cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 10px; }
    .nav-item:hover, .nav-item.active { background: var(--joe-dark); color: white; }
    .nav-item .badge { background: var(--joe-accent); color: var(--joe-black); padding: 2px 6px; border-radius: 10px; font-size: 10px; font-weight: 700; margin-left: auto; }
    .sidebar-user { padding: 16px 20px; border-top: 1px solid var(--joe-dark); margin-top: auto; }
    .user-info { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--joe-accent); display: flex; align-items: center; justify-content: center; font-weight: 600; color: var(--joe-black); font-size: 14px; overflow: hidden; }
    .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .user-details { flex: 1; min-width: 0; }
    .user-name { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-role { font-size: 11px; color: var(--joe-gray); }
    .main { flex: 1; padding: 24px; overflow-y: auto; }
    .page { display: none; }
    .page.active { display: block; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .stat-card h3 { font-size: 11px; text-transform: uppercase; color: var(--joe-gray); margin-bottom: 8px; }
    .stat-card .value { font-size: 28px; font-weight: 700; }
    .stat-card.hot .value { color: var(--joe-accent); }
    .stat-card.green .value { color: var(--joe-green); }
    .stat-card.blue .value { color: var(--joe-blue); }
    .filter-bar { background: white; padding: 16px; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .filter-row { display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-end; }
    .filter-group { display: flex; flex-direction: column; gap: 4px; }
    .filter-group label { font-size: 11px; text-transform: uppercase; color: var(--joe-gray); font-weight: 600; }
    .filter-group select { padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px; min-width: 140px; }
    .table-container { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 14px 16px; background: var(--joe-light); font-size: 12px; text-transform: uppercase; color: var(--joe-gray); font-weight: 600; cursor: pointer; }
    td { padding: 14px 16px; border-top: 1px solid var(--joe-light); font-size: 14px; }
    tr:hover { background: #fafafa; }
    .shop-name { font-weight: 600; color: var(--joe-black); cursor: pointer; }
    .shop-name:hover { color: var(--joe-accent); }
    .score { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .score.hot { background: #fef3c7; color: #92400e; }
    .score.warm { background: #dbeafe; color: #1e40af; }
    .score.cold { background: #e5e7eb; color: #4b5563; }
    .stage-badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
    .stage-new { background: #e5e7eb; color: #4b5563; }
    .stage-contacted { background: #dbeafe; color: #1e40af; }
    .stage-qualified { background: #fef3c7; color: #92400e; }
    .stage-demo_scheduled { background: #d1fae5; color: #065f46; }
    .stage-proposal { background: #ede9fe; color: #5b21b6; }
    .stage-closed_won { background: #10b981; color: white; }
    .stage-closed_lost { background: #ef4444; color: white; }
    .actions-cell { display: flex; gap: 8px; }
    .action-btn { width: 32px; height: 32px; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; background: var(--joe-light); color: var(--joe-gray); text-decoration: none; }
    .action-btn:hover { background: var(--joe-accent); color: var(--joe-black); }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .modal-overlay.open { display: flex; }
    .modal { background: white; border-radius: 16px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; }
    .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--joe-light); display: flex; justify-content: space-between; align-items: center; }
    .modal-header h2 { font-size: 18px; }
    .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--joe-gray); }
    .modal-body { padding: 24px; }
    .modal-tabs { display: flex; gap: 4px; margin-bottom: 20px; border-bottom: 1px solid var(--joe-light); }
    .modal-tab { padding: 10px 16px; background: none; border: none; font-size: 14px; font-weight: 500; color: var(--joe-gray); cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -1px; }
    .modal-tab.active { color: var(--joe-black); border-bottom-color: var(--joe-accent); }
    .modal-tab-content { display: none; }
    .modal-tab-content.active { display: block; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-group.full { grid-column: 1 / -1; }
    .form-group label { font-size: 12px; font-weight: 600; color: var(--joe-gray); }
    .form-group input, .form-group select, .form-group textarea { padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; }
    .form-group textarea { min-height: 80px; resize: vertical; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid var(--joe-light); display: flex; justify-content: flex-end; gap: 12px; }
    .log-activity-btn { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
    .log-btn { padding: 8px 12px; border: 1px solid #e5e7eb; background: white; border-radius: 6px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 6px; }
    .log-btn:hover { background: var(--joe-light); }
    .log-btn.call { border-color: var(--joe-green); color: var(--joe-green); }
    .log-btn.email { border-color: var(--joe-blue); color: var(--joe-blue); }
    .log-btn.meeting { border-color: var(--joe-purple); color: var(--joe-purple); }
    .activity-form { background: var(--joe-light); padding: 16px; border-radius: 8px; margin-bottom: 16px; display: none; }
    .activity-form.visible { display: block; }
    .activity-form-row { display: flex; gap: 12px; margin-bottom: 12px; }
    .activity-form-row .form-group { flex: 1; margin: 0; }
    .activity-list { max-height: 300px; overflow-y: auto; }
    .activity-item { display: flex; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--joe-light); }
    .activity-icon { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; }
    .activity-icon.call { background: #d1fae5; }
    .activity-icon.email { background: #dbeafe; }
    .activity-icon.meeting { background: #ede9fe; }
    .activity-icon.note { background: #e5e7eb; }
    .activity-content { flex: 1; }
    .activity-header { display: flex; justify-content: space-between; margin-bottom: 4px; }
    .activity-type { font-weight: 600; font-size: 13px; }
    .activity-outcome { font-size: 11px; padding: 2px 6px; border-radius: 4px; background: var(--joe-light); }
    .activity-outcome.connected { background: #d1fae5; color: #065f46; }
    .activity-outcome.interested { background: #fef3c7; color: #92400e; }
    .activity-notes { font-size: 13px; color: var(--joe-gray); margin-bottom: 4px; }
    .activity-meta { font-size: 11px; color: var(--joe-gray); }
    .empty-activities { text-align: center; padding: 24px; color: var(--joe-gray); }
    .pipeline-container { display: flex; gap: 16px; overflow-x: auto; padding-bottom: 16px; }
    .pipeline-column { min-width: 280px; background: var(--joe-light); border-radius: 12px; padding: 16px; }
    .pipeline-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .pipeline-header h3 { font-size: 14px; text-transform: uppercase; color: var(--joe-gray); }
    .pipeline-count { background: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: 600; }
    .pipeline-cards { display: flex; flex-direction: column; gap: 8px; min-height: 100px; }
    .pipeline-card { background: white; padding: 12px; border-radius: 8px; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .pipeline-card h4 { font-size: 14px; margin-bottom: 4px; }
    .pipeline-card .meta { font-size: 12px; color: var(--joe-gray); }
    .map-section { margin-bottom: 16px; }
    .map-toggle-btn { display: flex; align-items: center; gap: 8px; padding: 8px 16px; background: var(--joe-black); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; margin-bottom: 12px; }
    .map-toggle-btn.collapsed { background: white; color: var(--joe-black); border: 1px solid #e5e7eb; }
    .map-wrapper { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .map-wrapper.collapsed { display: none; }
    .map-container { height: 350px; position: relative; }
    #shops-map { width: 100%; height: 100%; }
    .toast { position: fixed; bottom: 24px; right: 24px; background: var(--joe-black); color: white; padding: 12px 20px; border-radius: 8px; display: none; z-index: 2000; }
    .toast.show { display: block; }
    .toast.success { background: var(--joe-green); }
    .toast.error { background: var(--joe-red); }
    .auth-error { background: rgba(239,68,68,0.1); border: 1px solid var(--joe-red); padding: 12px 20px; border-radius: 8px; margin-top: 16px; color: var(--joe-red); font-size: 14px; display: none; }
    .results-count { font-size: 14px; color: var(--joe-gray); margin-left: auto; }
  </style>
</head>
<body>
  <div class="auth-screen" id="authScreen">
    <img src="https://4591743.fs1.hubspotusercontent-na1.net/hubfs/4591743/Black.png" alt="joe">
    <h1>joe CRM</h1>
    <p>Partner Growth Console</p>
    <button class="btn btn-google" onclick="netlifyIdentity.open()">Sign in with Google</button>
    <div class="auth-error" id="auth-error">Only @joe.coffee accounts can access the CRM.</div>
  </div>

  <div class="app" id="app">
    <aside class="sidebar">
      <div class="sidebar-logo"><a href="https://joe.coffee"><img src="https://4591743.fs1.hubspotusercontent-na1.net/hubfs/4591743/Black.png" alt="joe"></a></div>
      <div class="nav-item active" data-page="dashboard">üìä Dashboard</div>
      <div class="nav-item" data-page="pipeline">üéØ Pipeline</div>
      <div class="nav-item" data-page="shops">‚òï All Shops</div>
      <div class="nav-item" data-page="activity">üìû Activity <span class="badge" id="today-count">0</span></div>
      <div class="sidebar-user">
        <div class="user-info">
          <div class="user-avatar" id="user-avatar">?</div>
          <div class="user-details"><div class="user-name" id="user-name">Loading...</div><div class="user-role">Partner Growth</div></div>
        </div>
        <button class="btn btn-secondary btn-small" style="width:100%;" onclick="signOut()">Sign Out</button>
      </div>
    </aside>

    <main class="main">
      <section class="page active" id="page-dashboard">
        <h1 style="margin-bottom:24px;">Dashboard</h1>
        <div class="stats-grid">
          <div class="stat-card"><h3>Total Shops</h3><div class="value" id="stat-total">-</div></div>
          <div class="stat-card hot"><h3>Hot Leads</h3><div class="value" id="stat-hot">-</div></div>
          <div class="stat-card blue"><h3>In Pipeline</h3><div class="value" id="stat-pipeline">-</div></div>
          <div class="stat-card green"><h3>Partners</h3><div class="value" id="stat-partners">-</div></div>
          <div class="stat-card"><h3>My Today</h3><div class="value" id="stat-today">-</div></div>
          <div class="stat-card"><h3>Follow-ups</h3><div class="value" id="stat-followups">-</div></div>
        </div>
        <h2 style="margin-bottom:16px;">üî• Hot Leads</h2>
        <div class="table-container">
          <table><thead><tr><th>Shop</th><th>Location</th><th>Score</th><th>Last Contact</th></tr></thead>
          <tbody id="hot-leads-table"><tr><td colspan="4">Loading...</td></tr></tbody></table>
        </div>
      </section>

      <section class="page" id="page-pipeline">
        <h1 style="margin-bottom:24px;">Pipeline</h1>
        <div class="pipeline-container" id="pipeline-container"></div>
      </section>

      <section class="page" id="page-shops">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <h1>All Shops</h1>
          <button class="btn btn-primary" onclick="openAddModal()">+ Add Shop</button>
        </div>
        <div class="filter-bar">
          <div class="filter-row">
            <div class="filter-group"><label>City</label><select id="city-filter" onchange="applyFilters()"><option value="">All Cities</option></select></div>
            <div class="filter-group"><label>State</label><select id="state-filter" onchange="applyFilters()"><option value="">All States</option></select></div>
            <div class="filter-group"><label>Stage</label><select id="stage-filter" onchange="applyFilters()"><option value="">All Stages</option></select></div>
            <div class="filter-group"><label>Score</label><select id="score-filter" onchange="applyFilters()"><option value="">Any</option><option value="80">80+</option><option value="60">60+</option></select></div>
            <span class="results-count" id="results-count">0 shops</span>
          </div>
        </div>
        <div class="map-section">
          <button class="map-toggle-btn" id="map-toggle-btn" onclick="toggleMap()">‚ñº üó∫Ô∏è Map</button>
          <div class="map-wrapper" id="map-wrapper"><div class="map-container"><div id="shops-map"></div></div></div>
        </div>
        <div class="table-container">
          <table><thead><tr><th onclick="sortBy('name')">Shop</th><th onclick="sortBy('city')">Location</th><th onclick="sortBy('lead_score')">Score</th><th onclick="sortBy('pipeline_stage')">Stage</th><th>Last Contact</th><th>Actions</th></tr></thead>
          <tbody id="shops-table"><tr><td colspan="6">Loading...</td></tr></tbody></table>
        </div>
      </section>

      <section class="page" id="page-activity">
        <h1 style="margin-bottom:24px;">üìû Activity Feed</h1>
        <div class="filter-bar">
          <div class="filter-row">
            <div class="filter-group"><label>Type</label><select id="act-type-filter" onchange="renderActivityFeed()"><option value="">All</option><option value="call">Calls</option><option value="email">Emails</option><option value="meeting">Meetings</option></select></div>
            <div class="filter-group"><label>Team</label><select id="act-member-filter" onchange="renderActivityFeed()"><option value="">Everyone</option><option value="me">Mine</option></select></div>
          </div>
        </div>
        <div class="table-container" style="padding:20px;"><div id="activity-feed"></div></div>
      </section>
    </main>
  </div>

  <div class="modal-overlay" id="shop-modal">
    <div class="modal">
      <div class="modal-header"><h2 id="modal-title">Shop</h2><button class="modal-close" onclick="closeModal()">&times;</button></div>
      <div class="modal-body">
        <div class="modal-tabs">
          <button class="modal-tab active" onclick="switchTab('details')">Details</button>
          <button class="modal-tab" onclick="switchTab('activity')">Activity <span id="act-count"></span></button>
        </div>
        <div class="modal-tab-content active" id="tab-details">
          <div class="form-grid">
            <div class="form-group"><label>Name</label><input type="text" id="shop-name"></div>
            <div class="form-group"><label>Stage</label><select id="shop-stage"><option value="new">New</option><option value="contacted">Contacted</option><option value="qualified">Qualified</option><option value="demo_scheduled">Demo Scheduled</option><option value="proposal">Proposal</option><option value="closed_won">Closed Won</option><option value="closed_lost">Closed Lost</option></select></div>
            <div class="form-group"><label>City</label><input type="text" id="shop-city"></div>
            <div class="form-group"><label>State</label><input type="text" id="shop-state"></div>
            <div class="form-group"><label>Phone</label><input type="tel" id="shop-phone"></div>
            <div class="form-group"><label>Email</label><input type="email" id="shop-email"></div>
            <div class="form-group"><label>Website</label><input type="url" id="shop-website"></div>
            <div class="form-group"><label>Contact</label><input type="text" id="shop-contact"></div>
            <div class="form-group full"><label>Notes</label><textarea id="shop-notes"></textarea></div>
          </div>
        </div>
        <div class="modal-tab-content" id="tab-activity">
          <div class="log-activity-btn">
            <button class="log-btn call" onclick="showActForm('call')">üìû Log Call</button>
            <button class="log-btn email" onclick="showActForm('email')">‚úâÔ∏è Log Email</button>
            <button class="log-btn meeting" onclick="showActForm('meeting')">ü§ù Log Meeting</button>
            <button class="log-btn" onclick="showActForm('note')">üìù Note</button>
          </div>
          <div class="activity-form" id="act-form">
            <input type="hidden" id="act-type">
            <div class="activity-form-row">
              <div class="form-group"><label>Outcome</label><select id="act-outcome"><option value="">Select...</option><option value="connected">Connected</option><option value="voicemail">Voicemail</option><option value="no_answer">No Answer</option><option value="interested">Interested</option><option value="not_interested">Not Interested</option><option value="follow_up">Follow-up Needed</option></select></div>
              <div class="form-group"><label>Follow-up</label><input type="date" id="act-followup"></div>
            </div>
            <div class="form-group"><label>Notes</label><textarea id="act-notes" placeholder="What happened?"></textarea></div>
            <div style="display:flex;gap:8px;justify-content:flex-end;">
              <button class="btn btn-secondary btn-small" onclick="hideActForm()">Cancel</button>
              <button class="btn btn-primary btn-small" onclick="saveActivity()">Save</button>
            </div>
          </div>
          <div class="activity-list" id="shop-activities"><div class="empty-activities">No activities yet</div></div>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveShop()">Save</button></div>
    </div>
  </div>

  <div class="modal-overlay" id="add-modal">
    <div class="modal">
      <div class="modal-header"><h2>Add Shop</h2><button class="modal-close" onclick="closeAddModal()">&times;</button></div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-group"><label>Name *</label><input type="text" id="add-name"></div>
          <div class="form-group"><label>City</label><input type="text" id="add-city"></div>
          <div class="form-group"><label>State</label><input type="text" id="add-state"></div>
          <div class="form-group"><label>Phone</label><input type="tel" id="add-phone"></div>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeAddModal()">Cancel</button><button class="btn btn-primary" onclick="addShop()">Add</button></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const SUPABASE_URL='https://vpnoaxpmhuknyaxcyxsu.supabase.co';
    const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZwbm9heHBtaHVrbnlheGN5eHN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NjkzNTMsImV4cCI6MjA4MjQ0NTM1M30.0JVwCaY-3nUHuJk49ibifQviT0LxBSdYXMslw9WIr9M';
    const MAPBOX='pk.eyJ1IjoiYnJlbmRlbmNvZmZleSIsImEiOiJjbTVycXk4anEwMHU2MnFwdHBtZmVtcHc3In0.INjjBnfpRPl4pv-2NcRB-A';
    const db=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
    mapboxgl.accessToken=MAPBOX;

    let shops=[],activities=[],currentUser=null,currentShopId=null,map=null,mapMarkers=[],mapVisible=true;
    let currentSort={field:'lead_score',direction:'desc'};
    const STAGES=[{id:'new',label:'New'},{id:'contacted',label:'Contacted'},{id:'qualified',label:'Qualified'},{id:'demo_scheduled',label:'Demo'},{id:'proposal',label:'Proposal'},{id:'closed_won',label:'Won'},{id:'closed_lost',label:'Lost'}];
    const ICONS={call:'üìû',email:'‚úâÔ∏è',meeting:'ü§ù',note:'üìù'};

    netlifyIdentity.on('init',u=>{if(u)handleLogin(u);});
    netlifyIdentity.on('login',u=>{handleLogin(u);netlifyIdentity.close();});
    netlifyIdentity.on('logout',()=>{document.getElementById('authScreen').style.display='flex';document.getElementById('app').classList.remove('active');currentUser=null;});

    function handleLogin(user){
      const email=user.email||'';
      if(!email.endsWith('@joe.coffee')){document.getElementById('auth-error').style.display='block';netlifyIdentity.logout();return;}
      currentUser={email,name:user.user_metadata?.full_name||email.split('@')[0],avatar:user.user_metadata?.avatar_url};
      document.getElementById('auth-error').style.display='none';
      document.getElementById('authScreen').style.display='none';
      document.getElementById('app').classList.add('active');
      document.getElementById('user-name').textContent=currentUser.name;
      const av=document.getElementById('user-avatar');
      if(currentUser.avatar)av.innerHTML=`<img src="${currentUser.avatar}">`;else av.textContent=currentUser.name[0].toUpperCase();
      ensureTeamMember();loadData();
    }

    async function ensureTeamMember(){if(!currentUser)return;await db.from('team_members').upsert({email:currentUser.email,name:currentUser.name,avatar_url:currentUser.avatar,last_login:new Date().toISOString(),is_active:true},{onConflict:'email'});}
    function signOut(){netlifyIdentity.logout();}

    async function loadData(){
      const{data:s}=await db.from('shops').select('*').order('lead_score',{ascending:false});shops=s||[];
      const{data:a}=await db.from('activities').select('*').order('created_at',{ascending:false}).limit(500);activities=a||[];
      populateFilters();renderDashboard();renderShopsTable();renderPipeline();renderActivityFeed();updateBadge();
    }

    function updateBadge(){const t=new Date().toISOString().split('T')[0];document.getElementById('today-count').textContent=activities.filter(a=>a.created_at.startsWith(t)).length;}

    function populateFilters(){
      const cities=[...new Set(shops.map(s=>s.city).filter(Boolean))].sort();
      document.getElementById('city-filter').innerHTML='<option value="">All Cities</option>'+cities.map(c=>`<option value="${c}">${c}</option>`).join('');
      const states=[...new Set(shops.map(s=>s.state).filter(Boolean))].sort();
      document.getElementById('state-filter').innerHTML='<option value="">All States</option>'+states.map(s=>`<option value="${s}">${s}</option>`).join('');
      document.getElementById('stage-filter').innerHTML='<option value="">All Stages</option>'+STAGES.map(s=>`<option value="${s.id}">${s.label}</option>`).join('');
    }

    function applyFilters(){renderShopsTable();if(map&&mapVisible)renderMapMarkers();}

    function getFilteredShops(){
      const city=document.getElementById('city-filter').value;
      const state=document.getElementById('state-filter').value;
      const stage=document.getElementById('stage-filter').value;
      const score=document.getElementById('score-filter').value;
      return shops.filter(s=>{
        if(city&&s.city!==city)return false;
        if(state&&s.state!==state)return false;
        if(stage&&s.pipeline_stage!==stage)return false;
        if(score&&(s.lead_score||0)<parseInt(score))return false;
        return true;
      });
    }

    function sortBy(f){if(currentSort.field===f)currentSort.direction=currentSort.direction==='asc'?'desc':'asc';else{currentSort.field=f;currentSort.direction='desc';}renderShopsTable();}

    function getSorted(list){
      return[...list].sort((a,b)=>{
        let av=a[currentSort.field]||'',bv=b[currentSort.field]||'';
        if(typeof av==='string'){av=av.toLowerCase();bv=bv.toLowerCase();}
        if(av<bv)return currentSort.direction==='asc'?-1:1;
        if(av>bv)return currentSort.direction==='asc'?1:-1;
        return 0;
      });
    }

    function renderDashboard(){
      document.getElementById('stat-total').textContent=shops.length;
      document.getElementById('stat-hot').textContent=shops.filter(s=>s.lead_score>=80).length;
      document.getElementById('stat-pipeline').textContent=shops.filter(s=>!['new','closed_won','closed_lost'].includes(s.pipeline_stage)).length;
      document.getElementById('stat-partners').textContent=shops.filter(s=>s.pipeline_stage==='closed_won').length;
      const t=new Date().toISOString().split('T')[0];
      document.getElementById('stat-today').textContent=currentUser?activities.filter(a=>a.team_member_email===currentUser.email&&a.created_at.startsWith(t)).length:0;
      document.getElementById('stat-followups').textContent=activities.filter(a=>a.follow_up_date&&!a.follow_up_completed&&new Date(a.follow_up_date)<=new Date()).length;
      const hot=shops.filter(s=>s.lead_score>=80).slice(0,10);
      document.getElementById('hot-leads-table').innerHTML=hot.length?hot.map(s=>`<tr><td><span class="shop-name" onclick="openShopModal('${s.id}')">${s.name}</span></td><td>${s.city||''}, ${s.state||''}</td><td><span class="score hot">${s.lead_score}</span></td><td>${s.last_contacted_at?formatDate(s.last_contacted_at):'Never'}</td></tr>`).join(''):'<tr><td colspan="4">No hot leads</td></tr>';
    }

    function renderShopsTable(){
      const f=getFilteredShops(),sorted=getSorted(f);
      document.getElementById('results-count').textContent=`${sorted.length} shops`;
      document.getElementById('shops-table').innerHTML=sorted.length?sorted.map(s=>`<tr><td><span class="shop-name" onclick="openShopModal('${s.id}')">${s.name}</span></td><td>${s.city||''}, ${s.state||''}</td><td><span class="score ${s.lead_score>=80?'hot':s.lead_score>=60?'warm':'cold'}">${s.lead_score||50}</span></td><td><span class="stage-badge stage-${s.pipeline_stage||'new'}">${STAGES.find(st=>st.id===s.pipeline_stage)?.label||'New'}</span></td><td>${s.last_contacted_at?formatDate(s.last_contacted_at):'Never'}</td><td class="actions-cell"><button class="action-btn" onclick="openShopModal('${s.id}')">üëÅÔ∏è</button>${s.phone?`<a class="action-btn" href="tel:${s.phone}">üìû</a>`:''}</td></tr>`).join(''):'<tr><td colspan="6">No shops</td></tr>';
    }

    function renderPipeline(){
      document.getElementById('pipeline-container').innerHTML=STAGES.map(st=>{
        const ss=shops.filter(s=>s.pipeline_stage===st.id);
        return`<div class="pipeline-column"><div class="pipeline-header"><h3>${st.label}</h3><span class="pipeline-count">${ss.length}</span></div><div class="pipeline-cards" ondrop="handleDrop(event,'${st.id}')" ondragover="event.preventDefault()">${ss.slice(0,15).map(s=>`<div class="pipeline-card" draggable="true" ondragstart="dragStart(event,'${s.id}')" onclick="openShopModal('${s.id}')"><h4>${s.name}</h4><div class="meta">${s.city||''} ‚Ä¢ ${s.lead_score||50}</div></div>`).join('')}</div></div>`;
      }).join('');
    }

    let dragId=null;
    function dragStart(e,id){dragId=id;}
    async function handleDrop(e,stage){
      e.preventDefault();if(!dragId)return;
      const shop=shops.find(s=>s.id===dragId);
      if(shop&&shop.pipeline_stage!==stage){await db.from('shops').update({pipeline_stage:stage}).eq('id',dragId);shop.pipeline_stage=stage;renderPipeline();renderShopsTable();showToast('Updated');}
      dragId=null;
    }

    function renderActivityFeed(){
      const type=document.getElementById('act-type-filter')?.value;
      const member=document.getElementById('act-member-filter')?.value;
      let f=[...activities];
      if(type)f=f.filter(a=>a.activity_type===type);
      if(member==='me'&&currentUser)f=f.filter(a=>a.team_member_email===currentUser.email);
      document.getElementById('activity-feed').innerHTML=f.length?f.slice(0,50).map(a=>{
        const shop=shops.find(s=>s.id===a.shop_id);
        return`<div class="activity-item" onclick="openShopModal('${a.shop_id}')" style="cursor:pointer;"><div class="activity-icon ${a.activity_type}">${ICONS[a.activity_type]||'üìã'}</div><div class="activity-content"><div class="activity-header"><span class="activity-type">${shop?.name||'Shop'} - ${a.activity_type}</span>${a.outcome?`<span class="activity-outcome ${a.outcome}">${a.outcome}</span>`:''}</div>${a.notes?`<div class="activity-notes">${a.notes}</div>`:''}<div class="activity-meta">${a.team_member_name} ‚Ä¢ ${formatDate(a.created_at)}</div></div></div>`;
      }).join(''):'<div class="empty-activities">No activities</div>';
    }

    function formatDate(d){
      const diff=Date.now()-new Date(d);
      if(diff<60000)return'Just now';if(diff<3600000)return`${Math.floor(diff/60000)}m`;if(diff<86400000)return`${Math.floor(diff/3600000)}h`;if(diff<604800000)return`${Math.floor(diff/86400000)}d`;
      return new Date(d).toLocaleDateString();
    }

    function toggleMap(){mapVisible=!mapVisible;document.getElementById('map-wrapper').classList.toggle('collapsed',!mapVisible);document.getElementById('map-toggle-btn').classList.toggle('collapsed',!mapVisible);if(mapVisible)setTimeout(()=>{initMap();if(map){map.resize();renderMapMarkers();}},100);}

    function initMap(){if(map)return;map=new mapboxgl.Map({container:'shops-map',style:'mapbox://styles/mapbox/light-v11',center:[-98.5795,39.8283],zoom:3.5});map.addControl(new mapboxgl.NavigationControl(),'top-left');map.on('load',renderMapMarkers);}

    function renderMapMarkers(){
      if(!map)return;mapMarkers.forEach(m=>m.remove());mapMarkers=[];
      const f=getFilteredShops().filter(s=>s.lat&&s.lng);
      f.forEach(s=>{
        const color=s.lead_score>=80?'#f59e0b':s.lead_score>=60?'#3b82f6':'#6b7280';
        const el=document.createElement('div');el.style.cssText=`width:16px;height:16px;background:${color};border:2px solid white;border-radius:50%;cursor:pointer;`;
        const popup=new mapboxgl.Popup({offset:15}).setHTML(`<strong>${s.name}</strong><br><small>${s.city}</small>`);
        mapMarkers.push(new mapboxgl.Marker(el).setLngLat([parseFloat(s.lng),parseFloat(s.lat)]).setPopup(popup).addTo(map));
      });
      if(f.length){const b=new mapboxgl.LngLatBounds();f.forEach(s=>b.extend([parseFloat(s.lng),parseFloat(s.lat)]));map.fitBounds(b,{padding:50,maxZoom:12});}
    }

    function switchTab(t){document.querySelectorAll('.modal-tab').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.modal-tab-content').forEach(x=>x.classList.remove('active'));document.querySelector(`.modal-tab[onclick="switchTab('${t}')"]`).classList.add('active');document.getElementById(`tab-${t}`).classList.add('active');}

    function openShopModal(id){
      currentShopId=id;const s=shops.find(x=>x.id===id);if(!s)return;
      switchTab('details');hideActForm();
      document.getElementById('modal-title').textContent=s.name;
      document.getElementById('shop-name').value=s.name||'';
      document.getElementById('shop-stage').value=s.pipeline_stage||'new';
      document.getElementById('shop-city').value=s.city||'';
      document.getElementById('shop-state').value=s.state||'';
      document.getElementById('shop-phone').value=s.phone||'';
      document.getElementById('shop-email').value=s.email||'';
      document.getElementById('shop-website').value=s.website||'';
      document.getElementById('shop-contact').value=s.contact_name||'';
      document.getElementById('shop-notes').value=s.notes||'';
      renderShopActivities(id);
      document.getElementById('shop-modal').classList.add('open');
    }

    function closeModal(){document.getElementById('shop-modal').classList.remove('open');currentShopId=null;}

    function renderShopActivities(id){
      const sa=activities.filter(a=>a.shop_id===id);
      document.getElementById('act-count').textContent=`(${sa.length})`;
      document.getElementById('shop-activities').innerHTML=sa.length?sa.slice(0,20).map(a=>`<div class="activity-item"><div class="activity-icon ${a.activity_type}">${ICONS[a.activity_type]||'üìã'}</div><div class="activity-content"><div class="activity-header"><span class="activity-type">${a.activity_type}</span>${a.outcome?`<span class="activity-outcome ${a.outcome}">${a.outcome}</span>`:''}</div>${a.notes?`<div class="activity-notes">${a.notes}</div>`:''}<div class="activity-meta">${a.team_member_name} ‚Ä¢ ${formatDate(a.created_at)}</div></div></div>`).join(''):'<div class="empty-activities">No activities yet</div>';
    }

    function showActForm(type){document.getElementById('act-type').value=type;document.getElementById('act-outcome').value='';document.getElementById('act-followup').value='';document.getElementById('act-notes').value='';document.getElementById('act-form').classList.add('visible');}
    function hideActForm(){document.getElementById('act-form').classList.remove('visible');}

    async function saveActivity(){
      if(!currentShopId||!currentUser)return;
      const act={shop_id:currentShopId,team_member_email:currentUser.email,team_member_name:currentUser.name,activity_type:document.getElementById('act-type').value,outcome:document.getElementById('act-outcome').value||null,notes:document.getElementById('act-notes').value,follow_up_date:document.getElementById('act-followup').value||null};
      const{data,error}=await db.from('activities').insert([act]).select().single();
      if(!error){activities.unshift(data);hideActForm();renderShopActivities(currentShopId);updateBadge();
        const shop=shops.find(s=>s.id===currentShopId);
        if(shop&&shop.pipeline_stage==='new'&&['call','email','meeting'].includes(act.activity_type)){await db.from('shops').update({pipeline_stage:'contacted'}).eq('id',currentShopId);shop.pipeline_stage='contacted';document.getElementById('shop-stage').value='contacted';}
        showToast('Logged!');}else showToast('Error','error');
    }

    async function saveShop(){
      if(!currentShopId)return;
      const u={name:document.getElementById('shop-name').value,pipeline_stage:document.getElementById('shop-stage').value,city:document.getElementById('shop-city').value,state:document.getElementById('shop-state').value,phone:document.getElementById('shop-phone').value,email:document.getElementById('shop-email').value,website:document.getElementById('shop-website').value,contact_name:document.getElementById('shop-contact').value,notes:document.getElementById('shop-notes').value};
      const{error}=await db.from('shops').update(u).eq('id',currentShopId);
      if(!error){Object.assign(shops.find(s=>s.id===currentShopId),u);closeModal();renderDashboard();renderShopsTable();renderPipeline();showToast('Saved!');}else showToast('Error','error');
    }

    function openAddModal(){document.getElementById('add-modal').classList.add('open');}
    function closeAddModal(){document.getElementById('add-modal').classList.remove('open');}

    async function addShop(){
      const name=document.getElementById('add-name').value.trim();if(!name){showToast('Name required','error');return;}
      const{data,error}=await db.from('shops').insert([{name,city:document.getElementById('add-city').value,state:document.getElementById('add-state').value,phone:document.getElementById('add-phone').value,pipeline_stage:'new',lead_score:50}]).select().single();
      if(!error){shops.unshift(data);closeAddModal();populateFilters();renderDashboard();renderShopsTable();renderPipeline();showToast('Added!');}
    }

    document.querySelectorAll('.nav-item').forEach(item=>{
      item.addEventListener('click',()=>{
        document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        item.classList.add('active');
        document.getElementById(`page-${item.dataset.page}`).classList.add('active');
        if(item.dataset.page==='shops'&&mapVisible)setTimeout(()=>{initMap();if(map){map.resize();renderMapMarkers();}},100);
        if(item.dataset.page==='activity')renderActivityFeed();
      });
    });

    function showToast(m,type='success'){const t=document.getElementById('toast');t.textContent=m;t.className=`toast show ${type}`;setTimeout(()=>t.classList.remove('show'),3000);}

    netlifyIdentity.init();
  </script>
</body>
</html>
