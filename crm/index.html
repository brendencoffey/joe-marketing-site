<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>joe CRM</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root{--joe-black:#1a1a1a;--joe-dark:#2d2d2d;--joe-gray:#6b7280;--joe-light:#f3f4f6;--joe-accent:#f59e0b;--joe-green:#10b981;--joe-red:#ef4444;--joe-blue:#3b82f6;--joe-purple:#8b5cf6}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--joe-light);color:var(--joe-black);min-height:100vh}
    .auth-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,var(--joe-black),var(--joe-dark));color:#fff}
    .auth-screen img{height:60px;margin-bottom:24px}
    .btn{padding:10px 20px;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:6px;transition:all .2s}
    .btn-primary{background:var(--joe-accent);color:var(--joe-black)}
    .btn-primary:hover{background:#d97706}
    .btn-secondary{background:var(--joe-dark);color:#fff;border:1px solid var(--joe-gray)}
    .btn-success{background:var(--joe-green);color:#fff}
    .btn-small{padding:6px 12px;font-size:12px}
    .btn-google{background:#fff;color:#333;padding:14px 28px}
    .app{display:none}.app.active{display:flex;min-height:100vh}
    .sidebar{width:220px;background:var(--joe-black);color:#fff;padding:20px 0;display:flex;flex-direction:column;flex-shrink:0}
    .sidebar-logo{padding:0 20px 20px;border-bottom:1px solid var(--joe-dark);margin-bottom:20px}
    .sidebar-logo img{height:32px}
    .nav-section{padding:0 12px;margin-bottom:8px}
    .nav-section-title{font-size:10px;text-transform:uppercase;color:var(--joe-gray);padding:8px;letter-spacing:.5px}
    .nav-item{padding:10px 12px;color:var(--joe-gray);cursor:pointer;display:flex;align-items:center;gap:10px;border-radius:6px;font-size:14px;margin-bottom:2px}
    .nav-item:hover,.nav-item.active{background:var(--joe-dark);color:#fff}
    .nav-item .badge{background:var(--joe-accent);color:var(--joe-black);padding:2px 6px;border-radius:10px;font-size:10px;font-weight:700;margin-left:auto}
    .nav-item .badge.red{background:var(--joe-red);color:#fff}
    .nav-item .badge.purple{background:var(--joe-purple);color:#fff}
    .sidebar-user{padding:16px 20px;border-top:1px solid var(--joe-dark);margin-top:auto}
    .user-info{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .user-avatar{width:32px;height:32px;border-radius:50%;background:var(--joe-accent);display:flex;align-items:center;justify-content:center;font-weight:600;font-size:12px;overflow:hidden}
    .user-avatar img{width:100%;height:100%;object-fit:cover}
    .user-name{font-size:13px;font-weight:600}
    .user-role{font-size:10px;color:var(--joe-gray)}
    .main{flex:1;padding:24px;overflow-y:auto}
    .page{display:none}.page.active{display:block}
    .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px}
    .page-header h1{font-size:24px}
    
    /* AI Copilot */
    .ai-copilot{background:linear-gradient(135deg,var(--joe-black),var(--joe-dark));border-radius:16px;padding:20px;margin-bottom:24px;color:#fff}
    .ai-header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
    .ai-header h2{font-size:18px}
    .ai-badge{background:var(--joe-accent);color:var(--joe-black);padding:2px 8px;border-radius:10px;font-size:10px;font-weight:700}
    .ai-input-container{display:flex;gap:12px}
    .ai-input{flex:1;padding:14px 18px;border:none;border-radius:12px;font-size:15px;background:rgba(255,255,255,.1);color:#fff;outline:none}
    .ai-input::placeholder{color:rgba(255,255,255,.5)}
    .ai-submit{padding:14px 24px;background:var(--joe-accent);color:var(--joe-black);border:none;border-radius:12px;font-weight:600;cursor:pointer}
    .ai-suggestions{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .ai-suggestion{background:rgba(255,255,255,.1);border:none;padding:6px 12px;border-radius:20px;color:rgba(255,255,255,.8);font-size:12px;cursor:pointer}
    .ai-suggestion:hover{background:rgba(255,255,255,.2)}
    .ai-response{margin-top:16px;padding:16px;background:rgba(255,255,255,.05);border-radius:12px;display:none}
    .ai-response.visible{display:block}
    .ai-response-header{display:flex;align-items:center;gap:8px;margin-bottom:12px;font-size:12px;color:var(--joe-accent);text-transform:uppercase;font-weight:600}
    .ai-response-content{font-size:14px;line-height:1.6}
    
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:24px}
    .stat-card{background:#fff;padding:16px;border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,.1);cursor:pointer;transition:transform .1s}
    .stat-card:hover{transform:translateY(-2px)}
    .stat-card h3{font-size:10px;text-transform:uppercase;color:var(--joe-gray);margin-bottom:6px}
    .stat-card .value{font-size:24px;font-weight:700}
    .stat-card.accent .value{color:var(--joe-accent)}
    .stat-card.green .value{color:var(--joe-green)}
    .stat-card.red .value{color:var(--joe-red)}
    .stat-card.blue .value{color:var(--joe-blue)}
    .stat-card.purple .value{color:var(--joe-purple)}
    .card{background:#fff;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.1);overflow:hidden;margin-bottom:20px}
    .card-header{padding:16px 20px;border-bottom:1px solid var(--joe-light);display:flex;justify-content:space-between;align-items:center}
    .card-header h2{font-size:16px}
    .card-body{padding:20px}
    
    /* Pipeline Reports */
    .reports-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin-bottom:24px}
    @media(max-width:1200px){.reports-grid{grid-template-columns:1fr}}
    
    .funnel-container{padding:20px}
    .funnel-stage{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    .funnel-bar-wrapper{flex:1;position:relative}
    .funnel-bar{height:32px;border-radius:6px;display:flex;align-items:center;padding:0 12px;font-size:12px;font-weight:600;color:#fff;transition:width .5s ease}
    .funnel-bar.new{background:var(--joe-gray)}
    .funnel-bar.contacted{background:var(--joe-blue)}
    .funnel-bar.qualified{background:var(--joe-accent)}
    .funnel-bar.demo_scheduled{background:var(--joe-green)}
    .funnel-bar.proposal{background:var(--joe-purple)}
    .funnel-label{width:80px;font-size:12px;font-weight:600;text-align:right}
    .funnel-count{width:50px;font-size:14px;font-weight:700;text-align:right}
    .funnel-percent{font-size:11px;color:var(--joe-gray);margin-left:8px}
    
    .conversion-list{padding:20px}
    .conversion-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--joe-light)}
    .conversion-row:last-child{border-bottom:none}
    .conversion-stages{font-size:13px;display:flex;align-items:center;gap:8px}
    .conversion-arrow{color:var(--joe-gray)}
    .conversion-rate{font-size:18px;font-weight:700}
    .conversion-rate.good{color:var(--joe-green)}
    .conversion-rate.medium{color:var(--joe-accent)}
    .conversion-rate.low{color:var(--joe-red)}
    
    .activity-summary{padding:20px}
    .activity-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--joe-light)}
    .activity-row:last-child{border-bottom:none}
    .activity-type-label{display:flex;align-items:center;gap:8px;font-size:13px}
    .activity-type-icon{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px}
    .activity-type-icon.call{background:#d1fae5}
    .activity-type-icon.email{background:#dbeafe}
    .activity-type-icon.note{background:#e5e7eb}
    .activity-type-icon.meeting{background:#fef3c7}
    .activity-counts{display:flex;gap:16px;align-items:center}
    .activity-count{text-align:center}
    .activity-count .num{font-size:18px;font-weight:700}
    .activity-count .label{font-size:9px;text-transform:uppercase;color:var(--joe-gray)}
    .activity-trend{font-size:12px;font-weight:600}
    .activity-trend.up{color:var(--joe-green)}
    .activity-trend.down{color:var(--joe-red)}
    .activity-trend.flat{color:var(--joe-gray)}
    
    .location-list{padding:20px}
    .location-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--joe-light)}
    .location-row:last-child{border-bottom:none}
    .location-name{font-size:13px;font-weight:500}
    .location-stats{display:flex;gap:12px;align-items:center}
    .location-hot{background:#fef3c7;color:#92400e;padding:4px 10px;border-radius:20px;font-size:12px;font-weight:600}
    .location-total{font-size:12px;color:var(--joe-gray)}
    
    /* Map */
    .map-section{margin-bottom:16px}
    .map-toggle{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .map-toggle-btn{display:flex;align-items:center;gap:8px;padding:8px 16px;background:var(--joe-black);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer}
    .map-toggle-btn.collapsed{background:#fff;color:var(--joe-black);border:1px solid #e5e7eb}
    .map-wrapper{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.1);transition:all .3s}
    .map-wrapper.collapsed{height:0;opacity:0;margin:0}
    .map-container{height:350px;position:relative}
    #shops-map{width:100%;height:100%}
    .map-legend{position:absolute;bottom:12px;left:12px;background:#fff;padding:10px 14px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.15);z-index:10;font-size:11px}
    .map-legend h4{margin-bottom:6px;font-size:10px;text-transform:uppercase;color:var(--joe-gray)}
    .legend-item{display:flex;align-items:center;gap:6px;margin-bottom:3px}
    .legend-dot{width:10px;height:10px;border-radius:50%}
    .legend-dot.hot{background:#f59e0b}
    .legend-dot.warm{background:#3b82f6}
    .legend-dot.cold{background:#6b7280}
    .map-stats{position:absolute;top:12px;right:12px;background:#fff;padding:10px 14px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.15);z-index:10}
    .map-stats .num{font-size:18px;font-weight:700}
    .map-stats .label{font-size:9px;text-transform:uppercase;color:var(--joe-gray)}
    
    .filter-bar{background:#fff;padding:12px 16px;border-radius:10px;margin-bottom:16px}
    .filter-row{display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end}
    .filter-group{display:flex;flex-direction:column;gap:4px}
    .filter-group>label{font-size:10px;text-transform:uppercase;color:var(--joe-gray);font-weight:600}
    .search-input,.filter-select{padding:8px 12px;border:1px solid #e5e7eb;border-radius:6px;font-size:13px}
    .search-input{width:180px}
    .multi-select{position:relative}
    .multi-select-trigger{padding:8px 12px;border:1px solid #e5e7eb;border-radius:6px;font-size:13px;min-width:130px;background:#fff;cursor:pointer;display:flex;justify-content:space-between;align-items:center;gap:8px}
    .multi-select-dropdown{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #e5e7eb;border-radius:6px;margin-top:4px;max-height:220px;overflow-y:auto;z-index:100;display:none;box-shadow:0 4px 12px rgba(0,0,0,.15)}
    .multi-select-dropdown.open{display:block}
    .multi-select-option{padding:8px 12px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:13px}
    .multi-select-option:hover{background:var(--joe-light)}
    .multi-select-option input{margin:0}
    .filter-tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:12px}
    .filter-tag{background:var(--joe-accent);color:var(--joe-black);padding:4px 10px;border-radius:20px;font-size:11px;font-weight:500;display:flex;align-items:center;gap:6px}
    .filter-tag .remove{cursor:pointer;font-weight:bold}
    .clear-filters{background:none;border:none;color:var(--joe-gray);font-size:12px;cursor:pointer;text-decoration:underline}
    .results-count{font-size:13px;color:var(--joe-gray);margin-left:auto}
    table{width:100%;border-collapse:collapse}
    th{text-align:left;padding:12px 16px;background:var(--joe-light);font-size:11px;text-transform:uppercase;color:var(--joe-gray);cursor:pointer}
    th:hover{background:#e5e7eb}
    td{padding:12px 16px;border-top:1px solid var(--joe-light);font-size:13px}
    tr:hover{background:#fafafa}
    tr.highlight{background:#fef3c7}
    .clickable{cursor:pointer;font-weight:600}.clickable:hover{color:var(--joe-accent)}
    .badge{display:inline-block;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600}
    .badge-gray{background:#e5e7eb;color:#4b5563}
    .badge-blue{background:#dbeafe;color:#1e40af}
    .badge-green{background:#d1fae5;color:#065f46}
    .badge-yellow{background:#fef3c7;color:#92400e}
    .badge-red{background:#fee2e2;color:#991b1b}
    .badge-purple{background:#ede9fe;color:#5b21b6}
    .score{display:inline-block;padding:4px 10px;border-radius:20px;font-size:12px;font-weight:600}
    .score.hot{background:#fef3c7;color:#92400e}
    .score.warm{background:#dbeafe;color:#1e40af}
    .score.cold{background:#e5e7eb;color:#4b5563}
    .stage-badge{display:inline-block;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;text-transform:uppercase}
    .stage-new{background:#e5e7eb;color:#4b5563}
    .stage-contacted{background:#dbeafe;color:#1e40af}
    .stage-qualified{background:#fef3c7;color:#92400e}
    .stage-demo_scheduled{background:#d1fae5;color:#065f46}
    .stage-proposal{background:#ede9fe;color:#5b21b6}
    .stage-closed_won{background:#10b981;color:#fff}
    .stage-closed_lost{background:#ef4444;color:#fff}
    .action-btn{width:28px;height:28px;border:none;border-radius:6px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;background:var(--joe-light);color:var(--joe-gray);font-size:12px;text-decoration:none}
    .action-btn:hover{background:var(--joe-accent);color:var(--joe-black)}
    .actions-cell{display:flex;gap:6px}
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000;padding:20px}
    .modal-overlay.open{display:flex}
    .modal{background:#fff;border-radius:12px;width:100%;max-width:700px;max-height:90vh;overflow-y:auto}
    .modal.wide{max-width:900px}
    .modal-header{padding:16px 20px;border-bottom:1px solid var(--joe-light);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:#fff;z-index:10}
    .modal-close{background:none;border:none;font-size:24px;cursor:pointer;color:var(--joe-gray)}
    .modal-body{padding:20px}
    .modal-tabs{display:flex;gap:4px;margin-bottom:16px;border-bottom:1px solid var(--joe-light);overflow-x:auto}
    .modal-tab{padding:8px 14px;background:none;border:none;font-size:13px;color:var(--joe-gray);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;white-space:nowrap}
    .modal-tab.active{color:var(--joe-black);border-bottom-color:var(--joe-accent)}
    .modal-tab-content{display:none}.modal-tab-content.active{display:block}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .form-group{display:flex;flex-direction:column;gap:4px}
    .form-group.full{grid-column:1/-1}
    .form-group label{font-size:11px;font-weight:600;color:var(--joe-gray);text-transform:uppercase}
    .form-group input,.form-group select,.form-group textarea{padding:10px 12px;border:1px solid #e5e7eb;border-radius:6px;font-size:13px}
    .form-group textarea{min-height:100px;font-family:inherit}
    .modal-footer{padding:14px 20px;border-top:1px solid var(--joe-light);display:flex;justify-content:space-between;gap:10px;position:sticky;bottom:0;background:#fff}
    
    /* Activity */
    .log-activity-btn{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
    .log-btn{padding:8px 12px;border:1px solid #e5e7eb;background:#fff;border-radius:6px;font-size:12px;cursor:pointer;display:flex;align-items:center;gap:6px}
    .log-btn:hover{background:var(--joe-light)}
    .log-btn.call{border-color:var(--joe-green);color:var(--joe-green)}
    .log-btn.email{border-color:var(--joe-blue);color:var(--joe-blue)}
    .activity-form{background:var(--joe-light);padding:12px;border-radius:8px;margin-bottom:12px;display:none}
    .activity-form.visible{display:block}
    .activity-list{max-height:300px;overflow-y:auto}
    .activity-item{display:flex;gap:10px;padding:10px 0;border-bottom:1px solid var(--joe-light)}
    .activity-icon{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0}
    .activity-icon.call{background:#d1fae5}
    .activity-icon.email{background:#dbeafe}
    .activity-icon.note{background:#e5e7eb}
    .activity-content{flex:1;min-width:0}
    .activity-type{font-weight:600;font-size:12px}
    .activity-notes{font-size:12px;color:var(--joe-gray);white-space:pre-wrap}
    .activity-meta{font-size:10px;color:var(--joe-gray);margin-top:2px}
    
    /* Pipeline */
    .pipeline-container{display:flex;gap:12px;overflow-x:auto;padding-bottom:12px}
    .pipeline-column{min-width:220px;background:var(--joe-light);border-radius:10px;padding:12px;flex-shrink:0}
    .pipeline-header{display:flex;justify-content:space-between;margin-bottom:10px}
    .pipeline-header h3{font-size:12px;text-transform:uppercase;color:var(--joe-gray)}
    .pipeline-count{background:#fff;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600}
    .pipeline-card{background:#fff;padding:12px;border-radius:8px;cursor:pointer;margin-bottom:8px;box-shadow:0 1px 2px rgba(0,0,0,.1)}
    .pipeline-card h4{font-size:13px;margin-bottom:4px}
    .pipeline-card .meta{font-size:11px;color:var(--joe-gray)}
    .pipeline-card .amount{font-size:14px;font-weight:600;color:var(--joe-green);margin-top:6px}
    
    /* Sequences */
    .sequence-card{background:#fff;border-radius:10px;padding:16px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    .sequence-card h3{font-size:15px;margin-bottom:4px}
    .sequence-steps{border-top:1px solid var(--joe-light);padding-top:12px;margin-top:12px}
    .sequence-step{display:flex;align-items:flex-start;gap:12px;padding:10px;background:var(--joe-light);border-radius:8px;margin-bottom:8px}
    .step-num{width:24px;height:24px;border-radius:50%;background:var(--joe-black);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;flex-shrink:0}
    .step-content{flex:1;min-width:0}
    .step-type{padding:2px 8px;border-radius:4px;font-size:10px;font-weight:500;display:inline-block}
    .step-type.email{background:#dbeafe;color:#1e40af}
    .step-type.call{background:#d1fae5;color:#065f46}
    .step-delay{font-size:10px;color:var(--joe-gray);margin-left:8px}
    .step-subject{font-size:12px;font-weight:500;margin-top:4px}
    
    /* Tasks */
    .task-item{display:flex;align-items:center;gap:12px;padding:12px;background:#fff;border-radius:8px;margin-bottom:8px;border:1px solid #e5e7eb}
    .task-item.sequence-task{border-left:3px solid var(--joe-purple)}
    .task-checkbox{width:20px;height:20px;border:2px solid #e5e7eb;border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}
    .task-checkbox.done{background:var(--joe-green);border-color:var(--joe-green);color:#fff}
    .task-info{flex:1;min-width:0}
    .task-title{font-size:13px;font-weight:500}
    .task-meta{font-size:11px;color:var(--joe-gray)}
    .task-due{font-size:11px;padding:3px 8px;border-radius:4px;flex-shrink:0}
    .task-due.overdue{background:#fee2e2;color:#991b1b}
    .task-due.today{background:#fef3c7;color:#92400e}
    .task-due.upcoming{background:#e5e7eb;color:#4b5563}
    
    .empty-state{text-align:center;padding:40px;color:var(--joe-gray)}
    .toast{position:fixed;bottom:24px;right:24px;background:var(--joe-black);color:#fff;padding:12px 20px;border-radius:8px;display:none;z-index:2000}
    .toast.show{display:block}
    .toast.success{background:var(--joe-green)}
    .toast.error{background:var(--joe-red)}
    .auth-error{background:rgba(239,68,68,.1);border:1px solid var(--joe-red);padding:12px;border-radius:8px;margin-top:16px;color:var(--joe-red);display:none}
    .quick-actions{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px}
    @media(max-width:768px){.sidebar{width:60px}.sidebar-logo span,.nav-section-title,.nav-item span:not(.badge),.user-info{display:none}.form-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="auth-screen" id="authScreen">
    <img src="https://4591743.fs1.hubspotusercontent-na1.net/hubfs/4591743/Black.png" alt="joe">
    <h1>joe CRM</h1>
    <p style="color:var(--joe-gray);margin-bottom:24px">Partner Growth Console</p>
    <button class="btn btn-google" onclick="netlifyIdentity.open()">Sign in with Google</button>
    <div class="auth-error" id="auth-error">Only @joe.coffee accounts can access.</div>
  </div>

  <div class="app" id="app">
    <aside class="sidebar">
      <div class="sidebar-logo"><img src="https://4591743.fs1.hubspotusercontent-na1.net/hubfs/4591743/Black.png" alt="joe"></div>
      <div class="nav-section">
        <div class="nav-section-title">Overview</div>
        <div class="nav-item active" data-page="dashboard"><span>üìä</span> <span>Dashboard</span></div>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Outbound</div>
        <div class="nav-item" data-page="shops"><span>‚òï</span> <span>Shops</span> <span class="badge" id="shops-badge">0</span></div>
        <div class="nav-item" data-page="pipeline"><span>üéØ</span> <span>Pipeline</span></div>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Inbound</div>
        <div class="nav-item" data-page="leads"><span>üî•</span> <span>New Leads</span> <span class="badge red" id="leads-badge">0</span></div>
        <div class="nav-item" data-page="contacts"><span>üë§</span> <span>Contacts</span></div>
        <div class="nav-item" data-page="companies"><span>üè¢</span> <span>Companies</span></div>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Sales</div>
        <div class="nav-item" data-page="deals"><span>üí∞</span> <span>Deals</span></div>
        <div class="nav-item" data-page="sequences"><span>‚ö°</span> <span>Sequences</span></div>
        <div class="nav-item" data-page="tasks"><span>‚úÖ</span> <span>Tasks</span> <span class="badge purple" id="tasks-badge">0</span></div>
      </div>
      <div class="sidebar-user">
        <div class="user-info">
          <div class="user-avatar" id="user-avatar">?</div>
          <div><div class="user-name" id="user-name">Loading...</div><div class="user-role">Partner Growth</div></div>
        </div>
        <button class="btn btn-secondary btn-small" style="width:100%" onclick="signOut()">Sign Out</button>
      </div>
    </aside>

    <main class="main">
      <!-- Dashboard -->
      <section class="page active" id="page-dashboard">
        <div class="page-header"><h1>Dashboard</h1></div>
        
        <!-- AI Copilot -->
        <div class="ai-copilot">
          <div class="ai-header">
            <span style="font-size:24px">‚òï</span>
            <h2>Ask joe</h2>
            <span class="ai-badge">AI</span>
          </div>
          <div class="ai-input-container">
            <input type="text" class="ai-input" id="ai-input" placeholder="What would you like to know?" onkeypress="if(event.key==='Enter')askJoe()">
            <button class="ai-submit" onclick="askJoe()">Ask</button>
          </div>
          <div class="ai-suggestions">
            <button class="ai-suggestion" onclick="askSuggestion(this)">Who should I call today?</button>
            <button class="ai-suggestion" onclick="askSuggestion(this)">Show me hot leads</button>
            <button class="ai-suggestion" onclick="askSuggestion(this)">Shops needing follow-up</button>
            <button class="ai-suggestion" onclick="askSuggestion(this)">Summarize my pipeline</button>
          </div>
          <div class="ai-response" id="ai-response">
            <div class="ai-response-header"><span>‚òï</span> joe's response</div>
            <div class="ai-response-content" id="ai-response-content"></div>
          </div>
        </div>
        
        <div class="stats-grid">
          <div class="stat-card accent" onclick="navigateTo('shops')"><h3>Total Shops</h3><div class="value" id="stat-shops">-</div></div>
          <div class="stat-card red" onclick="navigateTo('leads')"><h3>New Leads</h3><div class="value" id="stat-leads">-</div></div>
          <div class="stat-card blue" onclick="navigateTo('pipeline')"><h3>Hot (80+)</h3><div class="value" id="stat-hot">-</div></div>
          <div class="stat-card green" onclick="navigateTo('deals')"><h3>Deals Pipeline</h3><div class="value" id="stat-pipeline">-</div></div>
          <div class="stat-card purple" onclick="navigateTo('tasks')"><h3>Tasks Due</h3><div class="value" id="stat-tasks">-</div></div>
          <div class="stat-card" onclick="navigateTo('sequences')"><h3>In Sequences</h3><div class="value" id="stat-enrolled">-</div></div>
        </div>
        
        <!-- Pipeline Reports -->
        <div class="reports-grid">
          <div class="card">
            <div class="card-header"><h2>üìä Pipeline Funnel</h2></div>
            <div class="funnel-container" id="pipeline-funnel"></div>
          </div>
          <div class="card">
            <div class="card-header"><h2>üìà Conversion Rates</h2></div>
            <div class="conversion-list" id="conversion-rates"></div>
          </div>
          <div class="card">
            <div class="card-header"><h2>üìû Activity This Week</h2></div>
            <div class="activity-summary" id="activity-summary"></div>
          </div>
          <div class="card">
            <div class="card-header"><h2>üìç Hot Leads by Location</h2></div>
            <div class="location-list" id="hot-by-location"></div>
          </div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
          <div class="card">
            <div class="card-header"><h2>üî• Hot Leads</h2></div>
            <div class="card-body" id="dashboard-hot"></div>
          </div>
          <div class="card">
            <div class="card-header"><h2>‚úÖ Today's Tasks</h2></div>
            <div class="card-body" id="dashboard-tasks"></div>
          </div>
        </div>
      </section>

      <!-- Shops (Outbound Database) -->
      <section class="page" id="page-shops">
        <div class="page-header">
          <h1>‚òï Shops Database</h1>
          <button class="btn btn-primary" onclick="openShopModal()">+ Add Shop</button>
        </div>
        <p style="color:var(--joe-gray);margin-bottom:16px">Your outbound prospecting database. Engage shops here, then convert to contacts when they respond.</p>
        
        <div class="filter-bar">
          <div class="filter-row">
            <div class="filter-group">
              <label>Search</label>
              <input type="text" class="search-input" placeholder="Search shops..." id="shop-search" oninput="applyShopFilters()">
            </div>
            <div class="filter-group">
              <label>City</label>
              <div class="multi-select" id="city-filter">
                <div class="multi-select-trigger" onclick="toggleDropdown('city-filter')"><span>All Cities</span><span>‚ñº</span></div>
                <div class="multi-select-dropdown" id="city-dropdown"></div>
              </div>
            </div>
            <div class="filter-group">
              <label>State</label>
              <div class="multi-select" id="state-filter">
                <div class="multi-select-trigger" onclick="toggleDropdown('state-filter')"><span>All States</span><span>‚ñº</span></div>
                <div class="multi-select-dropdown" id="state-dropdown"></div>
              </div>
            </div>
            <div class="filter-group">
              <label>Stage</label>
              <div class="multi-select" id="stage-filter">
                <div class="multi-select-trigger" onclick="toggleDropdown('stage-filter')"><span>All Stages</span><span>‚ñº</span></div>
                <div class="multi-select-dropdown" id="stage-dropdown"></div>
              </div>
            </div>
            <div class="filter-group">
              <label>Min Score</label>
              <select class="filter-select" id="shop-score-filter" onchange="applyShopFilters()">
                <option value="">Any</option>
                <option value="80">Hot (80+) üî•</option>
                <option value="70">70+</option>
                <option value="60">Warm (60+)</option>
              </select>
            </div>
            <div class="filter-group">
              <label>Website</label>
              <select class="filter-select" id="shop-website-filter" onchange="applyShopFilters()">
                <option value="">Any</option>
                <option value="none">No Website üéØ</option>
                <option value="has">Has Website</option>
              </select>
            </div>
            <div class="filter-group">
              <label>&nbsp;</label>
              <button class="clear-filters" onclick="clearAllShopFilters()">Clear All</button>
            </div>
            <span class="results-count" id="shop-count">0 shops</span>
          </div>
          <div class="filter-tags" id="filter-tags"></div>
        </div>

        <!-- Map -->
        <div class="map-section">
          <div class="map-toggle">
            <button class="map-toggle-btn" id="map-toggle-btn" onclick="toggleMap()"><span>‚ñº</span> üó∫Ô∏è Map View</button>
          </div>
          <div class="map-wrapper" id="map-wrapper">
            <div class="map-container">
              <div id="shops-map"></div>
              <div class="map-legend">
                <h4>Lead Score</h4>
                <div class="legend-item"><span class="legend-dot hot"></span> Hot (80+)</div>
                <div class="legend-item"><span class="legend-dot warm"></span> Warm (60+)</div>
                <div class="legend-item"><span class="legend-dot cold"></span> Cold</div>
              </div>
              <div class="map-stats">
                <div class="num" id="map-stat-visible">0</div>
                <div class="label">On Map</div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <table>
            <thead>
              <tr>
                <th onclick="sortShopsBy('name')">Shop</th>
                <th onclick="sortShopsBy('city')">Location</th>
                <th onclick="sortShopsBy('lead_score')">Score</th>
                <th onclick="sortShopsBy('pipeline_stage')">Stage</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="shops-table"></tbody>
          </table>
        </div>
      </section>

      <!-- Pipeline (Outbound) -->
      <section class="page" id="page-pipeline">
        <div class="page-header"><h1>üéØ Outbound Pipeline</h1></div>
        <div class="pipeline-container" id="outbound-pipeline"></div>
      </section>

      <!-- New Leads (Inbound) -->
      <section class="page" id="page-leads">
        <div class="page-header">
          <h1>üî• New Leads</h1>
          <button class="btn btn-primary" onclick="openContactModal()">+ Add Lead</button>
        </div>
        <p style="color:var(--joe-gray);margin-bottom:16px">Inbound form submissions waiting for outreach.</p>
        <div id="leads-list"></div>
      </section>

      <!-- Contacts -->
      <section class="page" id="page-contacts">
        <div class="page-header"><h1>üë§ Contacts</h1><button class="btn btn-primary" onclick="openContactModal()">+ Add Contact</button></div>
        <div class="filter-bar">
          <input type="text" class="search-input" placeholder="Search..." id="contact-search" oninput="renderContacts()">
          <select class="filter-select" id="contact-stage-filter" onchange="renderContacts()">
            <option value="">All Stages</option>
            <option value="lead">Leads</option>
            <option value="customer">Customers</option>
          </select>
          <span class="results-count" id="contact-count">0</span>
        </div>
        <div class="card"><table><thead><tr><th>Name</th><th>Email</th><th>Company</th><th>Stage</th><th>Source</th><th>Actions</th></tr></thead><tbody id="contacts-table"></tbody></table></div>
      </section>

      <!-- Companies -->
      <section class="page" id="page-companies">
        <div class="page-header"><h1>üè¢ Companies</h1><button class="btn btn-primary" onclick="openCompanyModal()">+ Add Company</button></div>
        <div class="filter-bar"><input type="text" class="search-input" placeholder="Search..." id="company-search" oninput="renderCompanies()"><span class="results-count" id="company-count">0</span></div>
        <div class="card"><table><thead><tr><th>Name</th><th>City</th><th>Contacts</th><th>Actions</th></tr></thead><tbody id="companies-table"></tbody></table></div>
      </section>

      <!-- Deals -->
      <section class="page" id="page-deals">
        <div class="page-header"><h1>üí∞ Deals</h1><button class="btn btn-primary" onclick="openDealModal()">+ Add Deal</button></div>
        <div class="pipeline-container" id="deals-pipeline"></div>
      </section>

      <!-- Sequences -->
      <section class="page" id="page-sequences">
        <div class="page-header"><h1>‚ö° Sequences</h1><button class="btn btn-primary" onclick="openSequenceModal()">+ Create Sequence</button></div>
        <p style="color:var(--joe-gray);margin-bottom:16px">Automated outreach cadences for shops and contacts.</p>
        <div id="sequences-list"></div>
      </section>

      <!-- Tasks -->
      <section class="page" id="page-tasks">
        <div class="page-header"><h1>‚úÖ Tasks</h1><button class="btn btn-primary" onclick="openTaskModal()">+ Add Task</button></div>
        <div class="filter-bar">
          <select class="filter-select" id="task-filter" onchange="renderTasks()">
            <option value="pending">Pending</option>
            <option value="today">Due Today</option>
            <option value="overdue">Overdue</option>
            <option value="all">All</option>
          </select>
        </div>
        <div id="tasks-list"></div>
      </section>
    </main>
  </div>

  <!-- Shop Modal -->
  <div class="modal-overlay" id="shop-modal">
    <div class="modal">
      <div class="modal-header"><h2 id="shop-modal-title">Shop</h2><button class="modal-close" onclick="closeShopModal()">&times;</button></div>
      <div class="modal-body">
        <div class="modal-tabs">
          <button class="modal-tab active" data-tab="shop-details">Details</button>
          <button class="modal-tab" data-tab="shop-activity">Activity</button>
          <button class="modal-tab" data-tab="shop-convert">Convert to Contact</button>
        </div>
        <div class="modal-tab-content active" id="shop-tab-shop-details">
          <div class="form-grid">
            <div class="form-group"><label>Shop Name</label><input type="text" id="shop-name"></div>
            <div class="form-group"><label>Stage</label>
              <select id="shop-stage">
                <option value="new">New</option>
                <option value="contacted">Contacted</option>
                <option value="qualified">Qualified</option>
                <option value="demo_scheduled">Demo Scheduled</option>
                <option value="proposal">Proposal</option>
                <option value="closed_won">Closed Won</option>
                <option value="closed_lost">Closed Lost</option>
              </select>
            </div>
            <div class="form-group"><label>City</label><input type="text" id="shop-city"></div>
            <div class="form-group"><label>State</label><input type="text" id="shop-state"></div>
            <div class="form-group"><label>Phone</label><input type="tel" id="shop-phone"></div>
            <div class="form-group"><label>Email</label><input type="email" id="shop-email"></div>
            <div class="form-group"><label>Website</label><input type="url" id="shop-website"></div>
            <div class="form-group"><label>Lead Score</label><input type="text" id="shop-score" readonly></div>
            <div class="form-group"><label>Google Rating</label><input type="text" id="shop-rating" readonly></div>
            <div class="form-group"><label>Contact Name</label><input type="text" id="shop-contact-name"></div>
            <div class="form-group full"><label>Notes</label><textarea id="shop-notes"></textarea></div>
          </div>
        </div>
        <div class="modal-tab-content" id="shop-tab-shop-activity">
          <div class="log-activity-btn">
            <button class="log-btn call" onclick="showShopActivityForm('call')">üìû Log Call</button>
            <button class="log-btn email" onclick="showShopActivityForm('email')">‚úâÔ∏è Log Email</button>
            <button class="log-btn" onclick="showShopActivityForm('note')">üìù Add Note</button>
            <button class="btn btn-small btn-success" onclick="composeShopEmail()">‚úâÔ∏è Send Email</button>
          </div>
          <div class="activity-form" id="shop-activity-form">
            <input type="hidden" id="shop-activity-type">
            <div class="form-group" style="margin-bottom:10px"><label>Outcome</label><select id="shop-activity-outcome"><option value="">Select...</option><option value="connected">Connected</option><option value="voicemail">Voicemail</option><option value="no_answer">No Answer</option><option value="interested">Interested</option><option value="not_interested">Not Interested</option></select></div>
            <div class="form-group"><label>Notes</label><textarea id="shop-activity-notes" style="min-height:80px"></textarea></div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px"><button class="btn btn-secondary btn-small" onclick="hideShopActivityForm()">Cancel</button><button class="btn btn-primary btn-small" onclick="saveShopActivity()">Save</button></div>
          </div>
          <div class="activity-list" id="shop-activity-list"></div>
        </div>
        <div class="modal-tab-content" id="shop-tab-shop-convert">
          <p style="margin-bottom:16px">Convert this shop to a Contact + Company for inbound/deal tracking.</p>
          <div class="form-grid">
            <div class="form-group"><label>Contact First Name</label><input type="text" id="convert-first"></div>
            <div class="form-group"><label>Contact Last Name</label><input type="text" id="convert-last"></div>
            <div class="form-group"><label>Contact Email</label><input type="email" id="convert-email"></div>
            <div class="form-group"><label>Job Title</label><input type="text" id="convert-title" value="Owner"></div>
          </div>
          <button class="btn btn-success" style="margin-top:16px" onclick="convertShopToContact()">Convert to Contact + Company</button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeShopModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveShop()">Save Shop</button>
      </div>
    </div>
  </div>

  <!-- Contact Modal -->
  <div class="modal-overlay" id="contact-modal">
    <div class="modal">
      <div class="modal-header"><h2 id="contact-modal-title">Contact</h2><button class="modal-close" onclick="closeContactModal()">&times;</button></div>
      <div class="modal-body">
        <div class="modal-tabs">
          <button class="modal-tab active" data-tab="contact-details">Details</button>
          <button class="modal-tab" data-tab="contact-activity">Activity</button>
          <button class="modal-tab" data-tab="contact-sequences">Sequences</button>
        </div>
        <div class="modal-tab-content active" id="contact-tab-contact-details">
          <div class="form-grid">
            <div class="form-group"><label>First Name</label><input type="text" id="contact-first"></div>
            <div class="form-group"><label>Last Name</label><input type="text" id="contact-last"></div>
            <div class="form-group"><label>Email</label><input type="email" id="contact-email"></div>
            <div class="form-group"><label>Phone</label><input type="tel" id="contact-phone"></div>
            <div class="form-group"><label>Title</label><input type="text" id="contact-title"></div>
            <div class="form-group"><label>Company</label><select id="contact-company"></select></div>
            <div class="form-group"><label>Stage</label><select id="contact-lifecycle"><option value="lead">Lead</option><option value="customer">Customer</option></select></div>
            <div class="form-group"><label>Lead Source</label><input type="text" id="contact-source" placeholder="e.g., website, referral"></div>
          </div>
        </div>
        <div class="modal-tab-content" id="contact-tab-contact-activity">
          <div class="quick-actions">
            <button class="btn btn-small btn-secondary" onclick="showContactActivityForm('call')">üìû Log Call</button>
            <button class="btn btn-small btn-secondary" onclick="showContactActivityForm('email')">‚úâÔ∏è Log Email</button>
            <button class="btn btn-small btn-secondary" onclick="showContactActivityForm('note')">üìù Add Note</button>
            <button class="btn btn-small btn-success" onclick="composeContactEmail()">‚úâÔ∏è Send Email</button>
          </div>
          <div class="activity-form" id="contact-activity-form">
            <input type="hidden" id="contact-activity-type">
            <div class="form-group" style="margin-bottom:10px"><label>Outcome</label><select id="contact-activity-outcome"><option value="">Select...</option><option value="connected">Connected</option><option value="voicemail">Voicemail</option><option value="interested">Interested</option><option value="not_interested">Not Interested</option></select></div>
            <div class="form-group"><label>Notes</label><textarea id="contact-activity-notes" style="min-height:80px"></textarea></div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px"><button class="btn btn-secondary btn-small" onclick="hideContactActivityForm()">Cancel</button><button class="btn btn-primary btn-small" onclick="saveContactActivity()">Save</button></div>
          </div>
          <div class="activity-list" id="contact-activity-list"></div>
        </div>
        <div class="modal-tab-content" id="contact-tab-contact-sequences">
          <button class="btn btn-primary btn-small" onclick="showEnrollForm()" style="margin-bottom:16px">‚ö° Enroll in Sequence</button>
          <div class="activity-form" id="enroll-form">
            <div class="form-group" style="margin-bottom:10px"><label>Select Sequence</label><select id="enroll-sequence"></select></div>
            <div style="display:flex;gap:8px;justify-content:flex-end"><button class="btn btn-secondary btn-small" onclick="hideEnrollForm()">Cancel</button><button class="btn btn-primary btn-small" onclick="enrollContact()">Enroll</button></div>
          </div>
          <h4 style="margin:16px 0 8px;font-size:13px">Active Enrollments</h4>
          <div id="contact-enrollments"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div><button class="btn btn-success btn-small" onclick="createDealFromContact()">+ Create Deal</button></div>
        <div style="display:flex;gap:8px"><button class="btn btn-secondary" onclick="closeContactModal()">Cancel</button><button class="btn btn-primary" onclick="saveContact()">Save</button></div>
      </div>
    </div>
  </div>

  <!-- Company Modal -->
  <div class="modal-overlay" id="company-modal">
    <div class="modal">
      <div class="modal-header"><h2 id="company-modal-title">Company</h2><button class="modal-close" onclick="closeCompanyModal()">&times;</button></div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-group full"><label>Company Name</label><input type="text" id="company-name"></div>
          <div class="form-group"><label>City</label><input type="text" id="company-city"></div>
          <div class="form-group"><label>State</label><input type="text" id="company-state"></div>
          <div class="form-group"><label>Phone</label><input type="tel" id="company-phone"></div>
          <div class="form-group"><label>Website</label><input type="url" id="company-website"></div>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeCompanyModal()">Cancel</button><button class="btn btn-primary" onclick="saveCompany()">Save</button></div>
    </div>
  </div>

  <!-- Deal Modal -->
  <div class="modal-overlay" id="deal-modal">
    <div class="modal">
      <div class="modal-header"><h2 id="deal-modal-title">Deal</h2><button class="modal-close" onclick="closeDealModal()">&times;</button></div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-group full"><label>Deal Name</label><input type="text" id="deal-name"></div>
          <div class="form-group"><label>Amount ($)</label><input type="number" id="deal-amount"></div>
          <div class="form-group"><label>Close Date</label><input type="date" id="deal-close-date"></div>
          <div class="form-group"><label>Contact</label><select id="deal-contact"></select></div>
          <div class="form-group"><label>Stage</label><select id="deal-stage"><option value="appointment">Appointment</option><option value="qualified">Qualified</option><option value="presentation">Presentation</option><option value="contract">Contract</option><option value="closed_won">Won</option><option value="closed_lost">Lost</option></select></div>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeDealModal()">Cancel</button><button class="btn btn-primary" onclick="saveDeal()">Save</button></div>
    </div>
  </div>

  <!-- Sequence Modal -->
  <div class="modal-overlay" id="sequence-modal">
    <div class="modal wide">
      <div class="modal-header"><h2 id="sequence-modal-title">Create Sequence</h2><button class="modal-close" onclick="closeSequenceModal()">&times;</button></div>
      <div class="modal-body">
        <div class="form-grid" style="margin-bottom:20px">
          <div class="form-group"><label>Sequence Name</label><input type="text" id="sequence-name" placeholder="e.g., New Lead Outreach"></div>
          <div class="form-group"><label>Description</label><input type="text" id="sequence-desc"></div>
        </div>
        <div class="form-group" style="margin-bottom:16px">
          <label><input type="checkbox" id="sequence-default"> Set as default for new leads</label>
        </div>
        <h3 style="margin-bottom:12px">Steps</h3>
        <div id="sequence-steps-editor"></div>
        <button class="btn btn-secondary btn-small" onclick="addStep()">+ Add Step</button>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeSequenceModal()">Cancel</button><button class="btn btn-primary" onclick="saveSequence()">Save</button></div>
    </div>
  </div>

  <!-- Task Modal -->
  <div class="modal-overlay" id="task-modal">
    <div class="modal">
      <div class="modal-header"><h2>Add Task</h2><button class="modal-close" onclick="closeTaskModal()">&times;</button></div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-group full"><label>Title</label><input type="text" id="task-title"></div>
          <div class="form-group"><label>Type</label><select id="task-type"><option value="todo">To-Do</option><option value="call">Call</option><option value="email">Email</option></select></div>
          <div class="form-group"><label>Due Date</label><input type="datetime-local" id="task-due"></div>
          <div class="form-group full"><label>Contact</label><select id="task-contact"></select></div>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeTaskModal()">Cancel</button><button class="btn btn-primary" onclick="saveTask()">Save</button></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const SUPABASE_URL='https://vpnoaxpmhuknyaxcyxsu.supabase.co';
    const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZwbm9heHBtaHVrbnlheGN5eHN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NjkzNTMsImV4cCI6MjA4MjQ0NTM1M30.0JVwCaY-3nUHuJk49ibifQviT0LxBSdYXMslw9WIr9M';
    const MAPBOX_TOKEN='pk.eyJ1IjoiYnJlbmRlbmNvZmZleSIsImEiOiJjbTVycXk4anEwMHU2MnFwdHBtZmVtcHc3In0.INjjBnfpRPl4pv-2NcRB-A';
    const db=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
    mapboxgl.accessToken=MAPBOX_TOKEN;

    let currentUser=null;
    let shops=[],contacts=[],companies=[],deals=[],sequences=[],tasks=[],activities=[],enrollments=[];
    let currentShopId=null,currentContactId=null,currentCompanyId=null,currentDealId=null,currentSequenceId=null;
    let map=null,mapMarkers=[],mapVisible=true;
    let shopSort={field:'lead_score',dir:'desc'};
    let seqSteps=[];
    let shopFilters={cities:[],states:[],stages:[],minScore:null,websiteStatus:null};

    const SHOP_STAGES=[{id:'new',label:'New'},{id:'contacted',label:'Contacted'},{id:'qualified',label:'Qualified'},{id:'demo_scheduled',label:'Demo'},{id:'proposal',label:'Proposal'},{id:'closed_won',label:'Won'},{id:'closed_lost',label:'Lost'}];
    const DEAL_STAGES=[{id:'appointment',label:'Appointment'},{id:'qualified',label:'Qualified'},{id:'presentation',label:'Presentation'},{id:'contract',label:'Contract'}];
    const ICONS={call:'üìû',email:'‚úâÔ∏è',note:'üìù',todo:'‚úÖ',meeting:'ü§ù'};

    // Auth
    netlifyIdentity.on('init',u=>{if(u)handleLogin(u);});
    netlifyIdentity.on('login',u=>{handleLogin(u);netlifyIdentity.close();});
    netlifyIdentity.on('logout',()=>{location.reload();});

    function handleLogin(user){
      if(!user.email?.endsWith('@joe.coffee')){document.getElementById('auth-error').style.display='block';netlifyIdentity.logout();return;}
      currentUser={email:user.email,name:user.user_metadata?.full_name||user.email.split('@')[0],avatar:user.user_metadata?.avatar_url};
      document.getElementById('authScreen').style.display='none';
      document.getElementById('app').classList.add('active');
      document.getElementById('user-name').textContent=currentUser.name;
      const av=document.getElementById('user-avatar');
      if(currentUser.avatar)av.innerHTML='<img src="'+currentUser.avatar+'">';else av.textContent=currentUser.name[0].toUpperCase();
      loadAllData();
    }
    function signOut(){netlifyIdentity.logout();}

    async function loadAllData(){
      const[sh,c,co,d,seq,t,a,e]=await Promise.all([
        db.from('shops').select('*').order('lead_score',{ascending:false}),
        db.from('contacts').select('*').order('created_at',{ascending:false}),
        db.from('companies').select('*').order('name'),
        db.from('deals').select('*').order('created_at',{ascending:false}),
        db.from('sequences').select('*,sequence_steps(*)').order('created_at',{ascending:false}),
        db.from('tasks').select('*').order('due_date'),
        db.from('activities').select('*').order('created_at',{ascending:false}).limit(500),
        db.from('sequence_enrollments').select('*')
      ]);
      shops=sh.data||[];contacts=c.data||[];companies=co.data||[];deals=d.data||[];sequences=seq.data||[];tasks=t.data||[];activities=a.data||[];enrollments=e.data||[];
      renderDashboard();populateDropdowns();
      document.getElementById('shops-badge').textContent=shops.length;
    }

    function populateDropdowns(){
      const coOpts='<option value="">None</option>'+companies.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
      document.getElementById('contact-company').innerHTML=coOpts;
      const ctOpts='<option value="">Select...</option>'+contacts.map(c=>`<option value="${c.id}">${c.first_name} ${c.last_name}</option>`).join('');
      document.getElementById('deal-contact').innerHTML=ctOpts;
      document.getElementById('task-contact').innerHTML='<option value="">None</option>'+contacts.map(c=>`<option value="${c.id}">${c.first_name} ${c.last_name}</option>`).join('');
      document.getElementById('enroll-sequence').innerHTML=sequences.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
      populateShopFilters();
    }

    // Multi-select filter functions
    function populateShopFilters(){
      const cities=[...new Set(shops.map(s=>s.city).filter(Boolean))].sort();
      document.getElementById('city-dropdown').innerHTML=cities.map(c=>`<label class="multi-select-option"><input type="checkbox" value="${c}" onchange="updateShopFilter('cities','${c.replace(/'/g,"\\'")}',this.checked)">${c}</label>`).join('');
      const states=[...new Set(shops.map(s=>s.state).filter(Boolean))].sort();
      document.getElementById('state-dropdown').innerHTML=states.map(s=>`<label class="multi-select-option"><input type="checkbox" value="${s}" onchange="updateShopFilter('states','${s}',this.checked)">${s}</label>`).join('');
      document.getElementById('stage-dropdown').innerHTML=SHOP_STAGES.map(s=>`<label class="multi-select-option"><input type="checkbox" value="${s.id}" onchange="updateShopFilter('stages','${s.id}',this.checked)">${s.label}</label>`).join('');
      renderShops();
    }

    function toggleDropdown(id){
      const dd=document.querySelector('#'+id+' .multi-select-dropdown');
      document.querySelectorAll('.multi-select-dropdown.open').forEach(d=>{if(d!==dd)d.classList.remove('open');});
      dd.classList.toggle('open');
    }
    document.addEventListener('click',e=>{if(!e.target.closest('.multi-select'))document.querySelectorAll('.multi-select-dropdown.open').forEach(d=>d.classList.remove('open'));});

    function updateShopFilter(type,value,checked){
      if(checked)shopFilters[type].push(value);
      else shopFilters[type]=shopFilters[type].filter(v=>v!==value);
      applyShopFilters();
    }

    function applyShopFilters(){
      updateFilterDisplay();
      updateFilterTags();
      renderShops();
    }

    function updateFilterDisplay(){
      document.querySelector('#city-filter .multi-select-trigger span:first-child').textContent=shopFilters.cities.length?shopFilters.cities.length+' cities':'All Cities';
      document.querySelector('#state-filter .multi-select-trigger span:first-child').textContent=shopFilters.states.length?shopFilters.states.length+' states':'All States';
      document.querySelector('#stage-filter .multi-select-trigger span:first-child').textContent=shopFilters.stages.length?shopFilters.stages.length+' stages':'All Stages';
    }

    function updateFilterTags(){
      const tags=[];
      shopFilters.cities.forEach(c=>tags.push({type:'cities',value:c,label:c}));
      shopFilters.states.forEach(s=>tags.push({type:'states',value:s,label:s}));
      shopFilters.stages.forEach(s=>tags.push({type:'stages',value:s,label:SHOP_STAGES.find(st=>st.id===s)?.label||s}));
      const minScore=document.getElementById('shop-score-filter').value;
      if(minScore)tags.push({type:'score',value:minScore,label:'Score '+minScore+'+'});
      const website=document.getElementById('shop-website-filter').value;
      if(website)tags.push({type:'website',value:website,label:website==='none'?'No Website':'Has Website'});
      document.getElementById('filter-tags').innerHTML=tags.map(t=>`<span class="filter-tag">${t.label}<span class="remove" onclick="removeFilter('${t.type}','${t.value.replace(/'/g,"\\'")}')">√ó</span></span>`).join('');
    }

    function removeFilter(type,value){
      if(type==='cities'||type==='states'||type==='stages'){
        shopFilters[type]=shopFilters[type].filter(v=>v!==value);
        const cb=document.querySelector('#'+type.slice(0,-1)+'-dropdown input[value="'+value+'"]');
        if(cb)cb.checked=false;
      }else if(type==='score'){
        document.getElementById('shop-score-filter').value='';
      }else if(type==='website'){
        document.getElementById('shop-website-filter').value='';
      }
      applyShopFilters();
    }

    function clearAllShopFilters(){
      shopFilters={cities:[],states:[],stages:[],minScore:null,websiteStatus:null};
      document.querySelectorAll('.multi-select-dropdown input').forEach(cb=>cb.checked=false);
      document.getElementById('shop-score-filter').value='';
      document.getElementById('shop-website-filter').value='';
      document.getElementById('shop-search').value='';
      applyShopFilters();
    }

    // Dashboard
    function renderDashboard(){
      const newLeads=contacts.filter(c=>c.lead_status==='new'||!c.lead_status);
      const pendingTasks=tasks.filter(t=>t.status!=='completed');
      const today=new Date().toISOString().split('T')[0];
      const todayTasks=pendingTasks.filter(t=>t.due_date?.startsWith(today));
      const activeEnrollments=enrollments.filter(e=>e.status==='active');
      const pipeline=deals.filter(d=>!['closed_won','closed_lost'].includes(d.stage)).reduce((s,d)=>s+(d.amount||0),0);
      const hotShops=shops.filter(s=>s.lead_score>=80);

      document.getElementById('stat-shops').textContent=shops.length;
      document.getElementById('stat-leads').textContent=newLeads.length;
      document.getElementById('leads-badge').textContent=newLeads.length;
      document.getElementById('stat-hot').textContent=hotShops.length;
      document.getElementById('stat-tasks').textContent=pendingTasks.length;
      document.getElementById('tasks-badge').textContent=pendingTasks.length;
      document.getElementById('stat-enrolled').textContent=activeEnrollments.length;
      document.getElementById('stat-pipeline').textContent='$'+pipeline.toLocaleString();

      // Hot leads
      document.getElementById('dashboard-hot').innerHTML=hotShops.length?hotShops.slice(0,5).map(s=>`<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--joe-light)"><span class="clickable" onclick="openShopModal('${s.id}')">${s.name}</span><span class="score hot">${s.lead_score}</span></div>`).join(''):'<div class="empty-state">No hot leads</div>';

      // Today's tasks
      document.getElementById('dashboard-tasks').innerHTML=todayTasks.length?todayTasks.slice(0,5).map(t=>{
        const ct=contacts.find(c=>c.id===t.contact_id);
        return`<div class="task-item${t.sequence_enrollment_id?' sequence-task':''}"><div class="task-checkbox" onclick="completeTask('${t.id}')"></div><div class="task-info"><div class="task-title">${t.title}</div><div class="task-meta">${ct?ct.first_name+' '+ct.last_name:''}</div></div></div>`;
      }).join(''):'<div class="empty-state">No tasks today! üéâ</div>';
      
      // Render pipeline reports
      renderPipelineFunnel();
      renderConversionRates();
      renderActivitySummary();
      renderHotByLocation();
    }
    
    // Pipeline Funnel
    function renderPipelineFunnel(){
      const stageCounts=SHOP_STAGES.slice(0,5).map(stage=>{
        const count=shops.filter(s=>(s.pipeline_stage||'new')===stage.id).length;
        return{...stage,count};
      });
      const maxCount=Math.max(...stageCounts.map(s=>s.count),1);
      
      document.getElementById('pipeline-funnel').innerHTML=stageCounts.map(stage=>{
        const pct=shops.length?Math.round(stage.count/shops.length*100):0;
        const width=Math.max(20,stage.count/maxCount*100);
        return`<div class="funnel-stage"><span class="funnel-label">${stage.label}</span><div class="funnel-bar-wrapper"><div class="funnel-bar ${stage.id}" style="width:${width}%">${stage.count}</div></div><span class="funnel-percent">${pct}%</span></div>`;
      }).join('');
    }
    
    // Conversion Rates
    function renderConversionRates(){
      const stages=['new','contacted','qualified','demo_scheduled','proposal'];
      const conversions=[];
      
      for(let i=0;i<stages.length-1;i++){
        const fromStage=stages[i];
        const toStage=stages[i+1];
        const fromCount=shops.filter(s=>{
          const st=s.pipeline_stage||'new';
          return stages.indexOf(st)>=stages.indexOf(fromStage);
        }).length;
        const toCount=shops.filter(s=>{
          const st=s.pipeline_stage||'new';
          return stages.indexOf(st)>=stages.indexOf(toStage);
        }).length;
        const rate=fromCount?Math.round(toCount/fromCount*100):0;
        conversions.push({from:SHOP_STAGES.find(s=>s.id===fromStage).label,to:SHOP_STAGES.find(s=>s.id===toStage).label,rate});
      }
      
      document.getElementById('conversion-rates').innerHTML=conversions.map(c=>{
        const rateClass=c.rate>=50?'good':c.rate>=25?'medium':'low';
        return`<div class="conversion-row"><div class="conversion-stages"><span>${c.from}</span><span class="conversion-arrow">‚Üí</span><span>${c.to}</span></div><span class="conversion-rate ${rateClass}">${c.rate}%</span></div>`;
      }).join('');
    }
    
    // Activity Summary
    function renderActivitySummary(){
      const now=new Date();
      const weekAgo=new Date(now.getTime()-7*24*60*60*1000);
      const twoWeeksAgo=new Date(now.getTime()-14*24*60*60*1000);
      
      const thisWeek=activities.filter(a=>new Date(a.created_at)>=weekAgo);
      const lastWeek=activities.filter(a=>{const d=new Date(a.created_at);return d>=twoWeeksAgo&&d<weekAgo;});
      
      const types=['call','email','note','meeting'];
      const summary=types.map(type=>{
        const thisCount=thisWeek.filter(a=>a.activity_type===type).length;
        const lastCount=lastWeek.filter(a=>a.activity_type===type).length;
        let trend='flat',trendIcon='‚Üí';
        if(thisCount>lastCount){trend='up';trendIcon='‚Üë';}
        else if(thisCount<lastCount){trend='down';trendIcon='‚Üì';}
        return{type,thisCount,lastCount,trend,trendIcon};
      });
      
      document.getElementById('activity-summary').innerHTML=summary.map(s=>`<div class="activity-row"><div class="activity-type-label"><div class="activity-type-icon ${s.type}">${ICONS[s.type]||'üìã'}</div><span style="text-transform:capitalize">${s.type}s</span></div><div class="activity-counts"><div class="activity-count"><div class="num">${s.thisCount}</div><div class="label">This Week</div></div><div class="activity-count"><div class="num">${s.lastCount}</div><div class="label">Last Week</div></div><span class="activity-trend ${s.trend}">${s.trendIcon}</span></div></div>`).join('');
    }
    
    // Hot Leads by Location
    function renderHotByLocation(){
      const hotShops=shops.filter(s=>s.lead_score>=80);
      const byCity={};
      hotShops.forEach(s=>{
        const city=s.city||'Unknown';
        if(!byCity[city])byCity[city]={hot:0,total:0};
        byCity[city].hot++;
      });
      shops.forEach(s=>{
        const city=s.city||'Unknown';
        if(byCity[city])byCity[city].total++;
      });
      
      const sorted=Object.entries(byCity).sort((a,b)=>b[1].hot-a[1].hot).slice(0,6);
      
      document.getElementById('hot-by-location').innerHTML=sorted.length?sorted.map(([city,data])=>`<div class="location-row"><span class="location-name">${city}</span><div class="location-stats"><span class="location-hot">üî• ${data.hot}</span><span class="location-total">${data.total} total</span></div></div>`).join(''):'<div class="empty-state">No hot leads yet</div>';
    }

    // AI Copilot
    async function askJoe(){
      const q=document.getElementById('ai-input').value.trim();
      if(!q)return;
      document.getElementById('ai-response').classList.add('visible');
      document.getElementById('ai-response-content').innerHTML='Thinking...';
      
      // Build context
      const hotShops=shops.filter(s=>s.lead_score>=80);
      const newLeads=contacts.filter(c=>c.lead_status==='new'||!c.lead_status);
      const pendingTasks=tasks.filter(t=>t.status!=='completed');
      const today=new Date().toISOString().split('T')[0];
      const overdueTasks=pendingTasks.filter(t=>t.due_date&&t.due_date.split('T')[0]<today);
      const pipelineValue=deals.filter(d=>!['closed_won','closed_lost'].includes(d.stage)).reduce((s,d)=>s+(d.amount||0),0);
      
      // Stage breakdown
      const stageBreakdown=SHOP_STAGES.map(st=>({stage:st.label,count:shops.filter(s=>(s.pipeline_stage||'new')===st.id).length}));
      
      const context=`You are joe, a helpful sales AI assistant for a coffee shop CRM.

Current Stats:
- ${shops.length} total shops in database
- ${hotShops.length} hot leads (score 80+)
- ${newLeads.length} new inbound leads
- ${pendingTasks.length} pending tasks (${overdueTasks.length} overdue)
- $${pipelineValue.toLocaleString()} in deal pipeline
- ${enrollments.filter(e=>e.status==='active').length} contacts in sequences

Pipeline Breakdown:
${stageBreakdown.map(s=>`- ${s.stage}: ${s.count} shops`).join('\n')}

Hot Shops to Call: ${hotShops.slice(0,5).map(s=>`${s.name} (${s.city}, score ${s.lead_score})`).join(', ')}

New Leads: ${newLeads.slice(0,5).map(c=>`${c.first_name} ${c.last_name}`).join(', ')}

Recent Activities (last 7 days): ${activities.filter(a=>new Date(a.created_at)>=new Date(Date.now()-7*24*60*60*1000)).length} logged

Give practical, actionable advice. Be concise and helpful.`;

      try{
        const apiKey=localStorage.getItem('anthropic_api_key');
        if(!apiKey){
          const key=prompt('Enter your Anthropic API key (stored locally):');
          if(key)localStorage.setItem('anthropic_api_key',key);
          else{document.getElementById('ai-response-content').innerHTML='API key required';return;}
        }
        
        const res=await fetch('https://api.anthropic.com/v1/messages',{
          method:'POST',
          headers:{'Content-Type':'application/json','x-api-key':localStorage.getItem('anthropic_api_key'),'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
          body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1024,system:context,messages:[{role:'user',content:q}]})
        });
        const data=await res.json();
        if(data.error){document.getElementById('ai-response-content').innerHTML='Error: '+data.error.message;return;}
        document.getElementById('ai-response-content').innerHTML=data.content[0].text.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>');
      }catch(e){document.getElementById('ai-response-content').innerHTML='Error: '+e.message;}
    }
    function askSuggestion(btn){document.getElementById('ai-input').value=btn.textContent;askJoe();}

    // Shops
    function renderShops(){
      const q=(document.getElementById('shop-search').value||'').toLowerCase();
      const minScore=document.getElementById('shop-score-filter').value;
      const website=document.getElementById('shop-website-filter').value;
      
      let f=shops.filter(s=>{
        if(q&&!s.name.toLowerCase().includes(q)&&!(s.city||'').toLowerCase().includes(q))return false;
        if(shopFilters.cities.length&&!shopFilters.cities.includes(s.city))return false;
        if(shopFilters.states.length&&!shopFilters.states.includes(s.state))return false;
        if(shopFilters.stages.length&&!shopFilters.stages.includes(s.pipeline_stage||'new'))return false;
        if(minScore&&(s.lead_score||0)<parseInt(minScore))return false;
        if(website==='none'&&s.website)return false;
        if(website==='has'&&!s.website)return false;
        return true;
      });
      
      f.sort((a,b)=>{
        let av=a[shopSort.field]||'',bv=b[shopSort.field]||'';
        if(typeof av==='string')av=av.toLowerCase();
        if(typeof bv==='string')bv=bv.toLowerCase();
        return shopSort.dir==='asc'?(av>bv?1:-1):(av<bv?1:-1);
      });
      
      document.getElementById('shop-count').textContent=f.length+' shops';
      document.getElementById('shops-table').innerHTML=f.length?f.slice(0,100).map(s=>`<tr><td><span class="clickable" onclick="openShopModal('${s.id}')">${s.name}</span></td><td>${s.city||''}, ${s.state||''}</td><td><span class="score ${s.lead_score>=80?'hot':s.lead_score>=60?'warm':'cold'}">${s.lead_score||50}</span></td><td><span class="stage-badge stage-${s.pipeline_stage||'new'}">${SHOP_STAGES.find(st=>st.id===s.pipeline_stage)?.label||'New'}</span></td><td class="actions-cell"><button class="action-btn" onclick="openShopModal('${s.id}')">üëÅÔ∏è</button>${s.phone?`<a class="action-btn" href="tel:${s.phone}">üìû</a>`:''}${s.email?`<a class="action-btn" href="mailto:${s.email}">‚úâÔ∏è</a>`:''}</td></tr>`).join(''):'<tr><td colspan="5" class="empty-state">No shops</td></tr>';
      
      if(map&&mapVisible)renderMapMarkers(f);
    }
    function sortShopsBy(field){shopSort.dir=shopSort.field===field&&shopSort.dir==='desc'?'asc':'desc';shopSort.field=field;renderShops();}

    // Map
    function toggleMap(){
      mapVisible=!mapVisible;
      document.getElementById('map-wrapper').classList.toggle('collapsed',!mapVisible);
      document.getElementById('map-toggle-btn').classList.toggle('collapsed',!mapVisible);
      if(mapVisible)setTimeout(()=>{initMap();if(map)map.resize();},100);
    }
    function initMap(){
      if(map)return;
      map=new mapboxgl.Map({container:'shops-map',style:'mapbox://styles/mapbox/light-v11',center:[-98.5795,39.8283],zoom:3.5});
      map.addControl(new mapboxgl.NavigationControl(),'top-left');
      map.on('load',()=>renderMapMarkers(shops));
    }
    function renderMapMarkers(list){
      if(!map)return;
      mapMarkers.forEach(m=>m.remove());
      mapMarkers=[];
      const filtered=(list||shops).filter(s=>s.lat&&s.lng);
      document.getElementById('map-stat-visible').textContent=filtered.length;
      
      filtered.forEach(shop=>{
        const color=shop.lead_score>=80?'#f59e0b':shop.lead_score>=60?'#3b82f6':'#6b7280';
        const el=document.createElement('div');
        el.style.cssText=`width:16px;height:16px;background:${color};border:2px solid white;border-radius:50%;cursor:pointer;`;
        el.onclick=()=>openShopModal(shop.id);
        mapMarkers.push(new mapboxgl.Marker(el).setLngLat([parseFloat(shop.lng),parseFloat(shop.lat)]).addTo(map));
      });
      
      if(filtered.length>0){
        const bounds=new mapboxgl.LngLatBounds();
        filtered.forEach(s=>bounds.extend([parseFloat(s.lng),parseFloat(s.lat)]));
        map.fitBounds(bounds,{padding:50,maxZoom:12});
      }
    }

    // Outbound Pipeline
    function renderOutboundPipeline(){
      document.getElementById('outbound-pipeline').innerHTML=SHOP_STAGES.slice(0,5).map(stage=>{
        const ss=shops.filter(s=>(s.pipeline_stage||'new')===stage.id);
        return`<div class="pipeline-column"><div class="pipeline-header"><h3>${stage.label}</h3><span class="pipeline-count">${ss.length}</span></div>${ss.slice(0,15).map(s=>`<div class="pipeline-card" onclick="openShopModal('${s.id}')"><h4>${s.name}</h4><div class="meta">${s.city||''} ‚Ä¢ ${s.lead_score||50}</div></div>`).join('')}</div>`;
      }).join('');
    }

    // Shop Modal
    function openShopModal(id){
      currentShopId=id||null;
      document.querySelectorAll('#shop-modal .modal-tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('#shop-modal .modal-tab-content').forEach(t=>t.classList.remove('active'));
      document.querySelector('#shop-modal .modal-tab[data-tab="shop-details"]').classList.add('active');
      document.getElementById('shop-tab-shop-details').classList.add('active');
      hideShopActivityForm();
      
      if(id){
        const s=shops.find(x=>x.id===id);
        document.getElementById('shop-modal-title').textContent=s.name;
        document.getElementById('shop-name').value=s.name||'';
        document.getElementById('shop-stage').value=s.pipeline_stage||'new';
        document.getElementById('shop-city').value=s.city||'';
        document.getElementById('shop-state').value=s.state||'';
        document.getElementById('shop-phone').value=s.phone||'';
        document.getElementById('shop-email').value=s.email||'';
        document.getElementById('shop-website').value=s.website||'';
        document.getElementById('shop-score').value=s.lead_score||50;
        document.getElementById('shop-rating').value=s.google_rating?s.google_rating+' ‚≠ê':'N/A';
        document.getElementById('shop-contact-name').value=s.contact_name||'';
        document.getElementById('shop-notes').value=s.notes||'';
        document.getElementById('convert-first').value=(s.contact_name||'').split(' ')[0]||'';
        document.getElementById('convert-last').value=(s.contact_name||'').split(' ').slice(1).join(' ')||'';
        document.getElementById('convert-email').value=s.email||'';
        renderShopActivities(id);
      }else{
        document.getElementById('shop-modal-title').textContent='Add Shop';
        ['shop-name','shop-city','shop-state','shop-phone','shop-email','shop-website','shop-contact-name','shop-notes'].forEach(x=>document.getElementById(x).value='');
        document.getElementById('shop-stage').value='new';
        document.getElementById('shop-score').value='50';
        document.getElementById('shop-rating').value='N/A';
        document.getElementById('shop-activity-list').innerHTML='<div class="empty-state">Save shop first</div>';
      }
      document.getElementById('shop-modal').classList.add('open');
    }
    function closeShopModal(){document.getElementById('shop-modal').classList.remove('open');}
    
    async function saveShop(){
      const d={name:document.getElementById('shop-name').value,pipeline_stage:document.getElementById('shop-stage').value,city:document.getElementById('shop-city').value,state:document.getElementById('shop-state').value,phone:document.getElementById('shop-phone').value,email:document.getElementById('shop-email').value,website:document.getElementById('shop-website').value,contact_name:document.getElementById('shop-contact-name').value,notes:document.getElementById('shop-notes').value};
      if(currentShopId){
        await db.from('shops').update(d).eq('id',currentShopId);
        Object.assign(shops.find(s=>s.id===currentShopId),d);
      }else{
        d.lead_score=50;
        const{data:n}=await db.from('shops').insert([d]).select().single();
        if(n)shops.unshift(n);
      }
      closeShopModal();renderShops();renderOutboundPipeline();renderDashboard();showToast('Saved!');
    }

    // Shop Activities
    function renderShopActivities(id){
      const a=activities.filter(x=>x.shop_id===id);
      document.getElementById('shop-activity-list').innerHTML=a.length?a.slice(0,20).map(x=>`<div class="activity-item"><div class="activity-icon ${x.activity_type}">${ICONS[x.activity_type]||'üìã'}</div><div class="activity-content"><div class="activity-type">${x.activity_type}${x.outcome?' - '+x.outcome:''}</div>${x.notes?`<div class="activity-notes">${x.notes.substring(0,150)}</div>`:''}<div class="activity-meta">${x.team_member_name||''} ‚Ä¢ ${formatDate(x.created_at)}</div></div></div>`).join(''):'<div class="empty-state">No activities</div>';
    }
    function showShopActivityForm(t){document.getElementById('shop-activity-type').value=t;document.getElementById('shop-activity-form').classList.add('visible');}
    function hideShopActivityForm(){document.getElementById('shop-activity-form').classList.remove('visible');document.getElementById('shop-activity-outcome').value='';document.getElementById('shop-activity-notes').value='';}
    async function saveShopActivity(){
      if(!currentShopId)return;
      const{data}=await db.from('activities').insert([{shop_id:currentShopId,team_member_email:currentUser.email,team_member_name:currentUser.name,activity_type:document.getElementById('shop-activity-type').value,outcome:document.getElementById('shop-activity-outcome').value||null,notes:document.getElementById('shop-activity-notes').value}]).select().single();
      if(data)activities.unshift(data);
      
      const sh=shops.find(s=>s.id===currentShopId);
      if(sh&&sh.pipeline_stage==='new'){
        await db.from('shops').update({pipeline_stage:'contacted'}).eq('id',currentShopId);
        sh.pipeline_stage='contacted';
        document.getElementById('shop-stage').value='contacted';
      }
      hideShopActivityForm();renderShopActivities(currentShopId);showToast('Logged!');
    }
    function composeShopEmail(){
      const s=shops.find(x=>x.id===currentShopId);
      if(!s?.email){showToast('No email','error');return;}
      window.open(`mailto:${s.email}?subject=Quick question about ${s.name}`,'_blank');
    }

    // Convert Shop to Contact
    async function convertShopToContact(){
      if(!currentShopId)return;
      const shop=shops.find(s=>s.id===currentShopId);
      const first=document.getElementById('convert-first').value;
      const last=document.getElementById('convert-last').value;
      const email=document.getElementById('convert-email').value;
      const title=document.getElementById('convert-title').value;
      
      if(!first){showToast('First name required','error');return;}
      
      // Create company
      const{data:company}=await db.from('companies').insert([{name:shop.name,city:shop.city,state:shop.state,phone:shop.phone,website:shop.website}]).select().single();
      if(company)companies.push(company);
      
      // Create contact
      const{data:contact}=await db.from('contacts').insert([{first_name:first,last_name:last,email:email,phone:shop.phone,job_title:title,company_id:company?.id,lifecycle_stage:'lead',lead_status:'new',lead_source:'outbound'}]).select().single();
      if(contact)contacts.unshift(contact);
      
      // Update shop
      await db.from('shops').update({pipeline_stage:'qualified',company_id:company?.id}).eq('id',currentShopId);
      shop.pipeline_stage='qualified';
      shop.company_id=company?.id;
      
      closeShopModal();populateDropdowns();renderDashboard();showToast('Converted to contact!');
    }

    // Modal tab switching
    document.querySelectorAll('.modal-tab').forEach(tab=>{
      tab.addEventListener('click',()=>{
        const modal=tab.closest('.modal');
        modal.querySelectorAll('.modal-tab').forEach(t=>t.classList.remove('active'));
        modal.querySelectorAll('.modal-tab-content').forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.closest('.modal').id.replace('-modal','')+'-tab-'+tab.dataset.tab).classList.add('active');
      });
    });

    // Leads
    function renderLeads(){
      const leads=contacts.filter(c=>c.lead_status==='new'||!c.lead_status);
      document.getElementById('leads-list').innerHTML=leads.length?leads.map(c=>{
        const co=companies.find(x=>x.id===c.company_id);
        return`<div style="background:#fff;border-radius:10px;padding:16px;margin-bottom:12px;border-left:4px solid var(--joe-accent);display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:600">${c.first_name} ${c.last_name}</div><div style="font-size:13px;color:var(--joe-gray)">${co?.name||'No company'} ‚Ä¢ ${c.email||''}</div><div style="font-size:11px;color:var(--joe-gray);margin-top:4px">Source: ${c.lead_source||'unknown'} ‚Ä¢ ${formatDate(c.created_at)}</div></div><div style="display:flex;gap:8px"><button class="btn btn-small btn-secondary" onclick="openContactModal('${c.id}')">View</button><button class="btn btn-small btn-primary" onclick="quickEnroll('${c.id}')">‚ö° Enroll</button></div></div>`;
      }).join(''):'<div class="empty-state">No new leads üéâ</div>';
    }

    async function quickEnroll(contactId){
      const defaultSeq=sequences.find(s=>s.is_default)||sequences[0];
      if(!defaultSeq){showToast('Create a sequence first','error');return;}
      const existing=enrollments.find(e=>e.contact_id===contactId&&e.sequence_id===defaultSeq.id);
      if(existing){showToast('Already enrolled','error');return;}
      
      const{data:enrollment}=await db.from('sequence_enrollments').insert([{sequence_id:defaultSeq.id,contact_id:contactId,enrolled_by:currentUser.email,status:'active',current_step:1}]).select().single();
      if(enrollment){
        enrollments.push(enrollment);
        await createNextTask(enrollment,defaultSeq);
        await db.from('contacts').update({lead_status:'contacted'}).eq('id',contactId);
        const ct=contacts.find(c=>c.id===contactId);if(ct)ct.lead_status='contacted';
      }
      renderLeads();renderDashboard();showToast('Enrolled in '+defaultSeq.name);
    }

    async function createNextTask(enrollment,sequence){
      const steps=sequence.sequence_steps||[];
      const step=steps.find(s=>s.step_order===enrollment.current_step);
      if(!step)return;
      const contact=contacts.find(c=>c.id===enrollment.contact_id);
      const dueDate=new Date();
      dueDate.setDate(dueDate.getDate()+(step.delay_days||0));
      
      const{data:task}=await db.from('tasks').insert([{title:`${step.step_type}: ${step.subject||'Follow up'}`,task_type:step.step_type,due_date:dueDate.toISOString(),contact_id:enrollment.contact_id,sequence_enrollment_id:enrollment.id,description:step.body||'',assigned_to:currentUser.email,status:'not_started'}]).select().single();
      if(task)tasks.push(task);
    }

    // Contacts
    function renderContacts(){
      const q=(document.getElementById('contact-search').value||'').toLowerCase();
      const stage=document.getElementById('contact-stage-filter').value;
      const f=contacts.filter(c=>{
        if(q&&!(c.first_name+' '+c.last_name+' '+c.email).toLowerCase().includes(q))return false;
        if(stage&&c.lifecycle_stage!==stage)return false;
        return true;
      });
      document.getElementById('contact-count').textContent=f.length+' contacts';
      document.getElementById('contacts-table').innerHTML=f.length?f.map(c=>{
        const co=companies.find(x=>x.id===c.company_id);
        return`<tr><td><span class="clickable" onclick="openContactModal('${c.id}')">${c.first_name} ${c.last_name}</span></td><td>${c.email||'-'}</td><td>${co?.name||'-'}</td><td><span class="badge badge-${c.lifecycle_stage==='customer'?'green':'blue'}">${c.lifecycle_stage||'lead'}</span></td><td>${c.lead_source||'-'}</td><td class="actions-cell"><button class="action-btn" onclick="openContactModal('${c.id}')">‚úèÔ∏è</button></td></tr>`;
      }).join(''):'<tr><td colspan="6" class="empty-state">No contacts</td></tr>';
    }

    function openContactModal(id){
      currentContactId=id||null;
      document.querySelectorAll('#contact-modal .modal-tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('#contact-modal .modal-tab-content').forEach(t=>t.classList.remove('active'));
      document.querySelector('#contact-modal .modal-tab[data-tab="contact-details"]').classList.add('active');
      document.getElementById('contact-tab-contact-details').classList.add('active');
      hideContactActivityForm();hideEnrollForm();
      
      if(id){
        const c=contacts.find(x=>x.id===id);
        document.getElementById('contact-modal-title').textContent=`${c.first_name} ${c.last_name}`;
        document.getElementById('contact-first').value=c.first_name||'';
        document.getElementById('contact-last').value=c.last_name||'';
        document.getElementById('contact-email').value=c.email||'';
        document.getElementById('contact-phone').value=c.phone||'';
        document.getElementById('contact-title').value=c.job_title||'';
        document.getElementById('contact-company').value=c.company_id||'';
        document.getElementById('contact-lifecycle').value=c.lifecycle_stage||'lead';
        document.getElementById('contact-source').value=c.lead_source||'';
        renderContactActivities(id);renderEnrollments(id);
      }else{
        document.getElementById('contact-modal-title').textContent='Add Contact';
        ['contact-first','contact-last','contact-email','contact-phone','contact-title','contact-source'].forEach(x=>document.getElementById(x).value='');
        document.getElementById('contact-company').value='';
        document.getElementById('contact-lifecycle').value='lead';
        document.getElementById('contact-activity-list').innerHTML='<div class="empty-state">Save contact first</div>';
        document.getElementById('contact-enrollments').innerHTML='';
      }
      document.getElementById('contact-modal').classList.add('open');
    }
    function closeContactModal(){document.getElementById('contact-modal').classList.remove('open');}

    async function saveContact(){
      const d={first_name:document.getElementById('contact-first').value,last_name:document.getElementById('contact-last').value,email:document.getElementById('contact-email').value,phone:document.getElementById('contact-phone').value,job_title:document.getElementById('contact-title').value,company_id:document.getElementById('contact-company').value||null,lifecycle_stage:document.getElementById('contact-lifecycle').value,lead_source:document.getElementById('contact-source').value||null};
      if(currentContactId){
        await db.from('contacts').update(d).eq('id',currentContactId);
        Object.assign(contacts.find(c=>c.id===currentContactId),d);
      }else{
        d.lead_status='new';
        const{data:n}=await db.from('contacts').insert([d]).select().single();
        if(n)contacts.unshift(n);
      }
      closeContactModal();renderContacts();renderLeads();renderDashboard();populateDropdowns();showToast('Saved!');
    }

    function renderContactActivities(id){
      const a=activities.filter(x=>x.contact_id===id);
      document.getElementById('contact-activity-list').innerHTML=a.length?a.slice(0,20).map(x=>`<div class="activity-item"><div class="activity-icon ${x.activity_type}">${ICONS[x.activity_type]||'üìã'}</div><div class="activity-content"><div class="activity-type">${x.activity_type}${x.outcome?' - '+x.outcome:''}</div>${x.notes?`<div class="activity-notes">${x.notes.substring(0,150)}</div>`:''}<div class="activity-meta">${x.team_member_name||''} ‚Ä¢ ${formatDate(x.created_at)}</div></div></div>`).join(''):'<div class="empty-state">No activities</div>';
    }
    function showContactActivityForm(t){document.getElementById('contact-activity-type').value=t;document.getElementById('contact-activity-form').classList.add('visible');}
    function hideContactActivityForm(){document.getElementById('contact-activity-form').classList.remove('visible');document.getElementById('contact-activity-outcome').value='';document.getElementById('contact-activity-notes').value='';}
    async function saveContactActivity(){
      if(!currentContactId)return;
      const{data}=await db.from('activities').insert([{contact_id:currentContactId,team_member_email:currentUser.email,team_member_name:currentUser.name,activity_type:document.getElementById('contact-activity-type').value,outcome:document.getElementById('contact-activity-outcome').value||null,notes:document.getElementById('contact-activity-notes').value}]).select().single();
      if(data)activities.unshift(data);
      
      const ct=contacts.find(c=>c.id===currentContactId);
      if(ct&&(ct.lead_status==='new'||!ct.lead_status)){
        await db.from('contacts').update({lead_status:'contacted'}).eq('id',currentContactId);
        ct.lead_status='contacted';
      }
      hideContactActivityForm();renderContactActivities(currentContactId);renderDashboard();renderLeads();showToast('Logged!');
    }
    function composeContactEmail(){
      const c=contacts.find(x=>x.id===currentContactId);
      if(!c?.email){showToast('No email','error');return;}
      window.open(`mailto:${c.email}?subject=Following up`,'_blank');
    }

    function renderEnrollments(id){
      const e=enrollments.filter(x=>x.contact_id===id);
      document.getElementById('contact-enrollments').innerHTML=e.length?e.map(x=>{
        const s=sequences.find(y=>y.id===x.sequence_id);
        const steps=s?.sequence_steps?.length||0;
        return`<div style="background:var(--joe-light);padding:12px;border-radius:8px;margin-bottom:8px"><div style="display:flex;justify-content:space-between"><strong>${s?.name||'Sequence'}</strong><span class="badge badge-${x.status==='active'?'purple':x.status==='completed'?'green':'gray'}">${x.status}</span></div><div style="font-size:12px;color:var(--joe-gray)">Step ${x.current_step} of ${steps}</div></div>`;
      }).join(''):'<div class="empty-state">Not enrolled</div>';
    }
    function showEnrollForm(){document.getElementById('enroll-form').classList.add('visible');}
    function hideEnrollForm(){document.getElementById('enroll-form').classList.remove('visible');}
    async function enrollContact(){
      if(!currentContactId)return;
      const seqId=document.getElementById('enroll-sequence').value;
      const seq=sequences.find(s=>s.id===seqId);
      if(!seq){showToast('Select a sequence','error');return;}
      
      const existing=enrollments.find(e=>e.contact_id===currentContactId&&e.sequence_id===seqId);
      if(existing){showToast('Already enrolled','error');return;}
      
      const{data:enrollment}=await db.from('sequence_enrollments').insert([{sequence_id:seqId,contact_id:currentContactId,enrolled_by:currentUser.email,status:'active',current_step:1}]).select().single();
      if(enrollment){
        enrollments.push(enrollment);
        await createNextTask(enrollment,seq);
      }
      hideEnrollForm();renderEnrollments(currentContactId);renderDashboard();showToast('Enrolled!');
    }

    // Create deal from contact
    async function createDealFromContact(){
      if(!currentContactId)return;
      const ct=contacts.find(c=>c.id===currentContactId);
      const co=companies.find(c=>c.id===ct.company_id);
      document.getElementById('deal-name').value=co?.name||`${ct.first_name}'s Deal`;
      document.getElementById('deal-contact').value=currentContactId;
      document.getElementById('deal-amount').value='';
      document.getElementById('deal-close-date').value='';
      document.getElementById('deal-stage').value='appointment';
      currentDealId=null;
      closeContactModal();
      document.getElementById('deal-modal').classList.add('open');
    }

    // Companies
    function renderCompanies(){
      const q=(document.getElementById('company-search').value||'').toLowerCase();
      const f=companies.filter(c=>!q||c.name.toLowerCase().includes(q));
      document.getElementById('company-count').textContent=f.length+' companies';
      document.getElementById('companies-table').innerHTML=f.length?f.map(c=>{
        const ct=contacts.filter(x=>x.company_id===c.id).length;
        return`<tr><td><span class="clickable" onclick="openCompanyModal('${c.id}')">${c.name}</span></td><td>${c.city||'-'}</td><td>${ct}</td><td class="actions-cell"><button class="action-btn" onclick="openCompanyModal('${c.id}')">‚úèÔ∏è</button></td></tr>`;
      }).join(''):'<tr><td colspan="4" class="empty-state">No companies</td></tr>';
    }
    function openCompanyModal(id){currentCompanyId=id||null;if(id){const c=companies.find(x=>x.id===id);document.getElementById('company-modal-title').textContent=c.name;document.getElementById('company-name').value=c.name;document.getElementById('company-city').value=c.city||'';document.getElementById('company-state').value=c.state||'';document.getElementById('company-phone').value=c.phone||'';document.getElementById('company-website').value=c.website||'';}else{document.getElementById('company-modal-title').textContent='Add Company';['company-name','company-city','company-state','company-phone','company-website'].forEach(x=>document.getElementById(x).value='');}document.getElementById('company-modal').classList.add('open');}
    function closeCompanyModal(){document.getElementById('company-modal').classList.remove('open');}
    async function saveCompany(){const d={name:document.getElementById('company-name').value,city:document.getElementById('company-city').value,state:document.getElementById('company-state').value,phone:document.getElementById('company-phone').value,website:document.getElementById('company-website').value};if(currentCompanyId){await db.from('companies').update(d).eq('id',currentCompanyId);Object.assign(companies.find(c=>c.id===currentCompanyId),d);}else{const{data:n}=await db.from('companies').insert([d]).select().single();if(n)companies.push(n);}closeCompanyModal();renderCompanies();populateDropdowns();showToast('Saved!');}

    // Deals
    function renderDeals(){document.getElementById('deals-pipeline').innerHTML=DEAL_STAGES.map(st=>{const sd=deals.filter(d=>d.stage===st.id);const tot=sd.reduce((s,d)=>s+(d.amount||0),0);return`<div class="pipeline-column"><div class="pipeline-header"><h3>${st.label}</h3><span class="pipeline-count">$${tot.toLocaleString()}</span></div>${sd.map(d=>{const ct=contacts.find(c=>c.id===d.contact_id);return`<div class="pipeline-card" onclick="openDealModal('${d.id}')"><h4>${d.name}</h4><div class="meta">${ct?ct.first_name+' '+ct.last_name:'-'}</div>${d.amount?`<div class="amount">$${d.amount.toLocaleString()}</div>`:''}</div>`;}).join('')}</div>`;}).join('');}
    function openDealModal(id){currentDealId=id||null;if(id){const d=deals.find(x=>x.id===id);document.getElementById('deal-modal-title').textContent=d.name;document.getElementById('deal-name').value=d.name;document.getElementById('deal-amount').value=d.amount||'';document.getElementById('deal-close-date').value=d.close_date||'';document.getElementById('deal-contact').value=d.contact_id||'';document.getElementById('deal-stage').value=d.stage;}else{document.getElementById('deal-modal-title').textContent='Add Deal';['deal-name','deal-amount','deal-close-date'].forEach(x=>document.getElementById(x).value='');document.getElementById('deal-contact').value='';document.getElementById('deal-stage').value='appointment';}document.getElementById('deal-modal').classList.add('open');}
    function closeDealModal(){document.getElementById('deal-modal').classList.remove('open');}
    async function saveDeal(){const d={name:document.getElementById('deal-name').value,amount:parseFloat(document.getElementById('deal-amount').value)||null,close_date:document.getElementById('deal-close-date').value||null,contact_id:document.getElementById('deal-contact').value||null,stage:document.getElementById('deal-stage').value};if(currentDealId){await db.from('deals').update(d).eq('id',currentDealId);Object.assign(deals.find(x=>x.id===currentDealId),d);}else{const{data:n}=await db.from('deals').insert([d]).select().single();if(n)deals.unshift(n);}closeDealModal();renderDeals();renderDashboard();showToast('Saved!');}

    // Sequences
    function renderSequences(){
      document.getElementById('sequences-list').innerHTML=sequences.length?sequences.map(s=>{
        const steps=s.sequence_steps||[];
        const enrolled=enrollments.filter(e=>e.sequence_id===s.id&&e.status==='active').length;
        return`<div class="sequence-card"><div style="display:flex;justify-content:space-between"><div><h3>${s.name}${s.is_default?' ‚≠ê':''}</h3><div style="font-size:12px;color:var(--joe-gray)">${s.description||''}</div></div><div style="text-align:right"><div style="font-size:20px;font-weight:700">${steps.length}</div><div style="font-size:10px;color:var(--joe-gray)">STEPS</div></div></div><div class="sequence-steps">${steps.sort((a,b)=>a.step_order-b.step_order).map(st=>`<div class="sequence-step"><div class="step-num">${st.step_order}</div><div class="step-content"><span class="step-type ${st.step_type}">${st.step_type}</span><span class="step-delay">+${st.delay_days}d</span><div class="step-subject">${st.subject||'Task'}</div></div></div>`).join('')}</div><div style="margin-top:12px;display:flex;gap:8px;align-items:center"><button class="btn btn-small btn-secondary" onclick="editSequence('${s.id}')">Edit</button><span class="badge badge-purple">${enrolled} active</span></div></div>`;
      }).join(''):'<div class="empty-state">No sequences yet</div>';
    }

    function openSequenceModal(){
      currentSequenceId=null;
      seqSteps=[{step_order:1,step_type:'email',delay_days:0,subject:'',body:''}];
      document.getElementById('sequence-name').value='';
      document.getElementById('sequence-desc').value='';
      document.getElementById('sequence-default').checked=false;
      document.getElementById('sequence-modal-title').textContent='Create Sequence';
      renderStepsEditor();
      document.getElementById('sequence-modal').classList.add('open');
    }
    function editSequence(id){
      const s=sequences.find(x=>x.id===id);if(!s)return;
      currentSequenceId=id;
      seqSteps=(s.sequence_steps||[]).map(x=>({...x}));
      if(!seqSteps.length)seqSteps=[{step_order:1,step_type:'email',delay_days:0,subject:'',body:''}];
      document.getElementById('sequence-name').value=s.name;
      document.getElementById('sequence-desc').value=s.description||'';
      document.getElementById('sequence-default').checked=s.is_default||false;
      document.getElementById('sequence-modal-title').textContent='Edit Sequence';
      renderStepsEditor();
      document.getElementById('sequence-modal').classList.add('open');
    }
    function closeSequenceModal(){document.getElementById('sequence-modal').classList.remove('open');}

    function renderStepsEditor(){
      document.getElementById('sequence-steps-editor').innerHTML=seqSteps.map((s,i)=>`<div style="background:var(--joe-light);padding:12px;border-radius:8px;margin-bottom:8px"><div style="display:flex;gap:12px;align-items:center;margin-bottom:8px"><strong>Step ${s.step_order}</strong><select onchange="seqSteps[${i}].step_type=this.value" style="padding:4px 8px;border-radius:4px;border:1px solid #e5e7eb"><option value="email"${s.step_type==='email'?' selected':''}>üìß Email</option><option value="call"${s.step_type==='call'?' selected':''}>üìû Call</option></select><span style="font-size:12px">Wait</span><input type="number" value="${s.delay_days}" min="0" onchange="seqSteps[${i}].delay_days=parseInt(this.value)" style="width:60px;padding:4px 8px;border-radius:4px;border:1px solid #e5e7eb"> days<button onclick="seqSteps.splice(${i},1);seqSteps.forEach((x,j)=>x.step_order=j+1);renderStepsEditor()" style="margin-left:auto;background:none;border:none;cursor:pointer">üóëÔ∏è</button></div><input type="text" value="${(s.subject||'').replace(/"/g,'&quot;')}" onchange="seqSteps[${i}].subject=this.value" placeholder="Subject/Title" style="width:100%;padding:8px;border-radius:4px;border:1px solid #e5e7eb;margin-bottom:8px"><textarea onchange="seqSteps[${i}].body=this.value" placeholder="Body/Script" style="width:100%;padding:8px;border-radius:4px;border:1px solid #e5e7eb;min-height:60px">${s.body||''}</textarea></div>`).join('');
    }
    function addStep(){seqSteps.push({step_order:seqSteps.length+1,step_type:'email',delay_days:3,subject:'',body:''});renderStepsEditor();}

    async function saveSequence(){
      const name=document.getElementById('sequence-name').value;
      const desc=document.getElementById('sequence-desc').value;
      const isDefault=document.getElementById('sequence-default').checked;
      if(!name){showToast('Name required','error');return;}
      
      if(isDefault){
        await db.from('sequences').update({is_default:false}).neq('id',currentSequenceId||'');
        sequences.forEach(s=>s.is_default=false);
      }
      
      let id=currentSequenceId;
      if(id){
        await db.from('sequences').update({name,description:desc,is_default:isDefault}).eq('id',id);
        await db.from('sequence_steps').delete().eq('sequence_id',id);
        const s=sequences.find(x=>x.id===id);
        if(s){s.name=name;s.description=desc;s.is_default=isDefault;}
      }else{
        const{data:n}=await db.from('sequences').insert([{name,description:desc,created_by:currentUser?.email,is_default:isDefault,is_active:true}]).select().single();
        if(n){id=n.id;n.sequence_steps=[];sequences.unshift(n);}
      }
      
      for(const st of seqSteps){
        await db.from('sequence_steps').insert([{sequence_id:id,step_order:st.step_order,step_type:st.step_type,delay_days:st.delay_days,subject:st.subject,body:st.body}]);
      }
      
      const seq=sequences.find(s=>s.id===id);
      if(seq)seq.sequence_steps=seqSteps.map(s=>({...s,sequence_id:id}));
      
      closeSequenceModal();renderSequences();populateDropdowns();showToast('Saved!');
    }

    // Tasks
    function renderTasks(){
      const filter=document.getElementById('task-filter').value;
      const today=new Date().toISOString().split('T')[0];
      let f=tasks;
      
      if(filter==='pending')f=f.filter(t=>t.status!=='completed');
      else if(filter==='today')f=f.filter(t=>t.status!=='completed'&&t.due_date?.startsWith(today));
      else if(filter==='overdue')f=f.filter(t=>t.status!=='completed'&&t.due_date&&t.due_date.split('T')[0]<today);
      
      document.getElementById('tasks-list').innerHTML=f.length?f.map(t=>{
        const ct=contacts.find(c=>c.id===t.contact_id);
        const isSeq=t.sequence_enrollment_id;
        const dd=t.due_date?.split('T')[0]||'';
        let dueClass='upcoming';
        if(dd&&dd<today)dueClass='overdue';
        else if(dd===today)dueClass='today';
        const done=t.status==='completed';
        return`<div class="task-item${isSeq?' sequence-task':''}"><div class="task-checkbox${done?' done':''}" onclick="completeTask('${t.id}')">${done?'‚úì':''}</div><div class="task-info"><div class="task-title">${t.title}</div><div class="task-meta">${ct?ct.first_name+' '+ct.last_name:''}${isSeq?' ‚Ä¢ Sequence':''}</div></div>${dd?`<span class="task-due ${dueClass}">${dd}</span>`:''}</div>`;
      }).join(''):'<div class="empty-state">No tasks</div>';
    }

    async function completeTask(id){
      const task=tasks.find(t=>t.id===id);
      if(!task)return;
      
      await db.from('tasks').update({status:'completed',completed_at:new Date().toISOString()}).eq('id',id);
      task.status='completed';
      
      if(task.sequence_enrollment_id){
        const enrollment=enrollments.find(e=>e.id===task.sequence_enrollment_id);
        if(enrollment&&enrollment.status==='active'){
          const seq=sequences.find(s=>s.id===enrollment.sequence_id);
          const steps=seq?.sequence_steps||[];
          const nextStep=enrollment.current_step+1;
          
          if(nextStep<=steps.length){
            await db.from('sequence_enrollments').update({current_step:nextStep}).eq('id',enrollment.id);
            enrollment.current_step=nextStep;
            await createNextTask(enrollment,seq);
            showToast('Next step scheduled!');
          }else{
            await db.from('sequence_enrollments').update({status:'completed'}).eq('id',enrollment.id);
            enrollment.status='completed';
            showToast('Sequence completed! üéâ');
          }
        }
      }
      
      renderTasks();renderDashboard();
    }

    function openTaskModal(){
      ['task-title'].forEach(x=>document.getElementById(x).value='');
      document.getElementById('task-type').value='todo';
      document.getElementById('task-due').value='';
      document.getElementById('task-contact').value='';
      document.getElementById('task-modal').classList.add('open');
    }
    function closeTaskModal(){document.getElementById('task-modal').classList.remove('open');}
    async function saveTask(){
      const{data:n}=await db.from('tasks').insert([{title:document.getElementById('task-title').value,task_type:document.getElementById('task-type').value,due_date:document.getElementById('task-due').value||null,contact_id:document.getElementById('task-contact').value||null,assigned_to:currentUser?.email,status:'not_started'}]).select().single();
      if(n)tasks.push(n);
      closeTaskModal();renderTasks();renderDashboard();showToast('Created!');
    }

    // Navigation
    function navigateTo(page){
      document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      document.querySelector(`[data-page="${page}"]`).classList.add('active');
      document.getElementById('page-'+page).classList.add('active');
      if(page==='shops'){renderShops();setTimeout(()=>{initMap();if(map)map.resize();},100);}
      if(page==='pipeline')renderOutboundPipeline();
      if(page==='leads')renderLeads();
      if(page==='contacts')renderContacts();
      if(page==='companies')renderCompanies();
      if(page==='deals')renderDeals();
      if(page==='sequences')renderSequences();
      if(page==='tasks')renderTasks();
    }
    document.querySelectorAll('.nav-item').forEach(item=>item.addEventListener('click',()=>navigateTo(item.dataset.page)));

    function formatDate(d){if(!d)return'';const diff=Date.now()-new Date(d);if(diff<0)return'upcoming';if(diff<3600000)return Math.floor(diff/60000)+'m ago';if(diff<86400000)return Math.floor(diff/3600000)+'h ago';if(diff<604800000)return Math.floor(diff/86400000)+'d ago';return new Date(d).toLocaleDateString();}
    function showToast(m,type='success'){const t=document.getElementById('toast');t.textContent=m;t.className='toast show '+type;setTimeout(()=>t.classList.remove('show'),3000);}

    netlifyIdentity.init();
  </script>
</body>
</html>
