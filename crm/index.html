<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>joe CRM</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root{--joe-black:#1a1a1a;--joe-dark:#2d2d2d;--joe-gray:#6b7280;--joe-light:#f3f4f6;--joe-accent:#f59e0b;--joe-green:#10b981;--joe-red:#ef4444;--joe-blue:#3b82f6;--joe-purple:#8b5cf6}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--joe-light);color:var(--joe-black);min-height:100vh}
    .auth-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,var(--joe-black),var(--joe-dark));color:#fff}
    .auth-screen img{height:60px;margin-bottom:24px}
    .btn{padding:10px 20px;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:6px;transition:all .2s}
    .btn-primary{background:var(--joe-accent);color:var(--joe-black)}
    .btn-primary:hover{background:#d97706}
    .btn-secondary{background:var(--joe-dark);color:#fff;border:1px solid var(--joe-gray)}
    .btn-success{background:var(--joe-green);color:#fff}
    .btn-small{padding:6px 12px;font-size:12px}
    .btn-google{background:#fff;color:#333;padding:14px 28px}
    .app{display:none}.app.active{display:flex;min-height:100vh}
    .sidebar{width:220px;background:var(--joe-black);color:#fff;padding:20px 0;display:flex;flex-direction:column;flex-shrink:0}
    .sidebar-logo{padding:0 20px 20px;border-bottom:1px solid var(--joe-dark);margin-bottom:20px}
    .sidebar-logo img{height:32px}
    .nav-section{padding:0 12px;margin-bottom:8px}
    .nav-section-title{font-size:10px;text-transform:uppercase;color:var(--joe-gray);padding:8px;letter-spacing:.5px}
    .nav-item{padding:10px 12px;color:var(--joe-gray);cursor:pointer;display:flex;align-items:center;gap:10px;border-radius:6px;font-size:14px;margin-bottom:2px}
    .nav-item:hover,.nav-item.active{background:var(--joe-dark);color:#fff}
    .nav-item .badge{background:var(--joe-accent);color:var(--joe-black);padding:2px 6px;border-radius:10px;font-size:10px;font-weight:700;margin-left:auto}
    .nav-item .badge.red{background:var(--joe-red);color:#fff}
    .nav-item .badge.purple{background:var(--joe-purple);color:#fff}
    .sidebar-user{padding:16px 20px;border-top:1px solid var(--joe-dark);margin-top:auto}
    .user-info{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .user-avatar{width:32px;height:32px;border-radius:50%;background:var(--joe-accent);display:flex;align-items:center;justify-content:center;font-weight:600;font-size:12px;overflow:hidden}
    .user-avatar img{width:100%;height:100%;object-fit:cover}
    .user-name{font-size:13px;font-weight:600}
    .user-role{font-size:10px;color:var(--joe-gray)}
    .main{flex:1;padding:24px;overflow-y:auto}
    .page{display:none}.page.active{display:block}
    .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px}
    .page-header h1{font-size:24px}
    
    .dashboard-toggle{display:flex;gap:8px;margin-bottom:16px}
    .toggle-btn{padding:8px 16px;border:1px solid #e5e7eb;background:#fff;border-radius:6px;font-size:12px;cursor:pointer;font-weight:500}
    .toggle-btn.active{background:var(--joe-black);color:#fff;border-color:var(--joe-black)}
    
    .ai-copilot{background:linear-gradient(135deg,var(--joe-black),var(--joe-dark));border-radius:16px;padding:20px;margin-bottom:24px;color:#fff}
    .ai-header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
    .ai-header h2{font-size:18px}
    .ai-badge{background:var(--joe-accent);color:var(--joe-black);padding:2px 8px;border-radius:10px;font-size:10px;font-weight:700}
    .ai-input-container{display:flex;gap:12px}
    .ai-input{flex:1;padding:14px 18px;border:none;border-radius:12px;font-size:15px;background:rgba(255,255,255,.1);color:#fff;outline:none}
    .ai-input::placeholder{color:rgba(255,255,255,.5)}
    .ai-submit{padding:14px 24px;background:var(--joe-accent);color:var(--joe-black);border:none;border-radius:12px;font-weight:600;cursor:pointer}
    .ai-suggestions{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .ai-suggestion{background:rgba(255,255,255,.1);border:none;padding:6px 12px;border-radius:20px;color:rgba(255,255,255,.8);font-size:12px;cursor:pointer}
    .ai-suggestion:hover{background:rgba(255,255,255,.2)}
    .ai-response{margin-top:16px;padding:16px;background:rgba(255,255,255,.05);border-radius:12px;display:none}
    .ai-response.visible{display:block}
    .ai-response-header{display:flex;align-items:center;gap:8px;margin-bottom:12px;font-size:12px;color:var(--joe-accent);text-transform:uppercase;font-weight:600}
    .ai-response-content{font-size:14px;line-height:1.6}
    
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:24px}
    .stat-card{background:#fff;padding:16px;border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,.1);cursor:pointer;transition:transform .1s}
    .stat-card:hover{transform:translateY(-2px)}
    .stat-card h3{font-size:10px;text-transform:uppercase;color:var(--joe-gray);margin-bottom:6px}
    .stat-card .value{font-size:24px;font-weight:700}
    .stat-card.accent .value{color:var(--joe-accent)}
    .stat-card.green .value{color:var(--joe-green)}
    .stat-card.red .value{color:var(--joe-red)}
    .stat-card.blue .value{color:var(--joe-blue)}
    .stat-card.purple .value{color:var(--joe-purple)}
    .card{background:#fff;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.1);overflow:hidden;margin-bottom:20px}
    .card-header{padding:16px 20px;border-bottom:1px solid var(--joe-light);display:flex;justify-content:space-between;align-items:center}
    .card-header h2{font-size:16px}
    .card-body{padding:20px}
    
    .reports-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin-bottom:24px}
    @media(max-width:1200px){.reports-grid{grid-template-columns:1fr}}
    .funnel-container{padding:20px}
    .funnel-stage{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    .funnel-bar-wrapper{flex:1}
    .funnel-bar{height:32px;border-radius:6px;display:flex;align-items:center;padding:0 12px;font-size:12px;font-weight:600;color:#fff}
    .funnel-bar.new{background:var(--joe-gray)}
    .funnel-bar.contacted{background:var(--joe-blue)}
    .funnel-bar.qualified{background:var(--joe-accent)}
    .funnel-bar.demo_scheduled{background:var(--joe-green)}
    .funnel-bar.proposal{background:var(--joe-purple)}
    .funnel-label{width:80px;font-size:12px;font-weight:600;text-align:right}
    .funnel-percent{font-size:11px;color:var(--joe-gray);margin-left:8px}
    .conversion-list,.activity-summary,.location-list{padding:20px}
    .conversion-row,.activity-row,.location-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--joe-light)}
    .conversion-row:last-child,.activity-row:last-child,.location-row:last-child{border-bottom:none}
    .conversion-stages{font-size:13px;display:flex;align-items:center;gap:8px}
    .conversion-arrow{color:var(--joe-gray)}
    .conversion-rate{font-size:18px;font-weight:700}
    .conversion-rate.good{color:var(--joe-green)}
    .conversion-rate.medium{color:var(--joe-accent)}
    .conversion-rate.low{color:var(--joe-red)}
    .activity-type-label{display:flex;align-items:center;gap:8px;font-size:13px}
    .activity-type-icon{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px}
    .activity-type-icon.call{background:#d1fae5}
    .activity-type-icon.email{background:#dbeafe}
    .activity-type-icon.note{background:#e5e7eb}
    .activity-type-icon.sms{background:#ede9fe}
    .activity-counts{display:flex;gap:16px;align-items:center}
    .activity-count{text-align:center}
    .activity-count .num{font-size:18px;font-weight:700}
    .activity-count .label{font-size:9px;text-transform:uppercase;color:var(--joe-gray)}
    .activity-trend{font-size:12px;font-weight:600}
    .activity-trend.up{color:var(--joe-green)}
    .activity-trend.down{color:var(--joe-red)}
    .activity-trend.flat{color:var(--joe-gray)}
    .location-name{font-size:13px;font-weight:500}
    .location-stats{display:flex;gap:12px;align-items:center}
    .location-hot{background:#fef3c7;color:#92400e;padding:4px 10px;border-radius:20px;font-size:12px;font-weight:600}
    .location-total{font-size:12px;color:var(--joe-gray)}
    
    .map-section{margin-bottom:16px}
    .map-toggle{display:flex;align-items:center;margin-bottom:12px}
    .map-toggle-btn{display:flex;align-items:center;gap:8px;padding:8px 16px;background:var(--joe-black);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer}
    .map-toggle-btn.collapsed{background:#fff;color:var(--joe-black);border:1px solid #e5e7eb}
    .map-wrapper{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.1);transition:all .3s}
    .map-wrapper.collapsed{height:0;opacity:0;margin:0}
    .map-container{height:350px;position:relative}
    #shops-map{width:100%;height:100%}
    .map-legend{position:absolute;bottom:12px;left:12px;background:#fff;padding:10px 14px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.15);z-index:10;font-size:11px}
    .map-legend h4{margin-bottom:6px;font-size:10px;text-transform:uppercase;color:var(--joe-gray)}
    .legend-item{display:flex;align-items:center;gap:6px;margin-bottom:3px}
    .legend-dot{width:10px;height:10px;border-radius:50%}
    .legend-dot.hot{background:#f59e0b}
    .legend-dot.warm{background:#3b82f6}
    .legend-dot.cold{background:#6b7280}
    .map-stats{position:absolute;top:12px;right:12px;background:#fff;padding:10px 14px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.15);z-index:10}
    .map-stats .num{font-size:18px;font-weight:700}
    .map-stats .label{font-size:9px;text-transform:uppercase;color:var(--joe-gray)}
    
    .filter-bar{background:#fff;padding:12px 16px;border-radius:10px;margin-bottom:16px}
    .filter-row{display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end}
    .filter-group{display:flex;flex-direction:column;gap:4px}
    .filter-group>label{font-size:10px;text-transform:uppercase;color:var(--joe-gray);font-weight:600}
    .search-input,.filter-select{padding:8px 12px;border:1px solid #e5e7eb;border-radius:6px;font-size:13px}
    .search-input{width:180px}
    .multi-select{position:relative}
    .multi-select-trigger{padding:8px 12px;border:1px solid #e5e7eb;border-radius:6px;font-size:13px;min-width:130px;background:#fff;cursor:pointer;display:flex;justify-content:space-between;align-items:center;gap:8px}
    .multi-select-dropdown{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #e5e7eb;border-radius:6px;margin-top:4px;max-height:220px;overflow-y:auto;z-index:100;display:none;box-shadow:0 4px 12px rgba(0,0,0,.15)}
    .multi-select-dropdown.open{display:block}
    .multi-select-option{padding:8px 12px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:13px}
    .multi-select-option:hover{background:var(--joe-light)}
    .multi-select-option input{margin:0}
    .filter-tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:12px}
    .filter-tag{background:var(--joe-accent);color:var(--joe-black);padding:4px 10px;border-radius:20px;font-size:11px;font-weight:500;display:flex;align-items:center;gap:6px}
    .filter-tag .remove{cursor:pointer;font-weight:bold}
    .clear-filters{background:none;border:none;color:var(--joe-gray);font-size:12px;cursor:pointer;text-decoration:underline}
    .results-count{font-size:13px;color:var(--joe-gray);margin-left:auto}
    
    .searchable-select{position:relative}
    .searchable-select input{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:6px;font-size:13px}
    .searchable-select-dropdown{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #e5e7eb;border-radius:6px;margin-top:4px;max-height:200px;overflow-y:auto;z-index:100;display:none;box-shadow:0 4px 12px rgba(0,0,0,.15)}
    .searchable-select-dropdown.open{display:block}
    .searchable-select-option{padding:10px 12px;cursor:pointer;font-size:13px}
    .searchable-select-option:hover{background:var(--joe-light)}
    .searchable-select-create{padding:10px 12px;cursor:pointer;font-size:13px;color:var(--joe-blue);border-top:1px solid var(--joe-light)}
    .searchable-select-create:hover{background:var(--joe-light)}
    
    table{width:100%;border-collapse:collapse}
    th{text-align:left;padding:12px 16px;background:var(--joe-light);font-size:11px;text-transform:uppercase;color:var(--joe-gray);cursor:pointer}
    th:hover{background:#e5e7eb}
    td{padding:12px 16px;border-top:1px solid var(--joe-light);font-size:13px}
    tr:hover{background:#fafafa}
    .clickable{cursor:pointer;font-weight:600}.clickable:hover{color:var(--joe-accent)}
    .badge{display:inline-block;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600}
    .badge-gray{background:#e5e7eb;color:#4b5563}
    .badge-blue{background:#dbeafe;color:#1e40af}
    .badge-green{background:#d1fae5;color:#065f46}
    .badge-yellow{background:#fef3c7;color:#92400e}
    .badge-red{background:#fee2e2;color:#991b1b}
    .badge-purple{background:#ede9fe;color:#5b21b6}
    .score{display:inline-block;padding:4px 10px;border-radius:20px;font-size:12px;font-weight:600}
    .score.hot{background:#fef3c7;color:#92400e}
    .score.warm{background:#dbeafe;color:#1e40af}
    .score.cold{background:#e5e7eb;color:#4b5563}
    .stage-badge{display:inline-block;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;text-transform:uppercase}
    .stage-new{background:#e5e7eb;color:#4b5563}
    .stage-contacted{background:#dbeafe;color:#1e40af}
    .stage-qualified{background:#fef3c7;color:#92400e}
    .stage-demo_scheduled{background:#d1fae5;color:#065f46}
    .stage-proposal{background:#ede9fe;color:#5b21b6}
    .stage-closed_won{background:#10b981;color:#fff}
    .stage-closed_lost{background:#ef4444;color:#fff}
    .owner-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;background:var(--joe-light);border-radius:10px;font-size:10px;color:var(--joe-gray)}
    .owner-badge.mine{background:#dbeafe;color:#1e40af}
    .action-btn{width:28px;height:28px;border:none;border-radius:6px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;background:var(--joe-light);color:var(--joe-gray);font-size:12px;text-decoration:none}
    .action-btn:hover{background:var(--joe-accent);color:var(--joe-black)}
    .actions-cell{display:flex;gap:6px}
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000;padding:20px}
    .modal-overlay.open{display:flex}
    .modal{background:#fff;border-radius:12px;width:100%;max-width:700px;max-height:90vh;overflow-y:auto}
    .modal.wide{max-width:900px}
    .modal-header{padding:16px 20px;border-bottom:1px solid var(--joe-light);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:#fff;z-index:10}
    .modal-close{background:none;border:none;font-size:24px;cursor:pointer;color:var(--joe-gray)}
    .modal-body{padding:20px}
    .modal-tabs{display:flex;gap:4px;margin-bottom:16px;border-bottom:1px solid var(--joe-light);overflow-x:auto}
    .modal-tab{padding:8px 14px;background:none;border:none;font-size:13px;color:var(--joe-gray);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;white-space:nowrap}
    .modal-tab.active{color:var(--joe-black);border-bottom-color:var(--joe-accent)}
    .modal-tab-content{display:none}.modal-tab-content.active{display:block}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .form-group{display:flex;flex-direction:column;gap:4px}
    .form-group.full{grid-column:1/-1}
    .form-group label{font-size:11px;font-weight:600;color:var(--joe-gray);text-transform:uppercase}
    .form-group input,.form-group select,.form-group textarea{padding:10px 12px;border:1px solid #e5e7eb;border-radius:6px;font-size:13px}
    .form-group textarea{min-height:100px;font-family:inherit}
    .modal-footer{padding:14px 20px;border-top:1px solid var(--joe-light);display:flex;justify-content:space-between;gap:10px;position:sticky;bottom:0;background:#fff}
    
    .log-activity-btn{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
    .log-btn{padding:8px 12px;border:1px solid #e5e7eb;background:#fff;border-radius:6px;font-size:12px;cursor:pointer;display:flex;align-items:center;gap:6px}
    .log-btn:hover{background:var(--joe-light)}
    .log-btn.call{border-color:var(--joe-green);color:var(--joe-green)}
    .log-btn.email{border-color:var(--joe-blue);color:var(--joe-blue)}
    .log-btn.sms{border-color:var(--joe-purple);color:var(--joe-purple)}
    .activity-form{background:var(--joe-light);padding:12px;border-radius:8px;margin-bottom:12px;display:none}
    .activity-form.visible{display:block}
    .activity-list{max-height:300px;overflow-y:auto}
    .activity-item{display:flex;gap:10px;padding:10px 0;border-bottom:1px solid var(--joe-light)}
    .activity-icon{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0}
    .activity-icon.call{background:#d1fae5}
    .activity-icon.email{background:#dbeafe}
    .activity-icon.sms{background:#ede9fe}
    .activity-icon.note{background:#e5e7eb}
    .activity-content{flex:1;min-width:0}
    .activity-type{font-weight:600;font-size:12px}
    .activity-notes{font-size:12px;color:var(--joe-gray);white-space:pre-wrap}
    .activity-meta{font-size:10px;color:var(--joe-gray);margin-top:2px}
    
    .pipeline-container{display:flex;gap:12px;overflow-x:auto;padding-bottom:12px}
    .pipeline-column{min-width:220px;background:var(--joe-light);border-radius:10px;padding:12px;flex-shrink:0;transition:background .2s}
    .pipeline-column.drag-over{background:#dbeafe;border:2px dashed var(--joe-blue)}
    .pipeline-header{display:flex;justify-content:space-between;margin-bottom:10px}
    .pipeline-header h3{font-size:12px;text-transform:uppercase;color:var(--joe-gray)}
    .pipeline-count{background:#fff;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600}
    .pipeline-card{background:#fff;padding:12px;border-radius:8px;cursor:grab;margin-bottom:8px;box-shadow:0 1px 2px rgba(0,0,0,.1);transition:transform .1s,box-shadow .1s}
    .pipeline-card:active{cursor:grabbing}
    .pipeline-card.dragging{opacity:.5;transform:rotate(2deg)}
    .pipeline-card h4{font-size:13px;margin-bottom:4px}
    .pipeline-card .meta{font-size:11px;color:var(--joe-gray)}
    .pipeline-card .amount{font-size:14px;font-weight:600;color:var(--joe-green);margin-top:6px}
    
    .integration-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
    .integration-card{background:#fff;border-radius:12px;padding:20px;border:1px solid #e5e7eb}
    .integration-card.connected{border-color:var(--joe-green)}
    .integration-header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .integration-icon{width:48px;height:48px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:24px;background:var(--joe-light)}
    .integration-info h3{font-size:15px;margin-bottom:2px}
    .integration-info p{font-size:12px;color:var(--joe-gray)}
    .integration-status{display:flex;align-items:center;gap:6px;font-size:12px;margin-bottom:12px}
    .status-dot{width:8px;height:8px;border-radius:50%}
    .status-dot.connected{background:var(--joe-green)}
    .status-dot.disconnected{background:var(--joe-gray)}
    .badge-green{background:#d1fae5;color:#065f46}
    
    .sequence-card{background:#fff;border-radius:10px;padding:16px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    .sequence-card h3{font-size:15px;margin-bottom:4px}
    .sequence-steps{border-top:1px solid var(--joe-light);padding-top:12px;margin-top:12px}
    .sequence-step{display:flex;align-items:flex-start;gap:12px;padding:10px;background:var(--joe-light);border-radius:8px;margin-bottom:8px}
    .step-num{width:24px;height:24px;border-radius:50%;background:var(--joe-black);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;flex-shrink:0}
    .step-content{flex:1;min-width:0}
    .step-type{padding:2px 8px;border-radius:4px;font-size:10px;font-weight:500;display:inline-block}
    .step-type.email{background:#dbeafe;color:#1e40af}
    .step-type.call{background:#d1fae5;color:#065f46}
    .step-type.sms{background:#ede9fe;color:#5b21b6}
    .step-delay{font-size:10px;color:var(--joe-gray);margin-left:8px}
    .step-subject{font-size:12px;font-weight:500;margin-top:4px}
    
    .task-item{display:flex;align-items:center;gap:12px;padding:12px;background:#fff;border-radius:8px;margin-bottom:8px;border:1px solid #e5e7eb}
    .task-item.sequence-task{border-left:3px solid var(--joe-purple)}
    .task-checkbox{width:20px;height:20px;border:2px solid #e5e7eb;border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}
    .task-checkbox.done{background:var(--joe-green);border-color:var(--joe-green);color:#fff}
    .task-info{flex:1;min-width:0}
    .task-title{font-size:13px;font-weight:500}
    .task-meta{font-size:11px;color:var(--joe-gray)}
    .task-due{font-size:11px;padding:3px 8px;border-radius:4px;flex-shrink:0}
    .task-due.overdue{background:#fee2e2;color:#991b1b}
    .task-due.today{background:#fef3c7;color:#92400e}
    .task-due.upcoming{background:#e5e7eb;color:#4b5563}
    
    .empty-state{text-align:center;padding:40px;color:var(--joe-gray)}
    .toast{position:fixed;bottom:24px;right:24px;background:var(--joe-black);color:#fff;padding:12px 20px;border-radius:8px;display:none;z-index:2000}
    .toast.show{display:block}
    .help-fab{position:fixed;bottom:80px;right:24px;width:56px;height:56px;border-radius:50%;background:var(--joe-accent);color:var(--joe-black);border:none;font-size:24px;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.2);z-index:1000;display:flex;align-items:center;justify-content:center;transition:transform .2s}
    .help-fab:hover{transform:scale(1.1)}
    .toast.success{background:var(--joe-green)}
    .toast.error{background:var(--joe-red)}
    .auth-error{background:rgba(239,68,68,.1);border:1px solid var(--joe-red);padding:12px;border-radius:8px;margin-top:16px;color:var(--joe-red);display:none}
    .quick-actions{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px}
    @media(max-width:768px){.sidebar{width:60px}.sidebar-logo span,.nav-section-title,.nav-item span:not(.badge),.user-info{display:none}.form-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="auth-screen" id="authScreen">
    <img src="https://4591743.fs1.hubspotusercontent-na1.net/hubfs/4591743/Black.png" alt="joe">
    <h1>joe CRM</h1>
    <p style="color:var(--joe-gray);margin-bottom:24px">Partner Growth Console</p>
    <button class="btn btn-google" onclick="netlifyIdentity.open()">Sign in with Google</button>
    <div class="auth-error" id="auth-error">Only @joe.coffee accounts can access.</div>
  </div>

  <div class="app" id="app">
    <aside class="sidebar">
      <div class="sidebar-logo"><img src="https://4591743.fs1.hubspotusercontent-na1.net/hubfs/4591743/Black.png" alt="joe"></div>
      <div class="nav-section">
        <div class="nav-section-title">Overview</div>
        <div class="nav-item active" data-page="dashboard"><span>üìä</span> <span>Dashboard</span></div>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Outbound</div>
        <div class="nav-item" data-page="shops"><span>‚òï</span> <span>Shops</span> <span class="badge" id="shops-badge">0</span></div>
        <div class="nav-item" data-page="pipeline"><span>üéØ</span> <span>Pipeline</span></div>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Inbound</div>
        <div class="nav-item" data-page="leads"><span>üî•</span> <span>New Leads</span> <span class="badge red" id="leads-badge">0</span></div>
        <div class="nav-item" data-page="contacts"><span>üë§</span> <span>Contacts</span></div>
        <div class="nav-item" data-page="companies"><span>üè¢</span> <span>Companies</span></div>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Sales</div>
        <div class="nav-item" data-page="deals"><span>üí∞</span> <span>Deals</span></div>
        <div class="nav-item" data-page="sequences"><span>‚ö°</span> <span>Sequences</span></div>
        <div class="nav-item" data-page="meetings"><span>üé•</span> <span>Meeting Notes</span></div>
        <div class="nav-item" data-page="emails"><span>‚úâÔ∏è</span> <span>Email Templates</span></div>
        <div class="nav-item" data-page="tasks"><span>‚úÖ</span> <span>Tasks</span> <span class="badge purple" id="tasks-badge">0</span></div>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Settings</div>
        <div class="nav-item" data-page="team"><span>üë•</span> <span>Team</span></div>
        <div class="nav-item" data-page="integrations"><span>üîå</span> <span>Integrations</span></div>
      </div>
      <div class="sidebar-user">
        <div class="user-info">
          <div class="user-avatar" id="user-avatar">?</div>
          <div><div class="user-name" id="user-name">Loading...</div><div class="user-role">Partner Growth</div></div>
        </div>
        <button class="btn btn-secondary btn-small" style="width:100%" onclick="signOut()">Sign Out</button>
      </div>
    </aside>

    <main class="main">
      <!-- Dashboard -->
      <section class="page active" id="page-dashboard">
        <div class="page-header"><h1>Dashboard</h1></div>
        
        <div class="dashboard-toggle">
          <button class="toggle-btn active" id="toggle-my" onclick="setDashboardView('my')">üë§ My Dashboard</button>
          <button class="toggle-btn" id="toggle-all" onclick="setDashboardView('all')">üë• All Team</button>
        </div>
        
        <div class="ai-copilot">
          <div class="ai-header"><span style="font-size:24px">‚òï</span><h2>Ask joe</h2><span class="ai-badge">AI</span></div>
          <div class="ai-input-container">
            <input type="text" class="ai-input" id="ai-input" placeholder="What would you like to know?" onkeypress="if(event.key==='Enter')askJoe()">
            <button class="ai-submit" onclick="askJoe()">Ask</button>
          </div>
          <div class="ai-suggestions">
            <button class="ai-suggestion" onclick="askSuggestion(this)">Who should I call today?</button>
            <button class="ai-suggestion" onclick="askSuggestion(this)">Show me hot leads</button>
            <button class="ai-suggestion" onclick="askSuggestion(this)">How do I create a sequence?</button>
            <button class="ai-suggestion" onclick="askSuggestion(this)">How do I sync my Gmail?</button>
            <button class="ai-suggestion" onclick="askSuggestion(this)">What features are available?</button>
          </div>
          <div class="ai-response" id="ai-response">
            <div class="ai-response-header"><span>‚òï</span> joe's response</div>
            <div class="ai-response-content" id="ai-response-content"></div>
          </div>
        </div>
        
        <div class="stats-grid">
          <div class="stat-card accent" onclick="navigateTo('shops')"><h3>Total Shops</h3><div class="value" id="stat-shops">-</div></div>
          <div class="stat-card red" onclick="navigateTo('leads')"><h3 id="stat-leads-label">My Leads</h3><div class="value" id="stat-leads">-</div></div>
          <div class="stat-card blue" onclick="navigateTo('pipeline')"><h3>Hot (80+)</h3><div class="value" id="stat-hot">-</div></div>
          <div class="stat-card green" onclick="navigateTo('deals')"><h3 id="stat-deals-label">My Pipeline</h3><div class="value" id="stat-pipeline">-</div></div>
          <div class="stat-card purple" onclick="navigateTo('tasks')"><h3 id="stat-tasks-label">My Tasks</h3><div class="value" id="stat-tasks">-</div></div>
          <div class="stat-card" onclick="navigateTo('sequences')"><h3>In Sequences</h3><div class="value" id="stat-enrolled">-</div></div>
        </div>
        
        <div class="reports-grid">
          <div class="card"><div class="card-header"><h2>üìä Pipeline Funnel</h2></div><div class="funnel-container" id="pipeline-funnel"></div></div>
          <div class="card"><div class="card-header"><h2>üìà Conversion Rates</h2></div><div class="conversion-list" id="conversion-rates"></div></div>
          <div class="card"><div class="card-header"><h2>üìû Activity This Week</h2></div><div class="activity-summary" id="activity-summary"></div></div>
          <div class="card"><div class="card-header"><h2>üìç Hot by Location</h2></div><div class="location-list" id="hot-by-location"></div></div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
          <div class="card"><div class="card-header"><h2>üî• Hot Leads</h2></div><div class="card-body" id="dashboard-hot"></div></div>
          <div class="card"><div class="card-header"><h2 id="tasks-card-label">‚úÖ My Tasks Today</h2></div><div class="card-body" id="dashboard-tasks"></div></div>
        </div>
      </section>

      <!-- Shops -->
      <section class="page" id="page-shops">
        <div class="page-header"><h1>‚òï Shops Database</h1><button class="btn btn-primary" onclick="openShopModal()">+ Add Shop</button></div>
        <div class="filter-bar">
          <div class="filter-row">
            <div class="filter-group"><label>Search</label><input type="text" class="search-input" placeholder="Search..." id="shop-search" oninput="applyShopFilters()"></div>
            <div class="filter-group"><label>City</label><div class="multi-select" id="city-filter"><div class="multi-select-trigger" onclick="toggleDropdown('city-filter')"><span>All Cities</span><span>‚ñº</span></div><div class="multi-select-dropdown" id="city-dropdown"></div></div></div>
            <div class="filter-group"><label>State</label><div class="multi-select" id="state-filter"><div class="multi-select-trigger" onclick="toggleDropdown('state-filter')"><span>All States</span><span>‚ñº</span></div><div class="multi-select-dropdown" id="state-dropdown"></div></div></div>
            <div class="filter-group"><label>Stage</label><div class="multi-select" id="stage-filter"><div class="multi-select-trigger" onclick="toggleDropdown('stage-filter')"><span>All Stages</span><span>‚ñº</span></div><div class="multi-select-dropdown" id="stage-dropdown"></div></div></div>
            <div class="filter-group"><label>Score</label><select class="filter-select" id="shop-score-filter" onchange="applyShopFilters()"><option value="">Any</option><option value="80">Hot (80+)</option><option value="60">Warm (60+)</option></select></div>
            <div class="filter-group"><label>Owner</label><select class="filter-select" id="shop-owner-filter" onchange="applyShopFilters()"><option value="">Anyone</option><option value="mine">Mine</option></select></div>
            <div class="filter-group"><label>&nbsp;</label><button class="clear-filters" onclick="clearAllShopFilters()">Clear</button></div>
            <span class="results-count" id="shop-count">0 shops</span>
          </div>
          <div class="filter-tags" id="filter-tags"></div>
        </div>
        <div class="map-section">
          <div class="map-toggle"><button class="map-toggle-btn" id="map-toggle-btn" onclick="toggleMap()"><span>‚ñº</span> üó∫Ô∏è Map View</button></div>
          <div class="map-wrapper" id="map-wrapper">
            <div class="map-container"><div id="shops-map"></div>
              <div class="map-legend"><h4>Lead Score</h4><div class="legend-item"><span class="legend-dot hot"></span> Hot (80+)</div><div class="legend-item"><span class="legend-dot warm"></span> Warm (60+)</div><div class="legend-item"><span class="legend-dot cold"></span> Cold</div></div>
              <div class="map-stats"><div class="num" id="map-stat-visible">0</div><div class="label">On Map</div></div>
            </div>
          </div>
        </div>
        <div class="card"><table><thead><tr><th onclick="sortShopsBy('name')">Shop</th><th onclick="sortShopsBy('city')">Location</th><th onclick="sortShopsBy('lead_score')">Score</th><th onclick="sortShopsBy('pipeline_stage')">Stage</th><th>Owner</th><th>Actions</th></tr></thead><tbody id="shops-table"></tbody></table></div>
      </section>

      <!-- Pipeline -->
      <section class="page" id="page-pipeline">
        <div class="page-header"><h1>üéØ Outbound Pipeline</h1><p style="color:var(--joe-gray);font-size:13px">Drag cards to move stages</p></div>
        <div class="pipeline-container" id="outbound-pipeline"></div>
      </section>

      <!-- Leads -->
      <section class="page" id="page-leads">
        <div class="page-header"><h1>üî• New Leads</h1><button class="btn btn-primary" onclick="openContactModal()">+ Add Lead</button></div>
        <div id="leads-list"></div>
      </section>

      <!-- Contacts -->
      <section class="page" id="page-contacts">
        <div class="page-header"><h1>üë§ Contacts</h1><button class="btn btn-primary" onclick="openContactModal()">+ Add Contact</button></div>
        <div class="filter-bar">
          <input type="text" class="search-input" placeholder="Search..." id="contact-search" oninput="renderContacts()">
          <select class="filter-select" id="contact-stage-filter" onchange="renderContacts()"><option value="">All Stages</option><option value="lead">Leads</option><option value="customer">Customers</option></select>
          <select class="filter-select" id="contact-owner-filter" onchange="renderContacts()"><option value="">All Owners</option><option value="mine">Mine</option></select>
          <span class="results-count" id="contact-count">0</span>
        </div>
        <div class="card"><table><thead><tr><th>Name</th><th>Email</th><th>Company</th><th>Stage</th><th>Owner</th><th>Actions</th></tr></thead><tbody id="contacts-table"></tbody></table></div>
      </section>

      <!-- Companies -->
      <section class="page" id="page-companies">
        <div class="page-header"><h1>üè¢ Companies</h1><button class="btn btn-primary" onclick="openCompanyModal()">+ Add Company</button></div>
        <div class="filter-bar"><input type="text" class="search-input" placeholder="Search..." id="company-search" oninput="renderCompanies()"><span class="results-count" id="company-count">0</span></div>
        <div class="card"><table><thead><tr><th>Name</th><th>City</th><th>Contacts</th><th>Owner</th><th>Actions</th></tr></thead><tbody id="companies-table"></tbody></table></div>
      </section>

      <!-- Deals -->
      <section class="page" id="page-deals">
        <div class="page-header"><h1>üí∞ Deals</h1><div style="display:flex;gap:8px"><select class="filter-select" id="deals-owner-filter" onchange="renderDeals()"><option value="">All</option><option value="mine">Mine</option></select><button class="btn btn-primary" onclick="openDealModal()">+ Add Deal</button></div></div>
        <p style="color:var(--joe-gray);margin-bottom:16px;font-size:13px">Drag cards to move stages</p>
        <div class="pipeline-container" id="deals-pipeline"></div>
      </section>

      <!-- Sequences -->
      <section class="page" id="page-sequences">
        <div class="page-header"><h1>‚ö° Sequences</h1><button class="btn btn-primary" onclick="openSequenceModal()">+ Create Sequence</button></div>
        <p style="color:var(--joe-gray);margin-bottom:20px">Automate follow-up with multi-step outreach sequences. Use merge fields like <code style="background:#f3f4f6;padding:2px 6px;border-radius:4px">{{first_name}}</code>, <code style="background:#f3f4f6;padding:2px 6px;border-radius:4px">{{company}}</code>, <code style="background:#f3f4f6;padding:2px 6px;border-radius:4px">{{email}}</code> in templates.</p>
        <div class="stats-grid" style="margin-bottom:20px">
          <div class="stat-card"><h3>Total Sequences</h3><div class="value" id="seq-total">0</div></div>
          <div class="stat-card purple"><h3>Active Enrollments</h3><div class="value" id="seq-active">0</div></div>
          <div class="stat-card green"><h3>Completed This Week</h3><div class="value" id="seq-completed">0</div></div>
          <div class="stat-card accent"><h3>Tasks Created</h3><div class="value" id="seq-tasks">0</div></div>
        </div>
        <div id="sequences-list"></div>
      </section>

      <!-- Meeting Notes -->
      <section class="page" id="page-meetings">
        <div class="page-header"><h1>üé• Meeting Notes</h1><button class="btn btn-secondary" onclick="syncMeetTranscripts()">üîÑ Sync from Google Meet</button></div>
        <p style="color:var(--joe-gray);margin-bottom:20px">AI-analyzed meeting transcripts with sentiment analysis and key highlights.</p>
        
        <div class="stats-grid" style="margin-bottom:20px">
          <div class="stat-card"><h3>Total Meetings</h3><div class="value" id="meetings-total">0</div></div>
          <div class="stat-card green"><h3>Positive Sentiment</h3><div class="value" id="meetings-positive">0</div></div>
          <div class="stat-card accent"><h3>Neutral</h3><div class="value" id="meetings-neutral">0</div></div>
          <div class="stat-card red"><h3>Concerns Flagged</h3><div class="value" id="meetings-negative">0</div></div>
        </div>

        <div class="filter-bar" style="display:flex;gap:12px;margin-bottom:20px">
          <input type="text" id="meeting-search" placeholder="Search transcripts..." style="flex:1;padding:10px;border:1px solid #e5e7eb;border-radius:8px" oninput="renderMeetings()">
          <select class="filter-select" id="meeting-sentiment-filter" onchange="renderMeetings()">
            <option value="all">All Sentiment</option>
            <option value="positive">Positive</option>
            <option value="neutral">Neutral</option>
            <option value="negative">Negative/Concerns</option>
          </select>
          <select class="filter-select" id="meeting-contact-filter" onchange="renderMeetings()">
            <option value="all">All Contacts</option>
          </select>
        </div>

        <div id="meetings-list"></div>
      </section>

      <!-- Tasks -->
      <section class="page" id="page-tasks">
        <div class="page-header"><h1>‚úÖ Tasks</h1><button class="btn btn-primary" onclick="openTaskModal()">+ Add Task</button></div>
        <div class="filter-bar" style="display:flex;gap:12px">
          <select class="filter-select" id="task-filter" onchange="renderTasks()"><option value="pending">Pending</option><option value="today">Due Today</option><option value="overdue">Overdue</option><option value="all">All</option></select>
          <select class="filter-select" id="task-owner-filter" onchange="renderTasks()"><option value="mine">My Tasks</option><option value="all">All</option></select>
        </div>
        <div id="tasks-list"></div>
      </section>

      <!-- Team -->
      <section class="page" id="page-team">
        <div class="page-header"><h1>üë• Team</h1><button class="btn btn-primary" onclick="openTeamMemberModal()">+ Add Member</button></div>
        <div class="stats-grid" style="margin-bottom:24px">
          <div class="stat-card"><h3>Team Size</h3><div class="value" id="team-size">0</div></div>
          <div class="stat-card accent"><h3>Activities Today</h3><div class="value" id="team-activities-today">0</div></div>
          <div class="stat-card green"><h3>Deals This Month</h3><div class="value" id="team-deals-month">0</div></div>
          <div class="stat-card blue"><h3>Active Sequences</h3><div class="value" id="team-active-sequences">0</div></div>
        </div>
        <div class="card">
          <div class="card-header"><h2>Team Members</h2></div>
          <table>
            <thead><tr><th>Member</th><th>Role</th><th>Assigned Shops</th><th>Assigned Contacts</th><th>Open Deals</th><th>Activities (7d)</th><th>Actions</th></tr></thead>
            <tbody id="team-table"></tbody>
          </table>
        </div>
        <div class="card">
          <div class="card-header"><h2>üìä Leaderboard This Week</h2></div>
          <div class="card-body" id="team-leaderboard"></div>
        </div>
      </section>

      <!-- Email Templates -->
      <section class="page" id="page-emails">
        <div class="page-header"><h1>‚úâÔ∏è Email Templates</h1><button class="btn btn-primary" onclick="openEmailTemplateModal()">+ New Template</button></div>
        <p style="color:var(--joe-gray);margin-bottom:20px">Create reusable email templates with merge fields. Use <code style="background:#f3f4f6;padding:2px 6px;border-radius:4px">{{first_name}}</code>, <code style="background:#f3f4f6;padding:2px 6px;border-radius:4px">{{company}}</code>, <code style="background:#f3f4f6;padding:2px 6px;border-radius:4px">{{signature}}</code></p>
        
        <!-- Signature Settings -->
        <div class="card" style="margin-bottom:24px">
          <div class="card-header"><h2>‚úçÔ∏è My Email Signature</h2><button class="btn btn-small btn-secondary" onclick="previewSignature()">Preview</button></div>
          <div class="card-body">
            <div style="display:grid;grid-template-columns:120px 1fr;gap:20px">
              <div>
                <div style="width:100px;height:100px;border-radius:50%;background:var(--joe-light);display:flex;align-items:center;justify-content:center;overflow:hidden;margin-bottom:8px" id="sig-photo-preview">
                  <span style="font-size:32px;color:var(--joe-gray)">üë§</span>
                </div>
                <input type="file" id="sig-photo-input" accept="image/*" style="display:none" onchange="handleSignaturePhoto(this)">
                <button class="btn btn-small btn-secondary" onclick="document.getElementById('sig-photo-input').click()">Upload Photo</button>
                <button class="btn btn-small btn-secondary" onclick="useGooglePhoto()" style="margin-top:4px">Use Google Photo</button>
              </div>
              <div class="form-grid">
                <div class="form-group"><label>Full Name</label><input type="text" id="sig-name" placeholder="John Smith"></div>
                <div class="form-group"><label>Title</label><input type="text" id="sig-title" placeholder="Account Executive"></div>
                <div class="form-group"><label>Email</label><input type="email" id="sig-email" placeholder="john@joe.coffee"></div>
                <div class="form-group"><label>Phone</label><input type="tel" id="sig-phone" placeholder="(555) 123-4567"></div>
                <div class="form-group"><label>Scheduling Link</label><input type="url" id="sig-calendar" placeholder="https://calendly.com/yourname"></div>
                <div class="form-group"><label>Company</label><input type="text" id="sig-company" value="joe" placeholder="joe"></div>
              </div>
            </div>
            <button class="btn btn-primary" style="margin-top:16px" onclick="saveSignature()">Save Signature</button>
          </div>
        </div>

        <!-- Templates List -->
        <div class="card">
          <div class="card-header"><h2>üìã Templates</h2></div>
          <div class="card-body" id="email-templates-list"></div>
        </div>
      </section>

      <!-- Integrations -->
      <section class="page" id="page-integrations">
        <div class="page-header"><h1>üîå Integrations</h1></div>
        <p style="color:var(--joe-gray);margin-bottom:20px">Connect tools to sync emails, calendar, and meeting transcripts.</p>
        
        <!-- Google Workspace Section -->
        <div class="card" style="margin-bottom:20px">
          <div class="card-header"><h2>üî∑ Google Workspace</h2><span class="badge" id="google-status-badge">Not Connected</span></div>
          <div class="card-body">
            <div id="google-not-connected" style="display:block">
              <p style="margin-bottom:16px">Connect your Google Workspace account to sync Gmail, Calendar, and Meet transcripts.</p>
              <button class="btn btn-primary" onclick="connectGoogle()">üî∑ Connect Google Account</button>
            </div>
            <div id="google-connected" style="display:none">
              <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
                <div class="user-avatar" id="google-avatar" style="width:40px;height:40px">G</div>
                <div>
                  <div style="font-weight:600" id="google-email">Connected</div>
                  <div style="font-size:12px;color:var(--joe-gray)">Gmail, Calendar & Meet access enabled</div>
                </div>
                <button class="btn btn-secondary btn-small" style="margin-left:auto" onclick="disconnectGoogle()">Disconnect</button>
              </div>
              <div class="integration-grid" style="margin-top:16px">
                <div class="integration-card" id="gmail-card">
                  <div class="integration-header"><div class="integration-icon">üìß</div><div class="integration-info"><h3>Gmail</h3><p id="gmail-sync-status">Ready to sync</p></div></div>
                  <div style="display:flex;gap:8px;margin-top:12px">
                    <button class="btn btn-small btn-primary" onclick="syncGmail()">Sync Emails</button>
                    <button class="btn btn-small btn-secondary" onclick="viewGmailSettings()">Settings</button>
                  </div>
                </div>
                <div class="integration-card" id="calendar-card">
                  <div class="integration-header"><div class="integration-icon">üìÖ</div><div class="integration-info"><h3>Calendar</h3><p id="calendar-sync-status">Ready to sync</p></div></div>
                  <div style="display:flex;gap:8px;margin-top:12px">
                    <button class="btn btn-small btn-primary" onclick="syncCalendar()">Sync Meetings</button>
                    <button class="btn btn-small btn-secondary" onclick="viewCalendarSettings()">Settings</button>
                  </div>
                </div>
                <div class="integration-card" id="meet-card">
                  <div class="integration-header"><div class="integration-icon">üé•</div><div class="integration-info"><h3>Google Meet</h3><p id="meet-sync-status">Ready for transcripts</p></div></div>
                  <div style="display:flex;gap:8px;margin-top:12px">
                    <button class="btn btn-small btn-primary" onclick="syncMeetTranscripts()">Fetch Transcripts</button>
                    <button class="btn btn-small btn-secondary" onclick="viewMeetSettings()">Settings</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Other Integrations -->
        <div class="integration-grid">
          <div class="integration-card"><div class="integration-header"><div class="integration-icon">üì±</div><div class="integration-info"><h3>Twilio</h3><p>Send SMS & track calls</p></div></div><div class="integration-status"><span class="status-dot" id="twilio-status-dot"></span><span id="twilio-status-text">Not connected</span></div><button class="btn btn-secondary btn-small" onclick="testTwilioConnection()">Test Connection</button></div>
          <div class="integration-card"><div class="integration-header"><div class="integration-icon">üí¨</div><div class="integration-info"><h3>Slack</h3><p>Get deal notifications</p></div></div><div class="integration-status"><span class="status-dot disconnected"></span><span>Coming soon</span></div><button class="btn btn-secondary btn-small" disabled>Connect Slack</button></div>
        </div>

        <!-- API Keys -->
        <div class="card" style="margin-top:24px"><div class="card-header"><h2>üîë API Keys</h2></div><div class="card-body">
          <div class="form-grid">
            <div class="form-group"><label>Anthropic API Key</label><input type="password" id="api-anthropic" placeholder="sk-ant-..."></div>
            <div class="form-group"><label>Twilio Account SID</label><input type="text" id="api-twilio-sid" placeholder="AC..."></div>
            <div class="form-group"><label>Twilio Auth Token</label><input type="password" id="api-twilio-token"></div>
            <div class="form-group"><label>Twilio Phone</label><input type="text" id="api-twilio-phone" placeholder="+1..."></div>
          </div>
          <button class="btn btn-primary" style="margin-top:16px" onclick="saveApiKeys()">Save API Keys</button>
        </div></div>

        <!-- Sync Activity Log -->
        <div class="card" style="margin-top:24px"><div class="card-header"><h2>üìã Recent Sync Activity</h2><button class="btn btn-small btn-secondary" onclick="clearSyncLog()">Clear</button></div>
          <div class="card-body" id="sync-log" style="max-height:300px;overflow-y:auto">
            <div class="empty-state">No sync activity yet</div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Shop Modal -->
  <div class="modal-overlay" id="shop-modal">
    <div class="modal">
      <div class="modal-header"><h2 id="shop-modal-title">Shop</h2><button class="modal-close" onclick="closeShopModal()">&times;</button></div>
      <div class="modal-body">
        <div class="modal-tabs">
          <button class="modal-tab active" data-tab="details">Details</button>
          <button class="modal-tab" data-tab="activity">Activity</button>
          <button class="modal-tab" data-tab="convert">Convert</button>
        </div>
        <div class="modal-tab-content active" id="shop-tab-details">
          <div class="form-grid">
            <div class="form-group"><label>Shop Name</label><input type="text" id="shop-name"></div>
            <div class="form-group"><label>Stage</label><select id="shop-stage"><option value="new">New</option><option value="contacted">Contacted</option><option value="qualified">Qualified</option><option value="demo_scheduled">Demo Scheduled</option><option value="proposal">Proposal</option><option value="closed_won">Closed Won</option><option value="closed_lost">Closed Lost</option></select></div>
            <div class="form-group"><label>City</label><input type="text" id="shop-city"></div>
            <div class="form-group"><label>State</label><input type="text" id="shop-state"></div>
            <div class="form-group"><label>Phone</label><input type="tel" id="shop-phone"></div>
            <div class="form-group"><label>Email</label><input type="email" id="shop-email"></div>
            <div class="form-group"><label>Website</label><input type="url" id="shop-website"></div>
            <div class="form-group"><label>Lead Score</label><input type="text" id="shop-score" readonly></div>
            <div class="form-group"><label>Assigned To</label><select id="shop-assigned"></select></div>
            <div class="form-group"><label>Contact Name</label><input type="text" id="shop-contact-name"></div>
            <div class="form-group full"><label>Notes</label><textarea id="shop-notes"></textarea></div>
          </div>
        </div>
        <div class="modal-tab-content" id="shop-tab-activity">
          <div class="log-activity-btn">
            <button class="log-btn call" onclick="showShopActivityForm('call')">üìû Call</button>
            <button class="log-btn email" onclick="showShopActivityForm('email')">‚úâÔ∏è Email</button>
            <button class="log-btn sms" onclick="showShopActivityForm('sms')">üí¨ SMS</button>
            <button class="log-btn" onclick="showShopActivityForm('note')">üìù Note</button>
          </div>
          <div class="activity-form" id="shop-activity-form">
            <input type="hidden" id="shop-activity-type">
            <div class="form-group" style="margin-bottom:10px"><label>Outcome</label><select id="shop-activity-outcome"><option value="">Select...</option><option value="connected">Connected</option><option value="voicemail">Voicemail</option><option value="no_answer">No Answer</option><option value="interested">Interested</option><option value="not_interested">Not Interested</option></select></div>
            <div class="form-group"><label>Notes</label><textarea id="shop-activity-notes" style="min-height:80px"></textarea></div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px"><button class="btn btn-secondary btn-small" onclick="hideShopActivityForm()">Cancel</button><button class="btn btn-primary btn-small" onclick="saveShopActivity()">Save</button></div>
          </div>
          <div class="activity-list" id="shop-activity-list"></div>
        </div>
        <div class="modal-tab-content" id="shop-tab-convert">
          <p style="margin-bottom:16px">Convert this shop to a Contact + Company.</p>
          <div class="form-grid">
            <div class="form-group"><label>First Name</label><input type="text" id="convert-first"></div>
            <div class="form-group"><label>Last Name</label><input type="text" id="convert-last"></div>
            <div class="form-group"><label>Email</label><input type="email" id="convert-email"></div>
            <div class="form-group"><label>Title</label><input type="text" id="convert-title" value="Owner"></div>
          </div>
          <button class="btn btn-success" style="margin-top:16px" onclick="convertShopToContact()">Convert to Contact + Company</button>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeShopModal()">Cancel</button><button class="btn btn-primary" onclick="saveShop()">Save</button></div>
    </div>
  </div>

  <!-- Contact Modal -->
  <div class="modal-overlay" id="contact-modal">
    <div class="modal">
      <div class="modal-header"><h2 id="contact-modal-title">Contact</h2><button class="modal-close" onclick="closeContactModal()">&times;</button></div>
      <div class="modal-body">
        <div class="modal-tabs">
          <button class="modal-tab active" data-tab="details">Details</button>
          <button class="modal-tab" data-tab="activity">Activity</button>
          <button class="modal-tab" data-tab="sequences">Sequences</button>
        </div>
        <div class="modal-tab-content active" id="contact-tab-details">
          <div class="form-grid">
            <div class="form-group"><label>First Name</label><input type="text" id="contact-first"></div>
            <div class="form-group"><label>Last Name</label><input type="text" id="contact-last"></div>
            <div class="form-group"><label>Email</label><input type="email" id="contact-email"></div>
            <div class="form-group"><label>Phone</label><input type="tel" id="contact-phone"></div>
            <div class="form-group"><label>Title</label><input type="text" id="contact-title"></div>
            <div class="form-group"><label>Assigned To</label><select id="contact-assigned"></select></div>
            <div class="form-group full"><label>Company</label>
              <div class="searchable-select">
                <input type="text" id="contact-company-search" placeholder="Search or create company..." oninput="filterCompanies()" onfocus="showCompanyDropdown()">
                <input type="hidden" id="contact-company">
                <div class="searchable-select-dropdown" id="company-dropdown"></div>
              </div>
            </div>
            <div class="form-group"><label>Stage</label><select id="contact-lifecycle"><option value="lead">Lead</option><option value="customer">Customer</option></select></div>
            <div class="form-group"><label>Lead Source</label><input type="text" id="contact-source" placeholder="website, referral..."></div>
          </div>
        </div>
        <div class="modal-tab-content" id="contact-tab-activity">
          <div class="quick-actions">
            <button class="btn btn-small btn-secondary" onclick="showContactActivityForm('call')">üìû Call</button>
            <button class="btn btn-small btn-secondary" onclick="showContactActivityForm('email')">‚úâÔ∏è Email</button>
            <button class="btn btn-small btn-secondary" onclick="showContactActivityForm('sms')">üí¨ SMS</button>
            <button class="btn btn-small btn-secondary" onclick="showContactActivityForm('note')">üìù Note</button>
          </div>
          <div class="activity-form" id="contact-activity-form">
            <input type="hidden" id="contact-activity-type">
            <div class="form-group" style="margin-bottom:10px"><label>Outcome</label><select id="contact-activity-outcome"><option value="">Select...</option><option value="connected">Connected</option><option value="voicemail">Voicemail</option><option value="interested">Interested</option><option value="not_interested">Not Interested</option></select></div>
            <div class="form-group"><label>Notes</label><textarea id="contact-activity-notes" style="min-height:80px"></textarea></div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px"><button class="btn btn-secondary btn-small" onclick="hideContactActivityForm()">Cancel</button><button class="btn btn-primary btn-small" onclick="saveContactActivity()">Save</button></div>
          </div>
          <div class="activity-list" id="contact-activity-list"></div>
        </div>
        <div class="modal-tab-content" id="contact-tab-sequences">
          <button class="btn btn-primary btn-small" onclick="showEnrollForm()" style="margin-bottom:16px">‚ö° Enroll in Sequence</button>
          <div class="activity-form" id="enroll-form">
            <div class="form-group" style="margin-bottom:10px"><label>Select Sequence</label><select id="enroll-sequence"></select></div>
            <div style="display:flex;gap:8px;justify-content:flex-end"><button class="btn btn-secondary btn-small" onclick="hideEnrollForm()">Cancel</button><button class="btn btn-primary btn-small" onclick="enrollContact()">Enroll</button></div>
          </div>
          <h4 style="margin:16px 0 8px;font-size:13px">Active Enrollments</h4>
          <div id="contact-enrollments"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div><button class="btn btn-primary btn-small" onclick="openEmailComposer(currentContactId)">‚úâÔ∏è Send Email</button><button class="btn btn-success btn-small" onclick="createDealFromContact()" style="margin-left:8px">+ Create Deal</button></div>
        <div style="display:flex;gap:8px"><button class="btn btn-secondary" onclick="closeContactModal()">Cancel</button><button class="btn btn-primary" onclick="saveContact()">Save</button></div>
      </div>
    </div>
  </div>

  <!-- Company Modal -->
  <div class="modal-overlay" id="company-modal">
    <div class="modal">
      <div class="modal-header"><h2 id="company-modal-title">Company</h2><button class="modal-close" onclick="closeCompanyModal()">&times;</button></div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-group full"><label>Company Name</label><input type="text" id="company-name"></div>
          <div class="form-group"><label>City</label><input type="text" id="company-city"></div>
          <div class="form-group"><label>State</label><input type="text" id="company-state"></div>
          <div class="form-group"><label>Phone</label><input type="tel" id="company-phone"></div>
          <div class="form-group"><label>Website</label><input type="url" id="company-website"></div>
          <div class="form-group"><label>Assigned To</label><select id="company-assigned"></select></div>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeCompanyModal()">Cancel</button><button class="btn btn-primary" onclick="saveCompany()">Save</button></div>
    </div>
  </div>

  <!-- Deal Modal -->
  <div class="modal-overlay" id="deal-modal">
    <div class="modal wide">
      <div class="modal-header"><h2 id="deal-modal-title">Deal</h2><button class="modal-close" onclick="closeDealModal()">&times;</button></div>
      <div class="modal-body">
        <div class="modal-tabs">
          <button class="modal-tab active" data-tab="details">Details</button>
          <button class="modal-tab" data-tab="meetings">Meetings</button>
          <button class="modal-tab" data-tab="activity">Activity</button>
        </div>
        <div class="modal-tab-content active" id="deal-tab-details">
          <div class="form-grid">
            <div class="form-group full"><label>Deal Name</label><input type="text" id="deal-name"></div>
            <div class="form-group"><label>Amount ($)</label><input type="number" id="deal-amount"></div>
            <div class="form-group"><label>Close Date</label><input type="date" id="deal-close-date"></div>
            <div class="form-group full"><label>Contact</label>
              <div class="searchable-select">
                <input type="text" id="deal-contact-search" placeholder="Search contact..." oninput="filterDealContacts()" onfocus="showDealContactDropdown()">
                <input type="hidden" id="deal-contact">
                <div class="searchable-select-dropdown" id="deal-contact-dropdown"></div>
              </div>
            </div>
            <div class="form-group"><label>Stage</label><select id="deal-stage"><option value="appointment">Appointment</option><option value="qualified">Qualified</option><option value="presentation">Presentation</option><option value="contract">Contract</option><option value="closed_won">Won</option><option value="closed_lost">Lost</option></select></div>
            <div class="form-group"><label>Assigned To</label><select id="deal-assigned"></select></div>
          </div>
        </div>
        <div class="modal-tab-content" id="deal-tab-meetings">
          <div id="deal-meetings-list"></div>
        </div>
        <div class="modal-tab-content" id="deal-tab-activity">
          <div id="deal-activity-list"></div>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeDealModal()">Cancel</button><button class="btn btn-primary" onclick="saveDeal()">Save</button></div>
    </div>
  </div>

  <!-- Sequence Modal -->
  <div class="modal-overlay" id="sequence-modal">
    <div class="modal wide">
      <div class="modal-header"><h2 id="sequence-modal-title">Create Sequence</h2><button class="modal-close" onclick="closeSequenceModal()">&times;</button></div>
      <div class="modal-body">
        <div class="form-grid" style="margin-bottom:20px">
          <div class="form-group"><label>Sequence Name</label><input type="text" id="sequence-name" placeholder="e.g., New Lead Outreach"></div>
          <div class="form-group"><label>Description</label><input type="text" id="sequence-desc"></div>
        </div>
        <div class="form-group" style="margin-bottom:16px"><label><input type="checkbox" id="sequence-default"> Set as default for new leads</label></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h3>Steps</h3>
          <div style="font-size:12px;color:var(--joe-gray)">Merge fields: <code onclick="copyMergeField('{{first_name}}')" style="cursor:pointer;background:#f3f4f6;padding:2px 6px;border-radius:4px">{{first_name}}</code> <code onclick="copyMergeField('{{last_name}}')" style="cursor:pointer;background:#f3f4f6;padding:2px 6px;border-radius:4px">{{last_name}}</code> <code onclick="copyMergeField('{{email}}')" style="cursor:pointer;background:#f3f4f6;padding:2px 6px;border-radius:4px">{{email}}</code> <code onclick="copyMergeField('{{company}}')" style="cursor:pointer;background:#f3f4f6;padding:2px 6px;border-radius:4px">{{company}}</code> <code onclick="copyMergeField('{{phone}}')" style="cursor:pointer;background:#f3f4f6;padding:2px 6px;border-radius:4px">{{phone}}</code></div>
        </div>
        <div id="sequence-steps-editor"></div>
        <button class="btn btn-secondary btn-small" onclick="addStep()">+ Add Step</button>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="previewSequence()">üëÅÔ∏è Preview</button>
        <div style="display:flex;gap:8px">
          <button class="btn btn-secondary" onclick="closeSequenceModal()">Cancel</button>
          <button class="btn btn-primary" onclick="saveSequence()">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Sequence Preview Modal -->
  <div class="modal-overlay" id="sequence-preview-modal">
    <div class="modal wide">
      <div class="modal-header"><h2>Preview Sequence</h2><button class="modal-close" onclick="document.getElementById('sequence-preview-modal').classList.remove('open')">&times;</button></div>
      <div class="modal-body" id="sequence-preview-content"></div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="document.getElementById('sequence-preview-modal').classList.remove('open')">Close</button></div>
    </div>
  </div>

  <!-- Sequence Enrollments Modal -->
  <div class="modal-overlay" id="sequence-enrollments-modal">
    <div class="modal wide">
      <div class="modal-header"><h2 id="enrollments-modal-title">Enrolled Contacts</h2><button class="modal-close" onclick="document.getElementById('sequence-enrollments-modal').classList.remove('open')">&times;</button></div>
      <div class="modal-body">
        <div style="display:flex;gap:8px;margin-bottom:16px">
          <button class="btn btn-small btn-primary" onclick="bulkEnrollModal()">+ Enroll Contacts</button>
        </div>
        <table>
          <thead><tr><th>Contact</th><th>Current Step</th><th>Status</th><th>Enrolled</th><th>Actions</th></tr></thead>
          <tbody id="enrollments-table"></tbody>
        </table>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="document.getElementById('sequence-enrollments-modal').classList.remove('open')">Close</button></div>
    </div>
  </div>

  <!-- Bulk Enroll Modal -->
  <div class="modal-overlay" id="bulk-enroll-modal">
    <div class="modal">
      <div class="modal-header"><h2>Enroll Contacts</h2><button class="modal-close" onclick="document.getElementById('bulk-enroll-modal').classList.remove('open')">&times;</button></div>
      <div class="modal-body">
        <div class="form-group" style="margin-bottom:16px">
          <label>Select Contacts to Enroll</label>
          <div id="bulk-enroll-contacts" style="max-height:300px;overflow-y:auto;border:1px solid #e5e7eb;border-radius:8px;padding:8px"></div>
        </div>
        <p style="font-size:12px;color:var(--joe-gray)"><span id="bulk-enroll-count">0</span> contacts selected</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="document.getElementById('bulk-enroll-modal').classList.remove('open')">Cancel</button>
        <button class="btn btn-primary" onclick="bulkEnrollContacts()">Enroll Selected</button>
      </div>
    </div>
  </div>

  <!-- Task Modal -->
  <div class="modal-overlay" id="task-modal">
    <div class="modal">
      <div class="modal-header"><h2>Add Task</h2><button class="modal-close" onclick="closeTaskModal()">&times;</button></div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-group full"><label>Title</label><input type="text" id="task-title"></div>
          <div class="form-group"><label>Type</label><select id="task-type"><option value="todo">To-Do</option><option value="call">Call</option><option value="email">Email</option><option value="sms">SMS</option></select></div>
          <div class="form-group"><label>Due Date</label><input type="datetime-local" id="task-due"></div>
          <div class="form-group full"><label>Contact</label>
            <div class="searchable-select">
              <input type="text" id="task-contact-search" placeholder="Search contact..." oninput="filterTaskContacts()" onfocus="showTaskContactDropdown()">
              <input type="hidden" id="task-contact">
              <div class="searchable-select-dropdown" id="task-contact-dropdown"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeTaskModal()">Cancel</button><button class="btn btn-primary" onclick="saveTask()">Save</button></div>
    </div>
  </div>

  <!-- Email Template Modal -->
  <div class="modal-overlay" id="email-template-modal">
    <div class="modal wide">
      <div class="modal-header"><h2 id="email-template-modal-title">New Email Template</h2><button class="modal-close" onclick="closeEmailTemplateModal()">&times;</button></div>
      <div class="modal-body">
        <div class="form-grid" style="margin-bottom:16px">
          <div class="form-group"><label>Template Name</label><input type="text" id="template-name" placeholder="e.g., Initial Outreach"></div>
          <div class="form-group"><label>Category</label><select id="template-category"><option value="outreach">Outreach</option><option value="followup">Follow-up</option><option value="demo">Demo</option><option value="proposal">Proposal</option><option value="other">Other</option></select></div>
        </div>
        <div class="form-group" style="margin-bottom:16px">
          <label>Subject Line</label>
          <input type="text" id="template-subject" placeholder="e.g., Quick question about {{company}}">
        </div>
        <div style="margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">
          <label>Email Body</label>
          <div style="font-size:11px;color:var(--joe-gray)">
            Merge fields: 
            <code onclick="insertMergeField('template-body','{{first_name}}')" style="cursor:pointer;background:#f3f4f6;padding:2px 6px;border-radius:4px">{{first_name}}</code>
            <code onclick="insertMergeField('template-body','{{company}}')" style="cursor:pointer;background:#f3f4f6;padding:2px 6px;border-radius:4px">{{company}}</code>
            <code onclick="insertMergeField('template-body','{{signature}}')" style="cursor:pointer;background:#f3f4f6;padding:2px 6px;border-radius:4px">{{signature}}</code>
          </div>
        </div>
        <textarea id="template-body" style="width:100%;min-height:250px;padding:12px;border:1px solid #e5e7eb;border-radius:8px;font-family:inherit;font-size:14px;line-height:1.6" placeholder="Hi {{first_name}},

I noticed {{company}} and thought...

{{signature}}"></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="previewEmailTemplate()">üëÅÔ∏è Preview</button>
        <div style="display:flex;gap:8px">
          <button class="btn btn-secondary" onclick="closeEmailTemplateModal()">Cancel</button>
          <button class="btn btn-primary" onclick="saveEmailTemplate()">Save Template</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Email Composer Modal -->
  <div class="modal-overlay" id="email-composer-modal">
    <div class="modal wide">
      <div class="modal-header"><h2>‚úâÔ∏è Compose Email</h2><button class="modal-close" onclick="closeEmailComposer()">&times;</button></div>
      <div class="modal-body">
        <div class="form-grid" style="margin-bottom:16px">
          <div class="form-group">
            <label>To</label>
            <input type="email" id="compose-to" readonly style="background:#f9fafb">
          </div>
          <div class="form-group">
            <label>Template</label>
            <select id="compose-template" onchange="applyEmailTemplate()">
              <option value="">-- Select Template --</option>
            </select>
          </div>
        </div>
        <div class="form-group" style="margin-bottom:16px">
          <label>Subject</label>
          <input type="text" id="compose-subject" placeholder="Subject line...">
        </div>
        <div class="form-group" style="margin-bottom:16px">
          <label>Message</label>
          <textarea id="compose-body" style="width:100%;min-height:300px;padding:12px;border:1px solid #e5e7eb;border-radius:8px;font-family:inherit;font-size:14px;line-height:1.6"></textarea>
        </div>
        <div style="background:var(--joe-light);padding:12px;border-radius:8px">
          <label style="font-size:12px;color:var(--joe-gray);display:block;margin-bottom:8px">SIGNATURE PREVIEW</label>
          <div id="compose-signature-preview" style="font-size:13px"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div style="font-size:12px;color:var(--joe-gray)">Sending via Gmail</div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-secondary" onclick="closeEmailComposer()">Cancel</button>
          <button class="btn btn-primary" onclick="sendEmail()">üì§ Send Email</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Signature Preview Modal -->
  <div class="modal-overlay" id="signature-preview-modal">
    <div class="modal">
      <div class="modal-header"><h2>Signature Preview</h2><button class="modal-close" onclick="document.getElementById('signature-preview-modal').classList.remove('open')">&times;</button></div>
      <div class="modal-body" id="signature-preview-content"></div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="document.getElementById('signature-preview-modal').classList.remove('open')">Close</button></div>
    </div>
  </div>

  <!-- Meeting Detail Modal -->
  <div class="modal-overlay" id="meeting-detail-modal">
    <div class="modal wide">
      <div class="modal-header">
        <h2 id="meeting-detail-title">Meeting</h2>
        <button class="modal-close" onclick="document.getElementById('meeting-detail-modal').classList.remove('open')">&times;</button>
      </div>
      <div class="modal-body" id="meeting-detail-content" style="max-height:70vh;overflow-y:auto"></div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="copyToRoam()">üìã Copy to Roam</button>
        <button class="btn btn-secondary" onclick="document.getElementById('meeting-detail-modal').classList.remove('open')">Close</button>
      </div>
    </div>
  </div>

  <!-- Team Member Modal -->
  <div class="modal-overlay" id="team-modal">
    <div class="modal">
      <div class="modal-header"><h2 id="team-modal-title">Add Team Member</h2><button class="modal-close" onclick="closeTeamMemberModal()">&times;</button></div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-group full"><label>Email</label><input type="email" id="member-email" placeholder="name@joe.coffee"></div>
          <div class="form-group"><label>Name</label><input type="text" id="member-name" placeholder="Full name"></div>
          <div class="form-group"><label>Role</label><select id="member-role"><option value="sales">Sales Rep</option><option value="manager">Sales Manager</option><option value="admin">Admin</option></select></div>
        </div>
        <p style="margin-top:16px;font-size:12px;color:var(--joe-gray)">Team members must have a @joe.coffee email to sign in.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeTeamMemberModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveTeamMember()">Add Member</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  <button class="help-fab" onclick="openHelp()" title="Ask joe for help">?</button>

  <script>
    const SUPABASE_URL='https://vpnoaxpmhuknyaxcyxsu.supabase.co';
    const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZwbm9heHBtaHVrbnlheGN5eHN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NjkzNTMsImV4cCI6MjA4MjQ0NTM1M30.0JVwCaY-3nUHuJk49ibifQviT0LxBSdYXMslw9WIr9M';
    const MAPBOX_TOKEN='pk.eyJ1IjoiYnJlbmRlbm1hcnRpbjA1IiwiYSI6ImNtanAwZWZidjJodjEza3E2NDR4b242bW8ifQ.CjDrXl01VxVoEg6jh81c5Q';
    const db=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
    mapboxgl.accessToken=MAPBOX_TOKEN;

    let currentUser=null,shops=[],contacts=[],companies=[],deals=[],sequences=[],tasks=[],activities=[],enrollments=[],teamMembers=[],meetingNotes=[],emailTemplates=[];
    let currentShopId=null,currentContactId=null,currentCompanyId=null,currentDealId=null,currentSequenceId=null;
    let map=null,mapMarkers=[],mapVisible=true,shopSort={field:'lead_score',dir:'desc'},seqSteps=[],shopFilters={cities:[],states:[],stages:[]},dashboardView='my',draggedItem=null;

    const SHOP_STAGES=[{id:'new',label:'New'},{id:'contacted',label:'Contacted'},{id:'qualified',label:'Qualified'},{id:'demo_scheduled',label:'Demo'},{id:'proposal',label:'Proposal'},{id:'closed_won',label:'Won'},{id:'closed_lost',label:'Lost'}];
    const DEAL_STAGES=[{id:'appointment',label:'Appointment'},{id:'qualified',label:'Qualified'},{id:'presentation',label:'Presentation'},{id:'contract',label:'Contract'}];
    const ICONS={call:'üìû',email:'‚úâÔ∏è',sms:'üí¨',note:'üìù',todo:'‚úÖ'};

    netlifyIdentity.on('init',u=>{if(u)handleLogin(u);});
    netlifyIdentity.on('login',u=>{handleLogin(u);netlifyIdentity.close();});
    netlifyIdentity.on('logout',()=>location.reload());

    function handleLogin(user){
      if(!user.email?.endsWith('@joe.coffee')){document.getElementById('auth-error').style.display='block';netlifyIdentity.logout();return;}
      currentUser={email:user.email,name:user.user_metadata?.full_name||user.email.split('@')[0],avatar:user.user_metadata?.avatar_url};
      document.getElementById('authScreen').style.display='none';
      document.getElementById('app').classList.add('active');
      document.getElementById('user-name').textContent=currentUser.name;
      const av=document.getElementById('user-avatar');
      if(currentUser.avatar)av.innerHTML='<img src="'+currentUser.avatar+'">';else av.textContent=currentUser.name[0].toUpperCase();
      loadApiKeys();loadAllData();
    }
    function signOut(){netlifyIdentity.logout();}

    async function loadAllData(){
      const[sh,c,co,d,seq,t,a,e,tm,mn,et]=await Promise.all([
        db.from('shops').select('*').order('lead_score',{ascending:false}),
        db.from('contacts').select('*').order('created_at',{ascending:false}),
        db.from('companies').select('*').order('name'),
        db.from('deals').select('*').order('created_at',{ascending:false}),
        db.from('sequences').select('*,sequence_steps(*)').order('created_at',{ascending:false}),
        db.from('tasks').select('*').order('due_date'),
        db.from('activities').select('*').order('created_at',{ascending:false}).limit(500),
        db.from('sequence_enrollments').select('*'),
        db.from('team_members').select('*').order('name'),
        db.from('meeting_notes').select('*').order('meeting_date',{ascending:false}),
        db.from('email_templates').select('*').order('name')
      ]);
      shops=sh.data||[];contacts=c.data||[];companies=co.data||[];deals=d.data||[];sequences=seq.data||[];tasks=t.data||[];activities=a.data||[];enrollments=e.data||[];meetingNotes=mn.data||[];emailTemplates=et.data||[];
      const dbTeam=tm.data||[];
      const emails=new Set([currentUser?.email]);
      [...shops,...contacts,...deals].forEach(x=>{if(x.assigned_to)emails.add(x.assigned_to);});
      activities.forEach(act=>{if(act.team_member_email)emails.add(act.team_member_email);});
      teamMembers=dbTeam.length?[...dbTeam]:[];
      const dbEmails=new Set(teamMembers.map(t=>t.email));
      Array.from(emails).filter(Boolean).forEach(email=>{
        if(!dbEmails.has(email))teamMembers.push({email,name:email.split('@')[0],role:'sales'});
      });
      renderDashboard();populateDropdowns();
      document.getElementById('shops-badge').textContent=shops.length;
    }

    function populateDropdowns(){
      const teamOpts='<option value="">Unassigned</option>'+teamMembers.map(t=>`<option value="${t.email}">${t.name}</option>`).join('');
      ['shop-assigned','contact-assigned','company-assigned','deal-assigned'].forEach(id=>{const el=document.getElementById(id);if(el)el.innerHTML=teamOpts;});
      document.getElementById('enroll-sequence').innerHTML='<option value="">Select sequence...</option>'+sequences.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
      populateShopFilters();
    }

    function populateShopFilters(){
      const cities=[...new Set(shops.map(s=>s.city).filter(Boolean))].sort();
      document.getElementById('city-dropdown').innerHTML=cities.map(c=>`<label class="multi-select-option"><input type="checkbox" value="${c}" onchange="updateShopFilter('cities','${c.replace(/'/g,"\\'")}',this.checked)">${c}</label>`).join('');
      const states=[...new Set(shops.map(s=>s.state).filter(Boolean))].sort();
      document.getElementById('state-dropdown').innerHTML=states.map(s=>`<label class="multi-select-option"><input type="checkbox" value="${s}" onchange="updateShopFilter('states','${s}',this.checked)">${s}</label>`).join('');
      document.getElementById('stage-dropdown').innerHTML=SHOP_STAGES.map(s=>`<label class="multi-select-option"><input type="checkbox" value="${s.id}" onchange="updateShopFilter('stages','${s.id}',this.checked)">${s.label}</label>`).join('');
      renderShops();
    }

    // Searchable Selects
    function filterCompanies(){
      const q=(document.getElementById('contact-company-search').value||'').toLowerCase();
      const filtered=companies.filter(c=>c.name.toLowerCase().includes(q)).slice(0,10);
      let html=filtered.map(c=>`<div class="searchable-select-option" onclick="selectCompany('${c.id}','${c.name.replace(/'/g,"\\'")}')">${c.name}</div>`).join('');
      if(q&&!filtered.find(c=>c.name.toLowerCase()===q))html+=`<div class="searchable-select-create" onclick="createCompanyInline()">+ Create "${document.getElementById('contact-company-search').value}"</div>`;
      document.getElementById('company-dropdown').innerHTML=html||'<div class="searchable-select-option" style="color:var(--joe-gray)">Type to search...</div>';
    }
    function showCompanyDropdown(){document.getElementById('company-dropdown').classList.add('open');filterCompanies();}
    function selectCompany(id,name){document.getElementById('contact-company').value=id;document.getElementById('contact-company-search').value=name;document.getElementById('company-dropdown').classList.remove('open');}
    async function createCompanyInline(){
      const name=document.getElementById('contact-company-search').value;
      const{data}=await db.from('companies').insert([{name,assigned_to:currentUser?.email}]).select().single();
      if(data){companies.push(data);selectCompany(data.id,data.name);showToast('Company created!');}
    }

    function filterDealContacts(){
      const q=(document.getElementById('deal-contact-search').value||'').toLowerCase();
      const filtered=contacts.filter(c=>(c.first_name+' '+c.last_name).toLowerCase().includes(q)).slice(0,10);
      document.getElementById('deal-contact-dropdown').innerHTML=filtered.map(c=>`<div class="searchable-select-option" onclick="selectDealContact('${c.id}','${(c.first_name+' '+c.last_name).replace(/'/g,"\\'")}')">${c.first_name} ${c.last_name}</div>`).join('')||'<div class="searchable-select-option" style="color:var(--joe-gray)">No contacts found</div>';
    }
    function showDealContactDropdown(){document.getElementById('deal-contact-dropdown').classList.add('open');filterDealContacts();}
    function selectDealContact(id,name){document.getElementById('deal-contact').value=id;document.getElementById('deal-contact-search').value=name;document.getElementById('deal-contact-dropdown').classList.remove('open');}

    function filterTaskContacts(){
      const q=(document.getElementById('task-contact-search').value||'').toLowerCase();
      const filtered=contacts.filter(c=>(c.first_name+' '+c.last_name).toLowerCase().includes(q)).slice(0,10);
      document.getElementById('task-contact-dropdown').innerHTML=filtered.map(c=>`<div class="searchable-select-option" onclick="selectTaskContact('${c.id}','${(c.first_name+' '+c.last_name).replace(/'/g,"\\'")}')">${c.first_name} ${c.last_name}</div>`).join('')||'<div class="searchable-select-option" style="color:var(--joe-gray)">No contacts found</div>';
    }
    function showTaskContactDropdown(){document.getElementById('task-contact-dropdown').classList.add('open');filterTaskContacts();}
    function selectTaskContact(id,name){document.getElementById('task-contact').value=id;document.getElementById('task-contact-search').value=name;document.getElementById('task-contact-dropdown').classList.remove('open');}

    document.addEventListener('click',e=>{
      if(!e.target.closest('.multi-select'))document.querySelectorAll('.multi-select-dropdown.open').forEach(d=>d.classList.remove('open'));
      if(!e.target.closest('.searchable-select'))document.querySelectorAll('.searchable-select-dropdown.open').forEach(d=>d.classList.remove('open'));
    });

    function toggleDropdown(id){const dd=document.querySelector('#'+id+' .multi-select-dropdown');document.querySelectorAll('.multi-select-dropdown.open').forEach(d=>{if(d!==dd)d.classList.remove('open');});dd.classList.toggle('open');}
    function updateShopFilter(type,value,checked){if(checked)shopFilters[type].push(value);else shopFilters[type]=shopFilters[type].filter(v=>v!==value);applyShopFilters();}
    function applyShopFilters(){
      document.querySelector('#city-filter .multi-select-trigger span:first-child').textContent=shopFilters.cities.length?shopFilters.cities.length+' cities':'All Cities';
      document.querySelector('#state-filter .multi-select-trigger span:first-child').textContent=shopFilters.states.length?shopFilters.states.length+' states':'All States';
      document.querySelector('#stage-filter .multi-select-trigger span:first-child').textContent=shopFilters.stages.length?shopFilters.stages.length+' stages':'All Stages';
      const tags=[];
      shopFilters.cities.forEach(c=>tags.push({type:'cities',value:c,label:c}));
      shopFilters.states.forEach(s=>tags.push({type:'states',value:s,label:s}));
      shopFilters.stages.forEach(s=>tags.push({type:'stages',value:s,label:SHOP_STAGES.find(st=>st.id===s)?.label||s}));
      document.getElementById('filter-tags').innerHTML=tags.map(t=>`<span class="filter-tag">${t.label}<span class="remove" onclick="removeFilter('${t.type}','${t.value.replace(/'/g,"\\'")}')">√ó</span></span>`).join('');
      renderShops();
    }
    function removeFilter(type,value){shopFilters[type]=shopFilters[type].filter(v=>v!==value);const cb=document.querySelector(`#${type.slice(0,-1)}-dropdown input[value="${value}"]`);if(cb)cb.checked=false;applyShopFilters();}
    function clearAllShopFilters(){shopFilters={cities:[],states:[],stages:[]};document.querySelectorAll('.multi-select-dropdown input').forEach(cb=>cb.checked=false);document.getElementById('shop-score-filter').value='';document.getElementById('shop-owner-filter').value='';document.getElementById('shop-search').value='';applyShopFilters();}

    // Dashboard
    function setDashboardView(view){
      dashboardView=view;
      document.getElementById('toggle-my').classList.toggle('active',view==='my');
      document.getElementById('toggle-all').classList.toggle('active',view==='all');
      document.getElementById('stat-leads-label').textContent=view==='my'?'My Leads':'All Leads';
      document.getElementById('stat-deals-label').textContent=view==='my'?'My Pipeline':'All Pipeline';
      document.getElementById('stat-tasks-label').textContent=view==='my'?'My Tasks':'All Tasks';
      document.getElementById('tasks-card-label').textContent=view==='my'?'‚úÖ My Tasks Today':'‚úÖ All Tasks Today';
      renderDashboard();
    }

    function renderDashboard(){
      const myEmail=currentUser?.email,isMy=dashboardView==='my';
      const newLeads=contacts.filter(c=>c.lead_status==='new'||!c.lead_status);
      const myLeads=newLeads.filter(c=>c.assigned_to===myEmail||!c.assigned_to);
      const pendingTasks=tasks.filter(t=>t.status!=='completed');
      const myTasks=pendingTasks.filter(t=>t.assigned_to===myEmail);
      const today=new Date().toISOString().split('T')[0];
      const todayTasks=(isMy?myTasks:pendingTasks).filter(t=>t.due_date?.startsWith(today));
      const activeDeals=deals.filter(d=>!['closed_won','closed_lost'].includes(d.stage));
      const myDeals=activeDeals.filter(d=>d.assigned_to===myEmail);
      const pipeline=(isMy?myDeals:activeDeals).reduce((s,d)=>s+(d.amount||0),0);
      const hotShops=shops.filter(s=>s.lead_score>=80);

      document.getElementById('stat-shops').textContent=shops.length;
      document.getElementById('stat-leads').textContent=isMy?myLeads.length:newLeads.length;
      document.getElementById('leads-badge').textContent=newLeads.length;
      document.getElementById('stat-hot').textContent=hotShops.length;
      document.getElementById('stat-tasks').textContent=isMy?myTasks.length:pendingTasks.length;
      document.getElementById('tasks-badge').textContent=myTasks.length;
      document.getElementById('stat-enrolled').textContent=enrollments.filter(e=>e.status==='active').length;
      document.getElementById('stat-pipeline').textContent='$'+pipeline.toLocaleString();

      document.getElementById('dashboard-hot').innerHTML=hotShops.length?hotShops.slice(0,5).map(s=>`<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--joe-light)"><span class="clickable" onclick="openShopModal('${s.id}')">${s.name}</span><span class="score hot">${s.lead_score}</span></div>`).join(''):'<div class="empty-state">No hot leads</div>';
      document.getElementById('dashboard-tasks').innerHTML=todayTasks.length?todayTasks.slice(0,5).map(t=>{const ct=contacts.find(c=>c.id===t.contact_id);return`<div class="task-item${t.sequence_enrollment_id?' sequence-task':''}"><div class="task-checkbox" onclick="completeTask('${t.id}')"></div><div class="task-info"><div class="task-title">${t.title}</div><div class="task-meta">${ct?ct.first_name+' '+ct.last_name:''}</div></div></div>`;}).join(''):'<div class="empty-state">No tasks today! üéâ</div>';
      renderReports();
    }

    function renderReports(){
      const stageCounts=SHOP_STAGES.slice(0,5).map(stage=>({...stage,count:shops.filter(s=>(s.pipeline_stage||'new')===stage.id).length}));
      const maxCount=Math.max(...stageCounts.map(s=>s.count),1);
      document.getElementById('pipeline-funnel').innerHTML=stageCounts.map(s=>{const pct=shops.length?Math.round(s.count/shops.length*100):0;const width=Math.max(20,s.count/maxCount*100);return`<div class="funnel-stage"><span class="funnel-label">${s.label}</span><div class="funnel-bar-wrapper"><div class="funnel-bar ${s.id}" style="width:${width}%">${s.count}</div></div><span class="funnel-percent">${pct}%</span></div>`;}).join('');

      const stages=['new','contacted','qualified','demo_scheduled','proposal'];
      const conversions=[];
      for(let i=0;i<stages.length-1;i++){const from=stages[i],to=stages[i+1];const fromCount=shops.filter(s=>stages.indexOf(s.pipeline_stage||'new')>=i).length;const toCount=shops.filter(s=>stages.indexOf(s.pipeline_stage||'new')>=i+1).length;const rate=fromCount?Math.round(toCount/fromCount*100):0;conversions.push({from:SHOP_STAGES.find(s=>s.id===from).label,to:SHOP_STAGES.find(s=>s.id===to).label,rate});}
      document.getElementById('conversion-rates').innerHTML=conversions.map(c=>`<div class="conversion-row"><div class="conversion-stages"><span>${c.from}</span><span class="conversion-arrow">‚Üí</span><span>${c.to}</span></div><span class="conversion-rate ${c.rate>=50?'good':c.rate>=25?'medium':'low'}">${c.rate}%</span></div>`).join('');

      const weekAgo=new Date(Date.now()-7*24*60*60*1000),twoWeeksAgo=new Date(Date.now()-14*24*60*60*1000);
      let thisWeek=activities.filter(a=>new Date(a.created_at)>=weekAgo),lastWeek=activities.filter(a=>{const d=new Date(a.created_at);return d>=twoWeeksAgo&&d<weekAgo;});
      if(dashboardView==='my'){thisWeek=thisWeek.filter(a=>a.team_member_email===currentUser?.email);lastWeek=lastWeek.filter(a=>a.team_member_email===currentUser?.email);}
      const types=['call','email','sms','note'];
      document.getElementById('activity-summary').innerHTML=types.map(type=>{const thisCount=thisWeek.filter(a=>a.activity_type===type).length;const lastCount=lastWeek.filter(a=>a.activity_type===type).length;const trend=thisCount>lastCount?'up':thisCount<lastCount?'down':'flat';const icon=trend==='up'?'‚Üë':trend==='down'?'‚Üì':'‚Üí';return`<div class="activity-row"><div class="activity-type-label"><div class="activity-type-icon ${type}">${ICONS[type]}</div><span style="text-transform:capitalize">${type}s</span></div><div class="activity-counts"><div class="activity-count"><div class="num">${thisCount}</div><div class="label">This Week</div></div><div class="activity-count"><div class="num">${lastCount}</div><div class="label">Last Week</div></div><span class="activity-trend ${trend}">${icon}</span></div></div>`;}).join('');

      const hotShops=shops.filter(s=>s.lead_score>=80);
      const byCity={};hotShops.forEach(s=>{const city=s.city||'Unknown';byCity[city]=(byCity[city]||0)+1;});
      const sorted=Object.entries(byCity).sort((a,b)=>b[1]-a[1]).slice(0,6);
      document.getElementById('hot-by-location').innerHTML=sorted.length?sorted.map(([city,count])=>`<div class="location-row"><span class="location-name">${city}</span><span class="location-hot">üî• ${count}</span></div>`).join(''):'<div class="empty-state">No hot leads</div>';
    }

    async function askJoe(){
      const q=document.getElementById('ai-input').value.trim();if(!q)return;
      document.getElementById('ai-response').classList.add('visible');
      document.getElementById('ai-response-content').innerHTML='Thinking...';
      const apiKey=localStorage.getItem('anthropic_api_key');
      if(!apiKey){document.getElementById('ai-response-content').innerHTML='Add your Anthropic API key in Settings ‚Üí Integrations';return;}
      
      // Build comprehensive context
      const hotShops=shops.filter(s=>s.lead_score>=80);
      const activeEnrollments=enrollments.filter(e=>e.status==='active').length;
      const pendingTasks=tasks.filter(t=>t.status!=='completed').length;
      const openDeals=deals.filter(d=>!['closed_won','closed_lost'].includes(d.stage)).length;
      
      const crmKnowledge=`You are joe, a helpful AI assistant for the joe CRM system. You help sales team members use the CRM effectively.

CURRENT DATA:
- ${shops.length} total shops in database
- ${hotShops.length} hot leads (score 80+)
- ${contacts.length} contacts
- ${companies.length} companies
- ${openDeals} open deals
- ${pendingTasks} pending tasks
- ${activeEnrollments} active sequence enrollments
- ${sequences.length} sequences created
- ${meetingNotes.length} meeting notes

HOT SHOPS RIGHT NOW: ${hotShops.slice(0,5).map(s=>s.name+' in '+s.city+' (score: '+s.lead_score+')').join(', ')||'None with score 80+'}

CRM FEATURES GUIDE:

üìä DASHBOARD
- Toggle "My Dashboard" vs "All Team" to filter stats
- See your leads, pipeline value, tasks at a glance
- Quick stats update in real-time

‚òï SHOPS (Outbound Leads)
- Database of coffee shops to contact
- Lead Score: 0-100, higher = better fit. 80+ are "hot"
- Pipeline stages: New ‚Üí Contacted ‚Üí Qualified ‚Üí Demo Scheduled ‚Üí Proposal
- Click shop to edit, log activities, convert to contact
- Filter by city, state, stage, score, owner
- Map view shows locations (colored by score)
- "Mine Only" filter shows just your assigned shops

üéØ PIPELINE
- Drag and drop shops between stages
- Visual kanban board view
- Cards show shop name, city, score

üë§ CONTACTS & COMPANIES
- Contacts are people, Companies are businesses
- Lifecycle stages: Lead ‚Üí MQL ‚Üí SQL ‚Üí Opportunity ‚Üí Customer
- Activity tab: Log calls, emails, SMS, notes
- Sequences tab: Enroll in automated follow-up
- Create Deal button to start sales process

üí∞ DEALS
- Track revenue opportunities
- Stages: Appointment ‚Üí Qualified ‚Üí Presentation ‚Üí Contract ‚Üí Closed Won/Lost
- Drag and drop between stages
- Link to contacts

‚ö° SEQUENCES (Automation)
- Multi-step automated outreach
- Steps can be: Email, Call, or SMS reminders
- Set delay days between steps
- Use merge fields: {{first_name}}, {{last_name}}, {{email}}, {{company}}, {{phone}}
- Enrolling a contact auto-creates tasks
- Completing a task advances to next step
- View enrolled contacts, pause/resume, bulk enroll

‚úÖ TASKS
- Auto-created from sequences
- Manual tasks too
- Filter: Pending, Due Today, Overdue
- Click checkbox to complete
- Completing sequence tasks auto-advances

üé• MEETING NOTES
- Syncs Google Meet transcripts from Drive
- AI analyzes for: Sentiment, Key Points, Customer Quotes, Concerns
- Search across all transcripts
- Filter by sentiment or contact
- "Copy to Roam" formats for Roam Research

üîå INTEGRATIONS
- Google Workspace: Click "Connect Google Account" (one-time per person)
  - Gmail: Syncs emails with contacts as activities
  - Calendar: Imports meetings as tasks
  - Meet: Fetches transcripts for AI analysis
- Twilio: SMS (requires API keys)
- API Keys: Store Anthropic key for AI features

üë• TEAM
- View all team members
- See assigned shops, contacts, deals per person
- Activity leaderboard
- Add/edit team members

COMMON QUESTIONS:

Q: How do I log a call?
A: Open a shop or contact ‚Üí Activity tab ‚Üí Click "üìû Call" ‚Üí Add outcome and notes ‚Üí Save

Q: How do I create a sequence?
A: Go to Sequences ‚Üí "+ Create Sequence" ‚Üí Name it ‚Üí Add steps with type, delay, and template ‚Üí Save

Q: How do I use merge fields?
A: In sequence templates, type {{first_name}} etc. They get replaced with contact data when tasks are created.

Q: How do I enroll someone in a sequence?
A: Open contact ‚Üí Sequences tab ‚Üí Click "Enroll in Sequence" ‚Üí Select sequence ‚Üí Enroll

Q: How do I connect Google?
A: Settings ‚Üí Integrations ‚Üí Click "Connect Google Account" ‚Üí Sign in ‚Üí Done

Q: How do I sync meeting transcripts?
A: Make sure Google is connected ‚Üí Go to Integrations ‚Üí Click "Fetch Transcripts" under Google Meet

Q: What's a good lead score?
A: 80+ = Hot (prioritize), 60-79 = Warm (follow up), Below 60 = Cold (nurture)

Q: How do I move a shop through the pipeline?
A: Either drag the card in Pipeline view, or open the shop and change the Stage dropdown

Be concise, friendly, and specific. If asked about data, use the current stats above. Guide users step-by-step.`;

      try{
        const res=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':apiKey,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1024,system:crmKnowledge,messages:[{role:'user',content:q}]})});
        const data=await res.json();
        document.getElementById('ai-response-content').innerHTML=data.error?'Error: '+data.error.message:data.content[0].text.replace(/\n/g,'<br>');
      }catch(e){document.getElementById('ai-response-content').innerHTML='Error: '+e.message;}
    }
    function askSuggestion(btn){document.getElementById('ai-input').value=btn.textContent;askJoe();}
    function openHelp(){navigateTo('dashboard');setTimeout(()=>{document.getElementById('ai-input').focus();document.getElementById('ai-input').scrollIntoView({behavior:'smooth',block:'center'});},100);}

    // Shops
    function renderShops(){
      const q=(document.getElementById('shop-search').value||'').toLowerCase();
      const minScore=document.getElementById('shop-score-filter').value;
      const owner=document.getElementById('shop-owner-filter').value;
      let f=shops.filter(s=>{
        if(q&&!s.name.toLowerCase().includes(q)&&!(s.city||'').toLowerCase().includes(q))return false;
        if(shopFilters.cities.length&&!shopFilters.cities.includes(s.city))return false;
        if(shopFilters.states.length&&!shopFilters.states.includes(s.state))return false;
        if(shopFilters.stages.length&&!shopFilters.stages.includes(s.pipeline_stage||'new'))return false;
        if(minScore&&(s.lead_score||0)<parseInt(minScore))return false;
        if(owner==='mine'&&s.assigned_to!==currentUser?.email)return false;
        return true;
      });
      f.sort((a,b)=>{let av=a[shopSort.field]||'',bv=b[shopSort.field]||'';if(typeof av==='string'){av=av.toLowerCase();bv=bv.toLowerCase();}return shopSort.dir==='asc'?(av>bv?1:-1):(av<bv?1:-1);});
      document.getElementById('shop-count').textContent=f.length+' shops';
      document.getElementById('shops-table').innerHTML=f.length?f.slice(0,100).map(s=>{const ownerName=s.assigned_to?s.assigned_to.split('@')[0]:'‚Äî';const isMine=s.assigned_to===currentUser?.email;return`<tr><td><span class="clickable" onclick="openShopModal('${s.id}')">${s.name}</span></td><td>${s.city||''}, ${s.state||''}</td><td><span class="score ${s.lead_score>=80?'hot':s.lead_score>=60?'warm':'cold'}">${s.lead_score||50}</span></td><td><span class="stage-badge stage-${s.pipeline_stage||'new'}">${SHOP_STAGES.find(st=>st.id===s.pipeline_stage)?.label||'New'}</span></td><td><span class="owner-badge${isMine?' mine':''}">${ownerName}</span></td><td class="actions-cell"><button class="action-btn" onclick="openShopModal('${s.id}')">üëÅÔ∏è</button>${s.phone?`<a class="action-btn" href="tel:${s.phone}">üìû</a>`:''}${s.email?`<a class="action-btn" href="mailto:${s.email}">‚úâÔ∏è</a>`:''}</td></tr>`;}).join(''):'<tr><td colspan="6" class="empty-state">No shops</td></tr>';
      if(map&&mapVisible)renderMapMarkers(f);
    }
    function sortShopsBy(field){shopSort.dir=shopSort.field===field&&shopSort.dir==='desc'?'asc':'desc';shopSort.field=field;renderShops();}

    function toggleMap(){mapVisible=!mapVisible;document.getElementById('map-wrapper').classList.toggle('collapsed',!mapVisible);document.getElementById('map-toggle-btn').classList.toggle('collapsed',!mapVisible);if(mapVisible)setTimeout(()=>{initMap();if(map)map.resize();},100);}
    function initMap(){if(map)return;map=new mapboxgl.Map({container:'shops-map',style:'mapbox://styles/mapbox/light-v11',center:[-98.5795,39.8283],zoom:3.5});map.addControl(new mapboxgl.NavigationControl(),'top-left');map.on('load',()=>renderMapMarkers(shops));}
    function renderMapMarkers(list){if(!map)return;mapMarkers.forEach(m=>m.remove());mapMarkers=[];const filtered=(list||shops).filter(s=>s.lat&&s.lng);document.getElementById('map-stat-visible').textContent=filtered.length;filtered.forEach(shop=>{const color=shop.lead_score>=80?'#f59e0b':shop.lead_score>=60?'#3b82f6':'#6b7280';const el=document.createElement('div');el.style.cssText=`width:16px;height:16px;background:${color};border:2px solid white;border-radius:50%;cursor:pointer;`;el.onclick=()=>openShopModal(shop.id);mapMarkers.push(new mapboxgl.Marker(el).setLngLat([parseFloat(shop.lng),parseFloat(shop.lat)]).addTo(map));});if(filtered.length){const bounds=new mapboxgl.LngLatBounds();filtered.forEach(s=>bounds.extend([parseFloat(s.lng),parseFloat(s.lat)]));map.fitBounds(bounds,{padding:50,maxZoom:12});}}

    // Drag-drop Pipeline
    function renderOutboundPipeline(){document.getElementById('outbound-pipeline').innerHTML=SHOP_STAGES.slice(0,5).map(stage=>{const ss=shops.filter(s=>(s.pipeline_stage||'new')===stage.id);return`<div class="pipeline-column" data-stage="${stage.id}" ondragover="onDragOver(event)" ondrop="onDropShop(event)"><div class="pipeline-header"><h3>${stage.label}</h3><span class="pipeline-count">${ss.length}</span></div>${ss.slice(0,15).map(s=>`<div class="pipeline-card" draggable="true" data-id="${s.id}" ondragstart="onDragStart(event,'shop')" ondragend="onDragEnd(event)"><h4>${s.name}</h4><div class="meta">${s.city||''} ‚Ä¢ ${s.lead_score||50}</div></div>`).join('')}</div>`;}).join('');}
    function renderDeals(){const owner=document.getElementById('deals-owner-filter')?.value;let fd=deals;if(owner==='mine')fd=deals.filter(d=>d.assigned_to===currentUser?.email);document.getElementById('deals-pipeline').innerHTML=DEAL_STAGES.map(st=>{const sd=fd.filter(d=>d.stage===st.id);const tot=sd.reduce((s,d)=>s+(d.amount||0),0);return`<div class="pipeline-column" data-stage="${st.id}" ondragover="onDragOver(event)" ondrop="onDropDeal(event)"><div class="pipeline-header"><h3>${st.label}</h3><span class="pipeline-count">$${tot.toLocaleString()}</span></div>${sd.map(d=>{const ct=contacts.find(c=>c.id===d.contact_id);return`<div class="pipeline-card" draggable="true" data-id="${d.id}" ondragstart="onDragStart(event,'deal')" ondragend="onDragEnd(event)" onclick="openDealModal('${d.id}')"><h4>${d.name}</h4><div class="meta">${ct?ct.first_name+' '+ct.last_name:'-'}</div>${d.amount?`<div class="amount">$${d.amount.toLocaleString()}</div>`:''}</div>`;}).join('')}</div>`;}).join('');}
    function onDragStart(e,type){draggedItem={id:e.target.dataset.id,type};e.target.classList.add('dragging');}
    function onDragEnd(e){e.target.classList.remove('dragging');document.querySelectorAll('.pipeline-column').forEach(c=>c.classList.remove('drag-over'));}
    function onDragOver(e){e.preventDefault();e.currentTarget.classList.add('drag-over');}
    async function onDropShop(e){e.preventDefault();e.currentTarget.classList.remove('drag-over');if(!draggedItem||draggedItem.type!=='shop')return;const newStage=e.currentTarget.dataset.stage;await db.from('shops').update({pipeline_stage:newStage}).eq('id',draggedItem.id);const shop=shops.find(s=>s.id===draggedItem.id);if(shop)shop.pipeline_stage=newStage;renderOutboundPipeline();renderDashboard();showToast('Stage updated!');}
    async function onDropDeal(e){e.preventDefault();e.currentTarget.classList.remove('drag-over');if(!draggedItem||draggedItem.type!=='deal')return;const newStage=e.currentTarget.dataset.stage;await db.from('deals').update({stage:newStage}).eq('id',draggedItem.id);const deal=deals.find(d=>d.id===draggedItem.id);if(deal)deal.stage=newStage;renderDeals();renderDashboard();showToast('Stage updated!');}

    // Shop Modal
    function openShopModal(id){currentShopId=id||null;document.querySelectorAll('#shop-modal .modal-tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('#shop-modal .modal-tab-content').forEach(t=>t.classList.remove('active'));document.querySelector('#shop-modal .modal-tab[data-tab="details"]').classList.add('active');document.getElementById('shop-tab-details').classList.add('active');hideShopActivityForm();if(id){const s=shops.find(x=>x.id===id);document.getElementById('shop-modal-title').textContent=s.name;document.getElementById('shop-name').value=s.name||'';document.getElementById('shop-stage').value=s.pipeline_stage||'new';document.getElementById('shop-city').value=s.city||'';document.getElementById('shop-state').value=s.state||'';document.getElementById('shop-phone').value=s.phone||'';document.getElementById('shop-email').value=s.email||'';document.getElementById('shop-website').value=s.website||'';document.getElementById('shop-score').value=s.lead_score||50;document.getElementById('shop-assigned').value=s.assigned_to||'';document.getElementById('shop-contact-name').value=s.contact_name||'';document.getElementById('shop-notes').value=s.notes||'';document.getElementById('convert-first').value=(s.contact_name||'').split(' ')[0]||'';document.getElementById('convert-last').value=(s.contact_name||'').split(' ').slice(1).join(' ')||'';document.getElementById('convert-email').value=s.email||'';renderShopActivities(id);}else{document.getElementById('shop-modal-title').textContent='Add Shop';['shop-name','shop-city','shop-state','shop-phone','shop-email','shop-website','shop-contact-name','shop-notes'].forEach(x=>document.getElementById(x).value='');document.getElementById('shop-stage').value='new';document.getElementById('shop-score').value='50';document.getElementById('shop-assigned').value=currentUser?.email||'';document.getElementById('shop-activity-list').innerHTML='<div class="empty-state">Save first</div>';}document.getElementById('shop-modal').classList.add('open');}
    function closeShopModal(){document.getElementById('shop-modal').classList.remove('open');}
    async function saveShop(){const d={name:document.getElementById('shop-name').value,pipeline_stage:document.getElementById('shop-stage').value,city:document.getElementById('shop-city').value,state:document.getElementById('shop-state').value,phone:document.getElementById('shop-phone').value,email:document.getElementById('shop-email').value,website:document.getElementById('shop-website').value,assigned_to:document.getElementById('shop-assigned').value||null,contact_name:document.getElementById('shop-contact-name').value,notes:document.getElementById('shop-notes').value};if(currentShopId){await db.from('shops').update(d).eq('id',currentShopId);Object.assign(shops.find(s=>s.id===currentShopId),d);}else{d.lead_score=50;const{data:n}=await db.from('shops').insert([d]).select().single();if(n)shops.unshift(n);}closeShopModal();renderShops();renderOutboundPipeline();renderDashboard();showToast('Saved!');}
    function renderShopActivities(id){const a=activities.filter(x=>x.shop_id===id);document.getElementById('shop-activity-list').innerHTML=a.length?a.slice(0,20).map(x=>`<div class="activity-item"><div class="activity-icon ${x.activity_type}">${ICONS[x.activity_type]||'üìã'}</div><div class="activity-content"><div class="activity-type">${x.activity_type}${x.outcome?' - '+x.outcome:''}</div>${x.notes?`<div class="activity-notes">${x.notes.substring(0,150)}</div>`:''}<div class="activity-meta">${x.team_member_name||''} ‚Ä¢ ${formatDate(x.created_at)}</div></div></div>`).join(''):'<div class="empty-state">No activities</div>';}
    function showShopActivityForm(t){document.getElementById('shop-activity-type').value=t;document.getElementById('shop-activity-form').classList.add('visible');}
    function hideShopActivityForm(){document.getElementById('shop-activity-form').classList.remove('visible');document.getElementById('shop-activity-outcome').value='';document.getElementById('shop-activity-notes').value='';}
    async function saveShopActivity(){if(!currentShopId)return;const{data}=await db.from('activities').insert([{shop_id:currentShopId,team_member_email:currentUser.email,team_member_name:currentUser.name,activity_type:document.getElementById('shop-activity-type').value,outcome:document.getElementById('shop-activity-outcome').value||null,notes:document.getElementById('shop-activity-notes').value}]).select().single();if(data)activities.unshift(data);const sh=shops.find(s=>s.id===currentShopId);if(sh&&sh.pipeline_stage==='new'){await db.from('shops').update({pipeline_stage:'contacted'}).eq('id',currentShopId);sh.pipeline_stage='contacted';document.getElementById('shop-stage').value='contacted';}hideShopActivityForm();renderShopActivities(currentShopId);renderDashboard();showToast('Logged!');}
    async function convertShopToContact(){if(!currentShopId)return;const shop=shops.find(s=>s.id===currentShopId);const first=document.getElementById('convert-first').value;if(!first){showToast('First name required','error');return;}const{data:company}=await db.from('companies').insert([{name:shop.name,city:shop.city,state:shop.state,phone:shop.phone,website:shop.website,assigned_to:currentUser?.email}]).select().single();if(company)companies.push(company);const{data:contact}=await db.from('contacts').insert([{first_name:first,last_name:document.getElementById('convert-last').value,email:document.getElementById('convert-email').value,phone:shop.phone,job_title:document.getElementById('convert-title').value,company_id:company?.id,lifecycle_stage:'lead',lead_status:'new',lead_source:'outbound',assigned_to:currentUser?.email}]).select().single();if(contact)contacts.unshift(contact);await db.from('shops').update({pipeline_stage:'qualified',company_id:company?.id}).eq('id',currentShopId);shop.pipeline_stage='qualified';shop.company_id=company?.id;closeShopModal();populateDropdowns();renderDashboard();showToast('Converted!');}

    document.querySelectorAll('.modal-tab').forEach(tab=>{tab.addEventListener('click',()=>{const modal=tab.closest('.modal');modal.querySelectorAll('.modal-tab').forEach(t=>t.classList.remove('active'));modal.querySelectorAll('.modal-tab-content').forEach(t=>t.classList.remove('active'));tab.classList.add('active');document.getElementById(modal.id.replace('-modal','')+'-tab-'+tab.dataset.tab).classList.add('active');});});

    // Contacts
    function renderContacts(){const q=(document.getElementById('contact-search').value||'').toLowerCase();const stage=document.getElementById('contact-stage-filter').value;const owner=document.getElementById('contact-owner-filter').value;const f=contacts.filter(c=>{if(q&&!(c.first_name+' '+c.last_name+' '+c.email).toLowerCase().includes(q))return false;if(stage&&c.lifecycle_stage!==stage)return false;if(owner==='mine'&&c.assigned_to!==currentUser?.email)return false;return true;});document.getElementById('contact-count').textContent=f.length+' contacts';document.getElementById('contacts-table').innerHTML=f.length?f.map(c=>{const co=companies.find(x=>x.id===c.company_id);const ownerName=c.assigned_to?c.assigned_to.split('@')[0]:'‚Äî';const isMine=c.assigned_to===currentUser?.email;return`<tr><td><span class="clickable" onclick="openContactModal('${c.id}')">${c.first_name} ${c.last_name}</span></td><td>${c.email||'-'}</td><td>${co?.name||'-'}</td><td><span class="badge badge-${c.lifecycle_stage==='customer'?'green':'blue'}">${c.lifecycle_stage||'lead'}</span></td><td><span class="owner-badge${isMine?' mine':''}">${ownerName}</span></td><td><button class="action-btn" onclick="openContactModal('${c.id}')">‚úèÔ∏è</button></td></tr>`;}).join(''):'<tr><td colspan="6" class="empty-state">No contacts</td></tr>';}
    function renderLeads(){const leads=contacts.filter(c=>c.lead_status==='new'||!c.lead_status);document.getElementById('leads-list').innerHTML=leads.length?leads.map(c=>{const co=companies.find(x=>x.id===c.company_id);return`<div style="background:#fff;border-radius:10px;padding:16px;margin-bottom:12px;border-left:4px solid var(--joe-accent);display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:600">${c.first_name} ${c.last_name}</div><div style="font-size:13px;color:var(--joe-gray)">${co?.name||'No company'} ‚Ä¢ ${c.email||''}</div><div style="font-size:11px;color:var(--joe-gray);margin-top:4px">Source: ${c.lead_source||'unknown'} ‚Ä¢ ${formatDate(c.created_at)}</div></div><div style="display:flex;gap:8px"><button class="btn btn-small btn-secondary" onclick="openContactModal('${c.id}')">View</button><button class="btn btn-small btn-primary" onclick="quickEnroll('${c.id}')">‚ö° Enroll</button></div></div>`;}).join(''):'<div class="empty-state">No new leads üéâ</div>';}
    function openContactModal(id){currentContactId=id||null;document.querySelectorAll('#contact-modal .modal-tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('#contact-modal .modal-tab-content').forEach(t=>t.classList.remove('active'));document.querySelector('#contact-modal .modal-tab[data-tab="details"]').classList.add('active');document.getElementById('contact-tab-details').classList.add('active');hideContactActivityForm();hideEnrollForm();if(id){const c=contacts.find(x=>x.id===id);const co=companies.find(x=>x.id===c.company_id);document.getElementById('contact-modal-title').textContent=c.first_name+' '+c.last_name;document.getElementById('contact-first').value=c.first_name||'';document.getElementById('contact-last').value=c.last_name||'';document.getElementById('contact-email').value=c.email||'';document.getElementById('contact-phone').value=c.phone||'';document.getElementById('contact-title').value=c.job_title||'';document.getElementById('contact-company').value=c.company_id||'';document.getElementById('contact-company-search').value=co?.name||'';document.getElementById('contact-lifecycle').value=c.lifecycle_stage||'lead';document.getElementById('contact-source').value=c.lead_source||'';document.getElementById('contact-assigned').value=c.assigned_to||'';renderContactActivities(id);renderEnrollments(id);}else{document.getElementById('contact-modal-title').textContent='Add Contact';['contact-first','contact-last','contact-email','contact-phone','contact-title','contact-source','contact-company-search'].forEach(x=>document.getElementById(x).value='');document.getElementById('contact-company').value='';document.getElementById('contact-lifecycle').value='lead';document.getElementById('contact-assigned').value=currentUser?.email||'';document.getElementById('contact-activity-list').innerHTML='<div class="empty-state">Save contact first</div>';document.getElementById('contact-enrollments').innerHTML='<div class="empty-state">Save contact first</div>';}document.getElementById('contact-modal').classList.add('open');}
    function closeContactModal(){document.getElementById('contact-modal').classList.remove('open');}
    async function saveContact(){const d={first_name:document.getElementById('contact-first').value,last_name:document.getElementById('contact-last').value,email:document.getElementById('contact-email').value,phone:document.getElementById('contact-phone').value,job_title:document.getElementById('contact-title').value,company_id:document.getElementById('contact-company').value||null,lifecycle_stage:document.getElementById('contact-lifecycle').value,lead_source:document.getElementById('contact-source').value||null,assigned_to:document.getElementById('contact-assigned').value||null};if(currentContactId){await db.from('contacts').update(d).eq('id',currentContactId);Object.assign(contacts.find(c=>c.id===currentContactId),d);}else{d.lead_status='new';const{data:n}=await db.from('contacts').insert([d]).select().single();if(n)contacts.unshift(n);}closeContactModal();renderContacts();renderLeads();renderDashboard();populateDropdowns();showToast('Saved!');}
    function renderContactActivities(id){const a=activities.filter(x=>x.contact_id===id);document.getElementById('contact-activity-list').innerHTML=a.length?a.slice(0,20).map(x=>`<div class="activity-item"><div class="activity-icon ${x.activity_type}">${ICONS[x.activity_type]||'üìã'}</div><div class="activity-content"><div class="activity-type">${x.activity_type}${x.outcome?' - '+x.outcome:''}</div>${x.notes?`<div class="activity-notes">${x.notes.substring(0,150)}</div>`:''}<div class="activity-meta">${x.team_member_name||''} ‚Ä¢ ${formatDate(x.created_at)}</div></div></div>`).join(''):'<div class="empty-state">No activities</div>';}
    function showContactActivityForm(t){document.getElementById('contact-activity-type').value=t;document.getElementById('contact-activity-form').classList.add('visible');}
    function hideContactActivityForm(){document.getElementById('contact-activity-form').classList.remove('visible');document.getElementById('contact-activity-outcome').value='';document.getElementById('contact-activity-notes').value='';}
    async function saveContactActivity(){if(!currentContactId){showToast('Save contact first','error');return;}const{data}=await db.from('activities').insert([{contact_id:currentContactId,team_member_email:currentUser.email,team_member_name:currentUser.name,activity_type:document.getElementById('contact-activity-type').value,outcome:document.getElementById('contact-activity-outcome').value||null,notes:document.getElementById('contact-activity-notes').value}]).select().single();if(data)activities.unshift(data);const ct=contacts.find(c=>c.id===currentContactId);if(ct&&(ct.lead_status==='new'||!ct.lead_status)){await db.from('contacts').update({lead_status:'contacted'}).eq('id',currentContactId);ct.lead_status='contacted';}hideContactActivityForm();renderContactActivities(currentContactId);renderDashboard();renderLeads();showToast('Logged!');}
    function renderEnrollments(id){const e=enrollments.filter(x=>x.contact_id===id);document.getElementById('contact-enrollments').innerHTML=e.length?e.map(x=>{const s=sequences.find(y=>y.id===x.sequence_id);return`<div style="background:var(--joe-light);padding:12px;border-radius:8px;margin-bottom:8px"><div style="display:flex;justify-content:space-between"><strong>${s?.name||'Sequence'}</strong><span class="badge badge-${x.status==='active'?'purple':'green'}">${x.status}</span></div><div style="font-size:12px;color:var(--joe-gray)">Step ${x.current_step} of ${s?.sequence_steps?.length||0}</div></div>`;}).join(''):'<div class="empty-state">Not enrolled</div>';}
    function showEnrollForm(){if(!sequences.length){showToast('Create a sequence first','error');return;}document.getElementById('enroll-form').classList.add('visible');}
    function hideEnrollForm(){document.getElementById('enroll-form').classList.remove('visible');}
    async function enrollContact(){if(!currentContactId){showToast('Save contact first','error');return;}const seqId=document.getElementById('enroll-sequence').value;if(!seqId){showToast('Select a sequence','error');return;}const seq=sequences.find(s=>s.id===seqId);if(!seq){showToast('Sequence not found','error');return;}if(enrollments.find(e=>e.contact_id===currentContactId&&e.sequence_id===seqId)){showToast('Already enrolled','error');return;}const{data:enrollment}=await db.from('sequence_enrollments').insert([{sequence_id:seqId,contact_id:currentContactId,enrolled_by:currentUser.email,status:'active',current_step:1}]).select().single();if(enrollment){enrollments.push(enrollment);await createNextTask(enrollment,seq);}hideEnrollForm();renderEnrollments(currentContactId);renderDashboard();showToast('Enrolled!');}
    async function quickEnroll(contactId){const defaultSeq=sequences.find(s=>s.is_default)||sequences[0];if(!defaultSeq){showToast('Create a sequence first','error');return;}if(enrollments.find(e=>e.contact_id===contactId&&e.sequence_id===defaultSeq.id)){showToast('Already enrolled','error');return;}const{data:enrollment}=await db.from('sequence_enrollments').insert([{sequence_id:defaultSeq.id,contact_id:contactId,enrolled_by:currentUser.email,status:'active',current_step:1}]).select().single();if(enrollment){enrollments.push(enrollment);await createNextTask(enrollment,defaultSeq);await db.from('contacts').update({lead_status:'contacted'}).eq('id',contactId);const ct=contacts.find(c=>c.id===contactId);if(ct)ct.lead_status='contacted';}renderLeads();renderDashboard();showToast('Enrolled in '+defaultSeq.name);}
    async function createNextTask(enrollment,sequence){
      const steps=sequence.sequence_steps||[];
      const step=steps.find(s=>s.step_order===enrollment.current_step);
      if(!step)return;
      
      // Get contact and company for merge fields
      const contact=contacts.find(c=>c.id===enrollment.contact_id)||{};
      const company=companies.find(co=>co.id===contact.company_id);
      
      // Apply merge fields
      const mergeFields=(text)=>{
        if(!text)return text;
        return text
          .replace(/\{\{first_name\}\}/g,contact.first_name||'')
          .replace(/\{\{last_name\}\}/g,contact.last_name||'')
          .replace(/\{\{email\}\}/g,contact.email||'')
          .replace(/\{\{phone\}\}/g,contact.phone||'')
          .replace(/\{\{company\}\}/g,company?.name||'');
      };
      
      const subject=mergeFields(step.subject)||'Follow up';
      const body=mergeFields(step.body)||'';
      
      const dueDate=new Date();
      dueDate.setDate(dueDate.getDate()+(step.delay_days||0));
      
      const{data:task}=await db.from('tasks').insert([{
        title:`${step.step_type==='email'?'üìß':step.step_type==='call'?'üìû':'üí¨'} ${subject}`,
        task_type:step.step_type,
        due_date:dueDate.toISOString(),
        contact_id:enrollment.contact_id,
        sequence_enrollment_id:enrollment.id,
        assigned_to:currentUser.email,
        status:'not_started',
        notes:body
      }]).select().single();
      if(task)tasks.push(task);
    }
    function createDealFromContact(){if(!currentContactId)return;const ct=contacts.find(c=>c.id===currentContactId);const co=companies.find(c=>c.id===ct.company_id);closeContactModal();openDealModal();setTimeout(()=>{document.getElementById('deal-name').value=co?.name||ct.first_name+"'s Deal";document.getElementById('deal-contact').value=currentContactId;document.getElementById('deal-contact-search').value=ct.first_name+' '+ct.last_name;document.getElementById('deal-assigned').value=currentUser?.email||'';},50);}

    // Companies
    function renderCompanies(){const q=(document.getElementById('company-search').value||'').toLowerCase();const f=companies.filter(c=>!q||c.name.toLowerCase().includes(q));document.getElementById('company-count').textContent=f.length+' companies';document.getElementById('companies-table').innerHTML=f.length?f.map(c=>{const ct=contacts.filter(x=>x.company_id===c.id).length;const owner=c.assigned_to?c.assigned_to.split('@')[0]:'‚Äî';return`<tr><td><span class="clickable" onclick="openCompanyModal('${c.id}')">${c.name}</span></td><td>${c.city||'-'}</td><td>${ct}</td><td><span class="owner-badge">${owner}</span></td><td><button class="action-btn" onclick="openCompanyModal('${c.id}')">‚úèÔ∏è</button></td></tr>`;}).join(''):'<tr><td colspan="5" class="empty-state">No companies</td></tr>';}
    function openCompanyModal(id){currentCompanyId=id||null;if(id){const c=companies.find(x=>x.id===id);document.getElementById('company-modal-title').textContent=c.name;document.getElementById('company-name').value=c.name;document.getElementById('company-city').value=c.city||'';document.getElementById('company-state').value=c.state||'';document.getElementById('company-phone').value=c.phone||'';document.getElementById('company-website').value=c.website||'';document.getElementById('company-assigned').value=c.assigned_to||'';}else{document.getElementById('company-modal-title').textContent='Add Company';['company-name','company-city','company-state','company-phone','company-website'].forEach(x=>document.getElementById(x).value='');document.getElementById('company-assigned').value=currentUser?.email||'';}document.getElementById('company-modal').classList.add('open');}
    function closeCompanyModal(){document.getElementById('company-modal').classList.remove('open');}
    async function saveCompany(){const d={name:document.getElementById('company-name').value,city:document.getElementById('company-city').value,state:document.getElementById('company-state').value,phone:document.getElementById('company-phone').value,website:document.getElementById('company-website').value,assigned_to:document.getElementById('company-assigned').value||null};if(currentCompanyId){await db.from('companies').update(d).eq('id',currentCompanyId);Object.assign(companies.find(c=>c.id===currentCompanyId),d);}else{const{data:n}=await db.from('companies').insert([d]).select().single();if(n)companies.push(n);}closeCompanyModal();renderCompanies();populateDropdowns();showToast('Saved!');}

    // Deals
    function openDealModal(id){
      currentDealId=id||null;
      // Reset tabs
      document.querySelectorAll('#deal-modal .modal-tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('#deal-modal .modal-tab-content').forEach(t=>t.classList.remove('active'));
      document.querySelector('#deal-modal .modal-tab[data-tab="details"]').classList.add('active');
      document.getElementById('deal-tab-details').classList.add('active');
      
      if(id){
        const d=deals.find(x=>x.id===id);
        const ct=contacts.find(c=>c.id===d.contact_id);
        document.getElementById('deal-modal-title').textContent=d.name;
        document.getElementById('deal-name').value=d.name;
        document.getElementById('deal-amount').value=d.amount||'';
        document.getElementById('deal-close-date').value=d.close_date||'';
        document.getElementById('deal-contact').value=d.contact_id||'';
        document.getElementById('deal-contact-search').value=ct?ct.first_name+' '+ct.last_name:'';
        document.getElementById('deal-stage').value=d.stage;
        document.getElementById('deal-assigned').value=d.assigned_to||'';
        renderDealMeetings(id,d.contact_id);
        renderDealActivity(d.contact_id);
      }else{
        document.getElementById('deal-modal-title').textContent='Add Deal';
        ['deal-name','deal-amount','deal-close-date','deal-contact-search'].forEach(x=>document.getElementById(x).value='');
        document.getElementById('deal-contact').value='';
        document.getElementById('deal-stage').value='appointment';
        document.getElementById('deal-assigned').value=currentUser?.email||'';
        document.getElementById('deal-meetings-list').innerHTML='<div class="empty-state">Save deal first</div>';
        document.getElementById('deal-activity-list').innerHTML='<div class="empty-state">Save deal first</div>';
      }
      document.getElementById('deal-modal').classList.add('open');
    }
    function closeDealModal(){document.getElementById('deal-modal').classList.remove('open');}
    
    function renderDealMeetings(dealId,contactId){
      // Find meetings linked to this deal or contact
      const dealMeetings=meetingNotes.filter(m=>m.deal_id===dealId||m.contact_id===contactId);
      document.getElementById('deal-meetings-list').innerHTML=dealMeetings.length?dealMeetings.map(m=>{
        const sentimentColor=m.sentiment==='positive'?'green':m.sentiment==='negative'?'red':'gray';
        const sentimentIcon=m.sentiment==='positive'?'üòä':m.sentiment==='negative'?'üòü':'üòê';
        return`<div style="background:var(--joe-light);padding:16px;border-radius:8px;margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
            <div>
              <div style="font-weight:600">${m.title||'Meeting'}</div>
              <div style="font-size:12px;color:var(--joe-gray)">${formatDate(m.meeting_date)}</div>
            </div>
            <span class="badge badge-${sentimentColor}">${sentimentIcon} ${m.sentiment||'neutral'}</span>
          </div>
          <div style="font-size:13px;line-height:1.5">${extractSection(m.analysis||'','key points')||'<span style="color:var(--joe-gray)">No analysis</span>'}</div>
          ${m.source_url?`<a href="${m.source_url}" target="_blank" style="font-size:12px;color:var(--joe-blue);margin-top:8px;display:inline-block">View transcript ‚Üí</a>`:''}
        </div>`;
      }).join(''):'<div class="empty-state">No meetings linked to this deal yet.<br><small>Meetings are auto-linked when transcripts mention the contact.</small></div>';
    }
    
    function renderDealActivity(contactId){
      if(!contactId){document.getElementById('deal-activity-list').innerHTML='<div class="empty-state">No contact linked</div>';return;}
      const contactActivities=activities.filter(a=>a.contact_id===contactId).slice(0,15);
      document.getElementById('deal-activity-list').innerHTML=contactActivities.length?contactActivities.map(a=>`
        <div class="activity-item">
          <div class="activity-icon ${a.activity_type}">${ICONS[a.activity_type]||'üìã'}</div>
          <div class="activity-content">
            <div class="activity-type">${a.activity_type}${a.outcome?' - '+a.outcome:''}</div>
            ${a.notes?`<div class="activity-notes">${a.notes.substring(0,150)}</div>`:''}
            <div class="activity-meta">${a.team_member_name||''} ‚Ä¢ ${formatDate(a.created_at)}</div>
          </div>
        </div>
      `).join(''):'<div class="empty-state">No activity with this contact</div>';
    }
    async function saveDeal(){const d={name:document.getElementById('deal-name').value,amount:parseFloat(document.getElementById('deal-amount').value)||null,close_date:document.getElementById('deal-close-date').value||null,contact_id:document.getElementById('deal-contact').value||null,stage:document.getElementById('deal-stage').value,assigned_to:document.getElementById('deal-assigned').value||null};if(!d.name){showToast('Deal name required','error');return;}if(currentDealId){await db.from('deals').update(d).eq('id',currentDealId);Object.assign(deals.find(x=>x.id===currentDealId),d);}else{const{data:n}=await db.from('deals').insert([d]).select().single();if(n)deals.unshift(n);}closeDealModal();renderDeals();renderDashboard();showToast('Saved!');}

    // Sequences
    function renderSequences(){
      // Stats
      const activeEnrollments=enrollments.filter(e=>e.status==='active').length;
      const weekAgo=new Date(Date.now()-7*24*60*60*1000);
      const completedThisWeek=enrollments.filter(e=>e.status==='completed'&&new Date(e.updated_at||e.created_at)>=weekAgo).length;
      const seqTasks=tasks.filter(t=>t.sequence_enrollment_id).length;
      document.getElementById('seq-total').textContent=sequences.length;
      document.getElementById('seq-active').textContent=activeEnrollments;
      document.getElementById('seq-completed').textContent=completedThisWeek;
      document.getElementById('seq-tasks').textContent=seqTasks;
      
      document.getElementById('sequences-list').innerHTML=sequences.length?sequences.map(s=>{
        const steps=s.sequence_steps||[];
        const seqEnrollments=enrollments.filter(e=>e.sequence_id===s.id);
        const active=seqEnrollments.filter(e=>e.status==='active').length;
        const completed=seqEnrollments.filter(e=>e.status==='completed').length;
        const paused=seqEnrollments.filter(e=>e.status==='paused').length;
        return`<div class="card" style="margin-bottom:16px">
          <div class="card-header">
            <div style="display:flex;align-items:center;gap:12px">
              <h2>${s.name}${s.is_default?' ‚≠ê':''}</h2>
              ${s.description?`<span style="color:var(--joe-gray);font-weight:normal;font-size:13px">${s.description}</span>`:''}
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn btn-small btn-secondary" onclick="viewEnrollments('${s.id}')">üë• ${active} active</button>
              <button class="btn btn-small btn-secondary" onclick="editSequence('${s.id}')">Edit</button>
              <button class="btn btn-small btn-secondary" onclick="deleteSequence('${s.id}')" style="color:var(--joe-red)">Delete</button>
            </div>
          </div>
          <div class="card-body">
            <div style="display:flex;gap:24px;margin-bottom:16px">
              <div><span style="font-size:24px;font-weight:700">${steps.length}</span><span style="font-size:12px;color:var(--joe-gray);margin-left:4px">steps</span></div>
              <div><span style="font-size:24px;font-weight:700;color:var(--joe-purple)">${active}</span><span style="font-size:12px;color:var(--joe-gray);margin-left:4px">active</span></div>
              <div><span style="font-size:24px;font-weight:700;color:var(--joe-green)">${completed}</span><span style="font-size:12px;color:var(--joe-gray);margin-left:4px">completed</span></div>
              ${paused?`<div><span style="font-size:24px;font-weight:700;color:var(--joe-accent)">${paused}</span><span style="font-size:12px;color:var(--joe-gray);margin-left:4px">paused</span></div>`:''}
            </div>
            <div class="sequence-steps" style="display:flex;flex-wrap:wrap;gap:8px">
              ${steps.sort((a,b)=>a.step_order-b.step_order).map(st=>`<div style="display:flex;align-items:center;gap:8px;background:var(--joe-light);padding:8px 12px;border-radius:8px">
                <span style="width:24px;height:24px;border-radius:50%;background:var(--joe-${st.step_type==='email'?'blue':st.step_type==='call'?'green':'purple'});color:#fff;display:flex;align-items:center;justify-content:center;font-size:12px">${st.step_order}</span>
                <span style="font-size:12px;font-weight:600">${st.step_type==='email'?'üìß':st.step_type==='call'?'üìû':'üí¨'} ${st.step_type}</span>
                <span style="font-size:11px;color:var(--joe-gray)">+${st.delay_days}d</span>
                ${st.subject?`<span style="font-size:11px;color:var(--joe-gray);max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">"${st.subject}"</span>`:''}
              </div>`).join('<span style="color:var(--joe-gray)">‚Üí</span>')}
            </div>
          </div>
        </div>`;
      }).join(''):'<div class="empty-state">No sequences yet. Create one to automate your outreach!</div>';}

    function copyMergeField(field){navigator.clipboard.writeText(field);showToast('Copied '+field);}
    
    function previewSequence(){
      const sampleContact={first_name:'John',last_name:'Smith',email:'john@coffeeshop.com',phone:'(555) 123-4567'};
      const sampleCompany='The Coffee House';
      const preview=seqSteps.map(s=>{
        let subject=(s.subject||'').replace(/\{\{first_name\}\}/g,sampleContact.first_name).replace(/\{\{last_name\}\}/g,sampleContact.last_name).replace(/\{\{email\}\}/g,sampleContact.email).replace(/\{\{phone\}\}/g,sampleContact.phone).replace(/\{\{company\}\}/g,sampleCompany);
        let body=(s.body||'').replace(/\{\{first_name\}\}/g,sampleContact.first_name).replace(/\{\{last_name\}\}/g,sampleContact.last_name).replace(/\{\{email\}\}/g,sampleContact.email).replace(/\{\{phone\}\}/g,sampleContact.phone).replace(/\{\{company\}\}/g,sampleCompany);
        return`<div style="background:var(--joe-light);padding:16px;border-radius:8px;margin-bottom:12px">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
            <span style="font-weight:600">Step ${s.step_order}</span>
            <span class="badge badge-${s.step_type==='email'?'blue':s.step_type==='call'?'green':'purple'}">${s.step_type}</span>
            <span style="font-size:12px;color:var(--joe-gray)">Day ${s.delay_days}</span>
          </div>
          ${subject?`<div style="font-weight:600;margin-bottom:8px">${subject}</div>`:''}
          ${body?`<div style="white-space:pre-wrap;font-size:14px;line-height:1.5">${body}</div>`:'<div style="color:var(--joe-gray);font-style:italic">No template body</div>'}
        </div>`;
      }).join('');
      document.getElementById('sequence-preview-content').innerHTML=`
        <div style="background:#e0f2fe;padding:12px;border-radius:8px;margin-bottom:16px;font-size:13px">
          <strong>Sample Contact:</strong> ${sampleContact.first_name} ${sampleContact.last_name} (${sampleContact.email}) at ${sampleCompany}
        </div>
        ${preview||'<div class="empty-state">Add steps to preview</div>'}
      `;
      document.getElementById('sequence-preview-modal').classList.add('open');
    }
    
    let currentViewSequenceId=null;
    function viewEnrollments(seqId){
      currentViewSequenceId=seqId;
      const seq=sequences.find(s=>s.id===seqId);
      document.getElementById('enrollments-modal-title').textContent='Enrolled in: '+seq.name;
      const seqEnrollments=enrollments.filter(e=>e.sequence_id===seqId);
      document.getElementById('enrollments-table').innerHTML=seqEnrollments.length?seqEnrollments.map(e=>{
        const contact=contacts.find(c=>c.id===e.contact_id);
        const steps=seq.sequence_steps?.length||0;
        return`<tr>
          <td>${contact?contact.first_name+' '+contact.last_name:'Unknown'}<br><span style="font-size:11px;color:var(--joe-gray)">${contact?.email||''}</span></td>
          <td>Step ${e.current_step} of ${steps}</td>
          <td><span class="badge badge-${e.status==='active'?'purple':e.status==='completed'?'green':'gray'}">${e.status}</span></td>
          <td style="font-size:12px">${formatDate(e.created_at)}</td>
          <td class="actions-cell">
            ${e.status==='active'?`<button class="btn btn-small btn-secondary" onclick="pauseEnrollment('${e.id}')">‚è∏Ô∏è Pause</button>`:''}
            ${e.status==='paused'?`<button class="btn btn-small btn-secondary" onclick="resumeEnrollment('${e.id}')">‚ñ∂Ô∏è Resume</button>`:''}
            <button class="btn btn-small btn-secondary" onclick="unenrollContact('${e.id}')" style="color:var(--joe-red)">Remove</button>
          </td>
        </tr>`;
      }).join(''):'<tr><td colspan="5" class="empty-state">No contacts enrolled</td></tr>';
      document.getElementById('sequence-enrollments-modal').classList.add('open');
    }
    
    let bulkEnrollSelected=[];
    function bulkEnrollModal(){
      bulkEnrollSelected=[];
      const seqEnrollments=enrollments.filter(e=>e.sequence_id===currentViewSequenceId).map(e=>e.contact_id);
      const available=contacts.filter(c=>!seqEnrollments.includes(c.id));
      document.getElementById('bulk-enroll-contacts').innerHTML=available.length?available.map(c=>`
        <label style="display:flex;align-items:center;gap:8px;padding:8px;cursor:pointer;border-radius:4px" onmouseover="this.style.background='var(--joe-light)'" onmouseout="this.style.background='transparent'">
          <input type="checkbox" value="${c.id}" onchange="toggleBulkEnroll('${c.id}',this.checked)">
          <span>${c.first_name} ${c.last_name}</span>
          <span style="font-size:11px;color:var(--joe-gray)">${c.email||''}</span>
        </label>
      `).join(''):'<div class="empty-state">All contacts are already enrolled</div>';
      document.getElementById('bulk-enroll-count').textContent='0';
      document.getElementById('bulk-enroll-modal').classList.add('open');
    }
    
    function toggleBulkEnroll(contactId,checked){
      if(checked){bulkEnrollSelected.push(contactId);}
      else{bulkEnrollSelected=bulkEnrollSelected.filter(id=>id!==contactId);}
      document.getElementById('bulk-enroll-count').textContent=bulkEnrollSelected.length;
    }
    
    async function bulkEnrollContacts(){
      if(!bulkEnrollSelected.length){showToast('Select contacts first','error');return;}
      const seq=sequences.find(s=>s.id===currentViewSequenceId);
      for(const contactId of bulkEnrollSelected){
        const{data:enrollment}=await db.from('sequence_enrollments').insert([{
          sequence_id:currentViewSequenceId,
          contact_id:contactId,
          current_step:1,
          status:'active',
          enrolled_by:currentUser.email
        }]).select().single();
        if(enrollment){
          enrollments.push(enrollment);
          await createNextTask(enrollment,seq);
        }
      }
      document.getElementById('bulk-enroll-modal').classList.remove('open');
      viewEnrollments(currentViewSequenceId);
      showToast(bulkEnrollSelected.length+' contacts enrolled!');
    }
    
    async function pauseEnrollment(enrollmentId){
      await db.from('sequence_enrollments').update({status:'paused'}).eq('id',enrollmentId);
      const e=enrollments.find(x=>x.id===enrollmentId);
      if(e)e.status='paused';
      viewEnrollments(currentViewSequenceId);
      showToast('Enrollment paused');
    }
    
    async function resumeEnrollment(enrollmentId){
      await db.from('sequence_enrollments').update({status:'active'}).eq('id',enrollmentId);
      const e=enrollments.find(x=>x.id===enrollmentId);
      if(e)e.status='active';
      viewEnrollments(currentViewSequenceId);
      showToast('Enrollment resumed');
    }
    
    async function unenrollContact(enrollmentId){
      if(!confirm('Remove this contact from the sequence?'))return;
      await db.from('sequence_enrollments').delete().eq('id',enrollmentId);
      enrollments=enrollments.filter(e=>e.id!==enrollmentId);
      viewEnrollments(currentViewSequenceId);
      showToast('Contact removed from sequence');
    }
    
    async function deleteSequence(seqId){
      if(!confirm('Delete this sequence? Enrolled contacts will be unenrolled.'))return;
      await db.from('sequence_enrollments').delete().eq('sequence_id',seqId);
      await db.from('sequence_steps').delete().eq('sequence_id',seqId);
      await db.from('sequences').delete().eq('id',seqId);
      sequences=sequences.filter(s=>s.id!==seqId);
      enrollments=enrollments.filter(e=>e.sequence_id!==seqId);
      renderSequences();
      showToast('Sequence deleted');
    }
    function openSequenceModal(){currentSequenceId=null;seqSteps=[{step_order:1,step_type:'email',delay_days:0,subject:'',body:''}];document.getElementById('sequence-name').value='';document.getElementById('sequence-desc').value='';document.getElementById('sequence-default').checked=false;document.getElementById('sequence-modal-title').textContent='Create Sequence';renderStepsEditor();document.getElementById('sequence-modal').classList.add('open');}
    function editSequence(id){const s=sequences.find(x=>x.id===id);if(!s)return;currentSequenceId=id;seqSteps=(s.sequence_steps||[]).map(x=>({...x}));if(!seqSteps.length)seqSteps=[{step_order:1,step_type:'email',delay_days:0,subject:'',body:''}];document.getElementById('sequence-name').value=s.name;document.getElementById('sequence-desc').value=s.description||'';document.getElementById('sequence-default').checked=s.is_default||false;document.getElementById('sequence-modal-title').textContent='Edit Sequence';renderStepsEditor();document.getElementById('sequence-modal').classList.add('open');}
    function closeSequenceModal(){document.getElementById('sequence-modal').classList.remove('open');}
    function renderStepsEditor(){document.getElementById('sequence-steps-editor').innerHTML=seqSteps.map((s,i)=>`<div style="background:var(--joe-light);padding:12px;border-radius:8px;margin-bottom:8px"><div style="display:flex;gap:12px;align-items:center;margin-bottom:8px"><strong>Step ${s.step_order}</strong><select onchange="seqSteps[${i}].step_type=this.value" style="padding:4px 8px;border-radius:4px;border:1px solid #e5e7eb"><option value="email"${s.step_type==='email'?' selected':''}>üìß Email</option><option value="call"${s.step_type==='call'?' selected':''}>üìû Call</option><option value="sms"${s.step_type==='sms'?' selected':''}>üí¨ SMS</option></select><span style="font-size:12px">Wait</span><input type="number" value="${s.delay_days}" min="0" onchange="seqSteps[${i}].delay_days=parseInt(this.value)" style="width:60px;padding:4px 8px;border-radius:4px;border:1px solid #e5e7eb"> days<button onclick="seqSteps.splice(${i},1);seqSteps.forEach((x,j)=>x.step_order=j+1);renderStepsEditor()" style="margin-left:auto;background:none;border:none;cursor:pointer">üóëÔ∏è</button></div><input type="text" value="${(s.subject||'').replace(/"/g,'&quot;')}" onchange="seqSteps[${i}].subject=this.value" placeholder="Subject/Title" style="width:100%;padding:8px;border-radius:4px;border:1px solid #e5e7eb;margin-bottom:8px"><textarea onchange="seqSteps[${i}].body=this.value" placeholder="Body/Script" style="width:100%;padding:8px;border-radius:4px;border:1px solid #e5e7eb;min-height:60px">${s.body||''}</textarea></div>`).join('');}
    function addStep(){seqSteps.push({step_order:seqSteps.length+1,step_type:'email',delay_days:3,subject:'',body:''});renderStepsEditor();}
    async function saveSequence(){const name=document.getElementById('sequence-name').value;const desc=document.getElementById('sequence-desc').value;const isDefault=document.getElementById('sequence-default').checked;if(!name){showToast('Name required','error');return;}if(isDefault){await db.from('sequences').update({is_default:false}).neq('id',currentSequenceId||'');sequences.forEach(s=>s.is_default=false);}let id=currentSequenceId;if(id){await db.from('sequences').update({name,description:desc,is_default:isDefault}).eq('id',id);await db.from('sequence_steps').delete().eq('sequence_id',id);const s=sequences.find(x=>x.id===id);if(s){s.name=name;s.description=desc;s.is_default=isDefault;}}else{const{data:n}=await db.from('sequences').insert([{name,description:desc,created_by:currentUser?.email,is_default:isDefault,is_active:true}]).select().single();if(n){id=n.id;n.sequence_steps=[];sequences.unshift(n);}}for(const st of seqSteps){await db.from('sequence_steps').insert([{sequence_id:id,step_order:st.step_order,step_type:st.step_type,delay_days:st.delay_days,subject:st.subject,body:st.body}]);}const seq=sequences.find(s=>s.id===id);if(seq)seq.sequence_steps=seqSteps.map(s=>({...s,sequence_id:id}));closeSequenceModal();renderSequences();populateDropdowns();showToast('Saved!');}

    // Tasks
    function renderTasks(){const filter=document.getElementById('task-filter').value;const owner=document.getElementById('task-owner-filter').value;const today=new Date().toISOString().split('T')[0];let f=tasks;if(owner==='mine')f=f.filter(t=>t.assigned_to===currentUser?.email);if(filter==='pending')f=f.filter(t=>t.status!=='completed');else if(filter==='today')f=f.filter(t=>t.status!=='completed'&&t.due_date?.startsWith(today));else if(filter==='overdue')f=f.filter(t=>t.status!=='completed'&&t.due_date&&t.due_date.split('T')[0]<today);document.getElementById('tasks-list').innerHTML=f.length?f.map(t=>{const ct=contacts.find(c=>c.id===t.contact_id);const dd=t.due_date?.split('T')[0]||'';let dueClass='upcoming';if(dd&&dd<today)dueClass='overdue';else if(dd===today)dueClass='today';const done=t.status==='completed';return`<div class="task-item${t.sequence_enrollment_id?' sequence-task':''}"><div class="task-checkbox${done?' done':''}" onclick="completeTask('${t.id}')">${done?'‚úì':''}</div><div class="task-info"><div class="task-title">${t.title}</div><div class="task-meta">${ct?ct.first_name+' '+ct.last_name:''}${t.sequence_enrollment_id?' ‚Ä¢ Sequence':''}</div></div>${dd?`<span class="task-due ${dueClass}">${dd}</span>`:''}</div>`;}).join(''):'<div class="empty-state">No tasks</div>';}
    async function completeTask(id){const task=tasks.find(t=>t.id===id);if(!task)return;await db.from('tasks').update({status:'completed',completed_at:new Date().toISOString()}).eq('id',id);task.status='completed';if(task.sequence_enrollment_id){const enrollment=enrollments.find(e=>e.id===task.sequence_enrollment_id);if(enrollment&&enrollment.status==='active'){const seq=sequences.find(s=>s.id===enrollment.sequence_id);const nextStep=enrollment.current_step+1;if(nextStep<=(seq?.sequence_steps?.length||0)){await db.from('sequence_enrollments').update({current_step:nextStep}).eq('id',enrollment.id);enrollment.current_step=nextStep;await createNextTask(enrollment,seq);showToast('Next step scheduled!');}else{await db.from('sequence_enrollments').update({status:'completed'}).eq('id',enrollment.id);enrollment.status='completed';showToast('Sequence completed! üéâ');}}}renderTasks();renderDashboard();}
    function openTaskModal(){['task-title','task-contact-search'].forEach(x=>document.getElementById(x).value='');document.getElementById('task-contact').value='';document.getElementById('task-type').value='todo';document.getElementById('task-due').value='';document.getElementById('task-modal').classList.add('open');}
    function closeTaskModal(){document.getElementById('task-modal').classList.remove('open');}
    async function saveTask(){const{data:n}=await db.from('tasks').insert([{title:document.getElementById('task-title').value,task_type:document.getElementById('task-type').value,due_date:document.getElementById('task-due').value||null,contact_id:document.getElementById('task-contact').value||null,assigned_to:currentUser?.email,status:'not_started'}]).select().single();if(n)tasks.push(n);closeTaskModal();renderTasks();renderDashboard();showToast('Created!');}

    // Integrations
    // Google Integration
    let googleToken=null,googleUser=null,tokenClient=null;
    const GOOGLE_CLIENT_ID='801713754084-ul118isfsm86tohjbibe9gi39eu19agb.apps.googleusercontent.com';
    const GOOGLE_SCOPES='https://www.googleapis.com/auth/gmail.readonly https://www.googleapis.com/auth/gmail.send https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/drive.readonly';
    
    function initGoogleIntegration(){
      const savedToken=localStorage.getItem('google_token');
      const savedUser=localStorage.getItem('google_user');
      if(savedToken&&savedUser){
        googleToken=savedToken;
        googleUser=JSON.parse(savedUser);
        showGoogleConnected();
      }
    }
    
    function connectGoogle(){
      tokenClient=google.accounts.oauth2.initTokenClient({
        client_id:GOOGLE_CLIENT_ID,
        scope:GOOGLE_SCOPES,
        callback:(response)=>{
          if(response.access_token){
            googleToken=response.access_token;
            localStorage.setItem('google_token',googleToken);
            fetchGoogleUserInfo();
          }
        }
      });
      tokenClient.requestAccessToken();
    }
    
    async function fetchGoogleUserInfo(){
      try{
        const res=await fetch('https://www.googleapis.com/oauth2/v2/userinfo',{headers:{Authorization:'Bearer '+googleToken}});
        const user=await res.json();
        googleUser={email:user.email,name:user.name,picture:user.picture};
        localStorage.setItem('google_user',JSON.stringify(googleUser));
        showGoogleConnected();
        addSyncLog('‚úÖ Connected to Google as '+user.email);
      }catch(e){
        showToast('Failed to get user info','error');
        disconnectGoogle();
      }
    }
    
    function showGoogleConnected(){
      document.getElementById('google-not-connected').style.display='none';
      document.getElementById('google-connected').style.display='block';
      document.getElementById('google-status-badge').textContent='Connected';
      document.getElementById('google-status-badge').classList.add('badge-green');
      document.getElementById('google-email').textContent=googleUser?.email||'Connected';
      if(googleUser?.picture){
        document.getElementById('google-avatar').innerHTML='<img src="'+googleUser.picture+'" style="width:100%;height:100%;border-radius:50%">';
      }
    }
    
    function disconnectGoogle(){
      googleToken=null;googleUser=null;
      localStorage.removeItem('google_token');
      localStorage.removeItem('google_user');
      document.getElementById('google-not-connected').style.display='block';
      document.getElementById('google-connected').style.display='none';
      document.getElementById('google-status-badge').textContent='Not Connected';
      document.getElementById('google-status-badge').classList.remove('badge-green');
      addSyncLog('üîå Disconnected from Google');
    }
    
    async function syncGmail(){
      if(!googleToken){showToast('Connect Google first','error');return;}
      document.getElementById('gmail-sync-status').textContent='Syncing...';
      addSyncLog('üìß Starting Gmail sync...');
      try{
        // Get contact emails to filter relevant messages
        const contactEmails=contacts.map(c=>c.email).filter(Boolean);
        const query=contactEmails.length?'from:('+contactEmails.slice(0,10).join(' OR ')+') OR to:('+contactEmails.slice(0,10).join(' OR ')+')':'';
        const res=await fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages?maxResults=50'+(query?'&q='+encodeURIComponent(query):''),{headers:{Authorization:'Bearer '+googleToken}});
        const data=await res.json();
        if(!data.messages){document.getElementById('gmail-sync-status').textContent='No emails found';addSyncLog('üìß No matching emails found');return;}
        
        let synced=0;
        for(const msg of data.messages.slice(0,20)){
          const detail=await fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages/'+msg.id+'?format=metadata&metadataHeaders=From&metadataHeaders=To&metadataHeaders=Subject&metadataHeaders=Date',{headers:{Authorization:'Bearer '+googleToken}});
          const email=await detail.json();
          const headers={};
          email.payload.headers.forEach(h=>headers[h.name.toLowerCase()]=h.value);
          
          // Find matching contact
          const fromEmail=(headers.from||'').match(/<(.+?)>/)?.[1]||(headers.from||'').trim();
          const toEmail=(headers.to||'').match(/<(.+?)>/)?.[1]||(headers.to||'').trim();
          const contact=contacts.find(c=>c.email===fromEmail||c.email===toEmail);
          
          if(contact){
            // Check if already logged
            const existing=activities.find(a=>a.external_id==='gmail_'+msg.id);
            if(!existing){
              const{data:activity}=await db.from('activities').insert([{
                contact_id:contact.id,
                activity_type:'email',
                notes:'Subject: '+(headers.subject||'(no subject)')+'\nFrom: '+headers.from,
                team_member_email:currentUser.email,
                team_member_name:currentUser.name,
                external_id:'gmail_'+msg.id,
                external_source:'gmail'
              }]).select().single();
              if(activity){activities.unshift(activity);synced++;}
            }
          }
        }
        document.getElementById('gmail-sync-status').textContent='Last sync: '+new Date().toLocaleTimeString();
        addSyncLog('üìß Gmail sync complete: '+synced+' new emails logged');
        showToast(synced+' emails synced!');
      }catch(e){
        console.error(e);
        document.getElementById('gmail-sync-status').textContent='Sync failed';
        addSyncLog('‚ùå Gmail sync failed: '+e.message);
        if(e.message.includes('401'))disconnectGoogle();
      }
    }
    
    async function syncCalendar(){
      if(!googleToken){showToast('Connect Google first','error');return;}
      document.getElementById('calendar-sync-status').textContent='Syncing...';
      addSyncLog('üìÖ Starting Calendar sync...');
      try{
        const now=new Date().toISOString();
        const nextWeek=new Date(Date.now()+7*24*60*60*1000).toISOString();
        const res=await fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events?timeMin='+encodeURIComponent(now)+'&timeMax='+encodeURIComponent(nextWeek)+'&maxResults=50&singleEvents=true&orderBy=startTime',{headers:{Authorization:'Bearer '+googleToken}});
        const data=await res.json();
        if(!data.items){document.getElementById('calendar-sync-status').textContent='No events found';return;}
        
        let synced=0;
        for(const event of data.items){
          // Check if event has attendees matching contacts
          const attendeeEmails=(event.attendees||[]).map(a=>a.email);
          const matchingContact=contacts.find(c=>attendeeEmails.includes(c.email));
          
          if(matchingContact){
            // Create task for this meeting if not exists
            const existing=tasks.find(t=>t.external_id==='gcal_'+event.id);
            if(!existing){
              const startTime=event.start?.dateTime||event.start?.date;
              const{data:task}=await db.from('tasks').insert([{
                title:'üìÖ '+event.summary,
                task_type:'call',
                due_date:startTime,
                contact_id:matchingContact.id,
                assigned_to:currentUser.email,
                status:'not_started',
                external_id:'gcal_'+event.id,
                notes:'Google Calendar event\nMeet link: '+(event.hangoutLink||'N/A')
              }]).select().single();
              if(task){tasks.push(task);synced++;}
            }
          }
        }
        document.getElementById('calendar-sync-status').textContent='Last sync: '+new Date().toLocaleTimeString();
        addSyncLog('üìÖ Calendar sync complete: '+synced+' meetings imported');
        showToast(synced+' calendar events synced!');
        renderTasks();
      }catch(e){
        console.error(e);
        document.getElementById('calendar-sync-status').textContent='Sync failed';
        addSyncLog('‚ùå Calendar sync failed: '+e.message);
      }
    }
    
    async function syncMeetTranscripts(){
      if(!googleToken){showToast('Connect Google first','error');return;}
      document.getElementById('meet-sync-status').textContent='Searching...';
      addSyncLog('üé• Searching for Meet transcripts...');
      try{
        // Search Drive for Meet transcripts
        const res=await fetch("https://www.googleapis.com/drive/v3/files?q=name contains 'Transcript' and mimeType='application/vnd.google-apps.document'&fields=files(id,name,createdTime,webViewLink)",{headers:{Authorization:'Bearer '+googleToken}});
        const data=await res.json();
        if(!data.files||!data.files.length){
          document.getElementById('meet-sync-status').textContent='No transcripts found';
          addSyncLog('üé• No Meet transcripts found in Drive');
          return;
        }
        
        addSyncLog('üé• Found '+data.files.length+' transcripts');
        
        for(const file of data.files.slice(0,5)){
          // Export as plain text
          const textRes=await fetch('https://www.googleapis.com/drive/v3/files/'+file.id+'/export?mimeType=text/plain',{headers:{Authorization:'Bearer '+googleToken}});
          const transcript=await textRes.text();
          
          // Analyze with AI if we have API key
          const apiKey=localStorage.getItem('anthropic_api_key');
          if(apiKey&&transcript.length>100){
            addSyncLog('ü§ñ Analyzing transcript: '+file.name);
            await analyzeMeetingTranscript(file,transcript,apiKey);
          }
        }
        
        document.getElementById('meet-sync-status').textContent='Last sync: '+new Date().toLocaleTimeString();
        showToast('Transcripts processed!');
      }catch(e){
        console.error(e);
        document.getElementById('meet-sync-status').textContent='Sync failed';
        addSyncLog('‚ùå Meet sync failed: '+e.message);
      }
    }
    
    async function analyzeMeetingTranscript(file,transcript,apiKey){
      try{
        const prompt=`Analyze this meeting transcript and provide a structured analysis in the following format:

**SENTIMENT**: [Positive/Neutral/Negative] - [one sentence explanation]

**KEY POINTS**:
- [point 1]
- [point 2]
- [point 3]

**CUSTOMER QUOTES**:
- "[quote 1]"
- "[quote 2]"

**ACTION ITEMS** (extract ALL follow-ups mentioned, format each as):
- [ACTION]: [description] | OWNER: [who should do it, or "us" if internal] | DUE: [timeframe mentioned, or "soon"]

**CONCERNS**:
- [any objections or concerns raised]

**NEXT MEETING**: [if discussed, when/what]

Be thorough with action items - include anything that was promised, requested, or needs follow-up.

TRANSCRIPT:
${transcript.substring(0,10000)}`;

        const res=await fetch('https://api.anthropic.com/v1/messages',{
          method:'POST',
          headers:{'Content-Type':'application/json','x-api-key':apiKey,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
          body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:2000,messages:[{role:'user',content:prompt}]})
        });
        const data=await res.json();
        const analysis=data.content?.[0]?.text||'Analysis failed';
        
        // Extract sentiment
        const sentimentMatch=analysis.match(/\*\*SENTIMENT\*\*:\s*\[?(Positive|Neutral|Negative)\]?/i);
        const sentiment=sentimentMatch?sentimentMatch[1].toLowerCase():'neutral';
        
        // Try to match with a contact based on transcript content
        let matchedContactId=null;
        let matchedContact=null;
        for(const contact of contacts){
          const firstName=contact.first_name?.toLowerCase()||'';
          const emailName=contact.email?.split('@')[0]?.toLowerCase()||'';
          if(firstName.length>2&&transcript.toLowerCase().includes(firstName)){
            matchedContactId=contact.id;
            matchedContact=contact;
            break;
          }
          if(emailName.length>2&&transcript.toLowerCase().includes(emailName)){
            matchedContactId=contact.id;
            matchedContact=contact;
            break;
          }
        }
        
        // Find associated deal
        let matchedDealId=null;
        if(matchedContactId){
          const deal=deals.find(d=>d.contact_id===matchedContactId&&!['closed_won','closed_lost'].includes(d.stage));
          if(deal)matchedDealId=deal.id;
        }
        
        // Save as meeting note
        const{data:note}=await db.from('meeting_notes').insert([{
          title:file.name,
          transcript:transcript.substring(0,50000),
          analysis:analysis,
          source_url:file.webViewLink,
          created_by:currentUser.email,
          meeting_date:file.createdTime,
          contact_id:matchedContactId,
          deal_id:matchedDealId,
          sentiment:sentiment
        }]).select().single();
        
        if(note)meetingNotes.unshift(note);
        addSyncLog('‚úÖ Analyzed: '+file.name+' ('+sentiment+')');
        
        // Extract and create action items as tasks
        const actionMatch=analysis.match(/\*\*ACTION ITEMS\*\*:?([\s\S]*?)(?=\*\*CONCERNS|\*\*NEXT|$)/i);
        if(actionMatch){
          const actionText=actionMatch[1];
          const actionLines=actionText.split('\n').filter(l=>l.trim().startsWith('-'));
          let tasksCreated=0;
          
          for(const line of actionLines.slice(0,5)){  // Max 5 tasks per meeting
            const cleanLine=line.replace(/^-\s*/,'').trim();
            if(cleanLine.length<5)continue;
            
            // Parse due date hint
            let dueDate=new Date();
            dueDate.setDate(dueDate.getDate()+3); // Default 3 days
            if(cleanLine.toLowerCase().includes('tomorrow')){dueDate.setDate(dueDate.getDate()-2);}
            else if(cleanLine.toLowerCase().includes('today')){dueDate=new Date();}
            else if(cleanLine.toLowerCase().includes('week')){dueDate.setDate(dueDate.getDate()+4);}
            else if(cleanLine.toLowerCase().includes('month')){dueDate.setDate(dueDate.getDate()+27);}
            
            // Create task
            const{data:task}=await db.from('tasks').insert([{
              title:'üìπ '+cleanLine.substring(0,100),
              task_type:'todo',
              due_date:dueDate.toISOString(),
              contact_id:matchedContactId,
              assigned_to:currentUser.email,
              status:'not_started',
              notes:'From meeting: '+file.name+'\n\nFull item: '+cleanLine
            }]).select().single();
            if(task){tasks.push(task);tasksCreated++;}
          }
          if(tasksCreated>0)addSyncLog('üìã Created '+tasksCreated+' follow-up tasks');
        }
        
        // Log activity to contact if matched
        if(matchedContactId){
          await db.from('activities').insert([{
            contact_id:matchedContactId,
            activity_type:'note',
            notes:'üìπ Meeting: '+file.name+'\n\nüéØ Sentiment: '+sentiment.toUpperCase()+'\n\n'+analysis.substring(0,800),
            team_member_email:currentUser.email,
            team_member_name:currentUser.name,
            external_id:'meet_'+file.id
          }]);
          addSyncLog('üîó Linked to contact: '+matchedContact.first_name+' '+matchedContact.last_name);
        }
        
        // Update deal with meeting info if linked
        if(matchedDealId){
          const deal=deals.find(d=>d.id===matchedDealId);
          const existingNotes=deal?.notes||'';
          const meetingSummary='\n\nüìπ Meeting ('+new Date(file.createdTime).toLocaleDateString()+'): '+sentiment.toUpperCase()+' sentiment';
          await db.from('deals').update({notes:existingNotes+meetingSummary,last_meeting_sentiment:sentiment}).eq('id',matchedDealId);
          addSyncLog('üí∞ Updated deal with meeting sentiment');
        }
        
      }catch(e){
        addSyncLog('‚ùå Analysis failed: '+e.message);
        console.error(e);
      }
    }
    
    function viewGmailSettings(){showToast('Gmail settings: Syncs emails matching your contacts');}
    function viewCalendarSettings(){showToast('Calendar settings: Imports meetings with contacts as tasks');}
    function viewMeetSettings(){showToast('Meet settings: Analyzes transcripts from Google Drive with AI');}
    
    function addSyncLog(message){
      const log=document.getElementById('sync-log');
      const time=new Date().toLocaleTimeString();
      const entry=document.createElement('div');
      entry.style.cssText='padding:8px 0;border-bottom:1px solid var(--joe-light);font-size:13px';
      entry.innerHTML='<span style="color:var(--joe-gray);margin-right:8px">'+time+'</span>'+message;
      if(log.querySelector('.empty-state'))log.innerHTML='';
      log.insertBefore(entry,log.firstChild);
    }
    function clearSyncLog(){document.getElementById('sync-log').innerHTML='<div class="empty-state">No sync activity yet</div>';}
    
    async function testTwilioConnection(){
      const sid=localStorage.getItem('twilio_sid');
      const token=localStorage.getItem('twilio_token');
      if(!sid||!token){showToast('Add Twilio credentials first','error');return;}
      document.getElementById('twilio-status-text').textContent='Testing...';
      // Note: Direct Twilio API calls from browser are blocked by CORS
      // This would need a backend proxy in production
      showToast('Twilio credentials saved. SMS requires backend integration.');
      document.getElementById('twilio-status-dot').classList.add('connected');
      document.getElementById('twilio-status-text').textContent='Credentials saved';
    }

    function loadApiKeys(){
      document.getElementById('api-anthropic').value=localStorage.getItem('anthropic_api_key')||'';
      document.getElementById('api-twilio-sid').value=localStorage.getItem('twilio_sid')||'';
      document.getElementById('api-twilio-token').value=localStorage.getItem('twilio_token')||'';
      document.getElementById('api-twilio-phone').value=localStorage.getItem('twilio_phone')||'';
      initGoogleIntegration();
    }
    function saveApiKeys(){
      localStorage.setItem('anthropic_api_key',document.getElementById('api-anthropic').value);
      localStorage.setItem('twilio_sid',document.getElementById('api-twilio-sid').value);
      localStorage.setItem('twilio_token',document.getElementById('api-twilio-token').value);
      localStorage.setItem('twilio_phone',document.getElementById('api-twilio-phone').value);
      showToast('API keys saved!');
    }

    // Email Templates & Composer
    let currentTemplateId=null,composeContactId=null;
    
    function loadSignature(){
      const sig=JSON.parse(localStorage.getItem('email_signature')||'{}');
      document.getElementById('sig-name').value=sig.name||currentUser?.name||'';
      document.getElementById('sig-title').value=sig.title||'';
      document.getElementById('sig-email').value=sig.email||currentUser?.email||'';
      document.getElementById('sig-phone').value=sig.phone||'';
      document.getElementById('sig-calendar').value=sig.calendar||'';
      document.getElementById('sig-company').value=sig.company||'joe';
      if(sig.photo){
        document.getElementById('sig-photo-preview').innerHTML=`<img src="${sig.photo}" style="width:100%;height:100%;object-fit:cover">`;
      }
    }
    
    function saveSignature(){
      const sig={
        name:document.getElementById('sig-name').value,
        title:document.getElementById('sig-title').value,
        email:document.getElementById('sig-email').value,
        phone:document.getElementById('sig-phone').value,
        calendar:document.getElementById('sig-calendar').value,
        company:document.getElementById('sig-company').value,
        photo:localStorage.getItem('sig_photo_data')||''
      };
      localStorage.setItem('email_signature',JSON.stringify(sig));
      showToast('Signature saved!');
    }
    
    function handleSignaturePhoto(input){
      if(input.files&&input.files[0]){
        const file=input.files[0];
        if(file.size>5*1024*1024){showToast('Image too large (max 5MB)','error');return;}
        
        // Compress image
        const reader=new FileReader();
        reader.onload=function(e){
          const img=new Image();
          img.onload=function(){
            const canvas=document.createElement('canvas');
            const maxSize=200;
            let w=img.width,h=img.height;
            if(w>h){h=h*(maxSize/w);w=maxSize;}
            else{w=w*(maxSize/h);h=maxSize;}
            canvas.width=w;canvas.height=h;
            const ctx=canvas.getContext('2d');
            ctx.drawImage(img,0,0,w,h);
            const compressed=canvas.toDataURL('image/jpeg',0.8);
            localStorage.setItem('sig_photo_data',compressed);
            document.getElementById('sig-photo-preview').innerHTML=`<img src="${compressed}" style="width:100%;height:100%;object-fit:cover">`;
            showToast('Photo uploaded!');
          };
          img.src=e.target.result;
        };
        reader.readAsDataURL(file);
      }
    }
    
    function useGooglePhoto(){
      if(googleUser?.picture){
        localStorage.setItem('sig_photo_data',googleUser.picture);
        document.getElementById('sig-photo-preview').innerHTML=`<img src="${googleUser.picture}" style="width:100%;height:100%;object-fit:cover">`;
        showToast('Using Google profile photo');
      }else{
        showToast('Connect Google account first','error');
      }
    }
    
    function generateSignatureHTML(){
      const sig=JSON.parse(localStorage.getItem('email_signature')||'{}');
      if(!sig.name)return'<p style="color:#6b7280">Set up your signature in Email Templates</p>';
      return`<table cellpadding="0" cellspacing="0" style="font-family:Arial,sans-serif;font-size:14px;color:#1a1a1a">
        <tr>
          ${sig.photo?`<td style="padding-right:15px;vertical-align:top"><img src="${sig.photo}" width="80" height="80" style="border-radius:50%"></td>`:''}
          <td style="vertical-align:top">
            <p style="margin:0 0 4px;font-weight:bold;font-size:16px">${sig.name}</p>
            ${sig.title?`<p style="margin:0 0 4px;color:#6b7280">${sig.title}</p>`:''}
            ${sig.company?`<p style="margin:0 0 8px;font-weight:600;color:#f59e0b">${sig.company}</p>`:''}
            <p style="margin:0;font-size:13px">
              ${sig.email?`<a href="mailto:${sig.email}" style="color:#3b82f6;text-decoration:none">${sig.email}</a>`:''}
              ${sig.email&&sig.phone?' ‚Ä¢ ':''}
              ${sig.phone?`<a href="tel:${sig.phone}" style="color:#3b82f6;text-decoration:none">${sig.phone}</a>`:''}
            </p>
            ${sig.calendar?`<p style="margin:8px 0 0"><a href="${sig.calendar}" style="display:inline-block;background:#f59e0b;color:#1a1a1a;padding:6px 12px;border-radius:4px;text-decoration:none;font-size:12px;font-weight:bold">üìÖ Schedule a Call</a></p>`:''}
          </td>
        </tr>
      </table>`;
    }
    
    function previewSignature(){
      document.getElementById('signature-preview-content').innerHTML=generateSignatureHTML();
      document.getElementById('signature-preview-modal').classList.add('open');
    }
    
    function renderEmailTemplates(){
      loadSignature();
      document.getElementById('email-templates-list').innerHTML=emailTemplates.length?emailTemplates.map(t=>`
        <div style="display:flex;justify-content:space-between;align-items:center;padding:16px;border-bottom:1px solid var(--joe-light)">
          <div>
            <div style="font-weight:600">${t.name}</div>
            <div style="font-size:13px;color:var(--joe-gray)">${t.subject||'No subject'}</div>
            <span class="badge badge-gray" style="margin-top:4px">${t.category||'other'}</span>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-small btn-secondary" onclick="editEmailTemplate('${t.id}')">Edit</button>
            <button class="btn btn-small btn-secondary" onclick="deleteEmailTemplate('${t.id}')" style="color:var(--joe-red)">Delete</button>
          </div>
        </div>
      `).join(''):'<div class="empty-state">No templates yet. Create your first template!</div>';
    }
    
    function openEmailTemplateModal(){
      currentTemplateId=null;
      document.getElementById('email-template-modal-title').textContent='New Email Template';
      document.getElementById('template-name').value='';
      document.getElementById('template-category').value='outreach';
      document.getElementById('template-subject').value='';
      document.getElementById('template-body').value='';
      document.getElementById('email-template-modal').classList.add('open');
    }
    
    function editEmailTemplate(id){
      const t=emailTemplates.find(x=>x.id===id);
      if(!t)return;
      currentTemplateId=id;
      document.getElementById('email-template-modal-title').textContent='Edit Template';
      document.getElementById('template-name').value=t.name||'';
      document.getElementById('template-category').value=t.category||'outreach';
      document.getElementById('template-subject').value=t.subject||'';
      document.getElementById('template-body').value=t.body||'';
      document.getElementById('email-template-modal').classList.add('open');
    }
    
    function closeEmailTemplateModal(){document.getElementById('email-template-modal').classList.remove('open');}
    
    function insertMergeField(textareaId,field){
      const ta=document.getElementById(textareaId);
      const start=ta.selectionStart;
      const end=ta.selectionEnd;
      ta.value=ta.value.substring(0,start)+field+ta.value.substring(end);
      ta.focus();
      ta.selectionStart=ta.selectionEnd=start+field.length;
    }
    
    function previewEmailTemplate(){
      const subject=document.getElementById('template-subject').value;
      const body=document.getElementById('template-body').value;
      const sample={first_name:'John',last_name:'Smith',email:'john@coffeeshop.com',company:'The Coffee House'};
      const sig=generateSignatureHTML();
      const previewSubject=subject.replace(/\{\{first_name\}\}/g,sample.first_name).replace(/\{\{last_name\}\}/g,sample.last_name).replace(/\{\{company\}\}/g,sample.company);
      const previewBody=body.replace(/\{\{first_name\}\}/g,sample.first_name).replace(/\{\{last_name\}\}/g,sample.last_name).replace(/\{\{company\}\}/g,sample.company).replace(/\{\{email\}\}/g,sample.email).replace(/\{\{signature\}\}/g,'[SIGNATURE]');
      document.getElementById('signature-preview-content').innerHTML=`
        <div style="background:#f9fafb;padding:12px;border-radius:8px;margin-bottom:16px">
          <strong>Subject:</strong> ${previewSubject||'(no subject)'}
        </div>
        <div style="white-space:pre-wrap;line-height:1.6;margin-bottom:16px">${previewBody}</div>
        <div style="border-top:1px solid #e5e7eb;padding-top:16px">${sig}</div>
      `;
      document.getElementById('signature-preview-modal').classList.add('open');
    }
    
    async function saveEmailTemplate(){
      const name=document.getElementById('template-name').value.trim();
      const category=document.getElementById('template-category').value;
      const subject=document.getElementById('template-subject').value;
      const body=document.getElementById('template-body').value;
      if(!name){showToast('Name required','error');return;}
      
      if(currentTemplateId){
        await db.from('email_templates').update({name,category,subject,body}).eq('id',currentTemplateId);
        const t=emailTemplates.find(x=>x.id===currentTemplateId);
        if(t){t.name=name;t.category=category;t.subject=subject;t.body=body;}
      }else{
        const{data:newT}=await db.from('email_templates').insert([{name,category,subject,body,created_by:currentUser.email}]).select().single();
        if(newT)emailTemplates.push(newT);
      }
      closeEmailTemplateModal();renderEmailTemplates();showToast('Template saved!');
    }
    
    async function deleteEmailTemplate(id){
      if(!confirm('Delete this template?'))return;
      await db.from('email_templates').delete().eq('id',id);
      emailTemplates=emailTemplates.filter(t=>t.id!==id);
      renderEmailTemplates();showToast('Template deleted');
    }
    
    // Email Composer
    function openEmailComposer(contactId){
      composeContactId=contactId;
      const contact=contacts.find(c=>c.id===contactId);
      if(!contact||!contact.email){showToast('Contact has no email','error');return;}
      
      document.getElementById('compose-to').value=contact.email;
      document.getElementById('compose-subject').value='';
      document.getElementById('compose-body').value='';
      document.getElementById('compose-signature-preview').innerHTML=generateSignatureHTML();
      
      // Populate template dropdown
      document.getElementById('compose-template').innerHTML='<option value="">-- Select Template --</option>'+
        emailTemplates.map(t=>`<option value="${t.id}">${t.name}</option>`).join('');
      
      document.getElementById('email-composer-modal').classList.add('open');
    }
    
    function closeEmailComposer(){document.getElementById('email-composer-modal').classList.remove('open');}
    
    function applyEmailTemplate(){
      const templateId=document.getElementById('compose-template').value;
      if(!templateId)return;
      const t=emailTemplates.find(x=>x.id===templateId);
      if(!t)return;
      
      const contact=contacts.find(c=>c.id===composeContactId)||{};
      const company=companies.find(co=>co.id===contact.company_id);
      
      const applyMerge=(text)=>text
        .replace(/\{\{first_name\}\}/g,contact.first_name||'')
        .replace(/\{\{last_name\}\}/g,contact.last_name||'')
        .replace(/\{\{email\}\}/g,contact.email||'')
        .replace(/\{\{company\}\}/g,company?.name||'')
        .replace(/\{\{phone\}\}/g,contact.phone||'');
      
      document.getElementById('compose-subject').value=applyMerge(t.subject||'');
      
      // Replace signature placeholder with actual signature
      let body=applyMerge(t.body||'');
      const sigText=generateSignaturePlainText();
      body=body.replace(/\{\{signature\}\}/g,sigText);
      document.getElementById('compose-body').value=body;
    }
    
    function generateSignaturePlainText(){
      const sig=JSON.parse(localStorage.getItem('email_signature')||'{}');
      if(!sig.name)return'';
      let text='\n\n--\n';
      text+=sig.name+'\n';
      if(sig.title)text+=sig.title+'\n';
      if(sig.company)text+=sig.company+'\n';
      if(sig.email)text+=sig.email;
      if(sig.email&&sig.phone)text+=' ‚Ä¢ ';
      if(sig.phone)text+=sig.phone;
      text+='\n';
      if(sig.calendar)text+='Book a call: '+sig.calendar+'\n';
      return text;
    }
    
    async function sendEmail(){
      if(!googleToken){showToast('Connect Google first in Integrations','error');return;}
      
      const to=document.getElementById('compose-to').value;
      const subject=document.getElementById('compose-subject').value;
      let body=document.getElementById('compose-body').value;
      
      if(!to||!subject||!body){showToast('Fill in all fields','error');return;}
      
      // Add signature if not already in body
      if(!body.includes('--\n')){
        body+=generateSignaturePlainText();
      }
      
      // Create email in RFC 2822 format
      const email=[
        'Content-Type: text/plain; charset="UTF-8"',
        'MIME-Version: 1.0',
        `To: ${to}`,
        `Subject: ${subject}`,
        '',
        body
      ].join('\r\n');
      
      const encodedEmail=btoa(unescape(encodeURIComponent(email))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
      
      try{
        const res=await fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages/send',{
          method:'POST',
          headers:{Authorization:'Bearer '+googleToken,'Content-Type':'application/json'},
          body:JSON.stringify({raw:encodedEmail})
        });
        
        if(res.ok){
          // Log as activity
          await db.from('activities').insert([{
            contact_id:composeContactId,
            activity_type:'email',
            notes:'Subject: '+subject+'\n\n'+body.substring(0,500),
            team_member_email:currentUser.email,
            team_member_name:currentUser.name,
            external_source:'gmail_sent'
          }]);
          
          closeEmailComposer();
          showToast('Email sent! ‚úâÔ∏è');
        }else{
          const err=await res.json();
          showToast('Failed: '+(err.error?.message||'Unknown error'),'error');
        }
      }catch(e){
        showToast('Error: '+e.message,'error');
      }
    }

    // Meeting Notes
    function renderMeetings(){
      const search=(document.getElementById('meeting-search')?.value||'').toLowerCase();
      const sentimentFilter=document.getElementById('meeting-sentiment-filter')?.value||'all';
      const contactFilter=document.getElementById('meeting-contact-filter')?.value||'all';
      
      // Populate contact filter dropdown
      const contactOpts='<option value="all">All Contacts</option>'+contacts.map(c=>`<option value="${c.id}">${c.first_name} ${c.last_name}</option>`).join('');
      document.getElementById('meeting-contact-filter').innerHTML=contactOpts;
      
      // Analyze sentiment from each meeting's analysis
      const analyzedMeetings=meetingNotes.map(m=>{
        const analysis=(m.analysis||'').toLowerCase();
        let sentiment='neutral';
        if(analysis.includes('positive')||analysis.includes('interested')||analysis.includes('enthusiastic')||analysis.includes('excited'))sentiment='positive';
        else if(analysis.includes('negative')||analysis.includes('concern')||analysis.includes('objection')||analysis.includes('hesitant')||analysis.includes('frustrated'))sentiment='negative';
        return{...m,sentiment};
      });
      
      // Stats
      document.getElementById('meetings-total').textContent=meetingNotes.length;
      document.getElementById('meetings-positive').textContent=analyzedMeetings.filter(m=>m.sentiment==='positive').length;
      document.getElementById('meetings-neutral').textContent=analyzedMeetings.filter(m=>m.sentiment==='neutral').length;
      document.getElementById('meetings-negative').textContent=analyzedMeetings.filter(m=>m.sentiment==='negative').length;
      
      // Filter
      let filtered=analyzedMeetings;
      if(search){
        filtered=filtered.filter(m=>
          (m.title||'').toLowerCase().includes(search)||
          (m.transcript||'').toLowerCase().includes(search)||
          (m.analysis||'').toLowerCase().includes(search)
        );
      }
      if(sentimentFilter!=='all'){
        filtered=filtered.filter(m=>m.sentiment===sentimentFilter);
      }
      if(contactFilter!=='all'){
        filtered=filtered.filter(m=>m.contact_id===contactFilter);
      }
      
      document.getElementById('meetings-list').innerHTML=filtered.length?filtered.map(m=>{
        const contact=contacts.find(c=>c.id===m.contact_id);
        const sentimentColor=m.sentiment==='positive'?'green':m.sentiment==='negative'?'red':'gray';
        const sentimentIcon=m.sentiment==='positive'?'üòä':m.sentiment==='negative'?'üòü':'üòê';
        
        // Extract key sections from analysis
        const analysis=m.analysis||'';
        const keyPointsMatch=analysis.match(/key points?:?\s*([\s\S]*?)(?=customer quotes?|action items?|concerns?|$)/i);
        const quotesMatch=analysis.match(/customer quotes?:?\s*([\s\S]*?)(?=action items?|concerns?|$)/i);
        
        return`<div class="card" style="margin-bottom:16px">
          <div class="card-header">
            <div>
              <h2 style="font-size:16px">${m.title||'Meeting'}</h2>
              <div style="font-size:12px;color:var(--joe-gray)">${formatDate(m.meeting_date)}${contact?' ‚Ä¢ '+contact.first_name+' '+contact.last_name:''}</div>
            </div>
            <div style="display:flex;align-items:center;gap:12px">
              <span class="badge badge-${sentimentColor}">${sentimentIcon} ${m.sentiment}</span>
              ${m.source_url?`<a href="${m.source_url}" target="_blank" class="btn btn-small btn-secondary">üìÑ Original</a>`:''}
              <button class="btn btn-small btn-secondary" onclick="viewMeetingDetails('${m.id}')">View Full</button>
            </div>
          </div>
          <div class="card-body">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
              <div>
                <h4 style="font-size:12px;color:var(--joe-gray);margin-bottom:8px">KEY POINTS</h4>
                <div style="font-size:13px;line-height:1.6">${extractSection(analysis,'key points')||'<span style="color:var(--joe-gray)">No key points extracted</span>'}</div>
              </div>
              <div>
                <h4 style="font-size:12px;color:var(--joe-gray);margin-bottom:8px">CUSTOMER QUOTES</h4>
                <div style="font-size:13px;line-height:1.6;font-style:italic">${extractSection(analysis,'customer quotes')||'<span style="color:var(--joe-gray)">No quotes extracted</span>'}</div>
              </div>
            </div>
            ${extractSection(analysis,'concerns')?`
            <div style="margin-top:16px;padding:12px;background:#fef2f2;border-radius:8px">
              <h4 style="font-size:12px;color:var(--joe-red);margin-bottom:8px">‚ö†Ô∏è CONCERNS RAISED</h4>
              <div style="font-size:13px">${extractSection(analysis,'concerns')}</div>
            </div>`:''}
          </div>
        </div>`;
      }).join(''):'<div class="empty-state">No meeting notes yet. Sync from Google Meet to get started!</div>';
    }
    
    function extractSection(text,sectionName){
      const patterns=[
        new RegExp(`\\*\\*${sectionName}[:\\s]*\\*\\*([\\s\\S]*?)(?=\\*\\*|$)`,'i'),
        new RegExp(`${sectionName}:?\\s*([\\s\\S]*?)(?=key points|customer quotes|action items|concerns|sentiment|$)`,'i'),
        new RegExp(`#+\\s*${sectionName}[\\s\\S]*?([\\s\\S]*?)(?=#+|$)`,'i')
      ];
      for(const pattern of patterns){
        const match=text.match(pattern);
        if(match&&match[1]?.trim()){
          let content=match[1].trim();
          // Convert markdown lists to HTML
          content=content.replace(/^[\-\*]\s+/gm,'‚Ä¢ ').replace(/\n/g,'<br>');
          // Limit length for preview
          if(content.length>300)content=content.substring(0,300)+'...';
          return content;
        }
      }
      return null;
    }
    
    let currentMeetingId=null;
    function viewMeetingDetails(meetingId){
      currentMeetingId=meetingId;
      const m=meetingNotes.find(x=>x.id===meetingId);
      if(!m)return;
      
      const contact=contacts.find(c=>c.id===m.contact_id);
      const analysis=m.analysis||'No analysis available';
      
      document.getElementById('meeting-detail-title').textContent=m.title||'Meeting';
      document.getElementById('meeting-detail-content').innerHTML=`
        <div style="display:flex;gap:16px;margin-bottom:20px;flex-wrap:wrap">
          <div><strong>Date:</strong> ${formatDate(m.meeting_date)}</div>
          ${contact?`<div><strong>Contact:</strong> ${contact.first_name} ${contact.last_name}</div>`:''}
          ${m.source_url?`<div><a href="${m.source_url}" target="_blank">üìÑ View Original Document</a></div>`:''}
        </div>
        
        <div class="card" style="margin-bottom:20px">
          <div class="card-header"><h2>ü§ñ AI Analysis</h2></div>
          <div class="card-body">
            <div style="white-space:pre-wrap;line-height:1.7">${analysis.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/^[\-\*]\s+/gm,'‚Ä¢ ')}</div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h2>üìù Full Transcript</h2>
            <button class="btn btn-small btn-secondary" onclick="copyTranscript()">üìã Copy</button>
          </div>
          <div class="card-body">
            <div id="meeting-transcript" style="max-height:400px;overflow-y:auto;white-space:pre-wrap;font-size:13px;line-height:1.6;color:var(--joe-gray)">${m.transcript||'No transcript available'}</div>
          </div>
        </div>
      `;
      document.getElementById('meeting-detail-modal').classList.add('open');
    }
    
    function copyTranscript(){
      const m=meetingNotes.find(x=>x.id===currentMeetingId);
      if(m?.transcript){
        navigator.clipboard.writeText(m.transcript);
        showToast('Transcript copied!');
      }
    }
    
    function copyToRoam(){
      const m=meetingNotes.find(x=>x.id===currentMeetingId);
      if(!m)return;
      const contact=contacts.find(c=>c.id===m.contact_id);
      
      // Format for Roam with [[links]] and #tags
      let roamText=`**${m.title||'Meeting'}** #meeting #crm\n`;
      roamText+=`    - Date:: ${new Date(m.meeting_date).toLocaleDateString()}\n`;
      if(contact)roamText+=`    - Contact:: [[${contact.first_name} ${contact.last_name}]]\n`;
      if(m.source_url)roamText+=`    - Source:: ${m.source_url}\n`;
      roamText+=`    - **Analysis**\n`;
      
      // Parse analysis sections
      const analysis=m.analysis||'';
      const sections=['Sentiment','Key Points','Customer Quotes','Action Items','Concerns'];
      for(const section of sections){
        const content=extractSection(analysis,section);
        if(content){
          roamText+=`        - **${section}**\n`;
          roamText+=`            - ${content.replace(/<br>/g,'\n            - ').replace(/‚Ä¢ /g,'')}\n`;
        }
      }
      
      navigator.clipboard.writeText(roamText);
      showToast('Copied to Roam format!');
    }

    // Team Management
    let currentMemberId=null;
    function renderTeam(){
      const weekAgo=new Date(Date.now()-7*24*60*60*1000);
      const monthAgo=new Date(Date.now()-30*24*60*60*1000);
      const today=new Date().toISOString().split('T')[0];
      const activitiesToday=activities.filter(a=>a.created_at?.startsWith(today)).length;
      const dealsThisMonth=deals.filter(d=>new Date(d.created_at)>=monthAgo).length;
      const activeSeqs=enrollments.filter(e=>e.status==='active').length;
      document.getElementById('team-size').textContent=teamMembers.length;
      document.getElementById('team-activities-today').textContent=activitiesToday;
      document.getElementById('team-deals-month').textContent=dealsThisMonth;
      document.getElementById('team-active-sequences').textContent=activeSeqs;
      document.getElementById('team-table').innerHTML=teamMembers.length?teamMembers.map(m=>{
        const shopCount=shops.filter(s=>s.assigned_to===m.email).length;
        const contactCount=contacts.filter(c=>c.assigned_to===m.email).length;
        const dealCount=deals.filter(d=>d.assigned_to===m.email&&!['closed_won','closed_lost'].includes(d.stage)).length;
        const activityCount=activities.filter(a=>a.team_member_email===m.email&&new Date(a.created_at)>=weekAgo).length;
        const isMe=m.email===currentUser?.email;
        return`<tr><td><div style="display:flex;align-items:center;gap:10px"><div class="user-avatar" style="width:32px;height:32px;font-size:12px">${m.name?m.name[0].toUpperCase():'?'}</div><div><div style="font-weight:600">${m.name||m.email.split('@')[0]}${isMe?' <span style="color:var(--joe-accent)">(you)</span>':''}</div><div style="font-size:11px;color:var(--joe-gray)">${m.email}</div></div></div></td><td><span class="badge badge-${m.role==='admin'?'purple':m.role==='manager'?'blue':'gray'}">${m.role||'sales'}</span></td><td>${shopCount}</td><td>${contactCount}</td><td>${dealCount}</td><td>${activityCount}</td><td class="actions-cell"><button class="action-btn" onclick="editTeamMember('${m.id||''}','${m.email}')">‚úèÔ∏è</button>${!isMe&&m.id?`<button class="action-btn" onclick="removeTeamMember('${m.id}')" style="color:var(--joe-red)">üóëÔ∏è</button>`:''}</td></tr>`;
      }).join(''):'<tr><td colspan="7" class="empty-state">No team members</td></tr>';
      // Leaderboard
      const leaderData=teamMembers.map(m=>{
        const acts=activities.filter(a=>a.team_member_email===m.email&&new Date(a.created_at)>=weekAgo).length;
        const wonDeals=deals.filter(d=>d.assigned_to===m.email&&d.stage==='closed_won'&&new Date(d.updated_at||d.created_at)>=weekAgo).length;
        return{name:m.name||m.email.split('@')[0],email:m.email,activities:acts,deals:wonDeals,score:acts+(wonDeals*10)};
      }).sort((a,b)=>b.score-a.score);
      document.getElementById('team-leaderboard').innerHTML=leaderData.length?leaderData.slice(0,5).map((m,i)=>{
        const medal=i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':'';
        return`<div style="display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--joe-light)"><div style="display:flex;align-items:center;gap:12px"><span style="font-size:18px;width:30px">${medal||i+1+'.'}</span><span style="font-weight:${i<3?'600':'normal'}">${m.name}</span></div><div style="display:flex;gap:16px;font-size:13px"><span>${m.activities} activities</span><span>${m.deals} deals</span></div></div>`;
      }).join(''):'<div class="empty-state">No activity this week</div>';
    }
    function openTeamMemberModal(id){
      currentMemberId=null;
      document.getElementById('team-modal-title').textContent='Add Team Member';
      document.getElementById('member-email').value='';
      document.getElementById('member-name').value='';
      document.getElementById('member-role').value='sales';
      document.getElementById('member-email').disabled=false;
      document.getElementById('team-modal').classList.add('open');
    }
    function editTeamMember(id,email){
      const member=teamMembers.find(m=>m.email===email);
      if(!member)return;
      currentMemberId=id||null;
      document.getElementById('team-modal-title').textContent='Edit Team Member';
      document.getElementById('member-email').value=member.email;
      document.getElementById('member-email').disabled=true;
      document.getElementById('member-name').value=member.name||'';
      document.getElementById('member-role').value=member.role||'sales';
      document.getElementById('team-modal').classList.add('open');
    }
    function closeTeamMemberModal(){document.getElementById('team-modal').classList.remove('open');}
    async function saveTeamMember(){
      const email=document.getElementById('member-email').value.trim();
      const name=document.getElementById('member-name').value.trim();
      const role=document.getElementById('member-role').value;
      if(!email){showToast('Email is required','error');return;}
      if(!email.endsWith('@joe.coffee')){showToast('Must be a @joe.coffee email','error');return;}
      if(currentMemberId){
        await db.from('team_members').update({name,role}).eq('id',currentMemberId);
        const member=teamMembers.find(m=>m.id===currentMemberId);
        if(member){member.name=name;member.role=role;}
      }else{
        if(teamMembers.find(m=>m.email===email)){showToast('Member already exists','error');return;}
        const{data:newMember}=await db.from('team_members').insert([{email,name:name||email.split('@')[0],role}]).select().single();
        if(newMember)teamMembers.push(newMember);
      }
      closeTeamMemberModal();populateDropdowns();renderTeam();showToast('Team member saved!');
    }
    async function removeTeamMember(id){
      if(!confirm('Remove this team member?'))return;
      await db.from('team_members').delete().eq('id',id);
      teamMembers=teamMembers.filter(m=>m.id!==id);
      populateDropdowns();renderTeam();showToast('Member removed');
    }

    // Navigation
    function navigateTo(page){document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.querySelector(`[data-page="${page}"]`).classList.add('active');document.getElementById('page-'+page).classList.add('active');if(page==='shops'){renderShops();setTimeout(()=>{initMap();if(map)map.resize();},100);}if(page==='pipeline')renderOutboundPipeline();if(page==='leads')renderLeads();if(page==='contacts')renderContacts();if(page==='companies')renderCompanies();if(page==='deals')renderDeals();if(page==='sequences')renderSequences();if(page==='tasks')renderTasks();if(page==='meetings')renderMeetings();if(page==='emails')renderEmailTemplates();if(page==='team')renderTeam();}
    document.querySelectorAll('.nav-item').forEach(item=>item.addEventListener('click',()=>navigateTo(item.dataset.page)));

    function formatDate(d){if(!d)return'';const diff=Date.now()-new Date(d);if(diff<0)return'upcoming';if(diff<3600000)return Math.floor(diff/60000)+'m ago';if(diff<86400000)return Math.floor(diff/3600000)+'h ago';if(diff<604800000)return Math.floor(diff/86400000)+'d ago';return new Date(d).toLocaleDateString();}
    function showToast(m,type='success'){const t=document.getElementById('toast');t.textContent=m;t.className='toast show '+type;setTimeout(()=>t.classList.remove('show'),3000);}

    netlifyIdentity.init();
  </script>
</body>
</html>
